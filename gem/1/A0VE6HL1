ç™¼ä¿¡äºº: itoc.bbs@processor.tfcis.org (:MM:) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½] å‹•æ…‹è¨­å®šä½¿ç”¨è€…çš„çœ‹ç‰ˆæ¬Šé™
ç™¼ä¿¡ç«™: XEON (Sat, 07 Jun 2003 10:24:00 +0800 (CST))      Updated: 2004/12/06

â€» å¼•è¿°ã€Šamaki (æ·¡å¢¨)ã€‹ä¹‹éŠ˜è¨€ï¼š
>   æ¿ä¸»ä¸€è¨­å®šå¥½åå–®ï¼Œä¾¿ç«‹åˆ»å°åå–®ä¸­æ‰€æœ‰idé€²è¡Œå‹•æ…‹çš„é–±è®€æ¬Šé™è®Šæ›´ï¼Œæˆ‘æ˜¯ä¸æ˜¯è©²åœ¨
>   UCACHEæˆ–æ˜¯UTMPåŠ æ–°çš„æ¬„ä½ï¼Ÿ

  æ­¤ç¯‡ä¿®æ”¹å¯èˆ‡çœ‹æ¿å£äººåˆä½µä½¿ç”¨

â€» ä¸€ã€é¦–å…ˆåˆªé™¤åŸæœ¬çš„ brd_bits å®£å‘Š

: board.c

- char brd_bits[MAXBOARD];

#ifndef ENHANCED_VISIT
time_t brd_visit[MAXBOARD];             /* æœ€è¿‘ç€è¦½æ™‚é–“ */
#endif

: cache.c favor.c gem.c post.c visio.c vote.c

- extern char brd_bits[];


â€» äºŒã€æŠŠ brd_bits æ”¾é€² UTMP

: struct.h:struct UTMP

  int pal_max;                  /* æœ‰å¹¾å€‹å¥½å‹ */
  int pal_spool[PAL_MAX];       /* æ‰€æœ‰å¥½å‹çš„ userno */
+ short brd_bits[MAXBOARD];     /* çœ‹æ¿é–±è®€æ¬Šé™ */

: board.c cache.c favor.c gem.c post.c visio.c vote.c

  æ‰€æœ‰ brd_bits å–ä»£æˆ cutmp->brd_bits


â€» ä¸‰ã€æ–°å¢å€‹ STATUS_BRD_BITã€BRD_D_BIT

: ufo.h

+ #define STATUS_BRD_BIT  BFLAG(7)        /* è¢«è®Šæ›´éçœ‹æ¿æ¬Šé™ */

  ä½ ä¸ä¸€å®šç”¨7ï¼Œåªè¦å°æ–¼32çš„æ•¸å­—ä¸”è·Ÿå…¶ä»–æ——æ¨™æ²’æœ‰é‡è¤‡å³å¯ã€‚

: modes.h

#define BRD_Z_BIT       0x80    /* .BRH zap æ‰äº† */
+ #define BRD_D_BIT     0x100   /* dirty */


â€» å››ã€æ–°å¢ æ”¹æ‰€æœ‰ç·šä¸Šä½¿ç”¨è€… brd_bits çš„å‡½å¼

: maple.p

+ void utmp_brdset(int bno);

: board.c æ–°å¢å‡½å¼ utmp_brdset() æ–¼ Ben_Perm() å¾Œé¢

void
utmp_brdset(bno)
  int bno;
{
  UTMP *uentp, *uceil;

  uentp = ushm->uslot;
  uceil = (void *) uentp + ushm->offset;

  do
  {
    uentp->status |= STATUS_BRD_BIT;        /* å‘Šè¨´å°æ–¹è¦é‡æ–°åˆ¤æ–· brd_bits */
    uentp->brd_bits[bno] |= BRD_D_BIT;      /* è¦é‡æ–°åˆ¤æ–·çš„æ˜¯ bno é€™å€‹æ¿ */
  } while (++uentp <= uceil);
}


â€» äº”ã€ç•¶æ¿ä¸»è®Šå‹•çœ‹æ¿å¥½å‹æ™‚ï¼Œå°±è¦è®Šå‹•æ‰€æœ‰ç·šä¸Šä½¿ç”¨è€…çš„ brd_bits

: manage.c:XoBM()

    free(xt);
+   utmp_brdset(currbno);

    return XO_INIT;


â€» å…­ã€ç•¶ç«™é•·/æ¿ä¸»è®Šå‹•çœ‹æ¿æ¬Šé™æ™‚ï¼Œå°±è¦è®Šå‹•æ‰€æœ‰ç·šä¸Šä½¿ç”¨è€…çš„ brd_bits

: manage.c:post_brdlevel()

  if ((vans(msg_sure_ny) == 'y') && memcmp(&newbrd, oldbrd, sizeof(BRD)))
  {
    memcpy(oldbrd, &newbrd, sizeof(BRD));
    rec_put(FN_BRD, &newbrd, sizeof(BRD), currbno, NULL);
+   utmp_brdset(currbno);
  }

: acct.c:m_newbrd() åŠ newbrd.c:nbrd_newbrd()

  brh_save();
  board_main();                 /* reload brd_bits[] */
+ utmp_brdset(bno);

: acct.c:brd_edit()

        memcpy(bhdr, &newbh, sizeof(BRD));
        rec_put(FN_BRD, &newbh, sizeof(BRD), bno, NULL);
+       utmp_brdset(bno);


â€» ä¸ƒã€ç•¶æˆ‘ç™¼ç¾æˆ‘è‡ªå·±çš„ status æœ‰ STATUS_BRD_BIT æ™‚ï¼Œæˆ‘æ‡‰è©²è¦é‡æ–°è¼‰å…¥çœ‹æ¿

: æ”¹ board.c:class_head()

static int
class_head(xo)
  XO *xo;
{
+ if (cutmp->status & STATUS_BRD_BIT)
+ {
+   int n, max;
+   char bit_temp;
+
+   n = 0;
+   max = bshm->number;
+   do
+   {
+     bit_temp = cutmp->brd_bits[n];
+     if (bit_temp & BRD_D_BIT)   /* åªæ›´æ–°æœ‰ dirty çš„ï¼ŒåŸæœ¬çš„ V,H,Z è¦ä¿ç•™ */
+       cutmp->brd_bits[n] = Ben_Perm(n, cuser.userlevel) |
+         (bit_temp & (BRD_V_BIT | BRD_H_BIT | BRD_Z_BIT));
+   } while (++n < max);
+
+   cutmp->status ^= STATUS_BRD_BIT;
+   class_load(xo);
+ }
  vs_head("çœ‹æ¿åˆ—è¡¨", str_site);
  return class_neck(xo);
}


â€» å…«ã€åŸæœ¬å¯è¦‹çš„çœ‹æ¿å¯èƒ½çªç„¶è®Šæˆä¸å¯è¦‹ï¼Œæ‰€ä»¥å‘¼å« XoPost() çš„åœ°æ–¹è¦æ”¹

: menu.c:menu()

        if (currbno >= 0)
        {
          utmp_mode(M_BOARD);
-         XoPost(currbno);
+         if (XoPost(currbno) < 0)    /* å‚³å›-1 ä»£è¡¨ ç„¡é–±è®€æ¬Šé™ */
          {
            xover(XZ_POST);
#ifndef ENHANCED_VISIT
            time(&brd_visit[currbno]);
#endif
          }
        }

: xover.c:every_Z()

  case 'b':
    if (xz[XZ_POST - XO_ZONE].xo) /* è‹¥å·²é¸å®šçœ‹æ¿ï¼Œé€²å…¥çœ‹æ¿ï¼Œå¦å‰‡åˆ°çœ‹æ¿åˆ—è¡¨ */
    {
-     XoPost(currbno);
+     if (XoPost(currbno) < 0)
+       break;
      cmd = XZ_POST;
      break;
    }

--
  æ”¹ struct UTMP è¦æ¸… shmï¼Œé‡é–‹ bbsd

--
    [1;32mâ•­â”€ Origin â”€â•— [0;36m?[1m?[0;36m?[1mO[0;36m?[1m?[0;36m?[1m?[1;31m processor.tfcis.org [32m ï½ ÎºÎ»Î¼ â”€â”¤[m
    [1;32mâ”œ   Author   â•¡ [33;44mitoc.Dorm-GD2.NCTU.edu.tw                [m
