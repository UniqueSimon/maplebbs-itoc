ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š602) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] é‡å»ºæ‰€æœ‰ä½¿ç”¨è€…çš„ä¸Šç«™é€šçŸ¥æª”
æ™‚é–“: 2004/10/11 Mon 02:19:41                           Updated: 2004/11/22

  åˆ©ç”¨ FN_ALOHA ä¾†é‡å»º FN_FRIENZ

: src/util/Makefile

EXE =   ..... [1;33mfix_frienz[m

: util/fix_frienz.c æ–°å¢žæ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/fix_frienz.c    ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : é‡å»ºæ‰€æœ‰ä½¿ç”¨è€…çš„ä¸Šç«™é€šçŸ¥æª”                   */
/* create : 04/10/11                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


static int
acct_uno(userid)
  char *userid;
{
  int fd;
  int userno;
  char fpath[64];

  usr_fpath(fpath, userid, FN_ACCT);
  fd = open(fpath, O_RDONLY);
  if (fd >= 0)
  {
    read(fd, &userno, sizeof(userno));
    close(fd);
    return userno;
  }
  return 0;
}


static void
add_frienz(fpath, userid)
  char *fpath, *userid;
{
  ALOHA aloha;
  int fd;
  char path[64];
  FRIENZ frienz;

  if ((fd = open(fpath, O_RDONLY)) >= 0)
  {
    memset(&frienz, 0, sizeof(FRIENZ));
    strcpy(frienz.userid, userid);
    frienz.userno = acct_uno(userid);
    if (frienz.userno > 0)
    {
      while (read(fd, &aloha, sizeof(ALOHA)) == sizeof(ALOHA))
      {
        usr_fpath(path, aloha.userid, FN_FRIENZ);
        rec_add(path, &frienz, sizeof(FRIENZ));
      }
    }
    close(fd);
  }
}


int
main()
{
  char c;
  char fpath[64];
  struct dirent *de;
  DIR *dirp;
  char *userid;

  chdir(BBSHOME);

  for (c = 'a'; c <= 'z'; c++)
  {
    sprintf(fpath, "usr/%c", c);

    if (!(dirp = opendir(fpath)))
      continue;

    while (de = readdir(dirp))
    {
      userid = de->d_name;
      if (*userid <= ' ' || *userid == '.')
        continue;

      usr_fpath(fpath, userid, FN_FRIENZ);
      unlink(fpath);
    }

    closedir(dirp);

    printf("åˆªé™¤ frienz: è™•ç†å®Œ %c é–‹é ­çš„ ID\n", c);
  }

  for (c = 'a'; c <= 'z'; c++)
  {
    sprintf(fpath, "usr/%c", c);

    if (!(dirp = opendir(fpath)))
      continue;

    while (de = readdir(dirp))
    {
      userid = de->d_name;
      if (*userid <= ' ' || *userid == '.')
        continue;

      usr_fpath(fpath, userid, FN_ALOHA);
      add_frienz(fpath, userid);
    }

    closedir(dirp);

    printf("é‡å»º frienz: è™•ç†å®Œ %c é–‹é ­çš„ ID\n", c);
  }

  return 0;
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ž [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
