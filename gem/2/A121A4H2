ç™¼ä¿¡äºº: lzch.bbs@lzch.twbbs.org (å–”è€¶) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½] dict.c Yahoo! ç·šä¸Šå­—å…¸
ç™¼ä¿¡ç«™: ï¼‘ï¼”ï¼‘ï¼— (2006/03/13 Mon 13:03:08)                Updated: 2006/03/13

: src/game/Makefile

SO = ......  tetris.so [1;33;40mdict.so[m

.o.so:  ;  ......   .so -L../lib -ldao [1;33;40m-L/usr/local/lib -liconv[m

freebsd:
        @$(MAKE) CC=gcc ......  -I../include [1;33;40m-I/usr/local/include[m" $(SO)

: src/game/dict.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* dict.c        (YZU WindTopBBS Ver 3.02 )              */
/*-------------------------------------------------------*/
/* target : Yahoo ç·šä¸Šå­—å…¸                               */
/* create : 01/07/09                                     */
/* update :   /  /                                       */
/* author : statue.bbs@bbs.yzu.edu.tw                    */
/* change : hialan.bbs@venice.twbbs.org                  */
/* change : lzch.bbs@snow.ice.ntnu.edu.tw 20060313       */
/*-------------------------------------------------------*/

#if 0

  æ™®é€š
  http://tw.dictionary.yahoo.com/search?p=hello

#endif


#include "bbs.h"
#include "iconv.h"

#ifdef HAVE_NETTOOL

#define mouts(y,x,s)        { move(y,x); outs(s); }

#define HTTP_PORT           80
#define SERVER_yahoo        "tw.dictionary.yahoo.com"
#define CGI_yahoo           "/search?p="
#define REF                "http://tw.dictionary.yahoo.com/"


static int
encode_from_utf8_to_big5_and_more_out(server, s)
  char *server;
  char *s;
{
  FILE *fin, *fout;
  char *encFrom = "UTF-8", *encTo = "BIG-5";
  char fname_utf[64], fname_big[64];
  char bufin[1024], bufout[1024], *sin, *sout;
  int lenin, lenout, i;
  iconv_t c_pt;

  sprintf(fname_utf, "tmp/%s.yahoo_dict", cuser.userid);
  sprintf(fname_big, "tmp/%s.yahoo_dict.for_more", cuser.userid);

  if ((fin = fopen(fname_utf, "rt")) == NULL) {
    return -1;
  }
  if ((fout = fopen(fname_big, "wt")) == NULL) {
    return -1;
  }

  if ((c_pt = iconv_open(encTo, encFrom)) == (iconv_t)-1) {
    return -1;
  }

  while( fgets( bufin, 1024, fin ) != NULL ){
      lenin = strlen(bufin);
      lenout = 1024;
      sin = bufin;
      sout = bufout;
      iconv( c_pt, &sin, &lenin, &sout, &lenout );

      for( sin++, lenin--; lenin > 0; sin++, lenin--){
          iconv( c_pt, &sin, &lenin, &sout, &lenout );
      }

      bufout[1024-lenout] = '\0';

      /* skip DJ: []*/
      if( !strncmp( bufout, " DJ: []", 7 )){
              continue;
      }
      /* skip KK: []*/
      if( !strncmp( bufout, " KK: []", 7 ) ){
              continue;
      }

      /* é‡åˆ°æ¨™é¡Œ */
      if( !strncmp( bufout, "lzch_h200000000", 15 ) ){

          /* æŠŠå¾Œé¢çš„å­—å¿½ç•¥æ‰ (åœ¨ä¸€å¤§å †ç©ºç™½å¾Œé¢) */
          for( i = 0; strncmp( &bufout[i], "   ", 3 ) != 0 && i < 1024; i++ )
              ;
          bufout[i] = '\n';
          bufout[i+1] = '\0';
          fprintf( fout, "\n%s", bufout+15 ); /* çµ¦æ¨™é¡Œä¸€å€‹ enter */

          /* å–®å­—èˆ‡è§£é‡‹çš„åˆ†éš”ç·š */
          for( i = 0; i < 39; i++ ){
              fprintf( fout, "â”€"  );
          }
          fprintf( fout, "\n"  );
          continue;
      }

      /* é‡åˆ°è­¯è© */
      if( !strncmp( bufout, "lzch_explain000", 15 ) ){
          fprintf( fout, "â€» %s", bufout+15 );
          continue;
      }

      /* é‡åˆ°è©æ€§ */
      if( !strncmp( bufout, "lzch_pcixin0000", 15 ) ){
          bufout[strlen(bufout) - 1] = '\0';
          fprintf( fout, "> > %s < <\n", bufout+15 );
          continue;
      }

      /* æ™®é€šçš„è¼¸å‡º */
      fprintf( fout, "%s", bufout );
  }

  fprintf(fout, "\n\n--\nYahoo!å¥‡æ‘©å­—å…¸\nhttp://%s%s\n\n", server, s + 4);
  fclose(fout);
  more(fname_big, NULL);
  unlink(fname_big);
  iconv_close(c_pt);
  fclose(fin);
  fclose(fout);

  return 0;
}


static void
url_encode(dst, src)        /* URL encoding */
  uschar *dst;              /* Thor.990331: è¦ src çš„ä¸‰å€ç©ºé–“ */
  uschar *src;
{
  for (; *src; src++)
  {
    if (*src == ' ')
      *dst++ = '+';
    else if (is_alnum(*src))
      *dst++ = *src;
    else
    {
      register cc = *src;
      *dst++ = '%';
      *dst++ = radix32[cc >> 4];
      *dst++ = radix32[cc & 0xf];
    }
  }
  *dst = '\0';
}


static void
write_file(sockfd, fp)
  int sockfd;
  FILE *fp;
{
  static char pool[2048];
  int cc, i;
  char *xhead, *xtail;
  int show, start_show;
  int space;                /* åœ¨ html ä¸­ï¼Œé€£çºŒçš„ space åªæœƒç®—ä¸€æ¬¡ */

  char *start_str[] =
  {
    "<blockquote>",
    NULL
  };

  char *stop_str[] =
  {
    "<div id=\"morevoc\">",
    "<div id=\"emlist\">",
    "</blockquote>",
    "document.write(\"",
    NULL
  };

  char *newline_str[] =         /* å–ä»£æ›è¡Œå­—å…ƒçš„ç¬¦è™Ÿ */
  {
    "<br>",
    "</td>",
    "<h2>",                   /* æŸ¥å°‹çš„å–®å­— lzch_h200000000 */
    "<div class=chinese>",    /* ä¸­æ–‡ç™¼éŸ³ */
    "<div class=peng>",       /* è‹±æ–‡ä¾‹å¥ lzch_peng000000 */
    "<div class=pchi>",       /* è‹±æ–‡ä¾‹å¥çš„ç¿»è­¯ lzch_pchi000000 */
    "<div class=pexplain>",   /* (è‹±)ä¸­è­¯ (ä¸­)è‹±è­¯ lzch_explain000 */
    "<div class=ptitle>",     /* ä¸­æ–‡å­—å…¸è£¡çš„è‹±æ–‡ç›¸é—œå–®å­—ï¼Œè‹±æ–‡å­—å…¸è£¡çš„éŸ³æ¨™ */
    "<div class=pcixin>",     /* è©æ€§ lzch_pcixin0000 */
    NULL
  };

  /* parser return message from web server */
  xhead = pool;
  xtail = pool;
  show = 1;
  start_show=0;
  space = 0;

  for (;;xhead++)
  {
    if (xhead >= xtail)
    {
      xhead = pool;
      cc = read(sockfd, xhead, sizeof(pool));

    /* lzch test */
    /*  for( i = 0; i < 2048; i++ ){    fputc( pool[i], lzch );  } */

      if (cc <= 0)
        break;
      xtail = xhead + cc;
    }

    if (!start_show)
    {
      for (i = 0; start_str[i] != NULL; i++)
      {
        if (!str_ncmp(xhead, start_str[i], strlen(start_str[i])))
        {
          start_show = 1;
          xhead += strlen(start_str[i]);
          break;
        }
      }
    }
    else if (start_show)
    {
      for (i = 0; stop_str[i] != NULL; i++)
      {
        if (!str_ncmp(xhead, stop_str[i], strlen(stop_str[i])))
        {
          start_show = 0;
          xhead += strlen(stop_str[i]);
          break;
        }
      }
    }

    if (!start_show)
      continue;

    for (i = 0; newline_str[i] != NULL; i++)
    {
      if (!str_ncmp(xhead, newline_str[i], strlen(newline_str[i])))
      {
        fputc('\n', fp);
        if( !strncmp( xhead, "<h2>", 4 ) ){
            fprintf( fp, "lzch_h200000000" ); /* æ¨™è¨˜æ­¤ç‚ºæ¨™é¡Œ */
        }
        else if( !strncmp( xhead, "<div class=pcixin>", 18 ) ){
            fprintf( fp, "lzch_pcixin0000" ); /* æ¨™è¨˜æ­¤ç‚ºè©æ€§ */
        }
        else if( !strncmp( xhead, "<div class=pexplain>", 20 ) ){
            fprintf( fp, "lzch_explain000" ); /* æ¨™è¨˜æ­¤ç‚ºè­¯è© */
        }
        else if( !strncmp( xhead, "<br>\n<li>", 9 ) ){
            fprintf( fp, "lzch_explain000" ); /* æ¨™è¨˜æ­¤ç‚ºè­¯è© */
        }
        else if( !strncmp( xhead, "<div class=peng>", 16 ) ){
        }
        else if( !strncmp( xhead, "<div class=pchi>", 16 ) ){
        }
        else if( !strncmp( xhead, "<div class=ptitle>", 18 ) ){
        }
        xhead += strlen(newline_str[i]);
        space = 0;
        break;
      }
    }

    /* æ¨™ç±¤ç•¥é */
    cc = *xhead;
    switch(cc)
    {
    case '<':
      show = 0;
      continue;
    case '>':
      show = 1;
      continue;
    case '\n':
    case '\r':
      continue;
    case ' ':
      if (space)
        continue;
      space = 1;
    }

    if (show)
      fputc(cc, fp);

    if (cc != ' ')
      space = 0;
  }
  fputc('\n', fp);
}


static int
http_conn(server, s)
  char *server;
  char *s;
{
  int sockfd;
  FILE *fp;
  char fname[64], *str;

  if ((sockfd = dns_open(server, HTTP_PORT)) < 0)
  {
    vmsg("ç„¡æ³•èˆ‡ä¼ºæœå™¨å–å¾—é€£çµï¼ŒæŸ¥è©¢å¤±æ•—");
    return 0;
  }
  else
  {
    mouts(22, 0, "æ­£åœ¨é€£æ¥ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œ(æŒ‰ä»»æ„éµé›¢é–‹).............");
    refresh();
  }
  write(sockfd, s, strlen(s));
  shutdown(sockfd, 1);

  sprintf(fname, "tmp/%s.yahoo_dict", cuser.userid);

  fp = fopen(fname, "w");

  str = strchr(s + 4, ' ');

  if (str)
    *str = '\0';

  write_file(sockfd, fp);
  fclose(fp);

  close(sockfd);

  if( encode_from_utf8_to_big5_and_more_out( server, s ) == -1 ){
      more(fname, NULL);
  }

/*  more(fname, NULL);*/
  unlink(fname);
  return 0;
}


static void
yahoo_dict(word)
  char *word;
{
  char atrn[256], sendform[512];
  char ue_word[90];

  url_encode(ue_word, word);

  sprintf(atrn, "%s", ue_word);

  sprintf(sendform, "GET %s%s HTTP/1.0\n\n", CGI_yahoo, atrn);

  http_conn(SERVER_yahoo, sendform);
}


int
main_dreye()
{
  char word[30];

  while (1)
  {
    clear();
    move(0, 23);
    outs("\033[1;37;44mâ— Yahoo! ç·šä¸Šå­—å…¸ v0.1 â—\033[m");
    move(3, 0);
    outs("æ­¤å­—å…¸ä¾†æºç‚º Yahoo! ç·šä¸Šå­—å…¸ã€‚\n");
    prints("WWW: %s\n", REF);
    outs("author: statue.bbs@bbs.yzu.edu.tw\n");
    if (!vget(8, 0, "æŸ¥è©¢å­—å½™ï¼š", word, 30, DOECHO))
      break;

    yahoo_dict(word);
  }

  return 0;
}
#endif  /* HAVE_NETTOOL */


==
æˆ‘çš„ OS æ˜¯ freebsd 6.0 release
linux æ”¹ Makefile çš„æ–¹æ³•å¯èƒ½ä¸å¤ªä¸€æ¨£...
code å¯«çš„ä¸æ˜¯å¾ˆå¥½ï¼Œç¸½ä¹‹æ–¹æ³•æ˜¯ç”¨ iconv() æŠŠ yahoo å­—å…¸çš„ç·¨ç¢¼è½‰æˆ big5
æœ‰èˆˆè¶£çš„å†è‡ªå·±æ”¹å§ :)

é‚„æ˜¯æœ‰ bug çš„.. åªæ˜¯æˆ‘ä¸å¤ªçŸ¥é“æ˜¯ç‚ºä»€éº¼?? (ä¸æœƒæ”¹å•¦...)

http://xcin.linux.org.tw/i18n/pc2000/p4/node2.html
http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/converter.html#ICONV
http://opensvn.csie.org/pttbbs/tags/stable.rc/docs/FAQ
--
[1;32mâ–¡ Origin: [33mlzch.twbbs.org  [31mâ–¡ From: [36m140.122.37.121[m
