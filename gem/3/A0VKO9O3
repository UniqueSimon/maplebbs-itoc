ç™¼ä¿¡äºº: BioStar.bbs@micro.bio.ncue.edu.tw (æ¾Žæ¹–å°é›²é›€) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: [å•é¡Œ] å¦‚ä½•ä½¿ç³»çµ±è‡ªå‹•å¯„ç”Ÿæ—¥ç¥è³€ä¿¡çµ¦å£½æ˜Ÿ
ç™¼ä¿¡ç«™: æ“Žå¤©å´— (Wed, 27 Aug 2003 19:10:53 +0800 (CST))    Updated: 2003/08/27

å› ç‚ºæ•ç«™çš„ util/topusr.c æ˜¯æ¯å°æ™‚ä¸€æ¬¡......
ï¼ˆå› ç‚ºæŸäº›ä½¿ç”¨è€…æ€¥æ–¼çœ‹åˆ°è‡ªå·±çš„ã€Œè±åŠŸå‰æ¥­ã€ï¼‰

æ‰€ä»¥å°‡é€™åŠŸèƒ½ç¨ç«‹æˆ util/birth.c ......

: src/util/Makefile

EXE = ..... birth

: crontab -e åŠ å…¥

1 0 * * * bin/birth > /dev/null 2>&1

: util/birth.c æ–°å¢žæ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/birth.c     ( NTHU CS MapleBBS Ver 3.00 )        */
/*-------------------------------------------------------*/
/* target : ç³»çµ±è‡ªå‹•é€ç”Ÿæ—¥ç¥è³€ä¿¡ä»¶                       */
/* create : 99/03/29                                     */
/* update : 01/10/01                                     */
/* modify : BioStar.bbs@bbs.bio.ncue.edu.tw              */
/*-------------------------------------------------------*/


#include "bbs.h"


static UCACHE *ushm;


static inline void
init_ushm()
{
  ushm = shm_new(UTMPSHM_KEY, sizeof(UCACHE));
}


static inline void
bbs_biff(userid)
  char *userid;
{
  UTMP *utmp, *uceil;
  usint offset;

  offset = ushm->offset;
  if (offset > (MAXACTIVE - 1) * sizeof(UTMP))
    offset = (MAXACTIVE - 1) * sizeof(UTMP);

  utmp = ushm->uslot;
  uceil = (void *) utmp + offset;

  do
  {
    if (!str_cmp(utmp->userid, userid))
      utmp->status |= STATUS_BIFF;
  } while (++utmp <= uceil);
}


int
main()
{
  char c;
  int year, month, day;
  time_t now;
  struct tm *ptime;

  now = time(NULL);
  ptime = localtime(&now);

  year = ptime->tm_year;
  month = ptime->tm_mon + 1;
  day = ptime->tm_mday;

  init_ushm();

  for (c = 'a'; c <= 'z'; c++)
  {
    char buf[64];
    struct dirent *de;
    DIR *dirp;

    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      ACCT acct;
      int fd;
      char *fname;

      fname = de->d_name;
      if (*fname <= ' ' || *fname == '.')
        continue;

      sprintf(buf, "%s/.ACCT", fname);
      if ((fd = open(buf, O_RDONLY)) < 0)
        continue;

      read(fd, &acct, sizeof(ACCT));
      close(fd);

      if (acct.month == month && acct.day == day)   /* æœ¬æ—¥å£½æ˜Ÿ */
      {
        HDR hdr;
        char folder[64], lowid[IDLEN + 1];

        str_lower(lowid, acct.userid);
        sprintf(folder, "%s/.DIR", lowid);
        hdr_stamp(folder, HDR_COPY, &hdr, BBSHOME "etc/birth");
        strcpy(hdr.owner, STR_SYSOP);
        strcpy(hdr.title, "ç”Ÿæ—¥å¿«æ¨‚");
        hdr.xmode = 0;
        rec_add(folder, &hdr, sizeof(HDR));
        bbs_biff(acct.userid);
      }
    }

    closedir(dirp);
  }
}

--
 [1;43mâ”Œ[44mâ”¼[m Au[1mth[30mor[m: [44m å½°åŒ–å¸«å¤§ç”Ÿç‰©ç³»Ë™åŸé¢¨?çœºæœˆ?æ“Žå¤©å´— [31;47m micro.bio.ncue.edu.tw [m
 [1;41mâ””[42mâ”˜[m O[1mri[30mgi[mn: [1;36mBioStar [30må¾ž [35m163.23.212.15 [30mç™¼è¡¨[m
