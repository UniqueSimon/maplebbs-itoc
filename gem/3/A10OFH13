ç™¼ä¿¡äºº: chwaian.bbs@cpu.tfcis.org (ç„¡è¨€) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½]æŠ“å–å¥‡æ‘©é›»å½±
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2004/11/03 Wed 00:19:17)                Updated: 2006/03/08

æ‹¿itocå¯«çš„NCTUnews.c(é€™éš»ç¨‹å¼çœŸå¥½ç”¨@_@)æ”¹çš„

æœƒæŠ“ http://tw.movie.yahoo.com/movie_comming.html çš„æ–‡ç« 


é‚„è¦é–‹ Kimo_Movies æ¿


: crontab -e åŠ å…¥é€™äºŒè¡Œ

# å¥‡æ‘©é›»å½±æ¯å¤©æŠ“å…©æ¬¡
5 10,20 * * * bin/Kimomovie > /dev/null 2>&1

: src/util/Makefile

EXE =   ... [1;33mKimomovie[m

: src/util/Kimomovie.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/Kimomovie.c     ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : å¥‡æ‘©é›»å½±                                     */
/* create : 04/05/20                                     */
/* update :   /  /                                       */
/* author : chwaian.bbs@cpu.tfcis.org                    */
/*-------------------------------------------------------*/


#include "bbs.h"


#define LYNX_PATH       "/usr/local/bin/lynx --source"  /* lynx çš„çµ•å°è·¯å¾‘ */


/*-------------------------------------------------------*/
/* BRD shm éƒ¨åˆ†é ˆèˆ‡ cache.c ç›¸å®¹                         */
/*-------------------------------------------------------*/


static BCACHE *bshm;

static void
init_bshm()
{
  /* itoc.030727: åœ¨é–‹å•Ÿ bbsd ä¹‹å‰ï¼Œæ‡‰è©²å°±è¦åŸ·è¡Œé accountï¼Œ
     æ‰€ä»¥ bshm æ‡‰è©²å·²è¨­å®šå¥½ */

  bshm = shm_new(BRDSHM_KEY, sizeof(BCACHE));

  if (bshm->uptime <= 0)        /* bshm æœªè¨­å®šå®Œæˆ */
    exit(0);
}


static void
update_btime(brdname)
  char *brdname;
{
  BRD *bhdr, *tail;

  bhdr = bshm->bcache;
  tail = bhdr + bshm->number;
  do
  {
    if (!str_cmp(brdname, bhdr->brdname))
    {
      bhdr->btime = -1;
      break;
    }
  } while (++bhdr < tail);
}


/*-------------------------------------------------------*/
/* ç™¼æ–‡åˆ°çœ‹æ¿                                            */
/*-------------------------------------------------------*/


static char *Brdname = "Kimo_Movies";     /* æ¬² post çš„çœ‹æ¿ */
static char *Userid = "å¥‡æ‘©é›»å½±";   /* ä½œè€… */
static char *Username = "æœ€æ–°é›»å½±"; /* æš±ç¨± */


static void
new_post(fpath, title)           /* ç™¼æ–‡åˆ°çœ‹æ¿ */
  char *fpath;          /* æª”æ¡ˆè·¯å¾‘ */
  char *title;          /* æ–‡ç« æ¨™é¡Œ */
{
  HDR hdr;
  char folder[64];

  brd_fpath(folder, Brdname, FN_DIR);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, fpath);
  strcpy(hdr.owner, Userid);
  strcpy(hdr.nick, Username);
  strcpy(hdr.title, title);
  rec_add(folder, &hdr, sizeof(HDR));

  update_btime(Brdname);
}


/*-------------------------------------------------------*/
/* æŠ“ç¶²é                                                 */
/*-------------------------------------------------------*/


static int wlen;    /* æœ¬è¡Œæœ‰å¤šå°‘å­— */
static int slen;    /* æœ¬è¡Œæœ‰å¤šå°‘åŠå‹å­— */


static void
foutc(ch, fp)
  int ch;
  FILE *fp;
{
  static int in_tag = 0;    /* 1: åœ¨ <tag> ä¸­ */
  static int in_chi = 0;    /* 1: å‰ä¸€ç¢¼æ˜¯ä¸­æ–‡å­— */

  if (ch == '<')
  {
    in_tag = 1;
    return;
  }

  /* è·³é \t */
  if (ch == '\t')
    return;

  if (!in_tag)
  {
    if (in_chi)             /* å‰ä¸€å€‹charæ˜¯ä¸­æ–‡å­—çš„ç¬¬ä¸€ç¢¼ */
      in_chi = 0;
    else if (ch & 0x80)     /* å‰ä¸€å€‹charä¸æ˜¯ä¸­æ–‡å­—çš„ç¬¬ä¸€ç¢¼ï¼Œæª¢æŸ¥é€™charæ˜¯å¦ç‚ºä¸­æ–‡å­—çš„ç¬¬ä¸€ç¢¼ */
      in_chi = 1;
    else                    /* å¦‚æœéƒ½ä¸æ˜¯ï¼Œè¡¨ç¤ºé€™charæ˜¯åŠå‹å­— */
      slen++;

    if (wlen >= 60 - slen % 2)  /* ä¸€è¡Œæœ€å¤š 60 å­—ï¼Œè‹¥æœ‰å¥‡æ•¸å€‹åŠå‹å­—ï¼Œè©²è¡Œåªå° 59 å­— */
    {
      fputs("\n    ", fp);  /* æ¯è¡Œå‰é¢éƒ½ç©ºå››æ ¼ */
      wlen = 0;
      /* slen = 0; */
      slen = !in_chi;       /* è‹¥æ–°çš„é€™è¡Œç¬¬ä¸€å€‹charæ˜¯åŠå‹å­—ï¼Œslen=1 */
    }

    fputc(ch, fp);
    wlen++;
  }
  else
  {
    if (ch == '>')
      in_tag = 0;
  }
}


static void
fouts(str, fp)
  uschar *str;
  FILE *fp;
{
  int ch;

  wlen = 0;
  slen = 0;
  fputs("\n    ", fp);      /* æ¯è¡Œå‰é¢éƒ½ç©ºå››æ ¼ */

  while (ch = *str)
  {
    foutc(ch, fp);
    str++;
  }
}


static void
strip_title(str, title)
  uschar *str, *title;
{
  int ch, len = 0;
  uschar *dst;

  /* å»æ‰ str ä¸­çš„ \t åŠæœ€å¾Œçš„ <tag>ï¼Œå­˜åœ¨ title */

  dst = title;
  while (ch = *str++)
  {
    if (ch == '<')
      break;

    if (ch != '\t')
    {
      *dst++ = ch;
      if (++len > TTLEN)
        break;
    }
  }
  *dst = '\0';
}


static void
html_download(actno)          /* ä¸‹è¼‰æ–‡ç« ä¸¦è½‰æ›ç‚ºæ–‡å­—æª” */
  int actno;
{
  char link[128], title[TTLEN + 1], title2[TTLEN + 1];
  char buf[2048];       /* å‡è¨­æ–‡ç« æ¯æ®µä¸æœƒè¶…é 2048 å­— */
  char *fsrc = "tmp/Kimomovie.src";
  char *fdst = "tmp/Kimomovie.dst";
  FILE *fpr, *fpw;
  int mode;
  char *ptr;
  int right;            /* ä¸å­˜åœ¨çš„ç¶²å€è·³é */


  right = 0;

  /* ä¸‹è¼‰æ–‡ç«  */
  sprintf(link, "http://tw.movie.yahoo.com/mstory.html?t=movie&id=%d", actno);
  sprintf(buf, LYNX_PATH " '%s' > %s", link, fsrc);
  system(buf);

  /* è½‰æ›ç‚ºæ–‡å­—æª” */
  if (fpr = fopen(fsrc, "r"))
  {
    if (fpw = fopen(fdst, "w"))
    {
      /* é–‹é ­åŠ ä¸Šæª”é ­ */

      while (fgets(buf, sizeof(buf), fpr))
      {
        /* film_people.gif çš„ä¸‹ä¸€è¡Œå°±æ˜¯æ¨™é¡Œ */
        if (strstr(buf, "film_people.gif"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title);
          fgets(buf, sizeof(buf), fpr);

          if (fgets(buf, sizeof(buf), fpr))
          {

            strip_title(buf, title2);

            sprintf(title,"%s (%s)",title,title2);

            fprintf(fpw, "%s %s (%s) %s %s\n",
              STR_AUTHOR1, Userid, Username, STR_POST2, Brdname);
            fprintf(fpw, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n\n", title, Now());
            right = 1;
          }
          break;
        }
      }


      while (fgets(buf, sizeof(buf), fpr))
      {
        if (strstr(buf, "é¡ã€€ã€€å‹ï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\né¡ã€€ã€€å‹ï¼š%s\n", title2);
        }
        else if (strstr(buf, "ç‰‡ã€€ã€€é•·ï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\nç‰‡ã€€ã€€é•·ï¼š%s\n", title2);
        }
        else if (strstr(buf, "åˆ†ã€€ã€€ç´šï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\nåˆ†ã€€ã€€ç´šï¼š%s\n", title2);
        }
        else if (strstr(buf, "å°ã€€ã€€æ¼”ï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\nå°ã€€ã€€æ¼”ï¼š%s\n", title2);
        }
        else if (strstr(buf, "æ¼”ã€€ã€€å“¡ï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\næ¼”ã€€ã€€å“¡ï¼š%s\n", title2);
        }
        else if (strstr(buf, "ç™¼è¡Œå…¬å¸ï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\nç™¼è¡Œå…¬å¸ï¼š%s\n", title2);
        }
        else if (strstr(buf, "ä¸Šæ˜ æ—¥æœŸï¼š"))
        {
          fgets(buf, sizeof(buf), fpr);
          fgets(buf, sizeof(buf), fpr);
          strip_title(buf, title2);
          fprintf(fpw, "\nä¸Šæ˜ æ—¥æœŸï¼š%s\n", title2);
          fprintf(fpw, "\nåŠ‡æƒ…ç°¡ä»‹ï¼š\n");
          break;
        }
      }

      mode = 0;    /* 0:æœªé–‹å§‹  1:å°åˆ°ä¸€åŠ  2:çµæŸ */

      while (fgets(buf, sizeof(buf), fpr))
      {
        if (ptr = strstr(buf, "<td class=\"mbody\">"))
        {
          *ptr = '\0';
          mode++;
        }
        else if (strstr(buf, "<!--å½±ç‰‡å…§å®¹ä»‹ç´¹é–‹å§‹-->"))
        {
          mode++;
        }

        if (mode)
        {
           fouts(buf, fpw);
           if (mode == 2)
            break;
        }

      }


      /* çµå°¾åŠ ä¸Šä¾†æº */
      fprintf(fpw, "\n--\nYahoo!å¥‡æ‘©é›»å½±\n%s\n", link);
      fclose(fpw);
      fclose(fpr);

      if (right)
        new_post(fdst, title);
      unlink(fdst);
    }
    unlink(fsrc);
  }
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


static int
urhigh_query()
{
  char *ftmp = "tmp/Kimomovie.tmp";
  char buf[512];       /* å‡è¨­æ¯è¡Œä¸æœƒè¶…é 512 å­— */
  char *ptr;
  FILE *fp;
  int high;
  int tmp;

  high = 0;
  tmp = 0;
  sprintf(buf, LYNX_PATH " http://tw.movie.yahoo.com/movie_comming.html > %s",
    ftmp);
  system(buf);

  if (fp = fopen(ftmp, "r"))
  {
    while (fgets(buf, sizeof(buf), fp))
    {
      if (ptr = strstr(buf, "mstory.html?t=movie&id="))
      {
        tmp = atoi(ptr + 23);

        if(tmp > high)
         high = tmp;
      }
    }

    fclose(fp);
    unlink(ftmp);
  }
  return high;
}


int
main()
{
  FILE *fp;
  int myhigh, urhigh;
  char buf[10];

  chdir(BBSHOME);

  /* çœ‹è‡ªå·±æŠ“åˆ°ç¬¬å¹¾ç¯‡äº† */
  myhigh = 0;
  if (fp = fopen("run/Kimomovie", "r"))
  {
    fscanf(fp, "%8s", buf);
    fclose(fp);

    if ((urhigh = atoi(buf)) > 0)
      myhigh = urhigh;
  }

  /* çœ‹å¥‡æ‘©é›»å½±æœ€æ–°çš„æœ‰å¹¾ç¯‡ */
  urhigh = urhigh_query();

  if (!myhigh)           /* å¦‚æœè‡ªå·±æ²’æœ‰ç¯‡æ•¸è¨ˆæ•¸å™¨ï¼Œé‚£å°±æŠ“æœ€å¾Œä¸‰ç¯‡ */
    myhigh = urhigh - 3;

  if (myhigh >= urhigh)  /* æ²’æœ‰æ–°æ–‡ç«  */
    return 0;

  init_bshm();

  /* å»æŠ“æ–°çš„æ–‡ç«  */
  for (myhigh++; myhigh <= urhigh; myhigh++)
    html_download(myhigh);

  /* æ›´æ–°è‡ªå·±çš„ç¯‡æ•¸è¨ˆæ•¸å™¨ */
  if (fp = fopen("run/Kimomovie", "w"))
  {
    fprintf(fp, "%d", urhigh);
    fclose(fp);
  }

  return 0;
}



--
 [1;43mâ—¤[46mâ—¥[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [36;47m cpu.tfcis.org [m
 [1;44mâ—£[41mâ—¢[m A[1mut[30mho[mr: [1;33mchwaian [30må¾ [31m61-216-216-43.dynamic.hinet.net [30mç™¼è¡¨[m
