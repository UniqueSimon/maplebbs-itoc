ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] æ¿ä¸»æ•‘å› deleted æ¿æ–‡ç« 
æ™‚é–“: 2004/10/28 Thu 21:10:49                           Updated: 2004/10/28

â€» å¼•è¿°ã€ŠFish.bbs@fishocean.twbbs.org (é­šç¬¨é­šè ¢å‘†å‘†é­š)ã€‹ä¹‹éŠ˜è¨€ï¼š
>     æˆ‘ä¸€ç›´ä»¥ç‚º Junk å’Œ Delete æ¿æ˜¯è¦é¿å…èª¤åˆªæ–‡ç« 
>     æœ‰è¾¦æ³•åšåˆ°æ–‡ç« æ•‘å›ã„‡???

  è‹¥åŸæ–‡æ¨™é¡Œéé•·ï¼Œé‚£éº¼æ•‘å›çš„æ¨™é¡Œæœƒè®ŠçŸ­
  (å› ç‚ºåœ¨åˆªé™¤æ™‚ move_post() å°±å°‡æ¨™é¡Œæ”¹çŸ­äº†)

: post.c:post_cb[]

+ 'i', post_undelete,       [1;44m// æŒ‰éµè‡ªå®š [m
  'h', post_help

: post.c:post_undelete() æ–°å¢åœ¨ post_delete() å¾Œé¢

static int
post_undelete(xo)
  XO *xo;
{
  HDR *hdr, xpost;
  char fpath[64], userid[IDLEN + 2], buf[ANSILINELEN], *brdname, *ptr;
  FILE *fp;

  if (strcmp(currboard, BN_DELETED))
    return XO_NONE;

  hdr = (HDR *) xo_pool + (xo->pos - xo->top);
  if (!HAS_PERM(PERM_ALLBOARD))
  {
    sprintf(userid, "%-13s", cuser.userid);
    if (strncmp(hdr->title, userid, IDLEN + 1))
    {
      vmsg("é€™ä¸æ˜¯æ‚¨æ‰€åˆªé™¤çš„æ–‡ç« ï¼Œç„¡æ³•æ•‘å›");
      return XO_FOOT;
    }
  }

  brdname = NULL;
  hdr_fpath(fpath, xo->dir, hdr);
  if (fp = fopen(fpath, "r"))
  {
    if (fgets(buf, sizeof(buf), fp))
    {
      if ((brdname = strstr(buf, STR_POST1" ")) ||
        (brdname = strstr(buf, STR_POST2" ")))
      {
        brdname += 6;
        if (ptr = strchr(brdname, '\n'))
          *ptr = '\0';
      }
    }
    fclose(fp);
  }

  if (brdname && brd_bno(brdname) >= 0)
  {
    brd_fpath(buf, brdname, fn_dir);
    hdr_stamp(buf, HDR_COPY | 'A', &xpost, fpath);
    strcpy(xpost.owner, hdr->owner);
    strcpy(xpost.nick, hdr->nick);
    strcpy(xpost.date, hdr->date);      /* åŸæ–‡è½‰è¼‰ä¿ç•™åŸæ—¥æœŸ */
    strcpy(xpost.title, hdr->title + IDLEN + 1);
    rec_add(buf, &xpost, sizeof(HDR));

    sprintf(fpath, "å·²æˆåŠŸåœ°å°‡æœ¬æ–‡æ•‘å› %s æ¿", brdname);
    vmsg(fpath);
  }
  else
  {
    vmsg("æœ¬æ–‡æª”é ­æ²’æœ‰è¨˜éŒ„çœ‹æ¿åç¨±ï¼Œè«‹ä½¿ç”¨è½‰éŒ„ä¾†æ•‘å›");
  }

  return XO_FOOT;
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
