ç™¼ä¿¡äºº: TKyo.bbs@cpu.tfcis.org (æš—é»‘è²´å…¬å­) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: [åŠŸèƒ½] dict.c Yahoo! ç·šä¸Šå­—å…¸
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2006/03/13 Mon 13:42:16)                Updated: 2006/03/13

â€» å¼•è¿°ã€Šlzch.bbs@lzch.twbbs.org (å–”è€¶)ã€‹ä¹‹éŠ˜è¨€ï¼š
> linux æ”¹ Makefile çš„æ–¹æ³•å¯èƒ½ä¸å¤ªä¸€æ¨£...
> code å¯«çš„ä¸æ˜¯å¾ˆå¥½ï¼Œç¸½ä¹‹æ–¹æ³•æ˜¯ç”¨ iconv() æŠŠ yahoo å­—å…¸çš„ç·¨ç¢¼è½‰æˆ big5
> æœ‰èˆˆè¶£çš„å†è‡ªå·±æ”¹å§ :)
> é‚„æ˜¯æœ‰ bug çš„.. åªæ˜¯æˆ‘ä¸å¤ªçŸ¥é“æ˜¯ç‚ºä»€éº¼?? (ä¸æœƒæ”¹å•¦...)
> http://xcin.linux.org.tw/i18n/pc2000/p4/node2.html
> http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/converter.html#ICONV
> http://opensvn.csie.org/pttbbs/tags/stable.rc/docs/FAQ

æˆ‘çš„æ–¹æ³•æ¯”è¼ƒä¸ä¸€æ¨£

æˆ‘æ˜¯ç”¨ zh-autoconvert é€™å€‹å¥—ä»¶çš„ autob5 å·¥å…·è½‰æ› :)

: src/game/Makefile

SO = ......  tetris.so [1;33mdict.so[m

: src/game/dict.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* target : Yahoo ç·šä¸Šå­—å…¸                               */
/* create : 01/07/09                                     */
/* update : 06/01/16                                     */
/* author : statue.bbs@bbs.yzu.edu.tw                    */
/* change : kyo@cszone.tw                                */
/*-------------------------------------------------------*/

#if 0

  æ™®é€š
  http://tw.dictionary.yahoo.com/search?ei=big5&p=hello

  åŒç¾©å­—/åç¾©å­—
  http://tw.dictionary.yahoo.com/search?ei=big5&p=hello&type=t

  è®ŠåŒ–å½¢
  http://tw.dictionary.yahoo.com/search?ei=big5&p=hello&type=v

#endif


#include "bbs.h"

#ifdef HAVE_NETTOOL

#define mouts(y,x,s)    { move(y, x); outs(s); }

#define HTTP_PORT       80
#define SERVER_yahoo    "tw.dictionary.yahoo.com"
#define CGI_yahoo       "/search?ei=big5&p="
#define CGI_yahoo2      "&type="
#define REF             "http://tw.dictionary.yahoo.com/"
#define Dict_Name       "Yahoo! ç·šä¸Šå­—å…¸"

static void
url_encode(dst, src)        /* URL encoding */
  uschar *dst;       /* Thor.990331: è¦ src çš„ä¸‰å€ç©ºé–“ */
  uschar *src;
{
  for (; *src; src++)
  {
    if (*src == ' ')
      *dst++ = '+';
    else if (is_alnum(*src))
      *dst++ = *src;
    else
    {
      register cc = *src;
      *dst++ = '%';
      *dst++ = radix32[cc >> 4];
      *dst++ = radix32[cc & 0xf];
    }
  }
  *dst = '\0';
}


static int
write_file(type, sockfd, fp, ftmp)
  char type;
  int sockfd;
  FILE *fp;
  char *ftmp;
{
  static char pool[2048];
  int cc, i, j, fsize;
  char *xhead, *fimage;
  int show, start_show;
  int space;                /* åœ¨ html ä¸­ï¼Œé€£çºŒçš„ space åªæœƒç®—ä¸€æ¬¡ */

  char *start_str[] =
  {
    "d", "<div class=pcixin>",
    "d", "<div class=chinese>",
    "t", "<h4>",
    "v", "<h4>",
    NULL
  };

  char *stop_str[] =
  {
    "d", "</h2>",
    "A", "<h4>",
    "A", "</blockquote>",
    NULL
  };

  char *newline_str[] =      /* å–ä»£æ›è¡Œå­—å…ƒçš„ç¬¦è™Ÿ */
  {
    "<br>",
    "</div>",
    "</li>",
    NULL
  };

  char *other_str[] =        /* å…¶ä»–å­—å…ƒç¬¦è™Ÿ */
  {
    "A", "&nbsp;", " ",
    "d", "<li><div class=pexplain>", "\033[m\n  \033[1;33mË™\033[32m",
    "d", "<li>\n<div class=pexplain>", "\033[m\n  \033[1;33mË™\033[32m",
    "d", "<li>", "\033[m\n  \033[1;33mË™\033[32m",
    "d", "<div class=pexplain>", "\033[m\n    ",
    "d", "<div class=pcixin>", "\033[1;31m",
    "d", "<span id=dropdownid>", "\033[m      \033[1;37m",
    "d", "<div class=ptitle>", "\033[1;36m",
    "t", "<div class=ptitle>", "\033[m\n\n\033[1;36m",
    "t", "<div class=pexplain>", "\033[m\n",
    "v", "<div class=ptitle>", "\033[m\n\n\033[1;36m",
    "v", "<div class=pexplain>", "\033[m\n",
    NULL
  };

  FILE *fpw;

  fpw = fopen(ftmp, "w");

  while ((cc = read(sockfd, &pool, sizeof(pool))) > 0)
    fwrite(&pool, cc, 1, fpw);

  fclose(fpw);
  close(sockfd);

  sprintf(pool, "/usr/local/bin/autob5 -i utf8 -o big5 < %s > %s.big5",
    ftmp, ftmp);
  system(pool);
  unlink(ftmp);
  strcat(ftmp, ".big5");

  fimage = f_map(ftmp, &fsize);
  if (fimage == (char *) -1)
  {
    fclose(fp);
    vmsg("ç›®å‰ç„¡æ³•é–‹å•Ÿ Yahoo ç·šä¸Šå­—å…¸æš«å­˜æª”");
    return -1;
  }

  /* parser return message from web server */
  show = 1;
  start_show = 0;
  space = 0;

  for (xhead = fimage; *xhead; xhead++)
  {
    if (!start_show)
    {
      for (i = 0; start_str[i] != NULL; i += 2)
      {
        j = strlen(start_str[i + 1]);
        if ((start_str[i][0] == type || start_str[i][0] == 'A') &&
          str_ncmp(xhead, start_str[i + 1], j) == 0)
        {
          fputs("\033[m\n\n\033[1;31m", fp);
          start_show = 1;
          xhead += j;
          break;
        }
      }
    }
    else if (start_show)
    {
      for (i = 0; stop_str[i] != NULL; i += 2)
      {
        j = strlen(stop_str[i + 1]);
        if ((stop_str[i][0] == type || stop_str[i][0] == 'A') &&
          str_ncmp(xhead, stop_str[i + 1], j) == 0)
        {
          start_show = 0;
          xhead += j;
          break;
        }
      }
    }

    if (!start_show)
      continue;

    for (i = 0; newline_str[i] != NULL; i++)
    {
      j = strlen(newline_str[i]);
      if (str_ncmp(xhead, newline_str[i], j) == 0)
      {
        fputs("\033[m\n", fp);
        xhead += j;
        space = 0;
        break;
      }
    }


    for (i = 0; other_str[i] != NULL; i += 3)
    {
      j = strlen(other_str[i + 1]);
      if ((other_str[i][0] == type || other_str[i][0] == 'A') &&
        str_ncmp(xhead, other_str[i + 1], j) == 0)
      {
        fputs(other_str[i + 2], fp);
        xhead += j;
        space = 0;
        break;
      }
    }

    /* æ¨™ç±¤ç•¥é */

    cc = *xhead;
    switch(cc)
    {
    case '<':
      show = 0;
      continue;
    case '>':
      show = 1;
      continue;
    case '\n':
    case '\r':
      continue;
    case ' ':
      if (space)
        continue;
      space = 1;
    }

    if (show)
      fputc(cc, fp);

    if (cc != ' ')
      space = 0;
  }
  fputc('\n', fp);

  munmap(fimage, fsize);
  unlink(ftmp);

  return 1;
}


static int
http_conn(server, word, type, s)
  char *server;
  char *word;
  char type;
  char *s;
{
  int sockfd;
  FILE *fp;
  char fname[64], ftmp[64], *str;

  if ((sockfd = dns_open(server, HTTP_PORT)) < 0)
  {
    vmsg("ç„¡æ³•èˆ‡ä¼ºæœå™¨å–å¾—é€£çµï¼ŒæŸ¥è©¢å¤±æ•—");
    return 0;
  }
  else
  {
    mouts(22, 0, "æ­£åœ¨é€£æ¥ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œ(æŒ‰ä»»æ„éµé›¢é–‹).............");
    refresh();
  }
  write(sockfd, s, strlen(s));
  shutdown(sockfd, 1);

  sprintf(fname, "tmp/%s.yahoo_dict", cuser.userid);

  fp = fopen(fname, "w");
  sprintf(ftmp, "tmp/%s.yahoo_dict.tmp", cuser.userid);
  str = strchr(s + 4, ' ');

  if (str)
    *str = '\0';

  fprintf(fp, "%-24s\033[1;37;44m  " Dict_Name "  \033[m\n%s\n",
    "", msg_seperator);
  fprintf(fp, "è©²é é€£çµï¼šhttp://%s%s\n\n", server, s + 4);
  fprintf(fp, "%s", word);

  outz("æ“·å–è³‡æ–™ä¸­ï¼Œè«‹ç¨å¾Œ...");
  refresh();

  if (write_file(type, sockfd, fp, ftmp) >= 0)
    fprintf(fp, "\n\n%s\n%-26s\033[1;36;40mYahoo! \033[37mç·šä¸Šå­—å…¸\033[m\n",
      msg_seperator, "");

  fclose(fp);

  more(fname, (char *) -1);
  unlink(fname);
  return 0;
}


static void
yahoo_dict(word, type)
  char *word;
  char type;
{
  char sendform[512];
  char ue_word[90];

  url_encode(ue_word, word);

  if (type == 'd')
    sprintf(sendform, "GET " CGI_yahoo "%s HTTP/1.0\n\n", ue_word);
  else
    sprintf(sendform, "GET " CGI_yahoo "%s" CGI_yahoo2 "%c HTTP/1.0\n\n",
     ue_word, type);

  http_conn(SERVER_yahoo, word, type, sendform);
}


int
main_yahoo()
{
  char word[30];
  char *menu[] = {"DD",
      "D  é‡‹ç¾©",
      "T  åŒç¾©å­—/åç¾©å­—",
      "V  è®ŠåŒ–å½¢", NULL};

  while (1)
  {
    clear();
    move(0, 25);
    outs("\033[1;37;44mâ— " Dict_Name " â—\033[m");
    move(3, 0);
    outs("æ­¤å­—å…¸ä¾†æºç‚º " Dict_Name "ã€‚\n\n");
    outs("ç¶²å€ï¼š" REF);

    if (!vget(8, 0, "æŸ¥è©¢å­—å½™ï¼š", word, 30, DOECHO))
      break;

    yahoo_dict(word, pans(-1, -1, "æŸ¥è©¢é¸é …", menu));
  }

  return 0;
}
#endif  /* HAVE_NETTOOL */


--
[1;36m=[37m[[36mï¹[37m:[33m?[37mæ‘ƒ?[mâ—£?[1;33m?[37m:[36mï¹ [31mOrigin[37m ]|[[m  [0;31m?[1m?[1m?[0;31mO[0;31m?[1m?[1m?[0;31m?[1mcpu.tfcis.org  [37m]|[?[33mæŸèªª[m?[1;36mï¹[37m:][36m=[m
[1;36m=[0m[[1;36mï¹Š[37m:[33m?[30mæ‘ƒ?[mâ•±?[1;33m?[37m:[36mï¹Š [31mAuthor[m ]|[[1m     cszone.twbbs.org     [m]|[?[1;33m?[30m?[37mæ’[30m?[36mï¹Š[37m:[m][1;36m=[m
