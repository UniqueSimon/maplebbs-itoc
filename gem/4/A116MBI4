ç™¼ä¿¡äºº: itoc.bbs@cpu.tfcis.org (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: redirå¯å¦æ”¯æ´pttçš„æ—¥æœŸæ ¼å¼^^"...
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2005/04/24 Sun 11:23:34)                Updated: 2005/05/15

â€» å¼•è¿°ã€Šitoc (æ ¸å¿ƒå‹•åŠ›)ã€‹ä¹‹éŠ˜è¨€ï¼š
> â€» å¼•è¿°ã€Špigco (å“ˆ)ã€‹ä¹‹éŠ˜è¨€ï¼š
> > å¯ä¸å¯ä»¥è®“rediré€™æ”¯ç¨‹å¼æ”¯æ´pttçš„æ™‚é–“æ ¼å¼ XD...
>   3. å¦‚æœä½ èƒ½å–å¾—è©²ç«™çš„å®Œæ•´è³‡æ–™ï¼Œé‚£ä½ å¯ä»¥ç”¨è½‰æ›çš„

  å…ˆå°‡å…¶ä»– BBS ç«™çš„è³‡æ–™æŠ“å›ä¸¦è§£å£“ç¸®
  å‡è¨­å°‡ç›®éŒ„è§£é–‹åœ¨ /tmp/xxxx
  /tmp/xxxx è£¡é¢è¦æœ‰ .DIR åŠ M.*.A çš„æª”æ¡ˆ

  ç„¶å¾ŒåŸ·è¡Œ
  % ~/bin/transbrd /tmp/xxxx ABCD
  å³å¯å°‡ /tmp/xxxx é€™ç›®éŒ„ä¸‹çš„æ–‡ç« è½‰åˆ°ç«™ä¸Šçš„ [ABCD] æ¿ (è¦å…ˆåœ¨ç«™ä¸Šé–‹é€™å€‹æ¿)
  çœ‹æ¿ [ABCD] å¯ä»¥æ˜¯ä¸€å€‹å…¨æ–°çš„çœ‹æ¿
  ä¹Ÿå¯ä»¥æ˜¯ä¸€å€‹å·²æœ‰æ–‡ç« çš„çœ‹æ¿ (é‚£éº¼æœƒå°‡æ–‡ç« ä½µå…¥åˆ°æœ€å¾Œ)

  è½‰æ›ç¨‹å¼å¦‚ä¸‹

: src/util/Makefile

EXE =   ..... [1;33mtransbrd.c[m

: src/util/transbrd.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/transbrd.c                                       */
/*-------------------------------------------------------*/
/* target : Maple Sob 2.36 è‡³ Maple 3.02 çœ‹æ¿è½‰æ›        */
/* create : 05/04/24                                     */
/* update :   /  /                                       */
/*-------------------------------------------------------*/


#include "bbs.h"


/* ----------------------------------------------------- */
/* old DIR of board struct : 128 bytes                   */
/* ----------------------------------------------------- */

struct fileheader
{
  char filename[33];            /* M.9876543210.A */
  char savemode;                /* file save mode */
  char owner[14];               /* uid[.] */
  char date[6];                 /* [02/02] or space(5) */
  char title[73];
  uschar filemode;              /* must be last field @ boards.c */
};
typedef struct fileheader fileheader;


static time_t
trans_hdr_chrono(filename)
  char *filename;
{
  char time_str[11];

  /* M.1087654321.A æˆ– M.987654321.A */
  str_ncpy(time_str, filename + 2, filename[2] == '1' ? 11 : 10);

  return (time_t) atoi(time_str);
}


static void
trans_hdr_stamp(folder, t, hdr, fpath)
  char *folder;
  time_t t;
  HDR *hdr;
  char *fpath;
{
  FILE *fp;
  char *fname, *family;
  int rc;

  fname = fpath;
  while (rc = *folder++)
  {
    *fname++ = rc;
    if (rc == '/')
      family = fname;
  }
  fname = family + 1;
  *fname++ = '/';
  *fname++ = 'A';

  for (;;)
  {
    *family = radix32[t & 31];
    archiv32(t, fname);

    if (fp = fopen(fpath, "r"))
    {
      fclose(fp);
      t++;
    }
    else
    {
      memset(hdr, 0, sizeof(HDR));
      hdr->chrono = t;
      str_stamp(hdr->date, &hdr->chrono);
      strcpy(hdr->xname, --fname);
      break;
    }
  }
}


/* ----------------------------------------------------- */
/* è½‰æ›ä¸»ç¨‹å¼                                            */
/* ----------------------------------------------------- */


int
main(argc, argv)
  int argc;
  char *argv[];
{
  int fd;
  char *brdname, *path;
  char fpath[64], folder[64], buf[64];
  time_t chrono;
  fileheader fh;
  HDR hdr;

  if (argc != 3)
  {
    printf("Usage: %s path brdname\n", argv[0]);
    printf("å°‡ path é€™ç›®éŒ„ä¸‹çš„è³‡æ–™ä½µå…¥çœ‹æ¿ brdname\n");
    return 0;
  }

  chdir(BBSHOME);

  brdname = argv[2];
  brd_fpath(folder, brdname, NULL);
  if (!dashd(folder))
  {
    printf("BBS ä¸Šæ²’æœ‰æ­¤çœ‹æ¿ %s\n", brdname);
    return 0;
  }

  path = argv[1];
  sprintf(fpath, "%s/.DIR", path);
  if (!dashf(fpath))
  {
    printf("%s æ­¤ç›®éŒ„ä¸‹æ²’æœ‰å…¶ä»– BBS ç«™çš„æ–‡ç« \n", path);
    return 0;
  }

  /* è½‰æ›é€²æ¿ç•«é¢ */
  sprintf(fpath, "%s/notes", path);
  if (dashf(fpath))
  {
    brd_fpath(folder, brdname, FN_NOTE);
    f_cp(fpath, folder, O_TRUNC);
  }

  /* è½‰æ›æ–‡ç«  */
  sprintf(fpath, "%s/.DIR", path);
  if ((fd = open(fpath, O_RDONLY)) >= 0)
  {
    brd_fpath(folder, brdname, FN_DIR);

    while (read(fd, &fh, sizeof(fh)) == sizeof(fh))
    {
      /* è½‰æ›æ–‡ç«  .DIR */
      memset(&hdr, 0, sizeof(HDR));
      chrono = trans_hdr_chrono(fh.filename);
      trans_hdr_stamp(folder, chrono, &hdr, buf);
      str_ncpy(hdr.owner, fh.owner, sizeof(hdr.owner));
      str_ansi(hdr.title, fh.title, sizeof(hdr.title));
      hdr.xmode = (fh.filemode & 0x2) ? POST_MARKED : 0;
      rec_add(folder, &hdr, sizeof(HDR));

      /* æ‹·è²æª”æ¡ˆ */
      sprintf(fpath, "%s/%s", path, fh.filename);
      f_cp(fpath, buf, O_TRUNC);
    }
    close(fd);
  }

  return 0;
}

--
 [1;43mâ—¤[46mâ—¥[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [36;47m cpu.tfcis.org [m
 [1;44mâ—£[41mâ—¢[m A[1mut[30mho[mr: [1;33mitoc [30må¾ [31mitoc.Dorm11.NCTU.edu.tw [30mç™¼è¡¨[m
