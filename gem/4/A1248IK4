ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] æ–‡ç« ç½®åº•
æ™‚é–“: 2004/10/25 Mon 20:10:30                           Updated: 2005/12/28

â€» å¼•è¿°ã€Šshakalaca.bbs@php.twbbs.org (ç”¨èº«é«”è­‰æ˜ä½ çš„å‹æƒ…å§)ã€‹ä¹‹éŠ˜è¨€ï¼š
>   æˆ‘çš„æ–¹æ³•æ˜¯ç½®åº•çš„æ™‚å€™æŠŠæ–‡ç«  copy ä¸€ä»½åˆ°æœ€å¾Œé¢ (rec_add)
>   (ç•¶ç„¶è¦ç”¨ hard/soft link æˆ–è€… copy ä¸€ä»½ç•¶ç½®åº•æ–‡ç« éš¨ä½ é«˜èˆˆ)
>   ç„¶å¾Œçœ‹æ¿ç½®åº•æ•¸é‡ +1, å¦å¤–å¯«å€‹ rec_bot çš„å’šå’šï¼Œè®“æ¯æ¬¡æ–°å¢è³‡æ–™
>   (ç™¼è¡¨ï¼Œè½‰éŒ„ï¼Œmail2board) çš„æ™‚å€™éƒ½æœƒæŠŠæ–‡ç« æ’åˆ°é©ç•¶çš„ä½ç½®ã€‚
>   é€™æ¨£å­çš„å¥½è™•æ˜¯ä¸ç”¨åœ¨å¦å¤–é–‹ indexï¼Œè§£é™¤ç½®åº•æ™‚åªè¦æŠŠè©²æ–‡ç« åˆªé™¤å³å¯ã€‚
>   ç¼ºé»æ˜¯è¦æ”¹çš„åœ°æ–¹å¾ˆå¤šï¼Œinnbbsdï¼Œboardmailï¼Œbbs.cã€‚ã€‚ã€‚ :p

  å¦‚æœä¸æ–°é–‹ä¸€å€‹ .BOTTOMï¼Œé‚£éº¼å°±æ˜¯é€™ç¨®ä½œæ³•
  æ¡å–é€™ç¨®ä½œæ³•ï¼Œç¨‹å¼å¥½åƒæ¯”è¼ƒç°¡å–®

  1. è‹¥ mark/delete/rangedel/prune/title.. åŸæ–‡ï¼Œç½®åº•æ–‡ä¸¦ä¸æœƒè®Šå‹•
     åŒç†ï¼Œè‹¥è®Šå‹•ç½®åº•æ–‡ï¼ŒåŸæ–‡ä¹Ÿä¸æœƒè®Šå‹•
     (æ‰€ä»¥è©•åˆ†çš„åˆ†æ•¸ä¸¦ä¸æœƒé€£å‹•)

  2. å”¯ä¸€ä¸æ»¿è¶³ 1. çš„æ˜¯ edit é€™å‹•ä½œ
     ç·¨è¼¯åŸæ–‡/ç½®åº•æ–‡ï¼Œå…§å®¹æœƒé€£å‹• (å› ç‚ºç”¨ HDR_LINK é€£èµ·ä¾†)

  3. è‹¥è¦åˆªé™¤ç½®åº•æ–‡ï¼Œå‰‡ç›´æ¥ d æ‰å³å¯
     (d/D/^D/^N éƒ½å¯ä»¥ï¼Œç”šè‡³å–æ¶ˆ mark è¢« expire éæœŸæ¸…é™¤ä¹Ÿæ˜¯å¯èƒ½)

  4. ç½®åº•æ–‡æ²’æœ‰é–±è®€è¨˜éŒ„

  5. ç½®åº•æ–‡è·Ÿä¸€èˆ¬æ–‡ç« å®Œå…¨ä¸€æ¨£ï¼Œæ‰€ä»¥å¯ä»¥è‡ªç”±
     tag/è½‰å¯„/è½‰éŒ„/æ”¶ç²¾è¯å€/åŠ å¯†/mark...
     (ç¨‹å¼ä¸¦æ²’æœ‰é™åˆ¶æ¿ä¸»ä¸èƒ½åŠ å¯†ç½®åº•æ–‡ï¼Œæ‰€ä»¥å¦‚æœæ¿ä¸»å¾ˆç„¡èŠï¼Œä¹Ÿæ˜¯å¯ä»¥é€™æ¨£åš)
     (ç¨‹å¼ä¹Ÿæ²’æœ‰é™åˆ¶æ¿ä¸»ä¸èƒ½å–æ¶ˆç½®åº•æ–‡çš„ markï¼Œåæ­£ä¹Ÿä¸æœƒæ€éº¼æ¨£)

  6. åŒä¸€ç¯‡æ–‡ç« å¯ä»¥ç½®åº•å€‹å¥½å¹¾æ¬¡éƒ½æ²’é—œä¿‚

: hdr.h

+ #define POST_BOTTOM   0x00002000      /* ç½®åº•æ–‡ç«  */
#define POST_SCORE      0x00004000      /* æ¨™è¨˜è©•åˆ†éçš„ */

: post.c:post_item() æœ‰äºŒè™•è¦æ”¹

+ if (hdr->xmode & POST_BOTTOM)
+ {
+   /* ç”±æ–¼ç½®åº•æ–‡æ²’æœ‰é–±è®€è¨˜éŒ„ï¼Œæ‰€ä»¥å¼„æˆå·²è®€ */
+   char attr = post_attr(hdr);
+   if (attr == '+')
+     attr = ' ';
+   else if (attr >= 'A' && attr <= 'Z')
+     attr |= 0x20;          /* æ›å°å¯« */
+   prints("  é‡è¦%c%c", tag_char(hdr->chrono), attr);
+ }
+ else
    prints("%6d%c%c", num, tag_char(hdr->chrono), post_attr(hdr));

- if (hdr->xmode & POST_SCORE)
+ if (hdr->xmode & POST_SCORE && !(hdr->xmode & POST_BOTTOM))
+                                /* ç½®åº•æ–‡ä¸é¡¯ç¤ºåˆ†æ•¸ */

: post.c:post_history()

+ if (hdr->xmode & POST_BOTTOM)     /* ç½®åº•æ–‡ä¸åŠ å…¥é–±è®€è¨˜éŒ„ */
+   return;

  chrono = hdr->chrono;
  if (!brh_unread(chrono))      /* å¦‚æœå·²åœ¨ brh ä¸­ï¼Œå°±ç„¡éœ€å‹•ä½œ */
    return;

: post.c:post_bottom() æ–°å¢åœ¨ post_mark() ä¸‹é¢

static int
post_bottom(xo)
  XO *xo;
{
  if (bbstate & STAT_BOARD)
  {
    HDR *hdr, post;
    char fpath[64];

    hdr = (HDR *) xo_pool + (xo->pos - xo->top);

    if (hdr->xmode & POST_BOTTOM)       /* å·²ç½®åº•å°±ä¸èƒ½å†ç½®åº• */
      return XO_NONE;                   /* å…¶å¯¦æƒ³å†ç½®åº•ä¸€æ¬¡ä¹Ÿæ²’å·® :p */

    hdr_fpath(fpath, xo->dir, hdr);
    hdr_stamp(xo->dir, HDR_LINK | 'A', &post, fpath);
    post.xmode = POST_MARKED | POST_BOTTOM;  /* è‡ªå‹•åŠ  mark */
    strcpy(post.owner, hdr->owner);
    strcpy(post.nick, hdr->nick);
    strcpy(post.title, hdr->title);

    rec_add(xo->dir, &post, sizeof(HDR));
    btime_update(currbno);

    return post_load(xo);       /* ç«‹åˆ»é¡¯ç¤ºç½®åº•æ–‡ç«  */
  }
  return XO_NONE;
}

: post.c:post_cb[]

+ '_', post_bottom,             [1;44m // æŒ‰éµè‡ªå®š [m

  'h', post_help

: post.c:post_visit()

  ans = vans("è¨­å®šæ‰€æœ‰æ–‡ç«  (U)æœªè®€ (V)å·²è®€ (W)å‰å·²è®€å¾Œæœªè®€ (Q)å–æ¶ˆï¼Ÿ[Q] ");
  if (ans == 'v' || ans == 'u' || ans == 'w')
  {
+   int pos;

    row = xo->top;
    max = xo->max - row + 3;
    if (max > b_lines)
      max = b_lines;

    hdr = (HDR *) xo_pool;
-   brh_visit(ans == 'w' ? hdr[xo->pos - row].chrono : ans == 'u');
+   pos = xo->pos - row;
+   /* weiyu.20041010: åœ¨ç½®åº•æ–‡ä¸Šé¸ w è¦–ç‚ºå…¨éƒ¨å·²è®€ */
+   brh_visit(ans == 'w' ? hdr[pos].xmode & POST_BOTTOM ? 0 :
+                          hdr[pos].chrono : ans == 'u');

    row = 3;

: board.c:btime_refresh()

-       /* itoc.020829: æ‰¾æœ€å¾Œä¸€ç¯‡æœªè¢«åŠ å¯†çš„ HDR */
+       /* itoc.020829: æ‰¾æœ€å¾Œä¸€ç¯‡æœªè¢«åŠ å¯†ã€ä¸æ˜¯ç½®åº•çš„ HDR */
        while ((fsize -= sizeof(HDR)) >= 0)
        {
          lseek(fd, fsize, SEEK_SET);
          read(fd, &hdr, sizeof(HDR));
-         if (!(hdr.xmode & POST_RESTRICT))
+         if (!(hdr.xmode & (POST_RESTRICT | POST_BOTTOM)))
            break;
        }

====================================================================

  æ¥ä¸‹ä¾†å¢åŠ ä¸€å€‹ rec_bot.c

: src/lib/Makefile

SRC =  ... [1;33mrec_bot.c[m

OBJ =  ... [1;33mrec_bot.o[m

: src/lib/dao.p

/* rec_add.c */
int rec_add(char *fpath, void *data, int size);
+ /* rec_bot.c */
+ int rec_bot(char *fpath, void *data, int size);

: src/lib/rec_bot.c æ–°å¢æ­¤ç¨‹å¼

#include "dao.h"
#include <fcntl.h>
#include <unistd.h>
#include <sys/file.h>
#include <sys/stat.h>


static int
is_bottompost(hdr)
  HDR *hdr;
{
  return (hdr->xmode & POST_BOTTOM);
}


int
rec_bot(fpath, data, size)      /* amaki.040715: åµŒå…¥å¼å¯«æª” */
  char *fpath;
  void *data;
  int size;
{
  int fd, fsize, count;
  void *pool, *set;
  char set_pool[REC_SIZ];
  struct stat st;

  if ((fd = open(fpath, O_RDWR | O_CREAT, 0600)) < 0)
    return -1;

  /* flock(fd, LOCK_EX); */
  /* Thor.981205: ç”¨ fcntl å–ä»£flock, POSIXæ¨™æº–ç”¨æ³• */
  f_exlock(fd);

  fstat(fd, &st);

  count = 0;
  set = (void *) set_pool;

  if (fsize = st.st_size)
  {
    while ((fsize -= size) >= 0)
    {
      lseek(fd, fsize, SEEK_SET);
      read(fd, set, size);

      if (!is_bottompost(set))
      {
        if (count)
        {
          pool = (void *) malloc(count * size);

          read(fd, pool, count * size);
          lseek(fd, -size * count, SEEK_CUR);
        }
        break;
      }
      else if (fsize <= 0)      /* amaki.040715: å…¨éƒ¨éƒ½æ˜¯ç½®åº•çš„æ±è¥¿ */
      {
        count++;
        pool = (void *) malloc(count * size);

        lseek(fd, -size, SEEK_CUR);
        read(fd, pool, count * size);
        lseek(fd, -size * count, SEEK_CUR);
        break;
      }
      else
        count++;
    }
  }

  write(fd, data, size);

  if (count)
  {
    write(fd, pool, count * size);
    free(pool);
  }

  /* flock(fd, LOCK_EX); */
  /* Thor.981205: ç”¨ fcntl å–ä»£flock, POSIXæ¨™æº–ç”¨æ³• */
  f_unlock(fd);

  close(fd);

  return 0;
}

====================================================================

  æ¥ä¸‹ä¾†å°‡æ‰€æœ‰æ–°å¢æ–‡ç« çš„éƒ¨åˆ†ï¼Œå¾ rec_add æ”¹ç‚º rec_bot

: bhttpd.c:add_post()
: bmtad.c:visit_fresh()
: bmtad.c:mta_memo()
: bmtad.c:bbs_brd()
: account.c:keeplog()
: brdmail.c:mail2brd()

- rec_add(folder, &hdr, sizeof(HDR));
+ rec_bot(folder, &hdr, sizeof(HDR));

: enews.c:enews_cross()

- rec_add(xfolder, &xpost, sizeof(HDR));
+ rec_bot(xfolder, &xpost, sizeof(HDR));

: vote.c:keeplog()

- rec_add(folder, &hdr, sizeof(HDR));
+ rec_bot(folder, &hdr, sizeof(HDR));

: rec_article.c:bbspost_add()

- rec_add(fpath, &hdr, sizeof(HDR));
+ rec_bot(fpath, &hdr, sizeof(HDR));

: rec_article.c:move_post()

- rec_add(folder, &post, sizeof(HDR));
+ rec_bot(folder, &post, sizeof(HDR));

: song.c:song_order()

- rec_add(fpath, &xpost, sizeof(HDR));
+ rec_bot(fpath, &xpost, sizeof(HDR));

: post.c:move_post()

- rec_add(fnew, &post, sizeof(HDR));
+ rec_bot(fnew, &post, sizeof(HDR));

: post.c:do_unanonymous()

- rec_add(folder, &post, sizeof(HDR));
+ rec_bot(folder, &post, sizeof(HDR));

: post.c:do_post()

- if (!rec_add(folder, &post, sizeof(HDR)))
+ if (!rec_bot(folder, &post, sizeof(HDR)))

  ...

-         if (!rec_add(folder, &post, sizeof(HDR)))
+         if (!rec_bot(folder, &post, sizeof(HDR)))

: post.c:post_cross()

-       rec_add(xfolder, &xpost, sizeof(HDR));
+       rec_bot(xfolder, &xpost, sizeof(HDR));

  ...

-     rec_add(xfolder, &xpost, sizeof(HDR));
+     rec_bot(xfolder, &xpost, sizeof(HDR));

  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ç¬¬ä¸€æ¬¡é€²æ¿å°‡æ¸¸æ¨™æ”¾åœ¨æœªç½®åº•çš„æœ€å¾Œä¸€ç¯‡

: board.c:XoPost()

    xo->key = XZ_POST;
    xo->xyz = brd->title;

+   if (xo->pos == XO_TAIL)   /* ç¬¬ä¸€æ¬¡é€²æ¿å°‡æ¸¸æ¨™æ”¾åœ¨æœªç½®åº•çš„æœ€å¾Œä¸€ç¯‡ */
+     xo->pos = last_nobottom(xo->dir);

: board.c:last_nobottom() æ–°å¢æ­¤å‡½å¼åœ¨ XoPost() å‰é¢

static int
last_nobottom(folder)
  char *folder;
{
  int fd, fsize;
  struct stat st;
  HDR hdr;

  if ((fd = open(folder, O_RDONLY)) >= 0)
  {
    if (!fstat(fd, &st) && (fsize = st.st_size) >= sizeof(HDR))
    {
      while ((fsize -= sizeof(HDR)) >= 0)
      {
        lseek(fd, fsize, SEEK_SET);
        read(fd, &hdr, sizeof(HDR));
        if (!(hdr.xmode & POST_BOTTOM))
          break;
      }
    }
    close(fd);

    return fsize / sizeof(HDR);
  }

  return XO_TALL;
}

====================================================================

  æ¥ä¸‹ä¾†æ–°å¢ä¸€å€‹ help    â”œâ”€ post_bottom  ç½®åº•æ–‡ç« 

  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚æŒ‰  éµâ”‚ å‡½      å¼ â”‚  æ•˜                                        è¿°  â”‚
  â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚_     â”‚post_bottom â”‚ç½®åº•æ–‡ç«                                         â”‚
  â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    å°‡æ¸¸æ¨™ç§»åˆ°æŸæ¬„ï¼ŒæŒ‰ _ å¯ä»¥ç½®åº•è©²ç¯‡æ–‡ç« ï¼Œè¢«ç½®åº•çš„æ–‡ç« æœƒå‡ºç¾ã€Œé‡è¦ã€çš„ç¬¦
  è™Ÿï¼Œè¢«ç½®åº•çš„æ–‡ç« æœƒä¸€ç›´å‡ºç¾åœ¨çœ‹æ¿çš„åº•éƒ¨ï¼Œåªæœ‰æ¿ä¸»å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚

    è¦å–æ¶ˆç½®åº•ï¼Œç›´æ¥å°‡ç½®åº•çš„é‚£ç¯‡æ–‡ç« å–æ¶ˆæ¨™è¨˜ä¸¦åˆªé™¤å³å¯ã€‚

 =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
