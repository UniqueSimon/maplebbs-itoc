ç™¼ä¿¡äºº: SnowWolf.bbs@xeon.tfcis.org (éœå¤œ) çœ‹æ¿: plan
æ¨™  é¡Œ: [æ–‡ä»¶] å¤§å¯Œç¿
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (Fri, 08 Aug 2003 22:24:43 +0800 (CST))  Updated: 2004/01/10

: rich.c

/************************************************/
/*          å¤§å¯Œç¿_v1.00_870619                 */
/*                                              */
/*          Author: dsyan                       */
/*      Create: 87/04/29                        */
/*      Update: xx/xx/xx                        */
/************************************************/

/* æœ¬ç¨‹å¼åƒ…ä¾›å­¸è¡“æ¸¬è©¦åŠç§äººç ”ç©¶ç”¨é€”ï¼Œåš´ç¦ç§»ä½œä»–ç”¨!! */
/* è‹¥æœ‰ä»»ä½•å•é¡Œæ­¡è¿è¨è«–.. u8511088@cc.nctu.edu.tw   */
/* å¦‚æœä½ æŠŠå®ƒæ”¹å¾—å¾ˆæ£’çš„è©±, è¦è¨˜å¾— mail æˆ‘ä¸€ä¸‹å‘¦! :) */


#include "bbs.h"


struct RICH_STRUCT
{
  char lfx, lfy, nowuser, start, maxmax;
  char station[10], wapow[10], posi[10];
  char land[40], name[10][15], sym[10][3];
  char sls[6][3], msg[12][80], map[40][20], readmsg[10][12];
  char chance[15][60], fate[15][60], landst[6][5];
  int mapidx[40], chanceidx[15], fateidx[15], fee[40][9], current;
  long money[10];
};

static char inp[50], inpc, card, prec, delay, msgc, msgcc, editmode;
static char mymsg[6][80];
static struct RICH_STRUCT *ri;


/*-------------------------------------------------------*/
/* è¢å¹•æ§åˆ¶                                              */
/*-------------------------------------------------------*/


static void
clrfromto(x, y)
  int x, y;
{
  int i;

  i = x;
  while (i <= y)
  {
    move(i, 0);
    clrtoeol();
    i++;
  }
}


static int          /* 1: æª”æ¡ˆåœ¨  0: æª”æ¡ˆä¸åœ¨ */
show_file(fpath, ln, lines) /* å¾ç¬¬ ln åˆ—é–‹å§‹å°æª”æ¡ˆ lines è¡Œ */
  char *fpath;
  int ln, lines;
{
  FILE *fp;
  char buf[ANSILINELEN];
  int i;

  if ((fp = fopen(fpath, "r")))
  {
    clrfromto(ln, ln + lines);
    move(ln, 0);
    i = lines;
    while (fgets(buf, ANSILINELEN, fp) && i--)
      outs(buf);
    fclose(fp);
    return 1;
  }
  return 0;
}


static void
showcursor()
{
  char i, j, c[3];

  for (i = 0; i < 40; i++)
  {
    c[0] = 32;
    c[1] = 32;
    c[2] = 0;
    for (j = 0; j < ri->maxmax; j++)
    {
      if (ri->posi[j] == i)
    strcpy(c, ri->sym[j]);
    }
    if (!i)
    {
      move(20, 64);
      outs(c);
    }
    if (i > 0 && i < 10)
    {
      move(19, 67 - i * 6);
      outs(c);
    }
    if (i == 10)
    {
      move(20, 10);
      outs(c);
    }
    if (i > 10 && i < 20)
    {
      move(41 - i * 2, 12);
      outs(c);
    }
    if (i == 20)
    {
      move(2, 10);
      outs(c);
    }
    if (i > 20 && i < 30)
    {
      move(3, i * 6 - 113);
      outs(c);
    }
    if (i == 30)
    {
      move(2, 64);
      outs(c);
    }
    if (i > 30)
    {
      move(2 * i - 59, 62);
      outs(c);
    }
  }
}


static void
showhouse()
{
  int i, x;
  for (x = 0; x < 40; x++)
  {
    i = ri->mapidx[x];
    if (i < 0 || i > ri->maxmax - 1)
      continue;
    if (x > 0 && x < 10)
    {
      move(20, 66 - x * 6);
      prints("%s%s", ri->sym[i], ri->sls[ri->land[x]]);
    }
    if (x > 10 && x < 20)
    {
      move(41 - x * 2, 0);
      outs(ri->sls[ri->land[x]]);
      move(41 - x * 2, 10);
      outs(ri->sym[i]);
    }
    if (x > 20 && x < 30)
    {
      move(2, x * 6 - 114);
      prints("%s%s", ri->sym[i], ri->sls[ri->land[x]]);
    }
    if (x > 30)
    {
      move(2 * x - 59, 74);
      outs(ri->sls[ri->land[x]]);
      move(2 * x - 59, 64);
      outs(ri->sym[i]);
    }
  }
}


static void
my_turn()
{
  if (prec == ri->current && editmode)
  {
    move(7 + ri->lfx, 13 + ri->lfy);
    prints("%s[%s]è«‹æŒ‰ç©ºç™½éµæ“²éª°å­..", ri->sym[prec], ri->name[prec]);
    move(18, 16 + inpc);
  }
}


static void
showmsg()
{
  char i, j, buf[80];

  for (i = 0; i < 12; i++)
  {
    if (!ri->readmsg[prec][i])
      continue;
    strcpy(mymsg[msgc], ri->msg[i]);
    msgc = (msgc + 1) % 6;
    ri->readmsg[prec][i] = 0;
  }
  if (msgc != msgcc)
  {
    showcursor();
    showhouse();
    refresh();
    strcpy(buf, "                                                   ");
    for (i = 0; i < 6; i++)
    {
      move(12 + i, 14);
      j = 48 - strlen(mymsg[(msgc + i) % 6]);
      buf[j] = 0;
      prints("%s%s", mymsg[(msgc + i) % 6], buf);
      buf[j] = 32;
    }
    msgcc = msgc;
  }
  alarm(1);
  my_turn();
  refresh();
}


static void
sendmsg2(mytxt)
  char *mytxt;
{
  FILE *fp;
  char i, j, k;

  fp = fopen("etc/rich", "a+");
  fprintf(fp, "%s\n", mytxt);
  fclose(fp);

  for (i = 0; i < ri->maxmax; i++)
  {
    k = -1;
    while (k)
    {
      for (j = 0; j < 12; j++)
      {
    if (ri->readmsg[i][j])
      continue;
    ri->readmsg[i][j] = 1;
    strcpy(ri->msg[j], mytxt);
    k = 0;
    break;
      }
    }
  }
}


static void
goprison()
{
  char richbuf[100];

  move(9 + ri->lfx, 13 + ri->lfy);
  outs("å“ˆå“ˆå“ˆ! ä½ è¢«é—œäº†!!!");
  sprintf(richbuf, "%s%såç‰¢äº†...", ri->sym[prec], ri->name[prec]);
  sendmsg2(richbuf);
  if (card)
  {
    vmsg(NULL);
    move(9 + ri->lfx, 13 + ri->lfy);
    outs("ä»€éº¼?!æœ‰å…ç„å¡..é‚£ç®—äº†...");
    sendmsg2("ä»€éº¼?!æœ‰å…ç„å¡..é‚£ç®—äº†...");
    card--;
  }
  else
  {
    ri->posi[prec] = 10;
    delay = 3;
  }
}


static void
de(mo)
  long mo;
{
  ri->money[prec] -= mo;
}


static void
reload()
{
  clear();
  show_file("etc/game/display", 0, 24);
  showcursor();
  showhouse();
}


static void
editmsg()
{
  char i, mybuf[100];

  refresh();
  move(11, 18);
  outs("â†“è¨Šæ¯");

  while (-1)
  {
    i = vkey();
    switch (i)
    {
    case Ctrl('Q'):
      if (!prec)
      {
    sendmsg2("æ¡Œé•·å·²è½è·‘äº†..è«‹æŒ‰tabéµè·Ÿè‘—è½è·‘å§!!");
    ri->current = 1000;
    ri->start = 0;
    ri->maxmax = 0;
    return;
      }
      break;

    case Ctrl('L'):
      reload();
      break;

    case KEY_TAB:
      refresh();
      move(11, 18);
      outs("â†‘å‘½ä»¤");
      return;
      break;

    case KEY_BKSP:
      move(18, 16 + inpc);
      outs(" ");
      inpc--;
      if (inpc < 0)
    inpc = 0;
      move(18, 16 + inpc);
      break;

    case KEY_ENTER:
      if (inpc)
      {
    inp[inpc] = 0;
    if (!strcmp(inp, "/help"))
    {
      sendmsg2("æ¡Œé•·æ‰“ /bye å¯è·³å‡ºéŠæˆ²..");
      sendmsg2("æŒ‰ Tab éµå¯åˆ‡æ›è¨Šæ¯åŠå‘½ä»¤æ¨¡å¼..");
      sendmsg2("è¦è·³å‡ºå¿…é ˆæ•´çµ„è·³..");
    }
    else if (!prec && !strcmp(inp, "/bye"))
    {
      sendmsg2("æ¡Œé•·å·²è½è·‘äº†..");
      sendmsg2("è«‹æŒ‰tabéµè·Ÿè‘—è½è·‘å§!!");
      ri->current = 1000;
      ri->start = 0;
      ri->maxmax = 0;
      return;
    }
    else
    {
      sprintf(mybuf, "%s%s> %s", ri->sym[prec], ri->name[prec], inp);
      sendmsg2(mybuf);
    }
      }
      inpc = 0;
      move(18, 16);
      outs("                                        ");
      move(18, 16);
      break;

    default:
      inp[inpc] = i;
      move(18, 16 + inpc);
      outc(i);
      inpc++;
      move(18, 16 + inpc);
      if (inpc > 34)
    inpc = 34;
      break;
    }
  }
}


static void
log_rich(log)
  char *log;
{
  FILE *fp;

  if (fp = fopen("etc/game/rich.log", "a+"))
  {
    fprintf(fp, "%s %s\n", Now(), log);
    fclose(fp);
  }
}


int
main_rich()
{
  time_t now, startime;
  char richbuf[200], card;
  int i, j, k = -1, dice;
  delay = card = msgc = 0;
  FILE *fp;

  more("etc/game/rich.welcome", NULL);  /* æ­¡è¿ç•«é¢ */

  vs_bar("ç¶²è·¯å¤§å¯Œç¿");
  ri = shm_new(6665, sizeof(*ri));

  srandom(time(NULL) + cuser.userno);

  if (!ri->nowuser)
  {
    ri->nowuser = 22;
    vget(1, 0, "å¹¾å€‹äººè¦ç©?? (2~10)", richbuf, 3, LCECHO);
    i = atoi(richbuf);
    ri->nowuser = 0;
    if (i < 2 || i > 10)
      return;
    ri->maxmax = i;
  }

  move(19, 0);
  if (ri->start)
  {
    prints("å·²ç¶“æœ‰ä¸€çµ„å…± %d å€‹äººåœ¨ç©äº†!..\nè«‹ç­‰ä¸€ä¸‹å†é€²ä¾†..", ri->maxmax);
    vmsg(NULL);
    return 0;
  }

  if (!ri->maxmax && ri->nowuser)
  {
    outs("ä¸Šä¸€æ¡Œæ­£åœ¨çµæŸä¸­!..\nè«‹ç­‰ä¸€ä¸‹å†é€²ä¾†..");
    vmsg(NULL);
    return 0;
  }

  if (ri->nowuser == 22)
  {
    outs("è¨­å®šç©å®¶äººæ•¸ä¸­..è«‹ç¨å¾Œå†è©¦...");
    vmsg(NULL);
    return 0;
  }

  if (!ri->nowuser)
  {
    strcpy(ri->landst[0], "ç©ºåœ°");
    strcpy(ri->landst[1], "å¹³æˆ¿");
    strcpy(ri->landst[2], "äºŒæ¨“");
    strcpy(ri->landst[3], "ä¸‰æ¨“");
    strcpy(ri->landst[4], "å››æ¨“");
    strcpy(ri->landst[5], "æ—…é¤¨");

    strcpy(ri->sym[0], "ï¼‘");
    strcpy(ri->sym[1], "ï¼’");
    strcpy(ri->sym[2], "ï¼“");
    strcpy(ri->sym[3], "ï¼”");
    strcpy(ri->sym[4], "ï¼•");
    strcpy(ri->sym[5], "ï¼–");
    strcpy(ri->sym[6], "ï¼—");
    strcpy(ri->sym[7], "ï¼˜");
    strcpy(ri->sym[8], "ï¼™");
    strcpy(ri->sym[9], "ï¼");

    strcpy(ri->sls[0], "â—‹");
    strcpy(ri->sls[1], "â… ");
    strcpy(ri->sls[2], "â…¡");
    strcpy(ri->sls[3], "â…¢");
    strcpy(ri->sls[4], "â…£");
    strcpy(ri->sls[5], "â˜…");

    ri->lfx = ri->lfy = 1;
  }

  k = -1;
  for (prec = 0; prec < ri->maxmax; prec++)
  {
    move(prec + 3, 10);
    prints("%s [%s]         ", ri->sym[prec], ri->name[prec]);
    if (!ri->name[prec][0] && k < 0)
      k = prec;
  }
  prec = k;
  ri->name[prec][0] = 1;
  ri->nowuser++;

  move(19, 0);
  outs("è«‹è¼¸å…¥ä½ çš„å¤§å..");
  vget(prec + 3, 12, " ", richbuf, 11, LCECHO);
  if (!richbuf[0])
  {
    ri->name[prec][0] = 0;
    ri->nowuser--;
    return;
  }
  strcpy(ri->name[prec], richbuf);

  if (!prec)
  {
    for (i = 0; i < 40; i++)
      ri->land[i] = 0;

    /* åœ°åœ–æª” */
    fp = fopen("etc/game/map", "r");
    for (i = 0; i < 40; i++)
      fscanf(fp, "%s %d", ri->map[i], &ri->mapidx[i]);
    fclose(fp);

    /* å‘½é‹ */
    fp = fopen("etc/game/fate", "r");
    for (i = 0; i < 15; i++)
      fscanf(fp, "%s %d", ri->fate[i], &ri->fateidx[i]);
    fclose(fp);

    /* æ©Ÿæœƒ */
    fp = fopen("etc/game/chance", "r");
    for (i = 0; i < 15; i++)
      fscanf(fp, "%s %d", ri->chance[i], &ri->chanceidx[i]);
    fclose(fp);

    /* è²»ç”¨ */
    fp = fopen("etc/game/fee", "r");
    for (i = 0; i < 40; i++)
    {
      fscanf(fp, "%d %d %d %d %d %d %d %d %d\n", &ri->fee[i][0], &ri->fee[i][1],
    &ri->fee[i][2], &ri->fee[i][3], &ri->fee[i][4], &ri->fee[i][5], &ri->fee[i][6],
    &ri->fee[i][7], &ri->fee[i][8]);
    }
    fclose(fp);

    ri->current = 0;        /* æ¸…é †åº */
    for (i = 0; i < 6; i++)
      ri->msg[i][0] = 0;
  }

  ri->money[prec] = 20000;  /* å­˜éŒ¢ */
  ri->station[prec] = 0;    /* å­˜è»Šç«™ */
  ri->wapow[prec] = 0;      /* æŸ¥é›»åŠ›æ°´åŠ› */
  ri->posi[prec] = 0;       /* å­˜ä½ç½® */
  for (i = 0; i < 6; i++)
    mymsg[i][0] = 0;
  for (i = 0; i < 12; i++)
    ri->readmsg[prec][i] = 0;

  if (!prec)
  {
    sprintf(richbuf, "\033[32;1m%s\033[m é–‹äº†å¯å®¹ç´ %d äººçš„\033[31;1må¤§å¯Œç¿éŠæˆ²\033[m!..", cuser.userid, ri->maxmax);
    log_rich(richbuf);
    fp = fopen("etc/rich", "a+");
    fprintf(fp, "%s %s (%s)\n", str_author1, "æ¥“åŸç«™", "é«˜é›„æ‡‰ç”¨ç§‘æŠ€å¤§å­¸");
    fprintf(fp, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n\n\n", "å¤§å¯Œç¿éŠæˆ²è¨˜éŒ„", Btime(&now));
    fclose(fp);
  }
  sprintf(richbuf, "\033[32;1m%s\033[m åŠ å…¥äº†! ä»£è™Ÿæ˜¯ \033[33;1m%s\033[m ..", cuser.userid, ri->name[prec]);
  log_rich(richbuf);

  move(19, 0);
  outs("ç­‰å¾…å…¶ä»–çš„ä½¿ç”¨è€…åŠ å…¥...   ");
  strcpy(richbuf, "|/-\\");

  while (-1)            /* æŸ¥äººæ•¸ */
  {
    k = -1;
    for (i = 0; i < ri->maxmax; i++)
    {
      move(i + 3, 10);
      j = ri->name[i][0];
      if (j)
    prints("%s [%s]         ", ri->sym[i], (j == 1) ? "ç™»éŒ„ä¸­" : ri->name[i]);
      else
    prints("%s [ç©ºç™½]         ", ri->sym[i]);

      if (!ri->name[i][0] || ri->name[i][0] == 1)
    k = i;
    }
    if (k < 0)
      break;
    move(19, 24);
    prints("%c", richbuf[now % 4]);
    refresh();
    now = time(0);
    while (time(0) - now < 1);
  };

  ri->start = 1;
  show_file("etc/game/display", 0, 24);
  move(11, 34);
  prints("%s%s", ri->sym[prec], ri->name[prec]);

  /* é€²å…¥è¨Šæ¯ */
  sprintf(richbuf, "%s%s (%s) é€²ä¾†äº†", ri->sym[prec], ri->name[prec], cuser.userid);
  sendmsg2(richbuf);

  if (!prec)
  {
    sendmsg2("ç°¡æ˜“èªªæ˜ï¼š");
    sprintf(richbuf, "çµæŸæ³•..%s åœ¨è¨Šæ¯æ¬„æŒ‰ Ctrl-Q", ri->name[prec]);
    sendmsg2(richbuf);
    sendmsg2("Tab åˆ‡æ›è¦–çª—ï¼Œç©ºç™½éµæ“²éª°å­");
    sendmsg2("åœ¨è¨Šæ¯æ¬„æ‰“ /help æœƒæœ‰æ±‚åŠ©ç•«é¢å‡ºç¾...");
    sendmsg2("Have fun!.. :)");
  }
  signal(SIGALRM, showmsg);
  alarm(1);

  editmode = 1;
  my_turn();
  startime = time(0);

  /* é–‹å§‹ç¹åœˆåœˆäº† */
  while (-1)
  {
    i = ri->posi[prec];
    j = ri->mapidx[i];
    move(3 + ri->lfx, 13 + ri->lfy);
    prints("ç¾åœ¨ä½ç½®: [%d] %s (%s)       ",
      i, ri->map[i], ri->landst[ri->land[i]]);
    move(4 + ri->lfx, 13 + ri->lfy);
    if (j < 0 || j > ri->maxmax)
      outs("ç›®å‰å±¬æ–¼: â˜…" BBSNAME "â˜†");
    else
      prints("ç›®å‰å±¬æ–¼: %s[%s]      ", ri->sym[j], ri->name[j]);
    move(5 + ri->lfx, 13 + ri->lfy);
    prints("å¤§å¯Œç¿å¹£: %d  å…ç„å¡: %d     ", ri->money[prec], card);
    while (ri->current != prec)
    {
      editmode = 1;
      editmsg();
      editmode = 0;
      if (ri->current == prec)
    break;
      if (ri->current == 1000)
    goto gameover;
    }

    sprintf(richbuf, " ");
    sendmsg2(richbuf);
    sprintf(richbuf, "è¼ªåˆ°%s%säº†..", ri->sym[prec], ri->name[prec]);
    sendmsg2(richbuf);

    if (delay)
    {
      move(7 + ri->lfx, 13 + ri->lfy);
      outs("å—šå—šå—š..åç‰¢ä¸­...          ");
      move(8 + ri->lfx, 13 + ri->lfy);
      prints("é‚„è¦ %d æ¬¡æ‰è¼ªåˆ°ä½ å–”!!", delay);
      sprintf(richbuf, "%s%s..å—šå—šå—š..é‚„è¦%dæ¬¡æ‰å‡ºç„..:~",
    ri->sym[prec], ri->name[prec], delay);
      sendmsg2(richbuf);
      delay--;
      goto prison;
    }
    my_turn();
    while ((i = igetch()) != 32)
      if (ri->current == 1000)
    goto gameover;
    dice = random() % 11 + 2;

    move(7 + ri->lfx, 13 + ri->lfy);
    prints("æ“²å‡ºé»æ•¸.. %d é»                 ", dice);

    sprintf(richbuf, "%s%s..æ“²å‡º%dé»..", ri->sym[prec], ri->name[prec], dice);
    sendmsg2(richbuf);

    ri->posi[prec] += dice;
    move(8 + ri->lfx, 13 + ri->lfy);

    if (ri->posi[prec] > 39)    /* ç¹äº†ä¸€åœˆ?? */
    {
      outs("ç¶“é\"ç”±æ­¤å»\"..å¾—çé‡‘ 2000 å…ƒ!!");
      sprintf(richbuf, "%s%sç¶“é\"ç”±æ­¤å»\"..å¾—2000", ri->sym[prec], ri->name[prec]);
      sendmsg2(richbuf);
      de(-2000);
      ri->posi[prec] -= 40;
      vmsg(NULL);
      move(8 + ri->lfx, 13 + ri->lfy);
      outs("                                                ");
      move(8 + ri->lfx, 13 + ri->lfy);
    }
    prints("[%d]%s", ri->posi[i], ri->map[ri->posi[prec]]);
    sprintf(richbuf, "%s%sèµ°åˆ°[%d]%s", ri->sym[prec],
      ri->name[prec], ri->posi[prec], ri->map[ri->posi[prec]]);
    sendmsg2(richbuf);
    move(9 + ri->lfx, 13 + ri->lfy);

checkplace:
    if (ri->mapidx[ri->posi[prec]] < 0) /* ç‰¹æ®Šåœ°é»?? */
    {
      switch (ri->mapidx[ri->posi[prec]])
      {
      case -2:          /* å…è²»åœè»Šå ´ */
    outs("å…è²»çš„å‘¦..ä¼‘æ¯ä¸€ä¸‹å§... :)");
    break;

      case -3:          /* å‘½é‹ */
    dice = random() % 15;
    prints("[å‘½é‹]%s", ri->fate[dice]);
    sprintf(richbuf, "%s%s..[å‘½é‹]%s", ri->sym[prec],
      ri->name[prec], ri->fate[dice]);
    sendmsg2(richbuf);
    if (dice > 4)       /* å–®ç´”è·ŸéŒ¢æœ‰é—œ?? */
      de(-ri->fateidx[dice]);
    else
    {
      switch (dice)
      {
      case 0:       /* æ‹˜ç¥¨ */
        goprison();
        break;

      case 1:       /* ä¿®ç†è‡ªå·±æ‰€æœ‰æˆ¿å±‹-2 */
        vmsg(NULL);
        move(9 + ri->lfx, 13 + ri->lfy);
        j = k = 0;
        for (i = 0; i < 40; i++)
        {
          if (ri->mapidx[i] == prec)
          {
        if (ri->land[i] > 0 && ri->land[i] < 5)
          j++;
        else if (ri->land[i] == 5)
          k++;
          }
        }
        prints("æˆ¿å±‹ %d å¹¢..æ—…é¤¨ %d å¹¢..åˆè¨ˆ %d      ", j, k, j * 250 + k * 1000);
        sprintf(richbuf, "%s%s..æˆ¿å±‹%d..æ—…é¤¨%d..åˆè¨ˆ%d",
          ri->sym[prec], ri->name[prec], j, k, j * 250 + k * 1000);
        sendmsg2(richbuf);
        de(j * 250 + k * 1000);
        break;

      case 2:       /* ä½ çš„ç”Ÿæ—¥ */
        de(-(ri->maxmax - 1) * 100);
        for (k = 0; k < ri->maxmax; k++)
          if (k != prec)
        ri->money[k] -= 100;
        break;

      case 3:       /* å‡ºç„è¨±å¯è­‰ */
        card++;
        break;

      case 4:       /* è³£é»ƒç‰›ç¥¨ */
        vmsg(NULL);
        move(9 + ri->lfx, 13 + ri->lfy);
        outs("å–æ©Ÿæœƒä¸€å¼µ?? (Y/n) ");
        j = igetch();
        if (j == 'Y' || j == 'y')
        {
          move(10, 47);
          outs("Yes");
          i = -22222;
          ri->mapidx[ri->posi[prec]] = -5;
          goto checkplace;
        }
        /* å…ˆæŠŠindexæ”¹æˆæ©Ÿæœƒï¼Œç”¨i=-22222åšè¨˜è™Ÿï¼Œåˆ°æ™‚å†æ”¹å›ä¾† */
        {
          move(10, 47);
          outs("No");
          de(1000);
          break;
        }
      }
    }           /* å–®ç´”è·ŸéŒ¢æœ‰é—œ?? */
    break;

      case -4:          /* æ‰€å¾—ç¨… */
    de(2000);
    break;

      case -5:          /* æ©Ÿæœƒ */
    if (i == -22222)
      ri->mapidx[ri->posi[prec]] = -3;
    dice = random() % 15;
    move(9 + ri->lfx, 13 + ri->lfy);
    prints("[æ©Ÿæœƒ]%s ", ri->chance[dice]);
    sprintf(richbuf, "%s%s..[æ©Ÿæœƒ]%s", ri->sym[prec],
      ri->name[prec], ri->chance[dice]);
    sendmsg2(richbuf);
    if (dice > 6)       /* å–®ç´”è·ŸéŒ¢æœ‰é—œ?? */
      de(-ri->chanceidx[dice]);
    else
    {
      switch (dice)
      {
      case 0:       /* æ‹˜ç¥¨ */
        goprison();
        break;

      case 1:       /* ä¿®ç†è‡ªå·±æ‰€æœ‰æˆ¿å±‹ */
        vmsg(NULL);
        move(9 + ri->lfx, 13 + ri->lfy);
        k = j = 0;
        for (i = 0; i < 40; i++)
          if (ri->mapidx[i] == prec)
          {
        if (ri->land[i] > 0 && ri->land[i] < 5)
          i++;
        else if (ri->land[i] == 5)
          k++;
          }
        prints("æˆ¿å±‹ %d å¹¢..æ—…é¤¨ %d å¹¢..åˆè¨ˆ %d      ", j, k, j * 250 + k * 1000);
        sprintf(richbuf, "%s%s..æˆ¿å±‹%d..æ—…é¤¨%d..åˆè¨ˆ%d",
          ri->sym[prec], ri->name[prec], j, k, j * 250 + k * 1000);
        sendmsg2(richbuf);
        de(j * 250 + k * 1000);
        break;

      case 2:       /* ä»˜æˆ¶ç¨… */
        vmsg(NULL);
        move(9 + ri->lfx, 13 + ri->lfy);
        k = j = 0;
        for (i = 0; i < 40; i++)
          if (ri->mapidx[i] == prec)
          {
        if (ri->land[i] > 0 && ri->land[i] < 5)
          j++;
        else if (ri->land[i] == 5)
          k++;
          }
        prints("æˆ¿å±‹ %d å¹¢..æ—…é¤¨ %d å¹¢..åˆè¨ˆ %d      ", j, k, j * 400 + k * 1150);
        sprintf(richbuf, "%s%s..æˆ¿å±‹%d..æ—…é¤¨%d..åˆè¨ˆ%d",
          ri->sym[prec], ri->name[prec], j, k, j * 400 + k * 1150);
        sendmsg2(richbuf);
        de(j * 400 + k * 1150);
        break;

      case 3:       /* å‡ºç„è¨±å¯è­‰ */
        card++;
        break;

      case 4:       /* å‰é€²åˆ°åšæ„›è·¯ */
        if (ri->posi[prec] > 14)
          de(-2000);
        ri->posi[prec] = 14;
        break;

      case 5:       /* å‰é€²åˆ°æ°‘æ—è·¯ */
        if (ri->posi[prec] > 26)
          de(-2000);
        ri->posi[prec] = 26;
        break;

      case 6:       /* è‡ºä¸­è»Šç«™ */
        if (ri->posi[prec] > 15)
          de(-2000);
        ri->posi[prec] = 15;
        break;
      }
    }
    break;

      case -6:          /* åç‰¢/è·¯é */
    outs("å‘¼..ä¸å¯ä»¥åšå£äº‹å‘¦... :)");
    break;

      case -7:          /* é€²ç‰¢ */
    goprison();
    break;

      case -8:          /* è²¡ç”¢ç¨… */
    de(1000);
    break;

      case -9:          /* å„å¤§è»Šç«™ */
    if (ri->money[prec] >= 2000)
    {
      prints("%8såƒ¹å€¼ 2000 å…ƒï¼Œè²·?? (Y/n)", ri->map[ri->posi[prec]]);
      j = igetch();
      if (j != 'N' && j != 'n') /* è²· */
      {
        move(10, 47);
        outs("Yes");
        sprintf(richbuf, "%s%s..è²·ä¸‹%8s", ri->sym[prec],
          ri->name[prec], ri->map[ri->posi[prec]]);
        sendmsg2(richbuf);
        de(2000);
        ri->mapidx[ri->posi[prec]] = prec;
        ri->station[prec]++;
      }
      else              /* ä¸è²· */
      {
        move(10, 47);
        outs("No");
      }
    }
    else                /* è²·ä¸èµ· */
    {
      outs("å¾ˆæŠ±æ­‰ï¼Œä½ çš„ç¾é‡‘ä¸å¤ ...");
    }
    break;

      case -10:
    if (ri->money[prec] >= 1500)
    {
      prints("%8såƒ¹å€¼ 1500 å…ƒï¼Œè²·?? (Y/n)", ri->map[ri->posi[prec]]);
      j = igetch();
      if (j != 'N' && j != 'n') /* è²· */
      {
        move(10, 47);
        outs("Yes");
        sprintf(richbuf, "%s%s..è²·ä¸‹%8s", ri->sym[prec],
          ri->name[prec], ri->map[ri->posi[prec]]);
        sendmsg2(richbuf);
        de(1500);
        ri->mapidx[ri->posi[prec]] = prec;
        ri->wapow[prec]++;
      }
      else              /* ä¸è²· */
      {
        move(10, 47);
        outs("No");
      }
    }
    else                /* è²·ä¸èµ· */
    {
      outs("å¾ˆæŠ±æ­‰ï¼Œä½ çš„ç¾é‡‘ä¸å¤ ...");
    }
    break;
      }
    }

    /* éç‰¹æ®Šåœ°é» */
    else
    {
      i = ri->posi[prec];
      if (ri->mapidx[ri->posi[prec]] < 100) /* å·²è¢«è²·èµ°?? */
      {
    if (ri->mapidx[ri->posi[prec]] == prec) /* è‡ªå·±çš„åœ° */
    {
      if (i == 5 || i == 12 || i == 15 || i == 25 || i == 28 || i == 35)    /* è»Šç«™ã€æ°´å» ã€é›»å»  ..
                                         * ä¸èƒ½è“‹æˆ¿å­çš„åœ° */
        outs("ä½ è‡ªå·±çš„åœŸåœ°..ä¼‘æ¯ä¸€ä¸‹å§... :)");
      else if (ri->land[i] == 5)    /* æ—…é¤¨ */
        outs("å·²ç¶“æ˜¯[æ—…é¤¨]äº†!!");
      else if (ri->fee[i][6] <= ri->money[prec])
      {
        prints("è“‹\[%s]è¦ %d å…ƒ..è¦?? (Y/n)",
          ri->landst[ri->land[i] + 1], ri->fee[i][6]);
        j = igetch();
        if (j != 'n' && j != 'N')
        {
          move(10, 47);
          outs("Yes");
          ri->land[i]++;
          sprintf(richbuf, "%s%s..è“‹\%s", ri->sym[prec], ri->name[prec],
        ri->landst[ri->land[i]]);
          sendmsg2(richbuf);
          de(ri->fee[i][6]);
        }
        else
        {
          move(10, 47);
          outs("No");
        }
      }
      else
        outs("ä½ æ²’æœ‰è¶³å¤ çš„éŒ¢å–”!!");
    }
    else                /* åˆ¥äººçš„åœ° */
    {
      if (i == 5 || i == 15 || i == 25 || i == 35)
        k = ri->station[prec] * 500;    /* è»Šç«™ */
      else if (i == 12 || i == 28)
        k = dice * ((ri->wapow[prec] == 1) ? 10 : 100); /* è‡ªæ°´ã€é›»åŠ› */
      else
        k = ri->fee[i][ri->land[i]];
      prints("é€™æ˜¯%s[%s]çš„[%s]..éè·¯è²» %d", ri->sym[ri->mapidx[i]],
        ri->name[ri->mapidx[i]], ri->landst[ri->mapidx[i]], k);
      sprintf(richbuf, "%s%sèµ°åˆ°%s[%s]çš„åœ°..éè·¯è²»%d", ri->sym[prec],
        ri->name[prec], ri->sym[ri->mapidx[i]], ri->name[ri->mapidx[i]], k);
      sendmsg2(richbuf);
      de(k);
      ri->money[ri->mapidx[i]] += k;
    }
      }
      else      /* æœªè¢«è²·èµ° */
      {
    if (ri->mapidx[i] <= ri->money[prec])   /* è²·å¾—?*/
    {
      prints("é€™å¡Šç©ºåœ°åƒ¹å€¼ %d å…ƒï¼Œè²·?? (Y/n)", ri->mapidx[i]);
      j = igetch();
      if (j != 'N' && j != 'n') /* è²· */
      {
        move(10, 47);
        outs("Yes");
        sprintf(richbuf, "%s%s..è²·ä¸‹%s", ri->sym[prec], ri->name[prec], ri->map[i]);
        sendmsg2(richbuf);
        de(ri->mapidx[i]);
        ri->mapidx[i] = prec;
      }
      else              /* ä¸è²· */
      {
        move(10, 47);
        outs("No");
      }
    }
    else                /* è²·ä¸èµ· */
    {
      outs("å¾ˆæŠ±æ­‰ï¼Œä½ çš„ç¾é‡‘ä¸å¤ ...");
    }
      }
    }
prison:
    if (ri->current == 1000)
      goto gameover;
    ri->current = (prec + 1) % ri->maxmax;
    vmsg(NULL);
    for (i = 3; i < 10; i++)
    {
      move(i + ri->lfx, 13 + ri->lfy);
      outs("                                                ");
    }
  }
gameover:
  if (ri->current == 1000)
  {
    alarm(0);
    sprintf(richbuf, "\033[32;1m%s\033[m è½è·‘äº†! ..", cuser.userid, ri->name[prec]);
    log_rich(richbuf);

    clear();
    more("etc/rich", NULL);
    if (vans("ç§»è‡³å‚™å¿˜éŒ„(Y/N)ï¼Ÿ[N] ") == 'y')
    {
      mail_self("etc/rich", cuser.userid, "[å‚™ å¿˜ éŒ„] å¤§å¯Œç¿éŠæˆ²è¨˜éŒ„", MAIL_READ);
    }
    if (ri->nowuser == 1)   /* æœ€å¾Œä¸€å€‹è·‘æ‰çš„äºº */
    {
      sprintf(richbuf, "\033[35;1må¤§å¯Œç¿éŠæˆ²é †åˆ©çµæŸ\033[m!..");
      log_rich(richbuf);
      system("rm etc/rich");
    }
    ri->name[prec][0] = 0;
    ri->nowuser--;
    return 1;
  }
}


--
[1;36m=[37m[[36mï¹[37m:[33m?[37mæ‘ƒ?[mâ—£?[1;33m?[37m:[36mï¹ [31mOrigin[37m ]|[[m     [31m?[1må¨[0;31mO?[1mç—[0;31m?[1mprocessor.tfcis.org    [37m]|[?[33mæŸèªª[m?[1;36mï¹[37m:][36m=[m
[1;36m=[m[[1;36mï¹Š[37m:[33m?[30mæ‘ƒ?[mâ•±?[1;33m?[37m:[36mï¹Š [31mAuthor[m ]|[ [1m    218-172-173-190.hinet-ip.hinet  [m]|[?[1;33m?[30m?[37mæ’[30m?[36mï¹Š[37m:[m][1;36m=[m
