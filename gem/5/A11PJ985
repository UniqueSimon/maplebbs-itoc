ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] bbsnet.c BBS-Net
æ™‚é–“: 2005/12/09 Fri 23:33:03                          Updated: 2005/12/09

: menu.c åœ¨é©ç•¶çš„é¸å–®åŠ ä¸Š

+ "bin/bbsnet.so:x_bbsnet", PERM_VALID, - M_XMODE,
+ "BBSnet     â™‚ é›²éŠå››æµ· â™€",

: game/Makefile

SO =    ... [1;33mbbsnet.so[m

: game/bbsnet.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* bbsnet.c     ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : BBSnet                                       */
/* create : 01/12/13                                     */
/* update :   /  /                                       */
/* author : hightman.bbs@bbs.dot66.net                   */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


/* ----------------------------------------------------- */
/* BBSNET                                                */
/* ----------------------------------------------------- */

static uschar netbuf[2048];
static struct timeval tv;
static fd_set readfds;
static int cfd;


static void
break_check()
{
  int i, num;

  tv.tv_sec = 0;
  tv.tv_usec = 0;

  FD_ZERO(&readfds);
  FD_SET(0, &readfds);
  select(1, &readfds, NULL, NULL, &tv);

  if (FD_ISSET(0, &readfds))
  {
    num = read(0, netbuf, 80);
    for (i = 0; i < num; i++)
    {
      if (netbuf[i] == 3 || netbuf[i] == 4)
        close(cfd);
    }
  }
  alarm(1);
}


static void
telnetopt(fd, max)
  int fd;
  int max;
{
  int i;
  uschar c2, c3;
  uschar tmp[30];

  for (i = 0; i < max; i++)
  {
    if (netbuf[i] != 255)
    {
      write(0, &netbuf[i], 1);
      continue;
    }
    c2 = netbuf[i + 1];
    c3 = netbuf[i + 2];
    i += 2;
    if (c2 == 253 && (c3 == 3 || c3 == 24))
    {
      sprintf(tmp, "%c%c%c", 255, 251, c3);
      write(fd, tmp, 3);
      continue;
    }
    if ((c2 == 251 || c2 == 252) && (c3 == 1 || c3 == 3 || c3 == 24))
    {
      sprintf(tmp, "%c%c%c", 255, 253, c3);
      write(fd, tmp, 3);
      continue;
    }
    if (c2 == 251 || c2 == 252)
    {
      sprintf(tmp, "%c%c%c", 255, 254, c3);
      write(fd, tmp, 3);
      continue;
    }
    if (c2 == 253 || c2 == 254)
    {
      sprintf(tmp, "%c%c%c", 255, 252, c3);
      write(fd, tmp, 3);
      continue;
    }
    if (c2 == 250)
    {
      while (c3 != 240 && i < max)
      {
        c3 = netbuf[i];
        i++;
      }
      sprintf(tmp, "%c%c%c%c%c%c%c%c%c%c",
        255, 250, 24, 0, 65, 78, 83, 73, 255, 240);
      write(fd, tmp, 10);
    }
  }
  fflush(stdout);
}


static void
telnet(server, port)
  char *server;
  int port;
{
  int num;
  struct sockaddr_in sin;
  struct hostent *host;

  signal(SIGALRM, break_check);
  alarm(1);

  memset(&sin, 0, sizeof(sin));
  sin.sin_family = AF_INET;
  sin.sin_port = htons(port);

  if (!(host = gethostbyname(server)))
    sin.sin_addr.s_addr = inet_addr(server);
  else
    memcpy(&sin.sin_addr.s_addr, host->h_addr, host->h_length);

  cfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
  if (connect(cfd, (struct sockaddr *) & sin, sizeof(sin)) < 0)
  {
    close(cfd);
    return;
  }

  signal(SIGALRM, SIG_IGN);

  while (1)
  {
    tv.tv_sec = 2400;
    tv.tv_usec = 0;

    FD_ZERO(&readfds);
    FD_SET(cfd, &readfds);
    FD_SET(0, &readfds);

    if (select(cfd + 1, &readfds, NULL, NULL, &tv) <= 0)
      break;
    if (FD_ISSET(0, &readfds))
    {
      num = read(0, netbuf, 2048);
      if (num <= 0)
        break;
      if (netbuf[0] == 29)
        return;
      if (netbuf[0] == 13 && num == 1)
      {
        netbuf[1] = 10;
        num++;
      }
      write(cfd, netbuf, num);
    }
    else
    {
      num = read(cfd, netbuf, 2048);
      if (num <= 0)
        break;
      if (strchr(netbuf, 255))
        telnetopt(cfd, num);
      else
        write(0, netbuf, num);
    }
  }

  close(cfd);
}


int
x_bbsnet()
{
  int fd, i, j;
  char buf[80];

#define MAX_CONNLIST        20        /* å‡è¨­ç›®å‰åªæœ‰ 20 å€‹ç«™å°ï¼Œè‡³å¤š 51=3*(b_lines - 6) å€‹ç«™å° */

  struct CONNLIST
  {
    char host[40];
    char name[21];
    int port;
  }        connlist[MAX_CONNLIST];

#if 0                                /* etc/connlist æ ¼å¼ */
210.70.137.5:23:èˆ‡å—å…±èˆ
ptt.twbbs.org:23:PTT
#endif

  cutmp->status |= STATUS_REJECT;        /* bbsnet æ™‚ä¸æ”¶ç†±è¨Š */

  while (1)   /* itoc.010824: é€£å»åˆ¥çš„ç«™å›ä¾†ä»¥å¾Œé‚„æ˜¯ç•™åœ¨ bbsnet é¸å–®ä¸­ï¼Œ
                              å¯ä»¥å†é€£å»åˆ¥çš„ç«™ */
  {
    if ((fd = open("etc/connlist", O_RDONLY)) >= 0)
    {
      char *str, *ptr1, *ptr2;

      j = 0;
      mgets(-1);
      while ((str = mgets(fd)) && (j < MAX_CONNLIST))
      {
        if (ptr1 = strchr(str, ':'))
        {
          *ptr1 = '\0';
          do
          {
            i = *++ptr1;
          } while (i == ' ' || i == '\t');

          if (ptr2 = strchr(ptr1, ':'))
          {
            *ptr2 = '\0';
            do
            {
              i = *++ptr2;
            } while (i == ' ' || i == '\t');
          }

          if (i)
          {
            strcpy(connlist[j].host, str);
            strcpy(connlist[j].name, ptr2);
            i = atoi(ptr1);
            connlist[j].port = i > 0 ? i : 23;        /* é è¨­ port 23 */
            j++;
          }
        }
      }
      close(fd);
    }
    else
    {
      break;
    }

    vs_bar("ç’°å³¶æ—…è¡Œ");
    outs("â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      "â•â•â•â•â•â•â•â•â•â•â•â•â•®\n");

    for (i = 0; i < j; i++)
    {
      prints("â•‘ \033[1;33m%2d.\033[m%-21s", i + 1, connlist[i].name);

      if (++i < j)
        prints("\033[1;33m%2d.\033[m%-21s", i + 1, connlist[i].name);
      else
        prints("%24s", "");

      if (++i < j)
        prints("\033[1;33m%2d.\033[m%-21s â•‘\n", i + 1, connlist[i].name);
      else
        prints("%24s â•‘\n", "");
    }

    for (i /= 3; i < b_lines - 7; i++)
    {
      outs("â•‘                                                                          â•‘\n");
    }

    outs("â•‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘\n"
      "â•‘ \033[1;31mæ³¨æ„ï¼š\033[mç•¶æ‚¨é¸æ“‡äº†ç«™å°å¾Œï¼Œè¢å¹•åƒ"
      "ç•¶æ©Ÿä¸€æ¨£ä¸å‹•äº†ï¼Œè¡¨ç¤ºç¾åœ¨ç„¡æ³•ç™»å…¥å°æ–¹ä¸»æ©Ÿï¼Œ â•‘\n"
      "â•‘       è«‹ç¨å€™ telnet connect time out å¾Œæœƒè‡ªå‹•é€€"
      "å‡ºã€‚                      â•‘\n"
      "â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯");

    vget(b_lines, 0, "è«‹é¸æ“‡ä¸€å€‹é€£ç·šç«™å°ï¼š[Q] ", buf, 3, DOECHO);
    i = atoi(buf) - 1;
    if (i >= 0 && i < j)
    {
      sprintf(buf, "%s %s enter %s", cuser.userid, Now(), connlist[i].name);
      blog("BBSNET", buf);
      telnet(connlist[i].host, connlist[i].port);
      sprintf(buf, "%s %s leave %s", cuser.userid, Now(), connlist[i].name);
      blog("BBSNET", buf);
    }
    else
    {
      break;
    }
  }

  cutmp->status ^= STATUS_REJECT;
  return 0;
}

: etc/connlist æ–°å¢æ­¤æª”æ¡ˆ (é€™åªæ˜¯ç¯„ä¾‹)

ptt.twbbs.org:23:æ‰¹è¸¢è¸¢
ptt2.twbbs.org:23:æ‰¹è¸¢è¸¢å…”
bbs.badcow.com.tw:23:ä¸è‰¯ç‰›
bbs.kkcity.com.tw:23:ï¼«ï¼«ï¼£ï¼©ï¼´ï¼¹
bbs.nsysu.edu.tw:23:ä¸­å±±å¤§å­¸-ç¾éº—ä¹‹å³¶
bbs.cs.nthu.edu.tw:23:æ¸…å¤§è³‡å·¥Ë™æ¥“æ©‹é©›ç«™

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mpc512-1.EE.NCTU.edu.tw[37m ç™¼è¡¨[m
