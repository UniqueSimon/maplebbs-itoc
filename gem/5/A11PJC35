ä½œè€…: itoc (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: itoc
æ¨™é¡Œ: Re: [å•é¡Œ] é—œæ–¼ BBSNET.C
æ™‚é–“: 2005/12/08 Thu 20:47:10                           Updated: 2005/12/09

â€» å¼•è¿°ã€Šroga (ä»»æ€§)ã€‹ä¹‹éŠ˜è¨€ï¼š
> å°å¼Ÿè¦åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šé¢æ¶å…©å€‹ BBS ï¼Œ
> æƒ³è®“ä½¿ç”¨è€…é€é port 23 é€£ä¸Šå¾Œï¼Œ
> å†è®“ä»–é¸æ“‡ä»–è¦é€£é€™å°æ©Ÿå™¨ä¸Šçš„å“ªå€‹ BBS ã€‚
> æ‰€ä»¥æœ‰è¾¦æ³•æŠŠé€™å€‹åŠŸèƒ½åšåœ¨ä¸» BBS çš„é–‹é ­ç•«é¢ï¼Œç„¶å¾Œè®“ä½¿ç”¨è€…è‡ªç”±é¸æ“‡
> è¦é€£åˆ° ç¬¬äºŒå€‹ BBS æˆ–è€…æ˜¯ç›´æ¥é€²å…¥ä¸» BBS ã€‚

  è¦åœ¨åŒä¸€å°ä¸»æ©Ÿä¸Šï¼Œæ¶äºŒå€‹ BBS ç«™ï¼Œè«‹åƒè€ƒç²¾è¯å€
  [å®‰è£] ä¸€å°ä¸»æ©Ÿæ¶äºŒå€‹ BBS ç«™

  ä»¥ä¸‹ï¼Œæ‰€è¬‚
  ã€Œæœ¬ç«™ã€æŒ‡çš„æ˜¯é–‹åœ¨ port 23 çš„é‚£å€‹ç«™
  ã€ŒäºŒè™Ÿç«™ã€ã€ã€Œä¸‰è™Ÿç«™ã€æŒ‡çš„æ˜¯æ¶åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Šï¼Œä½†é–‹åœ¨ä¸åŒ port çš„é‚£äº›ç«™

: æœ¬ç«™è¦åŠ å…¥ BBSNet çš„åŠŸèƒ½

  è«‹åƒè€ƒç²¾è¯å€
  [ç¶²è·¯] bbsnet.c BBS-Net

: æ”¹æœ¬ç«™çš„ bbsnet.c

  æ–°å¢ä¸€å€‹ x_bbsnet2() åœ¨ x_bbsnet() å¾Œé¢
  å…§å®¹ç…§æŠ„ x_bbsnet()

: æ”¹æœ¬ç«™çš„ bbsnet.c:x_bbsnet2()

int
x_bbsnet2()
{
  int fd, i, j;
- char buf[80];
+ char buf[256];

  ...
  ...

- cutmp->status |= STATUS_REJECT;       /* bbsnet æ™‚ä¸æ”¶ç†±è¨Š */

- while (1)
- {
    ...
    ...

    else
    {
-     break;
+     return 0;
    }

    vs_bar("ç’°å³¶æ—…è¡Œ");

    ...
    ...

    vget(b_lines, 0, "è«‹é¸æ“‡ä¸€å€‹é€£ç·šç«™å°ï¼š[Q] ", buf, 3, DOECHO);
    i = atoi(buf) - 1;
-   if (i >= 0 && i < j)
+   if (i == 0)
+   {
+     return 0;
+   }
+   else if (i >= 1 && i < j)
    {
-     sprintf(buf, "%s %s enter %s", cuser.userid, Now(), connlist[i].name);
+     sprintf(buf, "%s %s enter %s", fromhost, Now(), connlist[i].name);
      blog("BBSNET", buf);
      telnet(connlist[i].host, connlist[i].port);
-     sprintf(buf, "%s %s leave %s", cuser.userid, Now(), connlist[i].name);
+     sprintf(buf, "%s %s leave %s", fromhost, Now(), connlist[i].name);
      blog("BBSNET", buf);
    }
-   else
-   {
-     break;
-   }
- }

- cutmp->status ^= STATUS_REJECT;
- return 0;
+ abort_bbs();
}

: æ”¹æœ¬ç«™çš„ bbsd.c:tn_main()

static inline void
tn_main()
{
  clear();

#ifdef HAVE_LOGIN_DENIED
  if (acl_has(BBS_ACLFILE, "", fromhost))
    login_abort("\nè²´æ©Ÿå™¨æ–¼ä¸è¢«æ•ç«™æ¥å—");
#endif

+ DL_func("bin/bbsnet.so:x_bbsnet2");

: æ”¹æœ¬ç«™çš„ etc/connlist
: ç¬¬ä¸€è¡Œå¯«æœ¬ç«™
: ç¬¬äºŒè¡Œå¯«äºŒè™Ÿç«™
: ç¬¬äºŒè¡Œå¯«ä¸‰è™Ÿç«™ (å¦‚æœæœ‰çš„è©±)
: ç¯„ä¾‹

xx.yy.zz:23:æœ¬ç«™çš„ç«™å
xx.yy.zz:3456:äºŒè™Ÿç«™çš„ç«™å
xx.yy.zz:4567:ä¸‰è™Ÿç«™çš„ç«™å

> ç„¶å¾Œï¼Œä½¿ç”¨è€…çš„ IP é‚„æ˜¯ä¸€æ¨£æ˜¯åŸæœ¬ä¸Šç«™çš„ IP
> ä¸æœƒè®Šæˆæä¾› bbsnet çš„ä¸»æ©Ÿçš„ IP ï¼Œé€™æ¨£æœ‰è¾¦æ³•é”æˆå—ï¼Ÿ

  ä»¥ä¸Šä½œæ³•
  é€£æœ¬ç«™æœƒæ˜¯ä½¿ç”¨è€…ä¾†æº IP
  é€£äºŒè™Ÿç«™ã€ä¸‰è™Ÿç«™çš„ä¾†æºéƒ½æœƒè®Šæˆä¸»æ©Ÿ IP

  è‹¥å¸Œæœ›é€£äºŒè™Ÿç«™ã€ä¸‰è™Ÿç«™çš„ä¾†æºéƒ½æ˜¯ä½¿ç”¨è€…ä¾†æº IP çš„è©±
  å‰‡é‚„è¦åšä»¥ä¸‹  (ä»¥ä¸‹é€™æ–¹æ³•æ˜¯è³¤æ‹› :p)

  ä½¿ç”¨ä»¥ä¸‹é€™æ–¹æ³•ï¼Œå¿…é ˆè¦äºŒè™Ÿç«™ã€ä¸‰è™Ÿç«™å’Œæœ¬ç«™åœ¨åŒä¸€å°æ©Ÿå™¨ä¸Š

: æ”¹æœ¬ç«™çš„ bbsnet.c:x_bbsnet2()

    else if (i >= 1 && i < j)
    {
+     while (1)
+     {
+       if (dashf("/tmp/bbsnet"))
+       {
+         usleep(500000);
+         continue;
+       }
+       if ((fd = open("/tmp/bbsnet",
+         O_WRONLY | O_CREAT | O_APPEND, 0666)) >= 0)
+       {
+         write(fd, fromhost, strlen(fromhost));
+         close(fd);
+       }
+     }
      sprintf(buf, "%s %s enter %s", fromhost, Now(), connlist[i].name);
      blog("BBSNET", buf);
      telnet(connlist[i].host, connlist[i].port);
      sprintf(buf, "%s %s leave %s", fromhost, Now(), connlist[i].name);
      blog("BBSNET", buf);
    }

: æ”¹ äºŒè™Ÿç«™ã€ä¸‰è™Ÿç«™çš„ bbsd.c:main()

    dns_name((char *) &sin.sin_addr, fromhost);
+   if (!strcmp(fromhost, "xx.yy.zz"))      /* å…¶ä¸­ xx.yy.zz æ˜¯æœ¬ç«™çš„ fqdn */
+   {
+     if (dashf("/tmp/bbsnet"))
+     {
+       FILE *fp;
+       if (fp = fopen("/tmp/bbsnet", "r"))
+       {
+         char buf[128];
+         if (fgets(buf, sizeof(buf), fp))
+           str_ncpy(fromhost, buf, sizeof(fromhost));
+         fclose(fp);
+       }
+       unlink("/tmp/bbsnet");
+     }
+   }

--
[1;36m=[37m[[36mï¹[37m:[33m?[37mæ‘ƒ?[mâ—£?[1;33m?[37m:[36mï¹ [31mOrigin[37m ]|[[m  [31m?[1må¨[;31;40mO?[1mç—[;31;40m?[1mcpu.tfcis.org  [37m]|[?[33mæŸèªª[m?[1;36mï¹[37m:][36m=[m
[1;36m=[m[[1;36mï¹Š[37m:[33m?[30mæ‘ƒ?[mâ•±?[1;33m?[37m:[36mï¹Š [31mAuthor[m ]|[[1m  pc512-1.ee.nctu.edu.tw  [m]|[?[1;33m?[30m?[37mæ’[30m?[36mï¹Š[37m:[m][1;36m=[m
