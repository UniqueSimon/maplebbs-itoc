ä½œè€…: chwaian (ç„¡è¨€) çœ‹æ¿: itoc
æ¨™é¡Œ: Re: æƒ³è«‹å•æœ‰åšè³­ç›¤çš„ç«™é•·
æ™‚é–“: 2004/08/23 Mon 20:20:27                           Updated: 2005/06/08

: src/game/Makefile

SO =    .... [1;33mbet.so[m

: src/game/ åº•ä¸‹å¢åŠ é€™éš»ç¨‹å¼

/*-------------------------------------------------------*/
/* so/bet.c         ( NTHU CS MapleBBS Ver 3.00 )        */
/*-------------------------------------------------------*/
/* target : ç˜‹ç‹‚è³­ç›¤ (åŸå:ä¸‹æ³¨éŠæˆ²)                     */
/* create :   /  /                                       */
/* update :   /  /                                       */
/* author : dsyan.bbs@Forever.twbbs.org                  */
/*          weiren@weiren.net                            */
/*-------------------------------------------------------*/

#if 0
   åŸæ§‹æƒ³åŠç¨‹å¼ç”± dsyan æä¾›åŠæ’°å¯«..
   å¾Œç¶“ weiren æ”¹å¯«éƒ¨åˆ†æ¶æ§‹å¾—æ­¤ç¨‹å¼..
   æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°æ­¡è¿èˆ‡é€™å…©ä½é€£çµ¡.. :)

   dsyan æ˜¯å¤©é•·åœ°ä¹…(Forever.twbbs.org) çš„ç«™é•·
   =>dsyan.bbs@Forever.twbbs.org
   weiren æ˜¯è’è¬¬åŒ–å¢ƒ (weird.twbbs.org.tw) çš„ç«™é•·
   =>http://www.weiren.net/
   =>weiren@weiren.net
#endif


#include "bbs.h"

#define maxboard    40
#define newgame     5           /* æœ€å¾Œé–‹çš„å¹¾ç›¤è¦è®Šè‰² */
#define LOCK_FILE   "etc/game/bet/bet.lock"


static void
add_post(brdname, fpath, title) /* ç™¼æ–‡åˆ°çœ‹æ¿ */
  char *brdname;                /* æ¬² post çš„çœ‹æ¿ */
  char *fpath;                  /* æª”æ¡ˆè·¯å¾‘ */
  char *title;                  /* æ–‡ç« æ¨™é¡Œ */
{
  HDR hdr;
  char folder[64];

  brd_fpath(folder, brdname, FN_DIR);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, fpath);
  strcpy(hdr.owner, STR_SYSOP);
  strcpy(hdr.nick, SYSOPNICK);
  strcpy(hdr.title, title);
  hdr.xmode = POST_MARKED;
  rec_bot(folder, &hdr, sizeof(HDR));

  btime_update(brd_bno(brdname));
}


int
main_bet()
{
  char i, j, k, num, cc[51], userid[IDLEN + 1];
  char buf[80], fpath[64], cho[9][51];
  int t[maxboard], money, tmp, phh, a, b, newbet[newgame];
  int turn = 0, ch_color;
  char ch;
  time_t set_time, close_time;
  FILE *fs, *fss;

  if (HAS_STATUS(STATUS_COINLOCK))
  {
    vmsg(msg_coinlock);
    return XEASY;
  }

  more("etc/game/bet/bet.welcome", NULL);
  if (fss = fopen("etc/game/bet/bet.new", "r"))
  {
    for (j = 0; j < newgame; j++)
      fscanf(fss, "%d\n", &newbet[j]);
    fclose(fss);
  }

  while (-1)
  {
    vs_bar("ç˜‹ç‹‚è³­ç›¤");

    if (dashf(LOCK_FILE))
    {
      vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
      return 0;
    }

    do
    {
      move(1, 0);
      outs("\033[44;1mç·¨è™Ÿ  å–®  åƒ¹           é …    ç›®    æ•˜    è¿° é–‹ å±€ è€…"
        "   å°šæœ‰å¹¾å°æ™‚  \033[m\n");
      fs = fopen("etc/game/bet/bet.list", "r");
      if (turn == 0)
        tmp = 0;
      else
      {
        tmp = 20;
        for (k = 0; k < 20; k++)
        {
          fscanf(fs, "%d %ld %s\n", &t[i], &close_time, userid);
          fgets(buf, 60, fs);
        }
      }
      for (i = tmp; i < 20 + tmp; i++)
      {
        fscanf(fs, "%d %ld %s\n", &t[i], &close_time, userid);
        fgets(buf, 60, fs);
        j = strlen(buf) - 1;
        buf[j] = 0;
        a = (close_time - time(0)) / 3600 / 24;
        b = (close_time - time(0)) / 3600 % 24;

        ch_color = 0;
        for (j = 0; j < newgame; j++)
        {
          if (newbet[j] == i + 1)
            ch_color = 1;
        }

        if (t[i])
        {
          sprintf(fpath, "etc/game/bet/bet.ans%d", i + 1);
          if (fss = fopen(fpath, "r"))
          {
            fclose(fss);
            prints("\033[35;1m %2d    %5d  %-40s %-12s [ç­‰å¾…ç™¼éŒ¢]\033[m\n",
              i + 1, t[i], buf, userid);
          }
          else if (close_time - time(0) > 0)
            prints("\033[%d;1m %2d    %5d  %-40s %-12s %2då¤©%2då°æ™‚\033[m\n",
              ch_color ? 37 : 32, i + 1, t[i], buf, userid, a, b);
          else
            prints("\033[32;1m %2d    %5d  %-40s %-12s     [å°ç›¤]\033[m\n",
              i + 1, t[i], buf, userid);
        }
        else
          prints("\033[31;1m %2d    -----      å°šæœªæœ‰äººé–‹å±€\033[m\n", i + 1);
      }
      fclose(fs);
      move(22, 0);
      clrtoeol();
      prints("\033[1;44;37mæŒ‰éµèªªæ˜: [n]ä¸‹ä¸€é  [p]ä¸Šä¸€é  [b]ä¸‹æ³¨/é–‹æ¡Œ/é–‹ç›¤ "
        "[q]é›¢é–‹  é‡‘å¹£: %10d     \033[m", cuser.gold);
      do
      {
        ch = igetch();
      } while (ch != 'q' && ch != 'n' && ch != 'p' && ch != 'b');
      if (ch == 'q')
        return 0;
      if (ch == 'n')
        turn = 1;
      if (ch == 'p')
        turn = 0;
      j = 0;
      if (ch == 'b')
      {
        vget(22, 0, "è«‹è¼¸å…¥ 1-40 æˆ–ç›´æ¥æŒ‰ Enter é›¢é–‹ï¼š", cc, 3, DOECHO);
        j = atoi(cc);
      }
    } while (!j || j > maxboard || j < 1);


    if (dashf(LOCK_FILE))
    {
      vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
      return 0;
    }

    if (t[j - 1])                /* å·²æœ‰äººé–‹å±€ */
    {
      fs = fopen("etc/game/bet/bet.list", "r");
      for (i = 0; i < j; i++)
      {
        fscanf(fs, "%d %ld %s\n", &t[i], &close_time, userid);
        fgets(buf, 60, fs);
      }
      fclose(fs);
      if (close_time < time(0))        /* æ™‚é–“åˆ° */
      {
        sprintf(fpath, "etc/game/bet/bet.ans%d", j);
        if (dashf(fpath))
        {
          vmsg("çµæœå·²å…¬ä½ˆ..çé‡‘å°‡æ–¼æ˜å¤© 6:30am ç™¼æ”¾..:)");
        }
        else if (strcmp(userid, cuser.userid))
        {
          sprintf(buf, "ä¸‹æ³¨æœŸé™å·²åˆ°..ç­‰å¾… %s é–‹å±€..", userid);
          vmsg(buf);
        }
        else
        {
          int ch[9], all = 0;

          vs_bar("ç˜‹ç‹‚è³­ç›¤");
          prints("\n\n\033[44;1m  å½©ç¥¨æ•¸    å€ç‡      æ•˜  è¿°"
            "           \033[m\n\n");
          sprintf(fpath, "etc/game/bet/bet.cho%d", j);
          fs = fopen(fpath, "r");
          fscanf(fs, "%d\n%d\n", &tmp, &all);
          for (i = 0; i < tmp; i++)
          {
            long xx;
            fgets(cho[i], 250, fs);
            fscanf(fs, "%d\n", &ch[i]);
            xx = all * 100 / ch[i];
            prints("%d)%6d   %3d.%-2d   %s",
              i + 1, ch[i], xx / 100, xx % 100, cho[i]);
          }
          fclose(fs);
          sprintf(buf, "è«‹è¼¸å…¥æœ€å¾Œçš„çµæœ(1-%d)æˆ–ç›´æ¥æŒ‰ Enteré›¢é–‹ï¼š", tmp);
          move(20, 0);
          prints("\033[1;31mæ³¨æ„ï¼šäº‚é–‹ç›¤è€…ï¼Œå°‡è™•ä»¥åœæ¬Šèˆ‡é‡‘éŒ¢æ­¸é›¶çš„è™•åˆ†\033[m");
          vget(22, 0, buf, cc, 3, DOECHO);
          num = atoi(cc);

          if (dashf(LOCK_FILE))
          {
            vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
            return 0;
          }
          if (num <= tmp && num >= 1)
          {
            if (vans(msg_sure_ny) == 'y')
            {
              char fpath[64], title[30], fname[60];

              if (dashf(LOCK_FILE))
              {
                vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
                return 0;
              }

              sprintf(fpath, "etc/game/bet/bet.ans%d", j);
              fss = fopen(fpath, "w");
              fprintf(fss, "%d", num);
              fclose(fss);

              sprintf(fpath, "tmp/addpost.tmp%d", j);
              sprintf(fname, "etc/game/bet/bet.betlog%d", j);

              if (fss = fopen(fpath, "w"))
              {
                sprintf(title, "ç›¤è™Ÿ[%d] å°ç›¤çµæœ", j);

                fprintf(fss, "%s %s (%s) %s %s\n", STR_AUTHOR1, STR_SYSOP,
                  SYSOPNICK, STR_POST2, BN_BET);
                fprintf(fss, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n\n", title, Now());

                fprintf(fss, "\n[é–‹ççµæœ]ï¼š%d\n", num);
                fprintf(fss, "\n--\nâ€» åº•ä¸‹ç‚ºæ­¤æ¬¡ä¸‹æ³¨ç‹€æ³ï¼Œ"
                  "æ˜å¤©æ—©ä¸Š6:30å°‡ç™¼æ”¾çé‡‘\n\n\n");

                f_suck(fss, fname);

                fclose(fss);
                add_post(BN_BET, fpath, title);
                unlink(fpath);
                unlink(fname);
              }
            }
          }
        }
      }
      else
      {
        sprintf(fpath, "etc/game/bet/bet.scr%d", j);
        more(fpath, NULL);

        while (1)
        {
          int ch[9], all = 0, hhall = 0;

          vs_bar("ç˜‹ç‹‚è³­ç›¤");
          prints("\n\n\033[44;1m  å½©ç¥¨æ•¸       å€ç‡      æ•˜  è¿°"
            "           \033[m\n\n");
          sprintf(fpath, "etc/game/bet/bet.cho%d", j);
          fs = fopen(fpath, "r");
          fscanf(fs, "%d\n%d\n", &tmp, &all);
          for (i = 0; i < tmp; i++)
          {
            int hh = 0;
            long xx;
            fgets(cho[i], 250, fs);
            fscanf(fs, "%d\n", &ch[i]);
            sprintf(fpath, "etc/game/bet/bet.cho%d.%d", j, i + 1);
            if (fss = fopen(fpath, "r"))
            {
              char id[13];
              phh = 0;
              while (fscanf(fss, "%s %d\n", id, &hh) != EOF)
              {
                if (!strcmp(id, cuser.userid))
                {
                  phh += hh;
                  hhall += hh;
                }
              }
              fclose(fss);
            }
            else
              hh = 0;
            xx = all * 100 / ch[i];
            prints("%2d)%4d/%4d   %3d.%-2d   %s",
              i + 1, phh, ch[i], xx / 100, xx % 100, cho[i]);
          }
          fclose(fs);
          prints("\nå…¨>%4d/%4d\n", hhall, all);
          prints("\næœ¬å±€ç¸½è³­é‡‘: \033[1;36m%d\033[m å–®å¼µè³­ç¥¨åƒ¹æ ¼: %d",
            all * t[j - 1], t[j - 1]);

          sprintf(buf, "è«‹è¼¸å…¥ä½ çš„é¸æ“‡(1-%d)æˆ–æŒ‰ q è·³å‡ºï¼š", tmp);
          vget(20, 0, buf, cc, 2, DOECHO);
          if (dashf(LOCK_FILE))
          {
            vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
            return 0;
          }
          if (cc[0] == 'q')
            break;
          num = cc[0] - 48;
          if (num > tmp || num < 1)
            vmsg("è¼¸å…¥ç¯„åœæœ‰èª¤!!è«‹é‡æ–°è¼¸å…¥..");
          else
          {
            sprintf(buf, "ä¸€å¼µå½©åˆ¸é‡‘å¹£%då…ƒï¼Œä½ ç›®å‰æœ‰é‡‘å¹£%då…ƒï¼Œ"
              "è¦è²·å¹¾å¼µï¼Ÿ(0-%d)",
              t[j - 1], cuser.gold, cuser.gold / t[j - 1]);
            vget(21, 0, buf, cc, 6, DOECHO);
            if (dashf(LOCK_FILE))
            {
              vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
              return 0;
            }
            if (atoi(cc) > cuser.gold / t[j - 1] || !atoi(cc) ||(atoi(cc) < 1))
              vmsg("è¼¸å…¥ç¯„åœæœ‰èª¤!!å–æ¶ˆ..");
            else
            {
              int hh = 0;
              if (close_time < time(0))
              {
                vmsg("è¶…éæ™‚é–“äº†!");
                return 0;
              }
              cuser.gold -= (atoi(cc) * t[j - 1]);
              sprintf(fpath, "etc/game/bet/bet.cho%d", j);
              fs = fopen(fpath, "r");
              fscanf(fs, "%d\n%d\n", &tmp, &all);
              for (i = 0; i < tmp; i++)
              {
                fgets(cho[i], 250, fs);
                fscanf(fs, "%d\n", &ch[i]);
              }
              fclose(fs);
              ch[num - 1] += atoi(cc);
              all += atoi(cc);
              fs = fopen(fpath, "w");
              fprintf(fs, "%d\n%d\n", tmp, all);
              for (i = 0; i < tmp; i++)
              {
                char g = strlen(cho[i]) - 1;
                cho[i][g] = 0;
                fprintf(fs, "%s\n%d\n", cho[i], ch[i]);
              }
              fclose(fs);
              sprintf(fpath, "etc/game/bet/bet.cho%d.%d", j, num);
              fs = fopen(fpath, "a");
              fprintf(fs, "%s %d\n", cuser.userid, atoi(cc));
              fclose(fs);

              sprintf(fpath, "etc/game/bet/bet.betlog%d", j);
              sprintf(buf, "ä½¿ç”¨è€…%sè²·äº†%då¼µ%dè™Ÿé¸é …(%s)\n",
                cuser.userid, atoi(cc), num, Now());
              f_cat(fpath, buf);
            }
          }
        }
      }
    }
    else    /* è‡ªå·±é–‹å±€ */
    {
      int khour, kd;

      more("etc/game/bet/bet.anno", NULL);

      if (vans("ç¢ºå®šè¦é–‹å±€(Y/N)ï¼Ÿ[N] ") != 'y')
        continue;

      if (dashf(LOCK_FILE))
      {
        vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
        return 0;
      }

      sprintf(cc, "tmp/%s_bet.scr", cuser.userid);
      vmsg("è«‹æŒ‰ä»»ä¸€éµé–‹å§‹ç·¨è¼¯æ­¤æ¬¡ [é–‹å±€å®—æ—¨]");
      if (vedit(cc, 0) < 0)
        continue;

      vs_bar("ç˜‹ç‹‚è³­ç›¤");
      vget(2, 0, "è«‹å¡«åœæ³¨æ™‚é–“å¹¾å°æ™‚å¾Œ(åä½æ•¸è¦è£œ0ï¼Œ0è«‹è¼¸å…¥00ï¼Œ"
        "1è«‹è¼¸å…¥01ï¼Œä»¥æ­¤é¡æ¨)ï¼š", buf, 3, DOECHO);
      khour = (buf[0] - '0') * 10 + (buf[1] - '0');
      vget(3, 0, "è«‹å¡«åœæ³¨æ™‚é–“å¤©å¾Œ(åä½æ•¸è¦è£œ0ï¼Œ0è«‹è¼¸å…¥00ï¼Œ"
        "1è«‹è¼¸å…¥01ï¼Œä»¥æ­¤é¡æ¨)ï¼š", buf, 3, DOECHO);
      kd = (buf[0] - '0') * 10 + (buf[1] - '0');
      if (khour < 10 && kd == 0)
      {
        vmsg("æ™‚é–“éçŸ­(æœ€çŸ­ 10 å°æ™‚)");
        continue;
      }
      if (kd > 14)
      {
        vmsg("æ™‚é–“éé•·(æœ€é•· 14 å¤©)");
        continue;
      }
      if (khour > 24)
      {
        vmsg("æ™‚é–“ä¸å¯è¶…é24å°æ™‚");
        continue;
      }
      if (kd < 0 || khour < 0)
      {
        vmsg("åä½æ•¸è¨˜å¾—è£œ0");
        continue;
      }
      set_time = time(0) + khour * 3600 + kd * 24 * 3600;

      if (!vget(4, 0, "è«‹ç°¡çŸ­æ•˜è¿°æ­¤å±€ï¼š", cc, 41, DOECHO))
        continue;

      move(5, 0);
      outs("\033[1;31mè¨­å®šé¸é …ï¼Œè«‹æ³¨æ„å’Œå±€ã€æ¯”è³½å–æ¶ˆç­‰ç‹€æ³ï¼Œ"
        "çµ•ä¸å¯æ²’æœ‰ç­”æ¡ˆï¼Œè¨­å®šå¾Œä¸å¯æ›´æ”¹ã€‚\033[m");

      vget(6, 0, "å…±æœ‰å¹¾å€‹é¸é …ï¼Ÿ(2-9)", buf, 2, DOECHO);
      tmp = atoi(buf);
      if (tmp < 1 || tmp > 9)
      {
        vmsg("é¸é …æ•¸ç›®éŒ¯èª¤!!");
        continue;
      }

      vget(7, 0, "å½©åˆ¸ä¸€å¼µå¤šå°‘éŒ¢ï¼Ÿ(100-10000)", buf, 6, DOECHO);
      money = atoi(buf);
      if (money < 100 || money > 10000)
      {
        vmsg("è¼¸å…¥é‡‘é¡éŒ¯èª¤!!");
        continue;
      }
      if (cuser.gold < money * (10 * tmp + 5))
      {
        sprintf(buf, "ä½ çš„éŒ¢ä¸è¶³ %d å…ƒå–”!!", money * (10 * tmp + 5));
        vmsg(buf);
        continue;
      }

      for (i = 0; i < tmp; i++)
      {
        move(8 + i, 0);
        prints("é¸é …%dï¼š", i + 1);
        do
        {
          vget(8 + i, 7, "", cho[i], 50, DOECHO);
        } while (!cho[i][0]);
      }
      sprintf(buf, "etc/game/bet/bet.cho%d", j);
      if (dashf(LOCK_FILE))
      {
        vmsg("ç™¼éŒ¢æ™‚é–“åœæ­¢ä¸‹æ³¨");
        return 0;
      }
      if (dashf(buf))
      {
        fclose(fs);
        vmsg("æœ‰äººæ¯”ä½ å¿«ä¸€æ­¥äº†");
        return 0;
      }

      if (vans("ç¢ºå®šé–‹ç›¤(Y/N)ï¼Ÿ[N] ") != 'y')
      {
        sprintf(cc, "etc/game/bet/bet.scr%d", j);
        unlink(cc);
        sprintf(cc, "tmp/%s_bet.*", cuser.userid);
        unlink(cc);
        vmsg("é–‹æ¡Œå–æ¶ˆ!!");
        return 0;
      }

      fs = fopen(buf, "w");
      fprintf(fs, "%d\n%d\n", tmp, tmp * 10);
      for (i = 0; i < tmp; i++)
      {
        fprintf(fs, "%s\n10\n", cho[i]);
        sprintf(buf, "etc/game/bet/bet.cho%d.%d", j, i + 1);
        fss = fopen(buf, "a+");
        fprintf(fss, "%s %d\n", cuser.userid, 10);
        fclose(fss);
      }
      fclose(fs);

      if (fss = fopen("etc/game/bet/bet.new", "r"))
      {
        for (i = 0; i < newgame; i++)
          fscanf(fss, "%d\n", &newbet[i]);
        fclose(fss);
      }
      if (fss = fopen("etc/game/bet/bet.new", "w"))
      {
        fprintf(fss, "%d\n", j);
        for (i = 0; i < newgame - 1; i++)
          fprintf(fss, "%d\n", newbet[i]);
        fclose(fss);
      }

      cuser.gold -= (money * (10 * tmp + 5));
      close_time = set_time;
      fs = fopen("etc/game/bet/bet.list", "r");
      fss = fopen("etc/game/bet/bet.list.w", "w");
      for (i = 0; i < maxboard; i++)
      {
        if (i + 1 == j)
        {
          fgets(buf, 60, fs);
          fgets(buf, 60, fs);
          fprintf(fss, "%d %ld %s\n", money, close_time, cuser.userid);
          fprintf(fss, "%s\n", cc);
        }
        else
        {
          fgets(buf, 60, fs);
          fprintf(fss, buf);
          fgets(buf, 60, fs);
          fprintf(fss, buf);
        }
      }
      fclose(fs);
      fclose(fss);
      f_mv("etc/game/bet/bet.list.w", "etc/game/bet/bet.list");

      sprintf(buf, "tmp/%s_bet.scr", cuser.userid);
      sprintf(fpath, "etc/game/bet/bet.scr%d", j);
      f_mv(buf, fpath);
      sprintf(fpath, "tmp/%s_bet.*", cuser.userid);
      unlink(fpath);
      vmsg("é–‹æ¡Œå®Œæˆ!!");
    }
  }
}

--
 [1;41mâ•­[44mâ”¼[m Or[1mig[30min[m: [43m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [35;47m processor.tfcis.org [m
 [1;42mâ”¼[45mâ”˜[m A[1mut[30mho[mr: [1;31mchwaian [30må¾ [36m218-171-119-168.dynamic.hinet.net [30mç™¼è¡¨[m
