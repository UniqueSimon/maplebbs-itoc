ä½œè€…: itoc (é¢¨èª¿é›¨é †ï¼Œåœ‹æ³°æ°‘å®‰) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] ç­”éŒ„æ©Ÿ
æ™‚é–“: Sat Jul  5 16:11:44 2003                          Updated: 2003/07/05

: menu.c:vs_head()

void
vs_head(title, mid)
  char *title, *mid;
{
  char buf[40], ttl[60];
+ char fpath[64];
  int spc, len;

  ...
  ...

+ usr_fpath(fpath, cuser.userid, "pnote.dat.new");

  if (cutmp->ufo & UFO_BIFF)
  {
    mid = "\033[5;41m éƒµå·®ä¾†æŒ‰éˆ´äº† \033[m";
    spc = 14;
  }
+ else if (rec_num(fpath, 1))
+ {
+   mid = "\033[5;41m æ‚¨æœ‰æ–°ç•™è¨€å–” \033[m";
+   spc = 14;
+ }
  else

: menu.c é©ç•¶çš„é¸å–®åŠ å…¥

+ "bin/pnote.so:main_pnote", PERM_BASIC, - M_XMODE,
+ "Pnote      â”œ ç­”éŒ„ç•™è¨€ â”¤",

: so/Makefile

SO =    ..... pnote.so

: so/pnote.c åŠ æ–°ç¨‹å¼

/*-------------------------------------------------------*/
/* pnote.c      ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : ç­”éŒ„æ©Ÿ                                       */
/* create : 98/04/14                                     */
/* update : 03/07/05                                     */
/* author : herb                                         */
/* recast : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


#define MAX_PNOTE       10      /* ç­”éŒ„æ©Ÿä¿ç•™é€šæ•¸ */
#define MAXHINTLINES    10      /* ç­”éŒ„æ©Ÿä¸»äººç•™è¨€é•·åº¦ */

/* binary æª” */
static char *fn_pnote_dat_new = "pnote.dat.new";/* ç­”éŒ„æ©Ÿè³‡æ–™åº«æ–°çš„ç•™è¨€ */
static char *fn_pnote_dat_old = "pnote.dat.old";/* ç­”éŒ„æ©Ÿè³‡æ–™åº«èˆŠçš„ç•™è¨€ */

/* ç´”æ–‡å­—æª” */
static char *fn_pnote_hint = "pnote.hint";      /* ç­”éŒ„æ©Ÿä¸»äººå•å€™èª */
static char *fn_pnote_tmp = "pnote.tmp";        /* ç§€å‡ºå…¨éƒ¨ç•™è¨€æ™‚çš„æš«å­˜æª” */


typedef struct
{
  time_t chrono;
  char userid[IDLEN + 1];
  char msg[3][71];
} PNOTE;


static int
pnote_init(pnotes, fpath)       /* å–å‡ºæ‰€æœ‰çš„ç•™è¨€ */
  PNOTE *pnotes;
  char *fpath;
{
  FILE *fp;
  int total;

  total = 0;
  if (fp = fopen(fpath, "r"))
  {
    while (fread(&pnotes[total], sizeof(PNOTE), 1, fp) == 1)
      total++;
    fclose(fp);
  }
  return total;
}


static void
pnote_show(pnote)
  PNOTE *pnote;
{
  int i;

  for (i = 8; i >= 4; i--)
  {
    move(i, 0);
    clrtoeol();
  }

  prints("\033[1;36mâ”Œâ”€â”€â”€ \033[37m%s\033[m åœ¨ \033[33m%s\033[m ç•™è¨€çµ¦æ‚¨",
    pnote->userid, Btime(&pnote->chrono));
  outs("\n  ");
  outs(pnote->msg[0]);
  outs("\n  ");
  outs(pnote->msg[1]);
  outs("\n  ");
  outs(pnote->msg[2]);
  outs("\n\033[1;36m  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[m\n");
}


static void
pnote_hint(userid)              /* ç§€å‡º userid çš„ä¸»äººå•å€™èª */
  char *userid;
{
  int i;
  char buf[80];
  FILE *fp;

  clear();
  move(1, 0);

  usr_fpath(buf, userid, fn_pnote_hint);
  if (fp = fopen(buf, "r"))
  {
    outs("\033[1;34mâ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ \033[32må•å€™èª\033[34m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—\033[m\n");

    i = 0;
    while (i++ < MAXHINTLINES && fgets(buf, sizeof(buf), fp))
      outs(buf);

    outs("\033[1;34mâ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—\033[m\n");
    fclose(fp);
  }
  else
  {
    prints("æ‚¨å¥½ï¼Œé€™æ˜¯ %s çš„é›»è©±ç­”éŒ„æ©Ÿï¼Œ", userid);
  }
  outs("\nè«‹åœ¨è½åˆ°ã€Œå—¶ã€è²å¾Œï¼Œé–‹å§‹ç•™è¨€ï¼Œè¬è¬ã€‚");
}


static void
pnote_draw(userid)              /* ç•™è¨€çµ¦ userid */
  char *userid;
{
  int i, cc;
  char fpath[64];
  PNOTE pnote;

  /* é–‹å§‹ç•™è¨€ */
  do
  {
    pnote.msg[0][0] = pnote.msg[1][0] = pnote.msg[2][0] = '\0';
    move(14, 0);
    clrtobot();
    outs("\nè«‹ç•™è¨€ (è‡³å¤šä¸‰è¡Œ)ï¼ŒæŒ‰[Enter]çµæŸ");
    for (i = 0; (i < 3) &&
      vget(16 + i, 0, "ï¼š", pnote.msg[i], 71, DOECHO); i++);
    cc = vans("(S)å­˜æª”è§€è³ (E)é‡æ–°ä¾†é (Q)ç®—äº†ï¼Ÿ[S] ");
    if (cc == 'q' || i == 0)
      return;
  } while (cc == 'e');

  time(&pnote.chrono);
  strcpy(pnote.userid, cuser.userid);

  /* å¯«å…¥å°æ–¹çš„ç•™è¨€æª” */
  usr_fpath(fpath, userid, fn_pnote_dat_new);
  if (rec_num(fpath, sizeof(PNOTE)) >= MAX_PNOTE)
  {
    vmsg("å°æ–¹çš„ç­”éŒ„æ©Ÿå·²æœ‰éå¤šæ–°ç•™è¨€ï¼Œç„¡æ³•å†ç•™è¨€");
    return;
  }
  rec_add(fpath, &pnote, sizeof(PNOTE));
}


static void
pnote_view(pnotes, num)         /* æŠŠ binary æª”æ”¹æˆæ–‡å­—æª”ï¼Œä¸¦å°å‡ºä¾† */
  PNOTE *pnotes;
  int num;
{
  int i;
  char fpath[64];
  FILE *fp;
  PNOTE *pnote;

  usr_fpath(fpath, cuser.userid, fn_pnote_tmp);

  if (fp = fopen(fpath, "w"))
  {
    fputs("                  \033[1;32mâ˜…\033[37m ç­” éŒ„ æ©Ÿ ä¸­ çš„ ç•™ è¨€ \033[32mâ˜…\033[m\n\n", fp);
    for (i = 0; i < num; i++)
    {
      pnote = &pnotes[i];

      fprintf(fp, "\033[1;36mâ”Œâ”€â”€â”€ \033[37m%s\033[m åœ¨ \033[33m%s\033[m ç•™è¨€çµ¦æ‚¨",
        pnote->userid, Btime(&pnote->chrono));
      fprintf(fp, "\n  %s\n  %s\n  ", pnote->msg[0], pnote->msg[1], pnote->msg[2]);
      fprintf(fp, "\n\033[1;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[m\n");
    }
    fclose(fp);

    more(fpath, NULL);
    unlink(fpath);
  }
}


static void
Pnote(newflag)
  int newflag;                  /* 1:æ–°ç•™è¨€ 0:èˆŠç•™è¨€ */
{
  int pos, num;
  char fpath[64], prompt[80];
  PNOTE pnotes[MAX_PNOTE];

  usr_fpath(fpath, cuser.userid, newflag ? fn_pnote_dat_new :  fn_pnote_dat_old);
  if ((num = pnote_init(pnotes, fpath)) <= 0)
  {
    vmsg("æ‚¨æ²’æœ‰ç•™è¨€");
    return;
  }

  vs_bar("ç­”éŒ„æ©Ÿ");

  pos = 0;
  sprintf(prompt, "â— ç€è¦½ç•™è¨€ P)å‰ç¿» N)å¾Œç¿» A)å…¨éƒ¨ %s K)åˆªé™¤å…¨éƒ¨ Q)é›¢é–‹ [Q] ", newflag ? "S)ä¿ç•™" : "D)åˆªé™¤");

  while (1)
  {
    if (pos < 0)                /* å…¨éƒ¨ç•™è¨€éƒ½è¢«åˆªé™¤æˆ–è¢«ä¿ç•™äº† */
      return;

    move(2, 0);
    clrtoeol();
    prints("\033[1;36mç­”éŒ„æ©Ÿè£¡çš„ \033[37m%d/%d\033[36m é€š%sç•™è¨€\033[m\n", pos + 1, num, newflag ? "æ–°çš„" : "");
    pnote_show(&pnotes[pos]);

    switch (vans(prompt))
    {
    case 'p':
      pos = (pos == 0) ? num - 1 : pos - 1;
      break;

    case 'n':
      pos = (pos == num - 1) ? 0 : pos + 1;
      break;

    case 'a':
      pnote_view(&pnotes, num);
      break;

    case 's':
      if (newflag)
      {
        if (num >= MAX_PNOTE)
        {
          vmsg("æ‚¨çš„çš„ç­”éŒ„æ©Ÿå·²ä¿ç•™éå¤šç•™è¨€");
        }
        else
        {
          char buf[64];

          usr_fpath(buf, cuser.userid, fn_pnote_dat_old);
          rec_add(buf, &pnotes[pos], sizeof(PNOTE));
          memcpy(&pnotes[pos], &pnotes[pos + 1], sizeof(PNOTE) * (num - pos - 1));
          rec_del(fpath, sizeof(PNOTE), pos, NULL);
          pos--;
          num--;
          vmsg("ä¿ç•™æˆåŠŸ");
        }
      }
      break;

    case 'd':
      if (!newflag)
      {
        memcpy(&pnotes[pos], &pnotes[pos + 1], sizeof(PNOTE) * (num - pos - 1));
        rec_del(fpath, sizeof(PNOTE), pos, NULL);
        pos--;
        num--;
      }
      break;

    case 'k':
      unlink(fpath);
      return;
      break;

    default:
      return;
    }
  }
}


static void
p_read()
{
  switch (vans("â— é–±è®€ç•™è¨€ N)æ–°çš„ç•™è¨€ S)è¢«ä¿å­˜çš„ç•™è¨€ Q)å–æ¶ˆï¼Ÿ[Q] "))
  {
  case 'n':
    Pnote(1);
    break;

  case 's':
    Pnote(0);
    break;
  }
}


static void
p_call()
{
  ACCT acct;

  if (acct_get("æ‚¨æƒ³ç•™è¨€çµ¦èª°ï¼š", &acct) > 0)
  {
    pnote_hint(acct.userid);
    pnote_draw(acct.userid);
  }
}


static void
p_edithint()
{
  char fpath[64];

  switch (vans("â— ä¸»äººç•™è¨€ D)åˆªé™¤ E)éŒ„è£½ Q)å–æ¶ˆï¼Ÿ[Q] "))
  {
  case 'e':
    usr_fpath(fpath, cuser.userid, fn_pnote_hint);
    vedit(fpath, 0);
    vmsg("ç•™è¨€éŒ„è£½å®Œç•¢");
    break;

  case 'd':
    usr_fpath(fpath, cuser.userid, fn_pnote_hint);
    unlink(fpath);
    vmsg("ç•™è¨€åˆªé™¤å®Œç•¢");
    break;
  }
}


int
main_pnote()
{
  while (1)
  {
    switch (vans("â˜… å€‹äººç­”éŒ„æ©Ÿï¼šR)é–±è®€ç•™è¨€ C)éŒ„è£½ç•™è¨€ E)æ›´æ”¹å•å€™èª Q)é›¢é–‹ï¼Ÿ[Q] "))
    {
    case 'r':
      p_read();
      break;

    case 'c':
      p_call();
      break;

    case 'e':
      p_edithint();
      break;

    default:
      return 0;
    }
  }
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
