Áôº‰ø°‰∫∫: itoc.bbs@cpu.tfcis.org (Ê†∏ÂøÉÂãïÂäõ) ÁúãÊùø: plan
Ê®ô  È°å: Re: expire Â∞èÂäüËÉΩË´ãÊïô
Áôº‰ø°Á´ô: ÂãïÂäõÊ†∏ÂøÉ (2006/03/28 Tue 23:15:37)                Updated: 2006/04/18

‚Äª ÂºïËø∞„Ääcchhsu (AG)„Äã‰πãÈäòË®ÄÔºö
> Âú®ÊüêÂÄãÁ´ôÁúãÂà∞ Âú®ÊñáÁ´†Ââç Â§öÂÄãËã±ÊñáÊ®ôË®ò"A" ...
> ‰∏ÄÊÆµÊôÇÈñìÂæå ÈÇ£ÂÄãÊñáÁ´† Â∞±ÊúÉËá™ÂãïË¢´expire Á†çÊéâ‰∫Ü
> Ë´ãÂïè ÈÄôÊòØÊÄéÈ∫ºÂÅöÂà∞ÁöÑ ..

  Ë¢´Ê®ôÁ§∫ POST_REMOVE ÁöÑÊñáÁ´†Âú®‰∏âÂ§©ÂæåÊúÉËá™ÂãïË¢´Âà™Èô§

: hdr.h

- #define POST_16         0x00008000
+ #define POST_REMOVE     0x00008000

: post.c:post_attr()

  if (mode & POST_MARKED)
    attr |= 'M';
+ else if (mode & POST_REMOVE)
+   attr |= 'A';

: post.c:post_remove() Êñ∞Â¢ûÊ≠§ÂáΩÂºèÂú® post_mark() ÂæåÈù¢

static int
post_remove(xo)
  XO *xo;
{
  if (bbstate & STAT_BOARD)
  {
    HDR *hdr;
    int pos, cur;

    pos = xo->pos;
    cur = pos - xo->top;
    hdr = (HDR *) xo_pool + cur;

    hdr->xmode ^= POST_REMOVE;
    currchrono = hdr->chrono;
    rec_put(xo->dir, hdr, sizeof(HDR), xo->key == XZ_XPOST ?
      hdr->xid : pos, cmpchrono);

    move(3 + cur, 7);
    outc(post_attr(hdr));
  }
  return XO_NONE;
}

: post.c:post_cb[]
: post.c:xpost_cb[]

  'm', post_mark,
+ 'i', post_remove,

: expire.c

#define EXPIRE_LOG      "run/expire.log"
+ static time_t ystday;

: expire.c:main()

  init_bshm();
+ ystday = time(NULL) - 86400 * 3;   /* Âè™‰øùÁïô‰∏âÂ§© */

: expire.c:expire()

    if (hdr.xmode & (POST_MARKED | POST_BOTTOM) || total <= minp)
      keep = 1;
+   else if ((hdr.xmode & POST_REMOVE) && (hdr.chrono < ystday))
+     keep = 0;

--
[1;36m=[37m[[36mÔπé[37m:[33m?[37mÊëÉ?[m‚ó£?[1;33m?[37m:[36mÔπé [31mOrigin[37m ]|[[m  [0;31m?[1m?[1m?[0;31mO[0;31m?[1m?[1m?[0;31m?[1mcpu.tfcis.org  [37m]|[?[33mÊêüË™™[m?[1;36mÔπé[37m:][36m=[m
[1;36m=[0m[[1;36mÔπä[37m:[33m?[30mÊëÉ?[m‚ï±?[1;33m?[37m:[36mÔπä [31mAuthor[m ]|[[1m itoc.dorm11.nctu.edu.tw  [m]|[?[1;33m?[30m?[37mÊèí[30m?[36mÔπä[37m:[m][1;36m=[m
