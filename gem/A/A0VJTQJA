ä½œè€…: Kudo (æ·¡è›‹~~) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] expire å¯«é€² .BRD [transbrd.c]
æ™‚é–“: Thu Apr 11 04:20:41 2002                          Updated: 2005/05/19

/*-------------------------------------------------------*/
/* util/transbrd.c     ( NTHU CS MapleBBS Ver 3.10 )     */
/*-------------------------------------------------------*/
/* target : M3 çœ‹æ¿è½‰æ›ç¨‹å¼                              */
/* create : 02/03/10                                     */
/* update :   /  /                                       */
/* author : Kudo.bbs@kudo.twbbs.org                      */
/*-------------------------------------------------------*/
/* syntax : transbrd                                     */
/*-------------------------------------------------------*/


#if 0

  ä½¿ç”¨æ–¹æ³•ï¼š

  0. For Maple 3.X To Maple 3.X
  1. ä½¿ç”¨å‰è«‹å…ˆå‚™ä»½ .BRD
  2. make transbrd.c
  3. åŸ·è¡Œ transbrd, ç”¢ç”Ÿ BRD.NEW, è«‹è‡ªè¡Œ rename ç‚º .BRD
  4. è½‰æ›å®Œå¾Œï¼Œå°‡æ–°åŠ å…¥çš„æ¬„ä½ï¼ŒåŠ å…¥ struct.h è£¡
  5. å°‡å…¨éƒ¨ source make clean å¾Œé‡æ–° make

#endif


#include "bbs.h"

#define DEF_MAXP        3000          /* çœ‹æ¿æ–‡ç« é è¨­ä¸Šé™æ•¸é‡ */
#define DEF_MINP        500           /* çœ‹æ¿æ–‡ç« é è¨­ä¸‹é™æ•¸é‡ */
#define DEF_MAXT        365           /* çœ‹æ¿æ–‡ç« é è¨­ä¿ç•™å¤©æ•¸ */

typedef struct
{
  char bname[BNLEN + 1];        /* board ID */
  int days;                     /* expired days */
  int maxp;                     /* max post */
  int minp;                     /* min post */
}      Life;

struct NEW
{
  char brdname[BNLEN + 1];      /* board name */
  char title[BTLEN + 1];
  char BM[BMLEN + 1];           /* BMs' uid, token '/' */

  uschar bvote;                 /* å…±æœ‰å¹¾é …æŠ•ç¥¨èˆ‰è¡Œä¸­ */

  time_t bstamp;                /* å»ºç«‹çœ‹æ¿çš„æ™‚é–“, unique */
  usint readlevel;              /* é–±è®€æ–‡ç« çš„æ¬Šé™ */
  usint postlevel;              /* ç™¼è¡¨æ–‡ç« çš„æ¬Šé™ */
  usint battr;                  /* çœ‹æ¿å±¬æ€§ */
  time_t btime;                 /* .DIR çš„ st_mtime */
  int bpost;                    /* å…±æœ‰å¹¾ç¯‡ post */
  time_t blast;                 /* æœ€å¾Œä¸€ç¯‡ post çš„æ™‚é–“ */
  int maxpost;                /* æ–‡ç« ä¸Šé™ */
  int minpost;                /* æ–‡ç« ä¸‹é™ */
  int maxtime;                /* æ–‡ç« ä¿ç•™æ™‚é–“ */
};

typedef struct NEW NEW;

int
main()
{
  NEW new;
  BRD old;
  int fdr, fdw;
  int count = 0, number;
  char *ptr, *bname, buf[256];
  Life table[MAXBOARD];
  FILE *fp;

  setgid(BBSGID);
  setuid(BBSUID);
  chdir(BBSHOME);

  /* --------------------------------------------------- */
  /* load expire.ctl                                     */
  /* --------------------------------------------------- */

  if (fp = fopen(FN_ETC_EXPIRE, "r"))
  {
    while (fgets(buf, sizeof(buf), fp) && buf[0])
    {
      if (buf[0] < '0')
        continue;

      bname = (char *) strtok(buf, " \t\r\n");
      if (bname && *bname)
      {
        strcpy(table[count].bname, bname);

        ptr = (char *) strtok(NULL, " \t\r\n");
        if (ptr && (number = atoi(ptr)) > 0)
        {
          table[count].days = number;

          ptr = (char *) strtok(NULL, " \t\r\n");
          if (ptr && (number = atoi(ptr)) > 0)
          {
            table[count].maxp = number;

            ptr = (char *) strtok(NULL, " \t\r\n");
            if (ptr && (number = atoi(ptr)) > 0)
            {
              table[count].minp = number;
            }
          }
        }
        count++;
      }
    }
    fclose(fp);
  }
  number = count;      /* å€Ÿ number ä¾†å­˜è®€å‡ºä¾†çš„è³‡æ–™æ•¸ç›® */

  /* --------------------------------------------------- */
  /* create BRD.NEW                                      */
  /* --------------------------------------------------- */

  if ((fdr = open(FN_BRD, O_RDONLY)) < 0)
    exit(1);

  fdw = open("BRD.NEW", O_WRONLY | O_CREAT, 0600);

  while (read(fdr, &old, sizeof(BRD)) == sizeof(BRD))
  {
   strcpy(new.brdname, old.brdname);

   for (count = 0;; count++)
   {
     if (count > number)
     {
       table[count].days = DEF_MAXT;
       table[count].maxp = DEF_MAXP;
       table[count].minp = DEF_MINP;
       break;
     }

     if (strcmp(old.brdname, table[count].bname) != 0)
       continue;
     else
       break;
   }

   strcpy(new.title, old.title);
   strcpy(new.BM, old.BM);

   new.bvote = old.bvote;
   new.bstamp = old.bstamp;
   new.readlevel = old.readlevel;
   new.postlevel = old.postlevel;
   new.battr = old.battr;
   new.btime = old.btime;
   new.bpost = old.bpost;
   new.blast = old.blast;
   new.maxpost = (table[count].maxp > 0) ? table[count].maxp : DEF_MAXP;
   new.minpost = (table[count].minp > 0) ? table[count].minp : DEF_MINP;
   new.maxtime = (table[count].days > 0) ? table[count].days : DEF_MAXT;

   write(fdw, &new, sizeof(NEW));
  }
  close(fdr);
  close(fdw);

}

--
Chih-Kuan Chien (Kudo)
kudo@ms21.url.com.tw

--
[1;32mâ–¡ Origin: [33mæ·¡è›‹çš„å°çª© [37mbbs.kudo.idv.tw
[1;31mâ–¡ From: [36mwww.kudo.idv.tw[m
