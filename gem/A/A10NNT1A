ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] æ©‹ç‰Œæ‰“è­œ
æ™‚é–“: 2004/10/25 Mon 02:27:37                           Updated: 2004/10/25

: menu.c é©ç•¶çš„é¸å–®åŠ å…¥

  "bin/bridge.so:main_bridge", 0, - M_XMODE,
  "Bridge     â™‚ æ©‹ç‰Œæ‰“è­œ â™€",

: src/so/Makefile

SO =    .... [1;33mbridge[m

: src/so/bridge.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* bridge.c     ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : æ©‹ç‰Œæ‰“è­œ                                     */
/* create : 04/10/24                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

enum {NORTH, WEST, EAST, SOUTH, TOTAL_PLAYER};
enum {SPADE, HEART, DIAMOND, CLUB, TOTAL_SUIT};

#define SUIT_LEN        13      /* æ¯ç¨®èŠ±è‰² 13 å¼µç‰Œ */
#define CYCLE_MAX       10      /* å‡è¨­æ¯äººæœ€å¤šå« 10 æ¬¡ */

/* å„å®¶ç‰Œçš„åæ¨™ */
static const int XPOS[TOTAL_PLAYER] = {2, 6, 6, 10};
static const int YPOS[TOTAL_PLAYER] = {8, 0, 16, 8};

/* å«ç‰Œåæ¨™ */
static const int XPOS_BID = 6;
static const int YPOS_BID = 32;

static const char MSGPLAYER[TOTAL_PLAYER][3] = {"åŒ—", "è¥¿", "æ±", "å—"};
static const char MSGSUIT[TOTAL_PLAYER][5] = {"é»‘æ¡ƒ", "ç´…å¿ƒ", "ç£šå¡Š", "æ¢…èŠ±"};
static const char MSGPOINT[SUIT_LEN][3] = {"ï¼¡", "ï¼’", "ï¼“", "ï¼”", "ï¼•",
  "ï¼–", "ï¼—", "ï¼˜", "ï¼™", "ï¼´", "ï¼ª", "ï¼±", "ï¼«"};

static char cards[TOTAL_PLAYER][TOTAL_SUIT][SUIT_LEN + 1];
static char bids[TOTAL_PLAYER][CYCLE_MAX][3];
static char leader[3];
static char result[8];

static int Open;        /* é–‹å« */

static int Debug;       /* 1:æœƒæª¢æŸ¥è¼¸å…¥ç‰Œçµ„æ˜¯å¦æ­£ç¢º */


static int              /* 1:æ­£ç¢º */
valid_suit(str)         /* æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„è¼¸å…¥ */
  char *str;
{
  int ch;
  char *ptr;

  if (!Debug)
    return 1;

  ptr = str;
  while (ch = *ptr)
  {
    if (ch == 't' || ch == 'j' || ch == 'q' || ch == 'k' || ch == 'a')
      *ptr = ch & ~0x20;        /* æ›å¤§å¯« */
    else if (!(ch >= '2' && ch <= '9') &&
      !(ch == 'T' || ch == 'J' || ch == 'Q' || ch == 'K' || ch == 'A'))
      return 0;
    ptr++;
  }

  return 1;
}


static int
suit_cmp(a, b)          /* ç”±å¤§è‡³å°æ’åº */
  char *a;
  char *b;
{
  int ac, bc;

  ac = (*a == 'T') ? ('0' + 10) :
       (*a == 'J') ? ('0' + 11) :
       (*a == 'Q') ? ('0' + 12) :
       (*a == 'K') ? ('0' + 13) :
       (*a == 'A') ? ('0' + 14) :
       *a;
  bc = (*b == 'T') ? ('0' + 10) :
       (*b == 'J') ? ('0' + 11) :
       (*b == 'Q') ? ('0' + 12) :
       (*b == 'K') ? ('0' + 13) :
       (*b == 'A') ? ('0' + 14) :
       *b;

  return bc - ac;
}


static void
input_cards(echo)       /* è¼¸å…¥å„å®¶çš„ç‰Œ */
  int echo;
{
  int x, y;
  int player, suit;
  char msg[32], *str;

  for (player = 0; player < TOTAL_PLAYER; player++)
  {
    x = XPOS[player];
    y = YPOS[player] << 1;

    for (suit = 0; suit < TOTAL_SUIT; suit++)
    {
      move(x + suit, 0);
      clrtoeol();
      sprintf(msg, "%så®¶%sçš„ç‰Œå¼µï¼š", MSGPLAYER[player], MSGSUIT[suit]);
      str = cards[player][suit];

      do
      {
        vget(x + suit, y, msg, str, SUIT_LEN + 1, echo);
      } while (!valid_suit(str));

      if (Debug)
        qsort(str, strlen(str), sizeof(char), suit_cmp);
    }
  }
}


static int              /* 1:é 0:æ²’é */
check_cards()           /* æª¢æŸ¥å„å®¶çš„ç‰Œ */
{
  char total[TOTAL_SUIT][SUIT_LEN];
  int player, suit, ch, success;
  char msg[32], *ptr;

  if (!Debug)
    return 1;

  /* æª¢æŸ¥æ¯äººå¼µæ•¸ */

  for (player = 0; player < TOTAL_PLAYER; player++)
  {
    ch = 0;
    for (suit = 0; suit < TOTAL_SUIT; suit++)
      ch += strlen(cards[player][suit]);
    if (ch != TOTAL_SUIT * SUIT_LEN / TOTAL_PLAYER)
    {
      sprintf(msg, "%så®¶çš„ç¸½å¼µæ•¸ä¸å°", MSGPLAYER[player]);
      vmsg(msg);
    }
  }


  /* æª¢æŸ¥ç‰Œæ˜¯å¦æœ‰é‡è¦† */

  memset(total, 0, sizeof(total));

  for (player = 0; player < TOTAL_PLAYER; player++)
  {
    for (suit = 0; suit < TOTAL_SUIT; suit++)
    {
      ptr = cards[player][suit];
      while (ch = *ptr)
      {
        ch = (ch == 'T') ? (10 - 1) :
             (ch == 'J') ? (11 - 1) :
             (ch == 'Q') ? (12 - 1) :
             (ch == 'K') ? (13 - 1) :
             (ch == 'A') ? (1 - 1) :
             ch - '1';

        total[suit][ch]++;
        ptr++;
      }
    }
  }

  success = 1;
  for (suit = 0; suit < TOTAL_SUIT; suit++)
  {
    for (ch = 0; ch < SUIT_LEN; ch++)
    {
      player = total[suit][ch] - 1;      /* å€Ÿç”¨ player */
      if (player)
      {
        sprintf(msg, "%s%s %s %d å¼µ", MSGSUIT[suit], MSGPOINT[ch],
          player > 0 ? "å¤š" : "å°‘", abs(player));
        vmsg(msg);
        success = 0;
      }
    }
  }

  return success;
}


static void
outs_cards()            /* å°å‡ºå„å®¶çš„ç‰Œ */
{
  int x, y;
  int player, suit;
  char *str;

  move(1, 0);
  clrtobot();

  for (player = 0; player < TOTAL_PLAYER; player++)
  {
    x = XPOS[player];
    y = YPOS[player];

    for (suit = 0; suit < TOTAL_SUIT; suit++)
    {
      str = cards[player][suit];
      move(x + suit, y);
      outs(*str ? str : "-");
    }
  }
}


static int              /* 1:æ­£ç¢º */
valid_call(str)         /* æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„è¼¸å…¥ */
  char *str;
{
  int ch;

  /* å«å“åªæª¢æŸ¥ç­†èª¤ï¼Œè€Œä¸æª¢æŸ¥æ˜¯å¦æœ‰é‚è¼¯ä¸Šçš„éŒ¯èª¤(å¤ªè¤‡é›œ) */

  ch = str[0];
  if (!ch)      /* pass */
  {
    str[0] = '-';
    str[1] = '\0';
    return 1;
  }

  if (!Debug)
    return 1;

  if ((ch < '1' || ch > '7') && (ch != 'x' && ch != 'X'))
    return 0;
  if (ch == 'x')
    str[0] = 'X';       /* æ›å¤§å¯« */

  ch = str[1];
  if (ch != 'c' && ch != 'C' &&
      ch != 'd' && ch != 'D' &&
      ch != 'h' && ch != 'H' &&
      ch != 's' && ch != 'S' &&
      ch != 'n' && ch != 'N')
    return 0;
  str[1] = ch & ~0x20;  /* æ›å¤§å¯« */

  return 1;
}


static void
input_bids()
{
  int player, cycle, pass;
  char msg[32], *str;

  while (1)     /* å€Ÿç”¨ pass */
  {
    pass = vans("é–‹å«çš„æ˜¯ (1)åŒ— (2)æ± (3)å— (4)è¥¿ï¼š");
    if (pass < '1' || pass > '4')
      continue;
    Open = (pass == '1') ? NORTH :
           (pass == '2') ? EAST :
           (pass == '3') ? SOUTH :
                         WEST;
    break;
  }

  player = Open;
  cycle = 0;
  pass = -1;            /* ç¬¬ä¸€åœˆè¦å››å€‹äººéƒ½ pass æ‰çµæŸ */
  do
  {
    sprintf(msg, "%så®¶å«å“ (Enter=Pass)ï¼š", MSGPLAYER[player]);
    str = bids[player][cycle];

    do
    {
      vget(b_lines, 0, msg, str, 3, DOECHO);
    } while (!valid_call(str));

    if (str[0] == '-')
    {
      if (++pass >= 3)
        str[0] = '=';   /* æœ€å¾Œä¸€å®¶ */
    }
    else
      pass = 0;

    /* è¼ªä¸‹ä¸€å®¶å« */
    if (player == NORTH)
      player = EAST;
    else if (player == EAST)
      player = SOUTH;
    else if (player == SOUTH)
      player = WEST;
    else
      player = NORTH;

    if (player == Open)
    {
      if (++cycle >= CYCLE_MAX)
        return;
    }
  } while (pass < 3);

  /* Pass åˆ°çµæŸ */
  bids[player][cycle][0] = '\0';

  vget(b_lines, 0, "é¦–å¼•ï¼š", leader, 3, DOECHO);
  vget(b_lines, 0, "çµæœï¼š", result, 8, DOECHO);
}


static void
outs_bids()
{
  int x;
  int player, cycle;
  char *str;

  x = XPOS_BID;

  move(x++, YPOS_BID);
  outs(Open == NORTH ? "North   East    South   West" :
       Open == EAST  ? "East    South   West    North" :
       Open == SOUTH ? "South   West    North   East" :
                       "West    North   East    South");

  player = Open;
  cycle = 0;
  move(x++, YPOS_BID);
  while (1)
  {
    str = bids[player][cycle];
    if (!*str)          /* å°å®Œäº† */
      break;

    prints("%-8s", str);

    /* è¼ªä¸‹ä¸€å®¶å« */
    if (player == NORTH)
      player = EAST;
    else if (player == EAST)
      player = SOUTH;
    else if (player == SOUTH)
      player = WEST;
    else
      player = NORTH;

    if (player == Open)
    {
      if (++cycle >= CYCLE_MAX)
        break;
      move(x++, YPOS_BID);
    }
  }

  x += 2;
  move(x, YPOS_BID);
  prints("Leader: %-8sResult:%s", leader, result);
}


int
main_bridge()
{
  switch (vans("â—æ©‹ç‰Œæ‰“è­œ 1)å¸Œæœ› 2)ä¸å¸Œæœ› ç¨‹å¼æª¢æŸ¥è¼¸å…¥ç‰Œçµ„ [Q] "))
  {
  case '1':
    Debug = 1;
    break;
  case '2':
    Debug = 0;
    break;
  default:
    return XEASY;
  }

  do
  {
    vs_bar("æ©‹ç‰Œæ‰“è­œ");
    refresh();

    input_cards(DOECHO);
    while (!check_cards())      /* é‡æ–°è¼¸å…¥ */
    {
      vmsg("ç‰Œçµ„è¼¸å…¥æœ‰èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
      move(b_lines, 0);
      clrtoeol();
      input_cards(GCARRY);
    }

    input_bids();

    outs_cards();
    outs_bids();
  } while (vmsg("æŒ‰ q é›¢é–‹ï¼Œå…¶ä»–éµç¹¼çºŒæ‰“è­œ") != 'q');

  return 0;
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
