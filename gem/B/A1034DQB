ç™¼ä¿¡äºº: qazq.bbs@bbs.cs.nchu.edu.tw (è¡€åœ¨æ·Œ....è¡€åœ¨æµ...) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½] è§€å¯Ÿå…¨ç«™ä¿¡ç®±ä½¿ç”¨ç‹€æ³ã€‚
ç™¼ä¿¡ç«™: ä¸­èˆˆè³‡ç§‘ (Sat, 13 Sep 2003 11:51:19 +0800 (CST))  Updated: 2005/06/11

    æŠ„ WinTop çš„.... :p


    é€™å€‹ç¨‹å¼ï¼Œæœƒå°‡å…¨éƒ¨ä½¿ç”¨è€…çš„ä¿¡ç®±å…§çš„ä¿¡ä»¶æ•¸é‡ï¼Œä»¥åŠå…¨éƒ¨ä¿¡ä»¶çš„å¤§å°ï¼ˆï½‹ï½‚ï¼‰

    æ’åºå°å‡ºã€‚

    ç”¢ç”Ÿæª”æ¡ˆåœ¨ ~/gem/@/@-mailsize

    å¯ä»¥åœ¨ BBS ç«™å…§ç›´æ¥è§€çœ‹ã€‚


    å…¶å¯¦ï¼Œé€™çœŸçš„æ˜¯ä¸€å€‹è®Šæ…‹çš„åŠŸèƒ½....

    ç«™é•·éƒ½æŠŠä½¿ç”¨è€…çš„ç”Ÿæ…‹çœ‹çš„ä¸€æ¸…äºŒæ¥š....>"<


    å¦‚æœç«™å°çš„ä½¿ç”¨è€…è¨»å†Šäººæ•¸çœ¾å¤šï¼Œé‚£è·‘èµ·ä¾†æ‡‰è©²æ˜¯å¾ˆåƒè³‡æºçš„....^^a

==============================================================================

: src/util/Makefile

EXE =   ... [1;33mshowMailsize[m

: src/util/showMailsize.c   æ–°å¢ä¸‹é¢æ•´æ”¯ç¨‹å¼

/*-------------------------------------------------------*/
/* util/showMailsize.c  ( NTHU CS MapleBBS Ver 3.00 )    */
/*-------------------------------------------------------*/
/* target : è§€å¯Ÿå…¨ç«™ä¿¡ç®±ä½¿ç”¨ç‹€æ³                         */
/* create : 03/09/13                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw (util/topusr.c) */
/* modify : qazq.bbs@bbs.cs.nchu.edu.tw                  */
/*-------------------------------------------------------*/

#include "bbs.h"

#define OUTFILE_MAILSIZE    BBSHOME"/gem/@/@-mailsize"

typedef struct
{
  char userid[IDLEN + 1];
  int mailnum;
  int mailsize;
}      DATA;

static int i = 0;  /* ç´€éŒ„æœ‰å¹¾å€‹ USER */

static DATA *mail;


static int
sort_compare(p1, p2)
  const void *p1;
  const void *p2;
{
  int k;
  DATA *a1, *a2;

  a1 = (DATA *) p1;
  a2 = (DATA *) p2;

  k = a2->mailnum - a1->mailnum;
  return k ? k : str_cmp(a1->userid, a2->userid);

}


static void
write_data(fpath, title, data)
  char *fpath;
  char *title;
  DATA *data;
{
  FILE *fp;
  char buf[256];
  int j;

  if (!(fp = fopen(fpath, "w")))
    return;

  j = 12 - (strlen(title) >> 1);
  sprintf(buf, " \033[1;33mâ—‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ "
    "\033[41m%%%ds%%s%%%ds"
    "\033[40m â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—‹\033[m\n\n", j, j);
  fprintf(fp, buf, "", title, "");

  for (j = 0; j < i; j++)
  {
    fprintf(fp, "[%3d] %-13s %3d å°   %5d ï½‹\n", j + 1,
      data[j].userid, data[j].mailnum, data[j].mailsize);
  }

  fprintf(fp, "\n");
  fclose(fp);
}


static int
mail_size(cuser)
  ACCT cuser;
{
  int fd, fsize,total;
  struct stat st;
  HDR *head, *tail;
  char *base, *folder, fpath[80], mbox_dir[64];


  usr_fpath(mbox_dir, cuser.userid, FN_DIR);

  if ((fd = open(folder = mbox_dir, O_RDWR)) < 0)
    return 0;

  fsize = 0;
  total = 0;

  if (!fstat(fd, &st) && (fsize = st.st_size) >= sizeof(HDR) &&
    (base = (char *) malloc(fsize)))
  {
    f_exlock(fd);

    if ((fsize = read(fd, base, fsize)) >= sizeof(HDR))
    {
      head = (HDR *) base;
      tail = (HDR *) (base + fsize);

      do
      {
        if(head->xid > 0)
        {
          total += head->xid;
        }
        else
        {
          hdr_fpath(fpath, folder, head);
          stat(fpath, &st);
          total += st.st_size;
          head->xid = st.st_size;
        }
      } while (++head < tail);

    }

    lseek(fd, (off_t) 0, SEEK_SET);
    write(fd, base, fsize);
    ftruncate(fd, fsize);
    f_unlock(fd);

    free(base);
  }

  close(fd);

  return total;
}

static inline void
topusr(cuser)
  ACCT cuser;
{
  char buf[64];

  str_ncpy(mail[i].userid, cuser.userid, sizeof(mail[i].userid));

  usr_fpath(buf, cuser.userid, FN_DIR);
  mail[i].mailnum = rec_num(buf, sizeof(HDR));

  mail[i].mailsize = mail_size(cuser) / 1024;

  i++;
}

/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main()
{
  int numuser;          /* ç¸½å…±æœ‰å¹¾å€‹è¨»å†Šå¸³è™Ÿ */
  char c;

  chdir(BBSHOME);
  numuser = rec_num(FN_SCHEMA, sizeof(SCHEMA)) + 100;
                                              /* åŠ  100 ä»¥å…å‰›å¥½æœ‰äººè¨»å†Š */
  mail = (DATA *) malloc(sizeof(DATA) * numuser);
  memset(mail, 0, sizeof(DATA) * numuser);

  for (c = 'a'; c <= 'z'; c++)
  {
    char buf[64], fpath[64];
    struct dirent *de;
    DIR *dirp;

    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      ACCT cuser;
      int fd;
      char *fname;

      fname = de->d_name;
      if (*fname <= ' ' || *fname == '.')
        continue;

      sprintf(fpath, "%s/.ACCT", fname);
      if ((fd = open(fpath, O_RDONLY)) < 0)
        continue;

      read(fd, &cuser, sizeof(cuser));
      close(fd);

      chdir(BBSHOME);       /* æ›åˆ°æ ¹ç›®éŒ„ï¼Œçµ¦ usr_fpath() ç”¨ */
      topusr(cuser);
      chdir(buf);           /* æ›å›åˆ° user ç›®éŒ„ */
    }

    closedir(dirp);
  }

  qsort(mail, numuser, sizeof(DATA), sort_compare);
  write_data(OUTFILE_MAILSIZE, "ä¿¡ç®±å®¹é‡æ’è¡Œæ¦œ", mail);

  return 0;
}

--
 [1m[42mâ”Œ[41mâ”¼[m Au[1mth[30mor[m: [43m ä¸­èˆˆè³‡ç§‘Ë™ä¸­èˆˆè³‡ç§‘ ï½…è³‡ç¨ç§€ [33;47m csNCHU.twbbs.org [m
 [1m[44mâ””[43mâ”˜[m O[1mri[30mgi[mn: [1;36mqazq [30må¾ [35m61-216-137-121.HINET-IP.hinet.net [30mç™¼è¡¨[m
