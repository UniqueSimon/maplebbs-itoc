ä½œè€…: itoc (æ ¸å¿ƒå‹•åŠ›) ç«™å…§: itoc
æ¨™é¡Œ: Re: è«‹å•rpgå†’éšªè€…çš„æ’è¡Œæ¦œæ‡‰è©²æ€éº¼åšå‘¢???
æ™‚é–“: 2004/10/25 Mon 23:55:04                           Updated: 2004/10/26

â€» å¼•è¿°ã€Šcomfan (é›£é  å‚·å¿ƒ)ã€‹ä¹‹éŠ˜è¨€ï¼š
> wdçš„rpgè§’è‰²æ‰®æ¼”éŠæˆ²è£¡é¢æœ‰ä¸€å€‹å­é¸å–® [L]istTop    ä½¿ç”¨è€…æ’è¡Œæ¦œ
> é€²å…¥è©²é¸å–®ä¹‹å¾Œ   çœ‹åˆ°çš„æ˜¯ä¸‹åˆ—çš„ç•«é¢   ä¸çŸ¥é“åœ¨Mapleè£¡é¢æ˜¯å¦ä¹Ÿæœ‰è¾¦æ³•åšå‡º
> åƒç«™ä¸Šrpgä½¿ç”¨è€…çš„æ’è¡Œæ¦œé¡ä¼¼çš„åŠŸèƒ½

  åœ¨æœ¬ä¾‹ä¸­åªæ’è¡Œ maxhp åŠ str æ¬„ä½
  æƒ³çŸ¥é“æœ‰å“ªäº›æ¬„ä½ï¼Œè«‹åƒè€ƒ rpg.h

  åœ¨ (A)nnounce è£¡é¢æ–°å¢è³‡æ–™ï¼Œè·¯å¾‘ç‚º -rpgmaxhp åŠ -rpgstr

: crontab -e åŠ å…¥é€™äºŒè¡Œ

# æ¯å¤©ä½œäºŒæ¬¡ RPG æ’è¡Œ
35 3,15 * * * * bin/toprpg > /dev/null 2>&1

: src/util/Makefile

EXE =   ... [1;33mtoprpg[m

: src/util/toprpg.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/toprpg.c        ( NTHU CS MapleBBS Ver 3.00 )    */
/*-------------------------------------------------------*/
/* target : ä½¿ç”¨è€… RPG è³‡æ–™çµ±è¨ˆåŠæ’å                    */
/* create : 04/10/25                                     */
/* update :   /  /                                       */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


[1;44m// é‚„è¦çµ±è¨ˆåˆ¥çš„æ¬„ä½çš„è©±ï¼Œé€™è£¡åŠ ä¸€è¡Œæª”æ¡ˆè·¯å¾‘ [m
[1;44m// ä¸¦åœ¨ (A)nnounce æ–°å¢ã€Œè³‡æ–™ã€æŒ‡å‘é€™äº›æª”æ¡ˆ [m
#define OUTFILE_RPGMAXHP BBSHOME"/gem/@/@-rpgmaxhp"
#define OUTFILE_RPGSTR   BBSHOME"/gem/@/@-rpgstr"


/*-------------------------------------------------------*/
/* author : mat.bbs@fall.twbbs.org                       */
/* modify : gslin@abpe.org                               */
/*-------------------------------------------------------*/


#define TOPNUM          (36)
#define TOPNUM_HALF     (TOPNUM/2)


typedef struct
{
  char userid[IDLEN + 1];
  char username[UNLEN + 1];
  int num;
}      DATA;

[1;44m// é‚„è¦çµ±è¨ˆåˆ¥çš„æ¬„ä½çš„è©±ï¼Œé€™è£¡åŠ ä¸€å€‹å®£å‘Š [m
static DATA topmaxhp[TOPNUM];
static DATA topstr[TOPNUM];


static int
sort_compare(p1, p2)
  const void *p1;
  const void *p2;
{
  DATA *a1, *a2;

  a1 = (DATA *) p1;
  a2 = (DATA *) p2;

  return (a2->num - a1->num);
}


static DATA *
findmin(src)
  DATA *src;
{
  int i;
  DATA *p;

  p = src;
  for (i = 0; i < TOPNUM; i++)
  {
    if (src[i].num < p->num)
      p = src + i;
  }
  return p;
}


static void
merge_id_nick(dst, userid, nick)
  char *dst;
  char *userid;
  char *nick;
{
  if (*userid)
  {
    sprintf(dst, "%s (%s)", userid, nick);

    if (strlen(dst) > 25)
      dst[25] = 0;
  }
  else
    dst[0] = 0;
}


static void
write_data(fpath, title, data)
  char *fpath;
  char *title;
  DATA *data;
{
  FILE *fp;
  char buf[256];
  int i, num1, num2;

  if (!(fp = fopen(fpath, "w")))
    return;

  i = 12 - (strlen(title) >> 1);
  sprintf(buf, " \033[1;33mâ—‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ \033[41m%%%ds%%s%%%ds"
    "\033[40m â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—‹\033[m\n\n", i, i);
  fprintf(fp, buf, "", title, "");

  fprintf(fp,
    "\033[1;37måæ¬¡  \033[33mä»£è™Ÿ(æš±ç¨±)                \033[36mæ•¸é‡\033[m   "
    "\033[1;37måæ¬¡  \033[33mä»£è™Ÿ(æš±ç¨±)                \033[36mæ•¸é‡\033[m\n"
    "\033[1;32m%s\033[m\n", MSG_SEPERATOR);

  for (i = 0; i < TOPNUM_HALF; i++)
  {
    char buf1[80], buf2[80];

    merge_id_nick(buf1, data[i].userid, data[i].username);
    merge_id_nick(buf2, data[i + TOPNUM_HALF].userid,
      data[i + TOPNUM_HALF].username);

    /* itoc.010408: è§£æ±ºéŒ¢å¤ªå¤šï¼Œç•«é¢çˆ†æ‰çš„å•é¡Œ */
    num1 = data[i].num / 1000000;
    num2 = data[i + TOPNUM_HALF].num / 1000000;
    if (num2)                   /* é‚£éº¼ data[i].num ä¹Ÿå¿…å®š > 10^6 */
    {
      fprintf(fp, "[%2d] %-25s %5dM  [%2d] %-25s %5dM\n", i + 1, buf1, num1,
        i + 1 + TOPNUM_HALF, buf2, num2);
    }
    else if (num1)
    {
      fprintf(fp, "[%2d] %-25s %5dM  [%2d] %-25s %6d\n", i + 1, buf1, num1,
        i + 1 + TOPNUM_HALF, buf2, data[i + TOPNUM_HALF].num);
    }
    else
    {
      fprintf(fp, "[%2d] %-25s %6d  [%2d] %-25s %6d\n",
        i + 1, buf1, data[i].num,
        i + 1 + TOPNUM_HALF, buf2, data[i + TOPNUM_HALF].num);
    }
  }

  fprintf(fp, "\n");
  fclose(fp);
}


static inline void
topusr(acct)
  ACCT *acct;
{
  DATA *p;
  int fd;
  char fpath[64];
  RPG rpg;

  sprintf(fpath, "%s/"FN_RPG, acct->userid);
  if ((fd = open(fpath, O_RDONLY)) < 0)
    return;
  read(fd, &rpg, sizeof(RPG));
  close(fd);

  [1;44m// é‚„è¦çµ±è¨ˆåˆ¥çš„æ¬„ä½çš„è©±ï¼Œé€™è£¡åŠ ä¸€å€‹ if (...) {...} å…±å…­è¡Œ [m

  if ((p = findmin(&topmaxhp))->num < rpg.maxhp)
  {
    str_ncpy(p->userid, acct->userid, sizeof(p->userid));
    str_ncpy(p->username, acct->username, sizeof(p->username));
    p->num = rpg.maxhp;
  }

  if ((p = findmin(&topstr))->num < rpg.str)
  {
    str_ncpy(p->userid, acct->userid, sizeof(p->userid));
    str_ncpy(p->username, acct->username, sizeof(p->username));
    p->num = rpg.str;
  }
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main()
{
  char c;
  int year, month, day;
  time_t now;
  struct tm *ptime;

  [1;44m// é‚„è¦çµ±è¨ˆåˆ¥çš„æ¬„ä½çš„è©±ï¼Œé€™è£¡åŠ ä¸€è¡Œ [m
  memset(&topmaxhp, 0, sizeof(topmaxhp));
  memset(&topstr, 0, sizeof(topstr));

  now = time(NULL);
  ptime = localtime(&now);

  year = ptime->tm_year;
  month = ptime->tm_mon + 1;
  day = ptime->tm_mday;

  for (c = 'a'; c <= 'z'; c++)
  {
    char buf[64];
    struct dirent *de;
    DIR *dirp;

    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      ACCT acct;
      int fd;
      char *fname;

      fname = de->d_name;
      if (*fname <= ' ' || *fname == '.')
        continue;

      sprintf(buf, "%s/.ACCT", fname);
      if ((fd = open(buf, O_RDONLY)) < 0)
        continue;

      read(fd, &acct, sizeof(ACCT));
      close(fd);

      topusr(&acct);
    }

    closedir(dirp);
  }

  [1;44m// é‚„è¦çµ±è¨ˆåˆ¥çš„æ¬„ä½çš„è©±ï¼Œé€™è£¡åŠ äºŒè¡Œ [m

  qsort(topmaxhp, TOPNUM, sizeof(DATA), sort_compare);
  write_data(OUTFILE_RPGMAXHP, "ï¼²ï¼°ï¼§è¡€ç‰›æ’è¡Œæ¦œ", &topmaxhp);

  qsort(topstr, TOPNUM, sizeof(DATA), sort_compare);
  write_data(OUTFILE_RPGSTR, "ï¼²ï¼°ï¼§åŠ›å£«æ’è¡Œæ¦œ", &topstr);

  return 0;
}


--
 [1;41mâ•­[44mâ”¼[m Or[1mig[30min[m: [43m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [35;47m processor.tfcis.org [m
 [1;42mâ”¼[45mâ”˜[m A[1mut[30mho[mr: [1;31mitoc [30må¾ [36mitoc.Dorm11.NCTU.edu.tw [30mç™¼è¡¨[m
