ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] ä¿¡ä»¶è‡ªå‹•è½‰å¯„åˆ°å¤–ç«™ Internet ä¿¡ç®±
æ™‚é–“: 2006/03/31 Fri 09:23:38                           Updated: 2006/03/31

â€» å¼•è¿°ã€Šguessi.bbs@bbs.ee.ndhu.edu.tw (æ²’)ã€‹ä¹‹éŠ˜è¨€ï¼š
> æƒ³å¯«ä¸€å€‹åŠŸèƒ½"è‡ªå‹•è½‰å¯„" ç•¶ä½¿ç”¨è€…æ”¶å–ä¿¡ä»¶æ™‚è‡ªå‹•è½‰å¯„åˆ°ç«™å¤–ä¿¡ç®± (é¡ä¼¼æ–¼å‚™ä»½?)

  è¨­å®šå¤–éƒ¨ä¿¡ç®±

: global.h

#define FN_ACL          "acl"           /* ä¸Šç«™åœ°é»è¨­å®š */
+ #define FN_FORWARD    "forward"       /* è‡ªå‹•è½‰å¯„è¨­å®š */

: maple.p åŠ ä¸€è¡Œ

+ int m_setforward(void);

: menu.c é©ç•¶çš„é¸å–®åŠ å…¥é€™é¸é …

+ m_setforward, PERM_BASIC, M_SMAIL,
+ "AutoForwardâ”œ è‡ªå‹•è½‰å¯„ â”¤",

: mail.c:m_setforward() åœ¨ mail_hold() å¾Œé¢æ–°å¢é€™å€‹å‡½å¼

int
m_setforward()
{
  char fpath[64], ip[50];
  FILE *fp;

  usr_fpath(fpath, cuser.userid, FN_FORWARD);
  if (fp = fopen(fpath, "r"))
  {
    fscanf(fp, "%s", ip);
    fclose(fp);
  }
  else
  {
    ip[0] = '\0';
  }

  vget(b_lines - 1, 0, "è«‹è¼¸å…¥ä¿¡ä»¶è‡ªå‹•è½‰å¯„çš„ E-mailï¼š", ip, 50, GCARRY);

  if (ip[0] && !not_addr(ip) &&
    vans("ç¢ºå®šé–‹å•Ÿè‡ªå‹•è½‰ä¿¡åŠŸ\èƒ½(Y/N)ï¼Ÿ[N] ") == 'y')
  {
    if (fp = fopen(fpath, "w"))
    {
      fprintf(fp, "%s", ip);
      fclose(fp);
      vmsg("è¨­å®šå®Œæˆ");
      return XEASY;
    }
  }

  unlink(fpath);
  vmsg("å–æ¶ˆè‡ªå‹•è½‰å¯„æˆ–ç„¡æ•ˆ E-mail");
  return XEASY;
}

> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ <

  è½‰å¯„ç«™å…§ä¾†ä¿¡è‡³å¤–éƒ¨ä¿¡ç®±

: mail.c:forward_mail() åœ¨ mail_send() å‰é¢æ–°å¢é€™å€‹å‡½å¼

/* cuser.userid å°‡ã€Œæ¨™é¡Œ titleã€æª”æ¡ˆåœ¨ fpathã€çš„ä¿¡ä»¶å¯„çµ¦ userid çš„å¤–éƒ¨ä¿¡ç®± */
static void
forward_mail(fpath, userid, title)
  char *fpath, *userid, *title;
{
  FILE *fp;
  char ip[80];

  usr_fpath(ip, userid, FN_FORWARD);
  if (fp = fopen(ip, "r"))
  {
    fscanf(fp, "%s", ip);
    fclose(fp);

    if (ip[0])
      bsmtp(fpath, title, ip, 0);
  }
}

: mail.c:mail_send()

    rec_add(folder, &hdr, sizeof(HDR));
+   forward_mail(fpath, rcpt, ve_title);

: mail.c:multi_send()

        rec_add(buf, &hdr, sizeof(HDR));
+       forward_mail(fpath, userid, title);

> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ <

  è½‰å¯„ç«™å¤–ä¾†ä¿¡è‡³å¤–éƒ¨ä¿¡ç®±

: bmtad.c:forward_mail() åœ¨ bbs_mail() å‰é¢æ–°å¢é€™å€‹å‡½å¼

/* hdr->owner å°‡ã€Œæ¨™é¡Œ hdr->titleã€æª”æ¡ˆåœ¨ folder ä¸‹ hdr->xnameã€
   çš„ä¿¡ä»¶å¯„çµ¦ userid çš„å¤–éƒ¨ä¿¡ç®± */

static void
forward_mail(hdr, folder, userid)
  HDR *hdr;
  char *folder;
  char *userid;
{
  FILE *fp;
  char ip[80], fpath[64];

  usr_fpath(ip, userid, FN_FORWARD);
  if (fp = fopen(ip, "r"))
  {
    fscanf(fp, "%s", ip);
    fclose(fp);

    if (ip[0])
    {
      hdr_fpath(fpath, folder, hdr);
      bbsmtp(fpath, hdr->title, ip, hdr->owner);
    }
  }
}

: bmtad.c:bbs_mail()

  rec_add(folder, &hdr, sizeof(HDR));
+ forward_mail(&hdr, folder, userid);

: bmtad.c:bbsmtp() åœ¨ forward_mail() å‰é¢æ–°å¢é€™å€‹å‡½å¼

static int                              /* >=0:æˆåŠŸ <0:å¤±æ•— */
bbsmtp(fpath, title, rcpt, sender)      /* å¾ bsmtp() æŠ„ä¾†çš„ */
  char *fpath, *title, *rcpt, *sender;
{
  int sock;
  time_t stamp;
  FILE *fp, *fr, *fw;
  char *str, buf[512], from[80], msgid[80];
  ACCT acct;

  if (acct_fetch(sender, &acct) < 0)
    return -1;

  time(&stamp);
  sprintf(from, "%s.bbs@%s", acct.userid, MYHOSTNAME);

  str = strchr(rcpt, '@') + 1;
  sock = dns_smtp(str);
  if (sock >= 0)
  {
    sleep(1);                   /* wait for mail server response */

    fr = fdopen(sock, "r");
    fw = fdopen(sock, "w");

    fgets(buf, sizeof(buf), fr);
    if (memcmp(buf, "220", 3))
      goto smtp_error;
    while (buf[3] == '-')
      fgets(buf, sizeof(buf), fr);

    fprintf(fw, "HELO %s\r\n", MYHOSTNAME);
    fflush(fw);
    do
    {
      fgets(buf, sizeof(buf), fr);
      if (memcmp(buf, "250", 3))
        goto smtp_error;
    } while (buf[3] == '-');

    fprintf(fw, "MAIL FROM:<%s>\r\n", from);
    fflush(fw);
    do
    {
      fgets(buf, sizeof(buf), fr);
      if (memcmp(buf, "250", 3))
        goto smtp_error;
    } while (buf[3] == '-');

    fprintf(fw, "RCPT TO:<%s>\r\n", rcpt);
    fflush(fw);
    do
    {
      fgets(buf, sizeof(buf), fr);
      if (memcmp(buf, "250", 3))
        goto smtp_error;
    } while (buf[3] == '-');

    fprintf(fw, "DATA\r\n", rcpt);
    fflush(fw);
    do
    {
      fgets(buf, sizeof(buf), fr);
      if (memcmp(buf, "354", 3))
        goto smtp_error;
    } while (buf[3] == '-');

    /* ------------------------------------------------- */
    /* begin of mail header                              */
    /* ------------------------------------------------- */

    archiv32(stamp, msgid);

    /* Thor.990125: å„˜å¯èƒ½çš„åƒ RFC 822 åŠ sendmail çš„ä½œæ³•, å…å¾—åˆ¥äººä¸æ¥:p */
    fprintf(fw, "From: \"%s\" <%s>\r\nTo: %s\r\n",
      acct.username, from, rcpt);
    /* itoc.030411: mail è¼¸å‡º RFC 2047 */
    output_rfc2047_qp(fw, "Subject: ", title, MYCHARSET, "\r\n");
    /* itoc.030323: mail è¼¸å‡º RFC 2045 */
    fprintf(fw, "X-Sender: %s (%s)\r\n"
      "Date: %s\r\nMessage-Id: <%s@%s>\r\n"
      "Mime-Version: 1.0\r\n"
      "Content-Type: %s; charset=%s\r\n"
      "Content-Transfer-Encoding: 8bit\r\n"
      "X-Disclaimer: [%s] å°æœ¬ä¿¡å…§å®¹æ•ä¸è² è²¬\r\n\r\n",
      acct.userid, acct.username,
      Atime(&stamp), msgid, MYHOSTNAME,
      "text/plain", MYCHARSET,
      str_site);

    /* ------------------------------------------------- */
    /* begin of mail body                                */
    /* ------------------------------------------------- */

    if (fp = fopen(fpath, "r"))
    {
      char *ptr;

      str = buf;
      *str++ = '.';
      while (fgets(str, sizeof(buf) - 3, fp))
      {
        if (ptr = strchr(str, '\n'))
        {
          *ptr++ = '\r';
          *ptr++ = '\n';
          *ptr = '\0';
        }
        fputs((*str == '.' ? buf : str), fw);
      }
      fclose(fp);
    }
#ifdef HAVE_SIGNED_MAIL
    if (!rec_get(FN_RUN_PRIVATE, buf, 8, 0))
    {
      time_t prichro;

      buf[8] = '\0';    /* Thor.990413: buf ç”¨ä¸åˆ°äº†ï¼Œå€Ÿä¾†ç”¨ç”¨ */
      prichro = chrono32(buf);
      archiv32(str_hash(msgid, prichro), buf);
      fprintf(fw,"â€» X-Sign: %s$%s %s\r\n",
        msgid, genpasswd(buf), Btime(&stamp));
    }
#endif
    fputs("\r\n.\r\n", fw);
    fflush(fw);

    fgets(buf, sizeof(buf), fr);
    if (memcmp(buf, "250", 3))
      goto smtp_error;

    fputs("QUIT\r\n", fw);
    fflush(fw);
    fclose(fw);
    fclose(fr);
    goto smtp_log;

smtp_error:

    /* itoc.041128.è¨»è§£: å‡¡æ˜¯èµ°åˆ°é€™è£¡çš„ï¼Œbuf æ˜¯å°æ–¹å›è¦†çš„éŒ¯èª¤è¨Šæ¯ */
    fclose(fr);
    fclose(fw);
    sprintf(from, "\t%.70s\n", buf);
    sock = -1;
  }
  else
  {
    strcpy(from, "\tSMTP é€£ç·šå¤±æ•—\n");
  }

smtp_log:

  /* --------------------------------------------------- */
  /* è¨˜éŒ„å¯„ä¿¡                                            */
  /* --------------------------------------------------- */

  sprintf(buf, "%s %-13s%c> %s\n%s\t%s\n\t%s\n",
    Btime(&stamp), acct.userid, '-', rcpt,
    sock >= 0 ? "" : from, title, fpath);
  f_cat(FN_RUN_MAIL_LOG, buf);

  return sock;
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
