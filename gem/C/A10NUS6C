ç™¼ä¿¡äºº: waynesan.bbs@csc241.twbbs.org (æ­å–œè¿·å¹»ç¾å·¥ç«™é•·çš®?çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠ å¼·] money.c çé‡‘ç³»çµ±-ç™¼çé‡‘çµ¦ä½œè€…
ç™¼ä¿¡ç«™: è¿·å¹»åœ‹åº¦ (2004/08/08 Sun 18:18:43)                Updated: 2005/09/16

â€» å¼•è¿°ã€ŠTitan.bbs@xeon.tfcis.org (ä¾†åƒè§€çš„)ã€‹ä¹‹éŠ˜è¨€ï¼š
>         å¯ä»¥å°æŠ•ç¨¿å‹•æ…‹çœ‹æ¿æˆ–æ˜¯æ­Œæœ¬è€…çµ¦é…¬å‹å—??

åœ¨æ–‡ç« åˆ—è¡¨ç™¼æ”¾çé‡‘çµ¦æ–‡ç« ä½œè€…

: post.c:post_cb[]

  Ctrl('O'), xo_usetup,
+ Ctrl('S'), post_award,

: post.c:xpost_cb[]

  Ctrl('O'), xo_usetup,
+ Ctrl('S'), post_award,

: post.c:post_award() æ–°å¢ä»¥ä¸‹å‡½å¼æ–¼ post_help() å‰é¢

static void
send_him_mail(user, gold, money) /* itoc.011115: å¯„æª”æ¡ˆçµ¦ userid */
  char *userid;        /* æ”¶ä»¶äºº */
  int gold, money;
{
  char folder[64], fpath[64];
  HDR hdr;
  FILE *fp;

  sprintf(fpath, "tmp/award.%d", userid);
  if (fp = fopen(fpath, "w"))
  {
    /* æ–‡ç« æª”é ­ */
    fprintf(fp, "%s %s (%s)\n", str_author1, cuser.userid, cuser.username);
    fprintf(fp, "æ¨™é¡Œ: ç™¼æ”¾çé‡‘\næ™‚é–“: %s\n\n", Now());

    /* æ–‡ç« å…§å®¹ */
    fprintf(fp, "%s ç™¼çµ¦æ‚¨ é‡‘ %d éŠ€ %d\n", cuser.userid, gold, money);
    fclose(fp);

    mail_him(fpath, userid, "ç™¼æ”¾çé‡‘", 0);

    unlink(fpath);
  }
}


static int
post_award(xo)      /* ç›´æ¥ç™¼çé‡‘çµ¦ä½œè€… */
  XO *xo;
{
  if (HAS_PERM(PERM_ALLACCT))
  {
    int money, gold;
    char *userid, buf[80];
    HDR *hdr;
    PAYCHECK paycheck;

    hdr = (HDR *) xo_pool + (xo->pos - xo->top);
    userid = hdr->owner;
    if (strchr(userid, '.'))
      return XO_NONE;
    usr_fpath(buf, userid, NULL);
    if (!dashd(buf))            /* é¿å…è©² ID è¢«åˆªé™¤äº† */
      return XO_NONE;

    if (vget(b_lines, 0, "ç™¼çµ¦å¤šå°‘éŠ€å¹£ï¼š", buf, 7, DOECHO) &&
      (money = atoi(buf)) >= 0   /* å¯ä»¥è¼¸å…¥ 0 */ &&
      vget(b_lines, 0, "ç™¼çµ¦å¤šå°‘é‡‘å¹£ï¼š", buf, 7, DOECHO) &&
      (gold = atoi(buf)) >= 0    /* å¯ä»¥è¼¸å…¥ 0 */ &&
      (money || gold))
    {
      memset(&paycheck, 0, sizeof(PAYCHECK));
      time(&paycheck.tissue);
      paycheck.money = money;
      paycheck.gold = gold;
      sprintf(paycheck.reason, "[ç¨¿è²»] %s", cuser.userid);

      usr_fpath(buf, userid, FN_PAYCHECK);
      rec_add(buf, &paycheck, sizeof(PAYCHECK));

      send_him_mail(userid, gold, money);

      sprintf(buf, "ç™¼çµ¦ %s é‡‘ %d éŠ€ %d", userid, gold, money);
      vmsg(buf);
    }

    return XO_FOOT;
  }
  return XO_NONE;
}

--
    [1;31m??[m
  [1;31mï¼  [37mï¼[34mâ–”â–”ï¼¼  [31mè¿·[34må¹»[37måœ‹åº¦[31m Charming [34mShadow [37mCountry[m
[1;31mâ–•  [37mï¼[31m  [37mï¼ï¼¼  [34mâ–[33må…¥å¢ƒä½å€ csc241.twbbs.org[m
[1;31mâ–•  [37mï¼¼ï¼[31m  [37mï¼  [34mâ–[32mä½å€ä»£ç¢¼ 203.71.212.241[m
[1;31m  ï¼¼??[37mï¼[31m  [34mï¼  [36mä¾†æºæ¯åœ‹ 218-163-194-130.dynamic.hinet.net[m
[1;31m  [4mï¼ã€€ã€€[34mâ–”â–”ï¼¼[;1;31m  ç™¼è¡¨æ™‚é–“ 2004/08/08 Sun 12:11:15[m
