ç™¼ä¿¡äºº: itoc.bbs@processor.tfcis.org (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: è«‹å•é—œæ–¼é›…è™ï¼å¥‡æ‘©çš„æ–°èåŠŸèƒ½
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2004/02/12 Thu 12:45:28)                Updated: 2006/08/12

  è¦å…ˆåšç²¾è¯å€é€™ç¯‡
  [åŠŸèƒ½] enews-open.c å¥‡æ‘©æ–°èè½‰è‡³çœ‹æ¿

: menu.c é©ç•¶é¸å–®åŠ å…¥

+ "bin/enews.so:main_enews", 0, - M_GAME,
+ "Enews       å¥‡æ‘©æ–°è",

: theme.h

#define FOOTER_VEDIT    \
COLOR1 " %s " COLOR2 " (^Z)èªªæ˜ (^W)ç¬¦è™Ÿ (^L)é‡ç¹ª (^X)æª”æ¡ˆè™•ç† ... \033[m"

+ #define FOOTER_ENEWS   \
+ COLOR1 " å¥‡æ‘©æ–°è " COLOR2 " (kj)ä¸Šä¸‹ç¯‡ (â†‘â†“â†)ä¸Šä¸‹é›¢é–‹             "
+ "                           "

  ...
  ...

#define FEETER_INNBBS   \
COLOR1 " è½‰ä¿¡è¨­å®š " COLOR2 " (â†‘/â†“)ä¸Šä¸‹ (PgUp/PgDn)ä¸Šä¸‹é  ... "

+ #define FEETER_ENEWS \
+ COLOR1 " å¥‡æ‘©æ–°è " COLOR2 " (æ–¹å‘)ç§»å‹• (å­—æ¯/æ•¸å­—)é …ç›®/ç¯‡æ•¸ " \
+ "(ENTER)ç€è¦½ (F/x) è½‰å¯„/è½‰éŒ„ (q)é›¢é–‹ "

: game/Makefile

SO =     ..... [1;33menews.so[m

: game/enews.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* enews.c  ( NTHU CS MapleBBS Ver 3.10 )                */
/*-------------------------------------------------------*/
/* target : Yahoo! å¥‡æ‘©æ–°è                              */
/* create : 02/01/27                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#if 0

 æœ¬å¥‡æ‘©æ–°èç¨‹å¼éœ€è¦é…åˆ enews-open å»æŠ“è³‡æ–™ï¼Œcrontab å¦‚ä¸‹ï¼š

# æ¯å¤© 10:30AM 4:30PM æŠ“å¥‡æ‘©æ–°è
30 10,16 * * * bin/enews-open

 è¦ä½¿ç”¨ enews-open.c å¿…é ˆè£æœ‰ lynx åŠ iconvã€‚

 æ–‡ç« æª”æ¡ˆæ”¾åœ¨ run/kimo/

 è³‡æ–™ä¾†æºï¼šYahoo! å¥‡æ‘©æ–°è http://tw.news.yahoo.com/

#endif


#include "bbs.h"


/*-------------------------------------------------------*/
/* variable                                              */
/*-------------------------------------------------------*/


/* itoc.020129: ç›®å‰ä¸æ”¯æ´ç¿»é ï¼Œæ‰€ä»¥æ¯ç¨®åˆ†é¡æ–°èæœ€å¤šä¹Ÿæ˜¯ 16 æ¢è€Œå·² */

#define MAX_ENEWS   16  /* ä¸€é æœ€å¤šæœ‰ 16 é … */

static char title[MAX_ENEWS][TTLEN + 1];    /* æœ¬åˆ†é¡æ–°èçš„æ‰€æœ‰æ¨™é¡Œ */
static char xname[MAX_ENEWS][10];           /* æœ¬åˆ†é¡æ–°èçš„æ‰€æœ‰æª”æ¡ˆè·¯å¾‘ */
static int maxitem;                         /* æœ¬åˆ†é¡çš„å…±æœ‰å¹¾ç¯‡ */

extern BCACHE *bshm;

extern void outgo_post(HDR *hdr, char *board);

#define mouts(x,y,s)    { move(x, y); outs(s); }

static void
enews_fpath(fpath, kind, fname)
  char *fpath;
  char kind;
  char *fname;
{
  sprintf(fpath, "run/kimo/%c/%s", kind, fname);
}


/*-------------------------------------------------------*/
/* E-News é¸å–®                                           */
/*-------------------------------------------------------*/


static void
enews_item(num, cc)
  int num;
  int cc;
{
  move(6 + num, 0);
  clrtoeol();
  move(6 + num, 15);
  prints(cc == num ? "%2d " COLOR4 " %.*s \033[m" : "%2d  %.*s",
    num + 1, d_cols + 54, title[num]);  /* å¤ªé•·çš„æˆªæ‰ */
}


static void
enews_body(kind, cc)
  char kind;
  int cc;
{
  int num;

  if (!maxitem)
    return;

  for (num = 0; num < maxitem; num++)
    enews_item(num, cc);

  for (; num < MAX_ENEWS; num++)
  {
    move(6 + num, 0);
    clrtoeol();
  }

  /* æ¸¸æ¨™ç§»å»æ‰€é¸é …çš„æœ€å¾Œ */
  num = 20 + strlen(title[cc]);
  if (num > 74)     /* å¤ªé•·çš„æˆªæ‰ */
    num = 74;
  move(6 + cc, num);
}


static void
enews_neck(kind, cc)
  char kind;
  int cc;
{
  int i;
  char class[12][5] =
  {
    "æ”¿æ²»", "ç¤¾æœƒ", "åœ‹éš›", "å…©å²¸", "è²¡ç¶“", "å½±è¦–",
    "é«”è‚²", "ç”Ÿæ´»", "ä¼‘é–’", "å¥åº·", "ç§‘æŠ€", "æ–°å¥‡"
  };

  move(4, 0);
  clrtoeol();
  move(4, 4);
  for (i = 'A'; i <= 'L'; i++)
    prints(i == kind ? "\033[1;36m%c\033[37;41m%s\033[m " :
      "\033[1;36m%c\033[m%s ", i, class[i - 'A']);

  enews_body(kind, cc);
}


static void
enews_head(kind, cc)
  char kind;
  int cc;
{
  clear();

  mouts(0, 8, "\033[1;37;42m  â•”â•â•®â•— â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    "â•â•â•â•â•â•â•â•â•â•®  \033[m");
  mouts(1, 8, "\033[1;37;42m  â•‘  â•‘â•‘â•­â•â•®â•­  â•®â•­â•â•®     \033[33m"
    "é›…è™ï¼å¥‡æ‘©æ–°è\033[37m            â•‘  \033[m");
  mouts(2, 8, "\033[1;37;42m  â•‘  â•‘â•‘â• â•â•â•‘â•‘â•‘â•°â•â•®     \033[33m"
    "http://tw.news.yahoo.com/\033[37m â•‘  \033[m");
  mouts(3, 8, "\033[1;37;42m  â•šâ•â•°â•©â•©â•â•©â•©â•©â•©â•â•â•¯ â•â•â•â•â•â•"
    "â•â•â•â•â•â•â•â•â•â•¯  \033[m");

  outf(FEETER_ENEWS);

  enews_neck(kind, cc);
}


static void
enews_load(kind)
  char kind;
{
  char fpath[64];
  FILE *fp;
  ENEWS enews;

  maxitem = 0;

  enews_fpath(fpath, kind, ".ENEWS");
  if (!(fp = fopen(fpath, "r")))
    return;

  while (fread(&enews, sizeof(ENEWS), 1, fp) == 1 && maxitem < MAX_ENEWS)
  {
    strcpy(title[maxitem], enews.title);
    strcpy(xname[maxitem], enews.xname);
    maxitem++;
  }
  fclose(fp);
}


/*-------------------------------------------------------*/
/* å…¶ä»–åŠŸèƒ½                                              */
/*-------------------------------------------------------*/


static int      /* å›å‚³æœ€å¾Œè®€åˆ°å“ªä¸€ç¯‡ */
enews_browse(kind, cc)
  char kind;
  int cc;
{
  int key;
  char fpath[64];

  for (;;)
  {
    if (cc >= maxitem)
      break;

    enews_fpath(fpath, kind, xname[cc]);

    /* Thor.990204: ç‚ºè€ƒæ…®more å‚³å›å€¼ */
    if ((key = more(fpath, FOOTER_ENEWS)) < 0)
      break;

    if (!key)       /* å·²è®€å®Œ */
      key = vkey();

    switch (key)
    {
    case KEY_RIGHT:
    case KEY_PGDN:
    case KEY_DOWN:
    case ' ':
    case 'j':
      if (cc < maxitem - 1)
      {
        cc++;
        continue;
      }
      break;

    case KEY_UP:
    case KEY_PGUP:
    case 'k':
      if (cc > 0)
      {
        cc--;
        continue;
      }
      break;
    }

    break;
  }

  return cc;
}


static void
enews_cross(kind, cc)       /* æä¾›å–®ç¯‡è½‰éŒ„åˆ°çœ‹æ¿ */
  char kind;
  int cc;
{
  int rc, battr, xbno;
  char xboard[IDLEN + 1], xfolder[64], fpath[64];
  HDR xpost;

  if (!cuser.userlevel)
    return;

  if (ask_board(xboard, BRD_W_BIT, "\n\n\033[1;33mè«‹æŒ‘é¸é©ç•¶çš„çœ‹æ¿ï¼Œ"
    "åˆ‡å‹¿è½‰éŒ„è¶…éä¸‰æ¿ã€‚\033[m\n\n"))
  {
    rc = vget(2, 0, "(S)å­˜æª” (L)ç«™å…§ (Q)å–æ¶ˆï¼Ÿ[Q] ", fpath, 3, LCECHO);
    if (rc == 'l' || rc == 's')
    {
      enews_fpath(fpath, kind, xname[cc]);
      brd_fpath(xfolder, xboard, fn_dir);

      /* è½‰éŒ„æ–°èå°±ç›´æ¥åŸæ–‡è½‰è¼‰ï¼Œä½†æ˜¯ä½œè€…æ›ç‚ºè‡ªå·± */
      hdr_stamp(xfolder, HDR_COPY | 'A', &xpost, fpath);
      strcpy(xpost.owner, cuser.userid);
      strcpy(xpost.nick, cuser.username);
      strcpy(xpost.title, title[cc]);

      xbno = brd_bno(xboard);
      battr = (bshm->bcache + xbno)->battr;

      /* Thor.990111: åœ¨å¯ä»¥è½‰å‡ºå‰, è¦check useræœ‰æ²’æœ‰è½‰å‡ºçš„æ¬ŠåŠ›? */
      if (!HAS_PERM(PERM_INTERNET) || (battr & BRD_NOTRAN))
        rc = 'l';

      if (rc == 's' && (!(battr & BRD_NOTRAN)))
        xpost.xmode = POST_OUTGO;

      rec_bot(xfolder, &xpost, sizeof(HDR));

      if (rc == 's' && (!(battr & BRD_NOTRAN)))
        outgo_post(&xpost, xboard);

      btime_update(xbno);

      /* Thor.981205: check è¢«è½‰çš„æ¿æœ‰æ²’æœ‰åˆ—å…¥ç´€éŒ„? */
      if (battr & BRD_NOCOUNT)
      {
        vmsg("è½‰éŒ„å®Œæˆï¼Œæ–‡ç« ä¸åˆ—å…¥ç´€éŒ„ï¼Œæ•¬è«‹åŒ…æ¶µã€‚");
      }
      else
      {
        cuser.numposts++;
        vmsg("è½‰éŒ„å®Œæˆ");
      }
    }
  }
  enews_head(kind, cc);
}


static int
enews_forward(kind, cc)     /* æä¾›å–®ç¯‡è½‰å¯„ */
  char kind;
  int cc;
{
  char rcpt[64];
  char fpath[64], folder[64], *userid;
  int userno, rc;
  int method;       /* è½‰å¯„åˆ° 0:ç«™å¤– >0:è‡ªå·± <0:å…¶ä»–ç«™å…§ä½¿ç”¨è€… */

  if (!HAS_PERM(PERM_INTERNET) || HAS_STATUS(STATUS_MAILOVER))
    return XO_NONE;

  strcpy(rcpt, cuser.email);
  if (!vget(b_lines, 0, "ç›®çš„åœ°ï¼š", rcpt, sizeof(rcpt), GCARRY))
    return XO_FOOT;

  userid = cuser.userid;
  userno = 0;

  if (!mail_external(rcpt)) /* ä¸­é€”æ””æˆª */
  {
    if (!str_cmp(rcpt, userid))
    {
      /* userno = cuser.userno; */  /* Thor.981027: å¯„ç²¾é¸é›†çµ¦è‡ªå·±ä¸é€šçŸ¥è‡ªå·± */
      method = 1;
    }
    else
    {
      if ((userno = acct_userno(rcpt)) <= 0)
      {
        zmsg(err_uid);
        return XO_FOOT;
      }
      method = -1;
    }

    usr_fpath(folder, rcpt, fn_dir);
  }
  else
  {
    if (not_addr(rcpt))
    {
      zmsg(err_email);
      return XO_FOOT;
    }

    method = 0;
  }

  enews_fpath(fpath, kind, xname[cc]);

  if (method)           /* è½‰å¯„ç«™å…§ */
  {
    HDR mhdr;

    hdr_stamp(folder, HDR_COPY, &mhdr, fpath);

    if (method > 0)     /* è½‰å¯„è‡ªå·± */
    {
      strcpy(mhdr.owner, "[ç²¾ é¸ é›†]");
      mhdr.xmode = MAIL_READ | MAIL_NOREPLY;
    }
    else            /* è½‰å¯„å…¶ä»–ä½¿ç”¨è€… */
    {
      strcpy(mhdr.owner, userid);
    }
    strcpy(mhdr.nick, cuser.username);
    strcpy(mhdr.title, title[cc]);
    rc = rec_add(folder, &mhdr, sizeof(HDR));
  }
  else              /* è½‰å¯„ç«™å¤– */
  {
    rc = bsmtp(fpath, title[cc], rcpt, 0);
  }

  if (userno > 0 && rc >= 0)
    m_biff(userno);

  zmsg(rc < 0 ? "éƒ¨ä»½ä¿¡ä»¶ç„¡æ³•å¯„é”" : "å¯„ä¿¡å®Œç•¢");

  enews_head(kind, cc);
  return XO_NONE;
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main_enews()
{
  int cc, ch;
  char kind;

  kind = 'A';   /* åˆ†é¡ */
  cc = 0;       /* ç¬¬å¹¾ç¯‡ */

  enews_load(kind);
  enews_head(kind, cc);

  while (ch = vkey())
  {
    if (ch >= 'a' && ch <= 'l')
    {
      kind = ch - 32;       /* è®Šå¤§å¯« */
      cc = 0;
      enews_load(kind);
      enews_neck(kind, cc);
      continue;
    }

    if (ch >= '1' && ch <= '9')
    {
      char ans[5];

      ans[0] = ch;
      ans[1] = '\0';
      vget(b_lines, 0, "è·³è‡³ç¬¬å¹¾é …ï¼š", ans, 4, GCARRY);
      outf(FEETER_ENEWS);   /* é‡ç¹ª feet */

      ch = atoi(ans);
      if (ch > 0  && ch <= maxitem)
      {
    enews_item(cc, 12345);  /* é‡ç¹ªåŸä¾†é‚£è¡Œ */
    cc = ch - 1;
    enews_item(cc, cc);
      }
      continue;
    }

    switch (ch)
    {
    case 'q':
    case 'e':
      return 0;

    case KEY_RIGHT:
      kind = kind < 'L' ? kind + 1 : 'A';
      cc = 0;
      enews_load(kind);
      enews_neck(kind, cc);
      break;

    case KEY_LEFT:
      kind = kind > 'A' ? kind - 1 : 'L';
      cc = 0;
      enews_load(kind);
      enews_neck(kind, cc);
      break;

    case KEY_DOWN:
      enews_item(cc, 12345);     /* é‡ç¹ªåŸä¾†é‚£è¡Œ */
      cc = cc < maxitem - 1 ? cc + 1 : 0;
      enews_item(cc, cc);
      break;

    case KEY_UP:
      enews_item(cc, 12345);    /* é‡ç¹ªåŸä¾†é‚£è¡Œ */
      cc = cc > 0 ? cc - 1 : maxitem - 1;
      enews_item(cc, cc);
      break;

    case '\n':
      cc = enews_browse(kind, cc);
      enews_head(kind, cc);
      break;

    case '0':
    case KEY_HOME:
      if (cc != 0)
      {
        enews_item(cc, 12345);  /* é‡ç¹ªåŸä¾†é‚£è¡Œ */
        cc = 0;
        enews_item(cc, cc);
      }
      break;

    case KEY_END:
      if (cc != maxitem - 1)
      {
        enews_item(cc, 12345);  /* é‡ç¹ªåŸä¾†é‚£è¡Œ */
        cc = maxitem - 1;
        enews_item(cc, cc);
      }
      break;

    case 'x':
      enews_cross(kind, cc);
      break;

    case 'F':
      if (enews_forward(kind, cc) == XO_FOOT)
        outf(FEETER_ENEWS);
      break;
    }
  }
}

--
 [1;43mâ•­[46mâ”¼[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [32;47m processor.tfcis.org [m
 [1;44mâ”¼[41mâ•¯[m A[1mut[30mho[mr: [1;33mitoc [30må¾ [35mpc512-2.ee.nctu.edu.tw [30mç™¼è¡¨[m
