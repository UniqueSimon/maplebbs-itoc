ç™¼ä¿¡äºº: hightman.bbs@bbs.hightman.net (å¾…å®š) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: è«‹å•æ€ä¹ˆå¾ç³»çµ±pidçŸ¥é“é‚£ä½ä½¿ç”¨è€…æ˜¯èª°?...
ç™¼ä¿¡ç«™: æ˜æœˆæ°´è»’BBS (Sat, 05 Jul 2003 12:31:45 +0800)     Updated: 2004/09/11

ä»¥å‰å¯«çš„ä¸€å€‹å°ç¨‹åºï¼Œæ”¾åˆ° util/ ä¸‹ï¼Œä¿®æ”¹ Makefile ç·¨è­¯å®ƒã€‚

: src/util/Makefile

EXE =   ... [1;33mpid2user[m

: src/util/pid2user.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/pid2user.c      (MapleBBS Ver 3.10)              */
/*-------------------------------------------------------*/
/* target : ç”±pidæ‰¾å‡ºç•¶å‰ç«™å…§ä½¿ç”¨è€…idå’Œå‹•æ…‹              */
/* author : hightman.bbs@bbs.hightman.net                */
/* create : 02/05/19                                     */
/* update :   /  /                                       */
/*-------------------------------------------------------*/


/* hightman.020519: 0
 * è¿‘æ—¥ç™¼ç¾å€‹åˆ¥é€²ç¨‹å ç”¨cpuå’Œmemoryè³‡æºéå¤šï¼Œ
 * æ“šæ­¤ç¨‹åºè§€å¯Ÿè©²ç”¨æˆ¶åœ¨åšä»€ä¹ˆ
 */

#define _MODES_C_

#include "bbs.h"

static UCACHE *ushm;


static int      /* 0: æ‰¾ä¸åˆ°ä½¿ç”¨è€…æ˜¯æ­¤ pid */
pid2user(pid)
  pid_t pid;
{
  UTMP *utmp, *uceil;
  usint offset;

  ushm = shm_new(UTMPSHM_KEY, sizeof(UCACHE));

  offset = ushm->offset;
  if (offset > (MAXACTIVE - 1) * sizeof(UTMP))
    offset = (MAXACTIVE - 1) * sizeof(UTMP);
  utmp = ushm->uslot;
  uceil = (void *) utmp + offset;

  offset = 1;
  do
  {
    if (utmp->pid == pid)
    {
      printf("ä½¿ç”¨è€…ä»£è™Ÿ: %s ç‹€æ…‹: %s [%d] ã€‚ (ä¾†è‡ª %s)\n",
        utmp->userid, ModeTypeTable[utmp->mode], utmp->mode, utmp->from);
      offset = 2;
      break;
    }
  } while (++utmp <= uceil);

  return (offset - 1);
}


int
main(argc, argv)
  int argc;
  char *argv[];
{
  pid_t pid;
  char c;
  extern int errno;

  if (argc < 2)
  {
    printf("Usage:\t%s <pid>\n", argv[0]);
    exit(-1);
  }

  setgid(BBSGID);
  setuid(BBSUID);
  chdir(BBSHOME);

  pid = atol(argv[1]);

  printf("æ‚¨è¼¸å…¥çš„é€²ç¨‹è™Ÿç‚ºï¼š [%ld]\n", (long) pid);
  if (!pid2user(pid))
  {
    printf("æŠ±æ­‰ï¼Œæ ¹æ“š pid: [%ld] æ‰¾ä¸åˆ° BBS ä½¿ç”¨è€…ã€‚\n", (long) pid);
    exit(0);
  }

  printf("æ˜¯å¦æ®ºæ­»è©²é€²ç¨‹(Y/N)ï¼Ÿ[N] ");
  c = getchar();
  if (c == 'y')
  {
    if (kill(pid, SIGKILL) == 0)
    {
      printf("\næˆåŠŸ\æ®ºæ‰é€²ç¨‹!\n");
    }
    else
    {
      if (errno == EINVAL)
      {
        printf("\nAn invalid signal was specified.\n");
      }
      else if (errno == ESRCH)
      {
        printf("\nThe  pid or process group does not exist.\n"
          "Note that an existing process might be a zombie,\n"
          "a process which  already  committed  termination,\n"
          "but has not yet been wait()ed for.\n");
      }
      else if (errno == EPERM)
      {
        printf("\nThe process does not have permission to \n"
          "send the signal to any of the receiving processes. \n");
      }
      else
      {
        printf("\nFail to kill the process for Unknown Reson.\n");
      }
    }
  }
  exit(0);
}

--
[1;32mâ€» Origin: [33mæ˜æœˆæ°´è»’ [37m<bbs.hightman.net> [m
[1;31mâ—† From: [36m218.72.33.236[m
