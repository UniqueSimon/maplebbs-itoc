ä½œè€…: itoc (League) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] çµ±è¨ˆä½¿ç”¨ç‡ä¸é«˜çš„çœ‹æ¿
æ™‚é–“: 2003/12/07 Sun 10:23:58                           Updated: 2005/05/25

: src/util/Makefile

EXE =   ... nouse-brd

: crontab -e åŠ å…¥

10 4 * * * bin/nouse-brd > /dev/null 2>&1

: src/util/nouse-brd.c æ–°å¢ç¨‹å¼å¦‚ä¸‹

/*-------------------------------------------------------*/
/* util/nouse_brd.c     ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : çµ±è¨ˆä½¿ç”¨ç‡ä¸é«˜çš„çœ‹æ¿                         */
/* create : 03/12/06                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


static char *Title = "ä½¿ç”¨ç‡ä¸é«˜çš„çœ‹æ¿";
static char *Brdname = "sysop";         [1;44m// çœ‹æ¿è‡ªå®š [m
static char *ftmp = "tmp/nouse-board";  /* æš«å­˜æª” */

static void
add_post()           /* ç™¼æ–‡åˆ°çœ‹æ¿ */
{
  HDR hdr;
  char folder[64];

  brd_fpath(folder, Brdname, FN_DIR);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, ftmp);
  strcpy(hdr.owner, STR_SYSOP);
  strcpy(hdr.nick, SYSOPNICK);
  strcpy(hdr.title, Title);
  rec_add(folder, &hdr, sizeof(HDR));
}


static time_t now;
static time_t delta;      /* æœ€å¾Œä¸€ç¯‡æ–‡ç« è·ç›®å‰å¹¾å¤© */
static int page;          /* æœ‰å¹¾ç¯‡æ–‡ç«  */

static void
expire(brd)
  BRD *brd;
{
  int fd, fsize;
  char folder[64];
  HDR hdr;
  struct stat st;

  brd_fpath(folder, brd->brdname, FN_DIR);

  if ((fd = open(folder, O_RDONLY)) >= 0 && !fstat(fd, &st))
  {
    fsize = st.st_size;
    page = fsize / sizeof(HDR);

    if (page <= 0)  /* æ²’æœ‰æ–‡ç« å‰‡çœ‹é–‹æ¿æ™‚é–“ */
    {
      delta = brd->bstamp;
    }
    else
    {
      delta = brd->bstamp;      /* é¿å…æ‰€æœ‰æ–‡ç« éƒ½æ˜¯ç½®åº•æ–‡ */
      while ((fsize -= sizeof(HDR)) >= 0)   /* æ‰¾æœ€å¾Œä¸€ç¯‡ä¸æ˜¯ç½®åº•æ–‡çš„æ™‚é–“ */
      {
        lseek(fd, fsize, SEEK_SET);
        read(fd, &hdr, sizeof(HDR));
        if (!(hdr.xmode & POST_BOTTOM))
        {
          delta = hdr.chrono;
          break;
        }
      }
    }
    delta = (now - delta) / 86400;
    close(fd);
  }
}


int
main()
{
  int score;
  FILE *fpr, *fpw;
  BRD brd;

  chdir(BBSHOME);

  if (!(fpr = fopen(FN_BRD, "r")) || !(fpw = fopen(ftmp, "w")))
    return -1;

  time(&now);

  fprintf(fpw, "%s %s (%s) %s %s\n",
    STR_AUTHOR1, STR_SYSOP, SYSOPNICK, STR_POST2, Brdname);
  fprintf(fpw, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n\n", Title, Btime(&now));

  while (fread(&brd, sizeof(BRD), 1, fpr) == 1)
  {
    if (!*brd.brdname)  /* æ­¤æ¿å·²è¢«åˆªé™¤ */
      continue;

    expire(&brd);

    score = page / 5 - delta;    [1;44m// å…¬å¼è‡ªå®š [m
    if (score <= -200)
    {
      fprintf(fpw, "%-12s æ¿ %4d åˆ†ï¼Œæœ€å¾Œä¸€ç¯‡æ–‡ç« æ–¼ %3d å¤©å‰ï¼Œ"
        "ç¸½å…±æœ‰ %4d ç¯‡æ–‡ç« \n",
        brd.brdname, score, delta, page);
    }
  }

  fprintf(fpw, "\n--\nâ€» æœ¬æ–‡ç”±è‡ªå‹•ç™¼æ–‡ç³»çµ±æ‰€ç™¼è¡¨\n");

  fclose(fpr);
  fclose(fpw);
  add_post();
  unlink(ftmp);

  return 0;
}


--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mthree.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
