ä½œè€…: itoc (test) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] æ–‡ç« è©•åˆ†åŠŸèƒ½
æ™‚é–“: Sun Aug 18 14:45:05 2002                          Updated: 2005/05/19

  è©•åˆ†æ’è¡Œæ¦œ

: crontab -e

# æ¯å¤©åšä¸€æ¬¡æ’è¡Œæ¦œçµ±è¨ˆ
28 3 * * * bin/topgem > /dev/null 2>&1
30 3 * * * bin/topsong > /dev/null 2>&1
+ 32 3 * * * bin/topscore > /dev/null 2>&1
34 3 * * * bin/topusr > /dev/null 2>&1

: BBS ç«™ä¸Š (A)nnounce è£¡é¢çš„ {æ’è¡Œ} çµ±è¨ˆè³‡æ–™

  Ctrl+P æ–°å¢ (D)è³‡æ–™
  æ¨™é¡Œï¼šè©•åˆ†æ¬¡æ•¸çµ±è¨ˆ
  æª”åï¼š-topscore

: src/util/Makefile åŠ å…¥ topscore

TOOL =  ... \
        ... \
        ... topgem [1;33mtopscore[m topsong ...

: src/util/topscore.c æ–°å¢é€™ç¨‹å¼ï¼Œå…§å®¹å¦‚ä¸‹

/*-------------------------------------------------------*/
/* util/topscore.c      ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : æ–‡ç« è©•åˆ†æ’å                                 */
/* create : 03/04/26                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/
/* syntax : topscore                                     */
/*-------------------------------------------------------*/


#include "bbs.h"


#define FN_RUN_SCOREUSIES       "run/score_usies"       /* è©•åˆ†è¨˜éŒ„ */
#define OUTFILE_TOPSCORE        "gem/@/@-topscore"


typedef struct
{
  char brdname[BNLEN + 1];
  char owner[IDLEN + 1];
  char title[TTLEN + 1];
  char score;
} SCOREDATA;


/*-------------------------------------------------------*/
/* æŠŠæ‰€æœ‰è¢«è©•åˆ†çš„æ–‡ç« æ‰¾å‡ºä¾†                              */
/*-------------------------------------------------------*/


static void
do_find(brdname)
  char *brdname;
{
  int i, size, fd;
  char fpath[64];
  struct stat st;
  HDR *hdr;
  SCOREDATA score;
  time_t due;

  brd_fpath(fpath, brdname, FN_DIR);
  if ((fd = open(fpath, O_RDONLY)) >= 0)
  {
    fstat(fd, &st);
    size = st.st_size;
    hdr = (HDR *) malloc(size);
    read(fd, hdr, size);
    close(fd);

    due = time(NULL) - 86400 * 10;      /* æœ€å¤šçµ±è¨ˆåˆ°åå¤©å‰çš„æ–‡ç«  */

    size /= sizeof(HDR);
    for (i = 0; i < size; i++)
    {
      if (hdr[i].score > 0 && hdr[i].chrono >= due)
      {
        strcpy(score.brdname, brdname);
        strcpy(score.owner, hdr[i].owner);
        strcpy(score.title, hdr[i].title);
        score.score = hdr[i].score;
        rec_add(FN_RUN_SCOREUSIES, &score, sizeof(SCOREDATA));
      }
    }

    free(hdr);
  }
}


/*-------------------------------------------------------*/
/* è£½ä½œæ’å                                              */
/*-------------------------------------------------------*/


static void
write_data(score, num)
  SCOREDATA *score;
  int num;
{
  int n;
  FILE *fp;

  if (!(fp = fopen(OUTFILE_TOPSCORE, "w")))
    return;

  fprintf(fp, "\033[37måæ¬¡\033[36mâ”€\033[37mçœ‹æ¿\033[36mâ”€â”€â”€â”€"
    "\033[37mä½œè€…\033[36mâ”€â”€â”€â”€â”€\033[37mæ¨™  é¡Œ\033[36mâ”€â”€â”€â”€"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[37måˆ†æ•¸\033[36mâ”€\033[m\n");

  for (n = 0; n < 50 && n < num; n++)           /* åªå–å‰ 50 å */
  {
    fprintf(fp, "%3d. %-13.13s%-13.13s%-38.38s %4d æ¬¡\033[m\n",
      n + 1, score[n].brdname, score[n].owner, score[n].title, score[n].score);
  }

  fclose(fp);
}


static int
count_cmp(b, a)
  SCOREDATA *a, *b;
{
  return (a->score - b->score);
}


int
main()
{
  int fd, size;
  struct stat st;
  SCOREDATA *score;
  BRD brd;

  chdir(BBSHOME);

  unlink(FN_RUN_SCOREUSIES);

  size = 0;
  while (!rec_get(FN_BRD, &brd, sizeof(BRD), size))
  {
    if ((brd.readlevel | brd.postlevel) < (PERM_VALID << 1)) /* éš±è—æ¿ä¸çµ±è¨ˆ */
      do_find(brd.brdname);
    size++;
  }

  if ((fd = open(FN_RUN_SCOREUSIES, O_RDWR)) < 0)
    return 0;

  if (!fstat(fd, &st) && (size = st.st_size) >= sizeof(SCOREDATA))
  {
    score = (SCOREDATA *) malloc(size);
    size = read(fd, score, size);

    qsort(score, size / sizeof(SCOREDATA), sizeof(SCOREDATA), count_cmp);

    lseek(fd, 0, SEEK_SET);
    write(fd, score, size);
    ftruncate(fd, size);

    write_data(score, size / sizeof(SCOREDATA));
    free(score);
  }

  close(fd);
  return 0;
}

--
[1;32mâ–¡ Origin: [33må‹•åŠ›æ ¸å¿ƒ [37mxeon.tfcis.org  [31mâ–¡ From: [36mitoc.Dorm-GD2.NCTU.edu.tw[m
