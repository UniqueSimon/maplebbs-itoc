ç™¼ä¿¡äºº: simple.bbs@bbs.wfc.edu.tw (é¤Šå…µåƒæ—¥ ç”¨åœ¨ä¸€æ™‚) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½]æ¨‚é€å½©-å¤§æ¨‚é€(ä¿®æ”¹ç‰ˆ)
ç™¼ä¿¡ç«™: å¡å¸ƒå¥‡è«¾ (2004/10/27 Wed 00:39:26)                Updated: 2007/05/02

: crontab -e åŠ å…¥äºŒè¡Œ

# æ¯æ˜ŸæœŸæ¨‚é€é–‹çä¸€æ¬¡
50 4 * * 6 bin/lottery-open > /dev/null 2>&1

: src/util/Makefile

EXE =   ... [1;33mlottery-open[m

: util/lottery-open.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/lottery-open.c  ( YZU WindTopBBS Ver 3.00 )      */
/*-------------------------------------------------------*/
/* target : å½©åˆ¸éŠæˆ² -- é–‹çç¨‹å¼                         */
/* create : 02/01/12                                     */
/* update : 03/05/26                                     */
/* author : verit.bbs@bbs.yzu.edu.tw                     */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/* modify : simple.bbs@bbs.wfc.edu.tw                    */
/*-------------------------------------------------------*/


#include "bbs.h"


#define OUTFILE_LOTTERY   "run/lottery.result"


/* lottery_num[0~5] æ˜¯ä¸€èˆ¬è™Ÿç¢¼ï¼›lottery_num[6] æ˜¯ç‰¹åˆ¥è™Ÿ */
static int lottery_num[6];

/* lottery_win[0~6] ä¾åºæ˜¯ä¸­å„çé …çš„æ³¨æ•¸
   0:æ™®ç 1:é™¸ç 2:ä¼ç 3:è‚†ç 4:åƒç 5:è²³ç 6:é ­ç */
static int lottery_win[7];

static double totalmoney;     /* ç¸½æŠ¼é‡‘ */

/* eachmoney[0~6] ä¾åºæ˜¯å„çé …çš„çé‡‘
   0:æ™®ç 1:é™¸ç 2:ä¼ç 3:è‚†ç 4:åƒç 5:è²³ç 6:é ­ç */
static int eachmoney[7];

static FILE *flog;


/*-------------------------------------------------------*/
/* ç™¼çé‡‘                                                */
/*-------------------------------------------------------*/


static void
add_money(log)
  BUY_LOTTERY *log;
{
  char fpath[64];
  PAYCHECK paycheck;
  static char name[7][4] = {"æ™®", "é™¸", "ä¼", "è‚†", "åƒ", "è²³", "é ­"};

  memset(&paycheck, 0, sizeof(PAYCHECK));
  time(&paycheck.tissue);
  paycheck.money = eachmoney[log->prize];
  sprintf(paycheck.reason, "å¤§æ¨‚é€%sççé‡‘", name[log->prize]);

  usr_fpath(fpath, log->userid, FN_PAYCHECK);
  rec_add(fpath, &paycheck, sizeof(PAYCHECK));

  fprintf(flog, "  %-13så½©åˆ¸è™Ÿç¢¼ç‚º %02d %02d %02d %02d %02d %02dï¼Œ"
    "ä¸­äº†%sç %d å…ƒ\n",
    log->userid, log->num[0], log->num[1], log->num[2],
    log->num[3], log->num[4], log->num[5], name[log->prize], paycheck.money);
}


static void
mail_lottery(log)       /* itoc.011115: å¯„æª”æ¡ˆçµ¦ userid */
  BUY_LOTTERY *log;
{
  int i;
  char folder[64];
  HDR hdr;
  static char userid[IDLEN + 1];
  static char fpath[64];
  static FILE *fp;

  /* log[] è¦ä¾ log->userid ä¾†æ’åº */
  /* åŒä¸€ä½ä½¿ç”¨è€…å¯èƒ½æœ‰å¤šå¼µå½©åˆ¸ä¸­çï¼Œåœ¨åŒä¸€å°ä¿¡è£¡é¢æœƒæŠŠæ‰€æœ‰æ˜ç´°éƒ½å¯«å‡ºä¾† */

  if (strcmp(userid, log->userid))   /* æ–°çš„ userid */
  {
    /* å°‡å‰ä¸€ä¸­çäººçš„ä¿¡å¯„å‡º */
    if (fp)
    {
      fclose(fp);

      usr_fpath(folder, userid, FN_DIR);
      hdr_stamp(folder, HDR_LINK, &hdr, fpath);
      strcpy(hdr.owner, STR_SYSOP);
      strcpy(hdr.nick, SYSOPNICK);
      strcpy(hdr.title, "å½©åˆ¸ç™¼éŒ¢");
      rec_add(folder, &hdr, sizeof(HDR));

      unlink(fpath);
    }

    if (!log->userid[0])   /* å·²å¯„å‡ºæœ€å¾Œä¸€ä½ä¸­çäººé€šçŸ¥ä¿¡ */
      return;

    /* é–‹å§‹æº–å‚™æ–°ä¸­çäººçš„ä¿¡ */
    strcpy(userid, log->userid);

    sprintf(fpath, "tmp/lottery.%s", userid);
    if (fp = fopen(fpath, "w"))
    {
      /* æ–‡ç« æª”é ­ */
      fprintf(fp, "%s %s (%s)\n", STR_AUTHOR1, STR_SYSOP, SYSOPNICK);
      fprintf(fp, "æ¨™é¡Œ: å½©åˆ¸ç™¼éŒ¢\næ™‚é–“: %s\n\n", Now());

      /* æ–‡ç« å…§å®¹ */
      fprintf(fp, "     æœ¬æœŸæ¨‚é€ä¸­çè™Ÿç¢¼ç‚ºï¼š\n\n          ");
      for (i = 0; i < 6; i++)
        fprintf(fp, "%02d  ", lottery_num[i]);
      fprintf(fp, "\n\n     æœ¬æœŸæ¨‚é€ç‰¹åˆ¥è™Ÿç¢¼ç‚ºï¼š%\n\n          ");
      fprintf(fp, "%02d\n\n", lottery_num[6]);
    }
  }

  fprintf(fp, "     æ‚¨æ‰€è³¼è²·çš„è™Ÿç¢¼ç‚ºï¼š\n\n          ");
  for (i = 0; i < 6; i++)
    fprintf(fp, "%02d  ", log->num[i]);

  fprintf(fp, "æ­å–œæ‚¨è´å¾— %d å…ƒï¼Œè©³ç´°ä¸­çè¨˜éŒ„è«‹åƒè€ƒ %s æ¿\n",
    eachmoney[log->prize], BN_RECORD);
}


/*-------------------------------------------------------*/
/* é–‹çè¨˜éŒ„                                              */
/*-------------------------------------------------------*/


static void
add_post(brdname, fpath, title)           /* ç™¼æ–‡åˆ°çœ‹æ¿ */
  char *brdname;        /* æ¬² post çš„çœ‹æ¿ */
  char *fpath;          /* æª”æ¡ˆè·¯å¾‘ */
  char *title;          /* æ–‡ç« æ¨™é¡Œ */
{
  HDR hdr;
  char folder[64];

  brd_fpath(folder, brdname, FN_DIR);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, fpath);
  strcpy(hdr.owner, STR_SYSOP);
  strcpy(hdr.nick, SYSOPNICK);
  strcpy(hdr.title, title);
  rec_add(folder, &hdr, sizeof(HDR));
}


/*-------------------------------------------------------*/
/* å°çä¸»ç¨‹å¼                                            */
/*-------------------------------------------------------*/


static void
generate_number()    /* ç”¢ç”Ÿä¸­ççµæœ */
{
  int i, j, num;

  srand(time(NULL));

  for (i = 0; i < 7; i++)
  {
rand_num:                       /* random å‡ºä¸€å€‹å’Œä¹‹å‰éƒ½ä¸åŒçš„æ•¸å­— */
    num = rand() % 49 + 1;
    for (j = 0; j < i; j++)
    {
      if (num == lottery_num[j])/* é€™å€‹æ•¸å­—ä»¥å‰ random éäº† */
        goto rand_num;
    }
    lottery_num[i] = num;
  }

  fprintf(flog, "     æœ¬æœŸæ¨‚é€ä¸­çè™Ÿç¢¼ç‚ºï¼š\n\n          ");
  for (i = 0; i < 6; i++)
    fprintf(flog, "%02d  ", lottery_num[i]);
  fprintf(flog, "\n\n     æœ¬æœŸæ¨‚é€ç‰¹åˆ¥è™Ÿç¢¼ç‚ºï¼š%\n\n          ");
  fprintf(flog, "%02d\n\n", lottery_num[6]);

  /* ä¸­çæ³¨æ•¸æ­¸é›¶ */
  for (i = 0; i < 7; i++)
    lottery_win[i] = 0;
}


static int  /* -1:æ‘ƒé¾œ 0:æ™®ç 1:é™¸ç 2:ä¼ç 3:è‚†ç 4:åƒç 5:è²³ç 6:é ­ç */
check_prize(log)
  BUY_LOTTERY *log;
{
  int i, j;
  int guessed;        /* ä¸­äº†å¹¾å€‹è™Ÿç¢¼ */
  int spec;           /* 1: ä¸­äº†ç‰¹åˆ¥è™Ÿç¢¼ */
  int prize;

  guessed = 0;
  for (i = 0; i < 6; i++)
  {
    for (j = 0; j < 6; j++)
    {
      if (log->num[i] == lottery_num[j])
      {
        guessed++;
        break;
      }
    }
  }

  spec = 0;
  for (i = 0; i < 6; i++)
  {
    if (log->num[i] == lottery_num[6])
    {
      spec = 1;
      break;
    }
  }

  /* é ­ç èˆ‡ç•¶æœŸå…­å€‹ä¸­çè™Ÿç¢¼å®Œå…¨ç›¸åŒè€…ã€ˆé †åºä¸é™ã€‰
     è²³ç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»äº”ç¢¼ï¼‹ç‰¹åˆ¥è™Ÿ
     åƒç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»äº”ç¢¼
     è‚†ç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»å››ç¢¼ï¼‹ç‰¹åˆ¥è™Ÿ
     ä¼ç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»å››ç¢¼
     é™¸ç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»ä¸‰ç¢¼ï¼‹ç‰¹åˆ¥è™Ÿ
     æ™®ç å°ä¸­ç•¶æœŸä¸­çè™Ÿç¢¼ä¹‹å…¶ä¸­ä»»ä¸‰ç¢¼
   */

  if (guessed <= 2)
  {
    prize = -1;
  }
  else if (guessed == 3)
  {
    prize = (!spec) ? 0 : 1;
  }
  else if (guessed == 4)
  {
    prize = (!spec) ? 2 : 3;
  }
  else if (guessed == 5)
  {
    prize = (!spec) ? 4 : 5;
  }
  else if (guessed == 6)
  {
    prize = 6;
  }

  if (prize >= 0)
    lottery_win[prize]++;
  return prize;
}


static void
check_money()         /* è¨ˆç®—å„çé …çé‡‘ */
{
  int i;
  double keepmoney;
  int rate[7] = {0, 0, 20, 5, 10, 9, 56};

  /* é ­ç å…± lottery_win[6] æ³¨ï¼Œä½”å‰©é¤˜çé‡‘56%
     è²³ç å…± lottery_win[5] æ³¨ï¼Œä½”å‰©é¤˜çé‡‘9%
     åƒç å…± lottery_win[4] æ³¨ï¼Œä½”å‰©é¤˜çé‡‘10%
     è‚†ç å…± lottery_win[3] æ³¨ï¼Œä½”å‰©é¤˜çé‡‘5%
     ä¼ç å…± lottery_win[2] æ³¨ï¼Œä½”å‰©é¤˜çé‡‘20%
     é™¸ç å…± lottery_win[1] æ³¨ï¼Œæ¯æ³¨çé‡‘ç‚º20000éŠ€å¹£
     æ™®ç å…± lottery_win[0] æ³¨ï¼Œæ¯æ³¨çé‡‘ç‚º8000éŠ€å¹£
   */

  /* å–å‡ºä¸ŠæœŸæœªç™¼å‡ºçš„çé‡‘ */
  keepmoney = 0;
  rec_get(LAST_KEEP_MONEY, &keepmoney, sizeof(keepmoney), 0);
  totalmoney += keepmoney;

  /* å…ˆæ‰£é™¤æ™®çã€é™¸ççš„çé‡‘ */
  totalmoney -= lottery_win[0] * 8000 + lottery_win[1] * 20000;
  if (totalmoney < 0)
    totalmoney = 0;

  for (i = 2; i < 7; i++)  /* é™¤æ™®çã€é™¸çä»¥å¤– */
  {
    if (lottery_win[i])
      eachmoney[i] = totalmoney / 100 / lottery_win[i] * rate[i];
    else
      keepmoney += totalmoney / 100 * rate[i];
  }
  eachmoney[1] = 20000;
  eachmoney[0] = 8000;

  /* å°‡æœªç™¼å‡ºçš„çé‡‘ä¿ç•™è‡³ä¸‹æœŸ */
  rec_put(LAST_KEEP_MONEY, &keepmoney, sizeof(keepmoney), 0, NULL);

  fprintf(flog, "å„çé …çš„çé‡‘ä¾åºæ˜¯ï¼š");
  for (i = 0; i < 7; i++)
    fprintf(flog, "%d ", eachmoney[i]);
  fprintf(flog, "\n\n");
}


static int
lottery_cmp(a, b)
  BUY_LOTTERY *a, *b;
{
  int ap, bp;

  ap = a->prize;
  bp = b->prize;

  if (ap * bp < 0)   /* ä¸€äººæœ‰ä¸­çï¼Œå¦ä¸€äººæ²’ä¸­ç */
    return ap - bp;  /* æ²’ä¸­ççš„æ”¾å‰é¢ */

  /* äºŒäººéƒ½æœ‰ä¸­çæˆ–éƒ½æ²’ä¸­çï¼Œä¾ id æ’åº */
  return strcmp(a->userid, b->userid);
}


static void
lottery_open()
{
  int fsize;
  BUY_LOTTERY *data, *head, *tail;

  if (data = (BUY_LOTTERY *) f_img(FN_RUN_LOTTERY, &fsize))
  {
    unlink(FN_RUN_LOTTERY);

    fsize /= sizeof(BUY_LOTTERY);
    totalmoney = fsize * 1000;

    /* ç¬¬ä¸€åœˆå°ç */
    head = data;
    tail = data + fsize;
    do
    {
      /* é–‹å§‹å°çï¼Œçµ±è¨ˆä¸­çæ³¨æ•¸ */
      head->prize = check_prize(head);
    } while (++head < tail);

    /* è¨ˆç®—å„çé …çé‡‘ */
    check_money();

    /* å°‡ data ä¾ userid æ’åº */
    qsort(data, fsize * sizeof(BUY_LOTTERY), sizeof(BUY_LOTTERY), lottery_cmp);

    /* ç¬¬äºŒåœˆç™¼çé‡‘ */
    head = data;
    do
    {
      if (head->prize >= 0)
      {
        add_money(head);
        mail_lottery(head);
      }
    } while (++head < tail);

    /* å¯„å‡ºæœ€å¾Œä¸€å€‹ä¸­çäººé€šçŸ¥ä¿¡ */
    data->userid[0] = '\0';
    mail_lottery(data);

    free(data);
  }
}


int
main()
{
  chdir(BBSHOME);

  if (flog = fopen(OUTFILE_LOTTERY, "w"))
  {
    generate_number();
    lottery_open();
    fclose(flog);
    add_post(BN_RECORD, OUTFILE_LOTTERY, "å¤§æ¨‚é€é–‹çè¨˜éŒ„");
  }

  exit(0);
}


--
[m[1;32mâ€» Origin: [33må³é³³æŠ€è¡“å­¸é™¢é›»ç®—ä¸­å¿ƒ å¡å¸ƒå¥‡è«¾ [37m<bbs.wfc.edu.tw>[m
[1;31mâ—† From: [36mbbs.wfc.edu.tw[m
