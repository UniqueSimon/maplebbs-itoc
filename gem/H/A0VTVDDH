ç™¼ä¿¡äºº: amaki.bbs@luna.twbbs.org (åˆè¦ºç¾Š) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: [ä¿®æ”¹]æŠŠ.USRæ”¾å…¥shmè£¡
ç™¼ä¿¡ç«™: æœˆä¸‹å¤œæƒ³ (2003/12/17 Wed 02:43:23)                Updated: 2005/03/18

â€» å¼•è¿°ã€Šamaki (åˆè¦ºç¾Š)ã€‹ä¹‹éŠ˜è¨€ï¼š
>   2. ç°¡åŒ–æ•´ç†usernoçš„å·¥ä½œï¼Œè®Šæˆåªéœ€è¦å¯«ä¸€æ”¯ç°¡å–®çš„utilityå³å¯å®Œå·¥(æ‡‰è©²å¾ˆå¥½å¯«ï¼Œ
>      å°±æ˜¯é–‹å•Ÿshmç„¶å¾Œé–‹å§‹é€ä¸€æŠŠ.USRçš„ä½ç½®å¡«å…¥.ACCTè£¡ï¼Œåªæœ‰ä¸æ­£ç¢ºçš„æ‰è¦æ”¹)ã€‚

  æ”¾åœ¨crontabè£¡å®šæœŸè·‘ï¼Œä¸è¦æ¯å¤©è·‘ï¼Œé€™å¾ˆæ“ç¡¬ç¢Ÿçš„-_-;;;

/*-------------------------------------------------------*/
/* util/checkUSERNO.c   ( NTHU CS MapleBBS Ver 3.00 )    */
/*-------------------------------------------------------*/
/* target : -??auserno                                   */
/* author : amaki.bbs@luna.twbbs.org                     */
/* create : 03/12/16                                     */
/* update :   /  /                                       */
/*-------------------------------------------------------*/

#include "bbs.h"

static SCACHE *schema_shm;


int
main()
{
  int fd, count, c, dirty = 0;
  SCHEMA *sch, *sch_set, *seek_set, *shm_set;
  struct stat st;

  chdir(BBSHOME);

  schema_shm = shm_new(SCHESHM_KEY, sizeof(SCACHE));

  fd = open(FN_SCHEMA, O_RDONLY, 0600);  /* amaki.é‚„æ²’æœ‰.USRé‚£æº–å‚™å€’ç«™äº† */
  fstat(fd, &st);

  /* amaki. å‡è¨­æœ‰300å€‹å­¤å…’IDä¸”æ²’æœ‰ä»»ä½•ç©ºé–“å¯ç”¨ */
  count = st.st_size + sizeof(SCHEMA) * 300;
  seek_set = sch = (SCHEMA *) malloc(count);
  read(fd, sch, count);
  count = count / sizeof(SCHEMA);
  close(fd);

  for (c = 'a'; c <= 'z'; c++)
  {
    char buf[64];
    struct dirent *de;
    DIR *dirp;

    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      ACCT cuser;
      char *fname;

      fname = de->d_name;
      if (*fname <= ' ' || *fname == '.')
        continue;

      sprintf(buf, "%s/.ACCT", fname);
      if ((fd = open(buf, O_RDWR | O_CREAT, 0600)) < 0);
        continue;
      f_exlock(fd);

      memset(&cuser, 0, sizeof(ACCT));
      read(fd, &cuser, sizeof(cuser));
      sch_set = sch + cuser.userno - 1;
      if (strncmp(sch_set->userid, cuser.userid, strlen(cuser.userid))
      {                 /* amaki.å­¤å…’ID */
        dirty = 1;
        do
        {
          if (!seek_set->userid[0])
          {
            shm_set = schema_shm->schema + (seek_set - sch);
            strcpy(shm_set->userid, cuser.userid);
            strcpy(seek_set->userid, cuser.userid);
            shm_set->uptime = seek_set->uptime = time(0);

            cuser.userno = (seek_set - sch) + 1;
            lseek(fd, -sizeof(ACCT), SEEK_CUR);
            write(fd, &cuser, sizeof(ACCT));
            break;
          }
        } while (++seek_set < sch + count);
      }
      f_unlock(fd);
      close(fd);
    }
    closedir(dirp);
  }


  if (dirty)
  {
    chdir(BBSHOME);
    unlink(FN_SCHEMA);
    if (seek_set < sch + schema_shm->number)
      rec_add(FN_SCHEMA, sch, sizeof(SCHEMA) * schema_shm->number);
    else
      rec_add(FN_SCHEMA, sch, sizeof(SCHEMA) *
        (schema_shm->number = seek_set - sch + 1));
  }
  free(sch);
}


--
  [1;33mOrigin: luna.twbbs.org[m
