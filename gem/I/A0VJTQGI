ç™¼ä¿¡äºº: qazq.bbs@bbs.cs.nchu.edu.tw (Î¾æ„›æƒ…å¾¡å®ˆÎ¾) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½] ç†±é–€çœ‹æ¿æ’è¡Œæ¦œ(2)ï¼topbrd.c
ç™¼ä¿¡ç«™: ä¸­èˆˆè³‡ç§‘ (Mon, 14 Jul 2003 17:08:54 +0800 (CST))  Updated: 2007/05/13

: util/Makefile

EXE = .......
[1;32m![m     ............. topusr [1;32mtopbrd[m usies-sort


: util/topbrd.c

    æ–°å¢æ•´æ”¯ç¨‹å¼ï¼Œåƒè€ƒ topgem.c æ”¹çš„ã€‚

/*-------------------------------------------------------*/
/* topbrd.c ( NTHU CS MapleBBS Ver 3.10 )                */
/*-------------------------------------------------------*/
/* target : ç†±é–€çœ‹æ¿æ’è¡Œæ¦œ                               */
/* create : 03/07/03                                     */
/* update : 03/07/03                                     */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/* modify : qazq.bbs@bbs.cs.nchu.edu.tw                  */
/*-------------------------------------------------------*/



#include "bbs.h"


#define BRD_TIMES   "run/brd_times.log"
#define TOPBRD      "gem/@/@-topbrd"

/*-------------------------------------------------------*/
/* BRD shm éƒ¨åˆ†é ˆèˆ‡ cache.c ç›¸å®¹                         */
/*-------------------------------------------------------*/


static BCACHE *bshm;


static void
init_bshm()
{
  /* itoc.030727: åœ¨é–‹å•Ÿ bbsd ä¹‹å‰ï¼Œæ‡‰è©²å°±è¦åŸ·è¡Œé accountï¼Œ
     æ‰€ä»¥ bshm æ‡‰è©²å·²è¨­å®šå¥½ */

  bshm = shm_new(BRDSHM_KEY, sizeof(BCACHE));

  if (bshm->uptime <= 0)        /* bshm æœªè¨­å®šå®Œæˆ */
    exit(0);
}


static BRD *
brd_get(brdname)
  char *brdname;
{
  BRD *bhdr, *tail;

  bhdr = bshm->bcache;
  tail = bhdr + bshm->number;
  do
  {
    if (!strcmp(brdname, bhdr->brdname))
      return bhdr;
  } while (++bhdr < tail);
  return NULL;
}


typedef struct
{
  int times;            /* é€²å…¥çœ‹æ¿é–±è®€æ¬¡æ•¸ */
  char brdname[BNLEN + 1];  /* æ¿å */
}   BRDDATA;


static int
int_cmp(a, b)
  BRDDATA *a, *b;
{
  return (b->times - a->times); /* ç”±å¤§æ’åˆ°å° */
}


int
main()
{
  time_t now;
  struct tm *ptime;
  BRDDATA board[MAXBOARD];
  FILE *fp;
  int locus, i, m;
  BRD *bhdr;

  chdir(BBSHOME);

  if (!(fp = fopen(BRD_TIMES, "r")))
    return;

  locus = 0;
  while (!feof(fp))
  {
    fscanf(fp, "%s%d", board[locus].brdname, &(board[locus].times));
    locus++;
  }
  fclose(fp);

  qsort(board, locus, sizeof(BRDDATA), int_cmp);

  init_bshm();

  fp = fopen(TOPBRD, "w");

  [1;44m// ä¸‹é¢æ˜¯é¡¯ç¤ºç•«é¢ï¼Œå¯ä»¥è‡ªå·±ç•«....çœ‹èµ·ä¾†å’Œç„¡åå°ç«™çš„æœ‰é»åƒ...(é€ƒ...:P)[m

  time(&now);
  ptime = localtime(&now);
  fprintf(fp, "        â”¤\033[1;41m        ç†±é–€çœ‹æ¿æ’è¡Œæ¦œ        \033[mâ”œ"
    "        \033[33mçµ±è¨ˆæ—¥æœŸ: \033[36m%d æœˆ %d æ—¥\033[m\n\n",
    ptime->tm_mon + 1, ptime->tm_mday);

  m = 1;
  for (i = 0; i < locus; i++)
  {
    if (board[i].times == 0)
      break;

    if (!(bhdr = brd_get(board[i].brdname)))   /* æ­¤æ¿å·²æ”¹åæˆ–è¢«ç  */
      continue;

    /* è·³éä¸åˆ—å…¥æ’è¡Œæ¦œçš„çœ‹æ¿ */
    /* (BASIC + ... + VALID) < (VALID << 1) */
    if ((bhdr->readlevel | bhdr->postlevel) >= (PERM_VALID << 1))
      continue;

    fprintf(fp, "\033[1;31m%4d. \033[33mçœ‹æ¿: \033[32m%-13s  "
      "\033[1;3%dm%5.5s\033[m %-34.33s  \033[1;35mäººæ¬¡ \033[36m%-3d\033[m\n",
      m, board[i].brdname, bhdr->class[3] & 7, bhdr->class,
      bhdr->title, board[i].times);

    m++;
  }

  fclose(fp);
}

: crontab -e æ–°å¢

36 3 * * * bin/topbrd > /dev/null 2>&1

    //ä¸€å®šè¦å…ˆéåˆå¤œ12é»æ‰èƒ½è·‘å”·ï¼å› ç‚ºè¦è®“ account è·‘å‡º usies-sort

--
[1;31m|[33m Origin [31m| [0;45m ä¸­èˆˆè³‡ç§‘ ä¸­èˆˆè³‡ç§‘ ï½…è³‡ç¨ç§€ [35;47m bbs.cs.nchu.edu.tw [m
[1;31m|[35m Author [31m| [36m61-216-136-210.HINET-IP.hinet.net[m
