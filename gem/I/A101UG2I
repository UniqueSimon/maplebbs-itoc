ä½œè€…: itoc (League) çœ‹æ¿: plan
æ¨™é¡Œ: è‚¡å¸‚å¤§äº¨
æ™‚é–“: 2004/02/03 Tue 14:49:04                           Updated: 2004/03/02

: src/maple/menu.c é©ç•¶çš„é¸å–®åŠ å…¥

  "bin/stock.so:main_stock", PERM_BASIC, - M_GAME,
  "1Stock     â™‚ è‚¡å¸‚å¤§äº¨ â™€",

: src/include/config.h

+ #define STOCKSHM_KEY    4999    /* è‚¡å¸‚ */
#define PIPSHM_KEY      4998    /* é›»å­é›å°æˆ° */

: src/game/Makefile

SO =     ..... stock.so

: src/game/stock.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* stock.c        ( NTHU CS MapleBBS Ver 3.10 )          */
/*-------------------------------------------------------*/
/* target : çœŸå¯¦è‚¡ç¥¨éŠæˆ²                                 */
/* create : 98/06/21                                     */
/* update : 01/05/08                                     */
/* author : dsyan.bbs@forever.twbbs.org                  */
/* recast : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#if 0

 æœ¬è‚¡å¸‚éœ€è¦é…åˆ bin/stock-open.pl é€™ç¨‹å¼å»æŠ“è³‡æ–™ï¼Œcrontab å¦‚ä¸‹ï¼š

# æ¯å¤© 3:50PM è½‰æ›è‚¡å¸‚æ ¼å¼
50 15 * * * bin/stock-open.pl > etc/game/stock_data

 etc/game/stock_name æ˜¯æ‰€æœ‰è‚¡ç¥¨çš„åˆ—è¡¨ï¼Œè‹¥æœ‰æ–°è‚¡åŠ å…¥ï¼Œå¯ä»¥åŠ åœ¨æœ€å¾Œ
 etc/game/stock_data æ˜¯æ‰€æœ‰è‚¡ç¥¨çš„å¸‚åƒ¹ï¼Œstock-open.pl æœƒå»æŠ“

 è¦ä½¿ç”¨ stock-open.c å¿…é ˆè£æœ‰ lynxã€‚

#endif


#include "bbs.h"


#ifdef HAVE_GAME


#define STOSUM          2000       /* éŠæˆ²ä¸­æœ€å¤šå…è¨±å¹¾å®¶å…¬å¸ */
#define STOCKNAME       "è‚¡å¸‚å¤§äº¨"

#define FN_STOCK        "stock"    /* usr ç›®éŒ„ä¸‹å€‹äººçš„è‚¡å¸‚æª”æ¡ˆï¼å„è‚¡æ“æœ‰å¼µæ•¸ */
#define FN_STOCK_LOG    "stock.log"/* usr ç›®éŒ„ä¸‹å€‹äººçš„è‚¡å¸‚æª”æ¡ˆï¼æ­·å²è¨˜éŒ„ */


typedef struct
{
  char name[STOSUM][12];    /* æ‰€æœ‰å„å®¶è‚¡ç¥¨çš„åå­— #### ç”²ä¹™ä¸™
                               å››å€‹æ•¸å­—ã€ä¸€å€‹ç©ºç™½ã€ä¸‰å€‹åœ‹å­— */
  char update[11];          /* æ›´æ–°æ—¥æœŸæ ¼å¼ [90/05/08] */
  int price[STOSUM];        /* åƒ¹æ ¼ */
                            /* ç‚ºäº†ç¨‹å¼æ–¹ä¾¿ï¼Œ23.45 å…ƒå°±å„²å­˜æˆ 23450ï¼Œ
                               å³ä¸€å¼µ(1000è‚¡çš„åƒ¹æ ¼) */
  int max;                  /* å…±æœ‰å¹¾å®¶å…¬å¸ */
  int maxpage;              /* å…±éœ€è¦å¹¾é  */
} STOCK;


int
main_stock()
{
  int own[STOSUM];      /* å°å„è‚¡çš„æ“æœ‰è‚¡ä»½ */
  char *fname = FN_STOCK_LOG;
  char name[12], buf[128];
  FILE *fp;
  int i, ch, price, num, money, page, max, maxpage;
  time_t now;
  struct tm *ptime;
  STOCK *sto;

  if (HAS_STATUS(STATUS_COINLOCK))
  {
    vmsg(msg_coinlock);
    return XEASY;
  }

  if (!dashf("etc/game/stock_data") || !dashf("etc/game/stock_name"))
  {
    vmsg("è‚¡å¸‚æª”æ¡ˆéºå¤±ï¼Œè«‹å‘Šè¨´ç«™é•·");
    return XEASY;
  }

  /* initialize shared memory */
  sto = shm_new(STOCKSHM_KEY, sizeof(STOCK));

  /* è®€è³‡æ–™æª” */

  fp = fopen("etc/game/stock_data", "r");   /* è®€å–ç›®å‰è‚¡åƒ¹ */
  fgets(buf, 30, fp);
  if (strcmp(buf, sto->update))     /* è‹¥ shm ä¸­ä¸æ˜¯ä»Šå¤©çš„è³‡æ–™ï¼Œæ‰æ›´æ–° */
  {
    FILE *fn;

    strcpy(sto->update, buf);       /* æ›´æ–°æ—¥æœŸ */

    ch = 0;
    fn = fopen("etc/game/stock_name", "r");
    while (fgets(sto->name[ch], 12, fn))
    {
      fgets(buf, 12, fn);
      ch++;             /* å€Ÿç”¨ ch ä½œç‚º stock_name ä¸­çš„å…¬å¸æ•¸ */
    }
    fclose(fn);

    num = 0;
    fn = fopen("etc/game/stock_name", "a");

    while (fgets(buf, 80, fp))  /* å¾ stock_data å–å‡ºè‚¡åƒ¹å­˜å…¥ shm */
    {
      /* åœ¨æœ¬ while è¿´åœˆä¸­ï¼Œ
         ch æ˜¯æŒ‡ stock_name ä¸­çš„å…¬å¸æ•¸ï¼Œnum æ˜¯æŒ‡ stock_data ä¸­çš„å…¬å¸æ•¸ */

      if (buf[0] < '0' || buf[0] > '9')
        continue;       /* ä¸åˆç†çš„æ ¼å¼ */

      buf[11] = '\0';
      buf[21] = '\0';
      num++;

      strcpy(name, buf);            /* buf[0] ~ buf[11] ç‚ºå…¬å¸åç¨± */
      price = atoi(buf + 16) * 10;  /* buf[16] ~ buf[21] ç‚ºåƒ¹æ ¼ */

      /* ç‚ºäº†é¿å…ç¶²é çš„è®Šå‹•æˆ–æ–°ä¸Šå¸‚å…¬å¸ï¼Œè€Œä½¿ stock_name å’Œ stock_data
         ä¸æ˜¯ä¸€å°ä¸€å°æ‡‰ï¼Œæ˜¯æ•…å¾ stock_data ä¸­æŠ“åˆ°åƒ¹æ ¼ä»¥å¾Œï¼Œè¦æœå°‹æ­£ç¢ºçš„æ¬„ä½ */

      for (i = 0; i < ch; i++)
      {
        if (!strcmp(name, sto->name[i]))
          break;
      }

      if (i == ch && ch < STOSUM)   /* å¦‚æœæœ‰æ–°å¢å…¬å¸ï¼Œè¦å¯«å…¥ stock_name */
      {                 /* å¦‚æœå·²ç¶“è¶…é STOSUMï¼Œå‰‡ä¸å¾—å¢åŠ  */
        strcpy(sto->name[i], name);
        fprintf(fn, "%s\n", name);
        ch++;
      }
      sto->price[i] = price;
    }

    fclose(fn);
    sto->max = num;
    sto->maxpage = num / 40 + ((num % 40) ? 1 : 0);
    /* maxpage = max/40 å–å¤©èŠ±æ¿å‡½æ•¸ */
  }
  fclose(fp);

  max = sto->max;
  maxpage = sto->maxpage;

  /* è®€å– user è³‡æ–™æª” */

  usr_fpath(buf, cuser.userid, FN_STOCK);

  if (fp = fopen(buf, "r")) /* ä»¥å‰ç©éè‚¡å¸‚ï¼Œè®€å–ç›®å‰æ‰€æœ‰çš„è‚¡ä»½ */
  {
    for (i = 0; i < STOSUM; i++)
      fscanf(fp, "%d\n", &own[i]);
  }
  else              /* æ²’ç©éè‚¡å¸‚ï¼Œå»ºç«‹æ–°æª” */
  {
    fp = fopen(buf, "w");
    for (i = 0; i < STOSUM; i++)
    {
      fprintf(fp, "%d\n", 0);
      own[i] = 0;
    }
  }
  fclose(fp);


  /* ç•«é¢ä¸»ç¨‹å¼ */

  page = 0;

  while (1)
  {
    vs_bar(STOCKNAME);
    move(1, 0);
    outs("\033[1;31;46m ç·¨è™Ÿ \033[42m è‚¡ ç¥¨ å ç¨± \033[43m åƒ¹ æ ¼ \033[45m"
      " æŒæœ‰å¼µæ•¸ \033[46m     ç·¨è™Ÿ \033[42m è‚¡ ç¥¨ å ç¨± \033[43m"
      " åƒ¹ æ ¼ \033[45m æŒæœ‰å¼µæ•¸  \033[m");

    /* å°‡æœ¬é çš„è‚¡åƒ¹åˆ†æˆäºŒæ¬„é¡¯ç¤º */

    for (i = 0; i < 20; i++)
    {
      move(i + 2, 0);

      num = page * 40 + i;
      if (num + 1 <= max)
      {
        price = sto->price[num];
        ch = (price % 1000) / 10;   /* å°æ•¸ä½ */
        prints(" %3d)  %11s%5d.%02d %5d         ",
          num + 1, sto->name[num], price / 1000,
          (ch < 10 ? ch * 10 : ch), own[num]);
      }

      num += 20;
      if (num + 1 <= max)
      {
        price = sto->price[num];
        ch = (price % 1000) / 10;   /* å°æ•¸ä½ */
        prints("%3d)  %11s%5d.%02d %5d\n",
          num + 1, sto->name[num], price / 1000,
          (ch < 10 ? ch * 10 : ch), own[num]);
      }
    }

    move(b_lines - 1, 0);
    prints(COLOR1 " n:ä¸‹é  p:ä¸Šé  b:è²· s:è³£ v:çœ‹ e:ä¿® q:é›¢é–‹ "
      "éŒ¢:%-8d %2d/%2dé    %-12.10s\033[m",
      cuser.money, page + 1, maxpage, sto->update);

get_key:
    switch (ch = vkey())
    {

    /* ä»¥ä¸‹ name, price, num, i å°‡ä¸å†ç”¨åˆ°ï¼Œå€Ÿä¾†åšå›ç­” */

    /* itoc.010512.è¨»è§£: ç”±æ–¼æ˜¯åœ¨ä¸‹åˆä¸‰é»åŠä»Šå¤©çš„ç›¤å·²ç¶“é—œäº†ä»¥å¾Œï¼Œæ‰å»æŠ“ä»Šå¤©
       çš„æ”¶ç›¤å€¼ï¼Œæ‰€ä»¥å¯ä»¥å…ˆçŸ¥é“å¯¦éš›ä»Šå¤©å„è‚¡çš„æ¼²è·Œï¼Œå¦‚æœä¸é™åˆ¶äº¤æ˜“æ™‚é–“ï¼Œé‚£éº¼
       å°‡å¯ä»¥ä»¥æ˜¨å¤©çš„åƒ¹æ ¼çš„è²·é€²ã€‚åŒç†ï¼Œè³£å‡ºä¹Ÿè¦é™åˆ¶æ™‚é–“ */

    case 'b':   /* buy */
      now = time(0);
      ptime = localtime(&now);
      if (ptime->tm_hour >= 6 && ptime->tm_hour <= 15)
      {
        vmsg("äº¤æ˜“æ™‚é–“ç‚ºæ¯å¤© 4:00pm åˆ°éš”å¤©æ—©ä¸Š 7:00am .. :)");
        break;
      }

      sprintf(buf, "è¦è²·å“ªå®¶(1-%d)ï¼Ÿ", max);
      vget(b_lines, 0, buf, name, 4, DOECHO);
      i = atoi(name);
      if (i < 1 || i > max)
        break;

      price = sto->price[i - 1];
      price += price / 300; /* æŠ½ç¨…åƒåˆ†ä¹‹ä¸‰ */
      money = price ? cuser.money / price : 0; /* itoc.010716: é é˜² price=0 */
      sprintf(buf, "è¦è²·å¹¾å¼µ(1-%d)ï¼Ÿ", money);
      vget(b_lines, 0, buf, name, 4, DOECHO);
      num = atoi(name);
      if (num < 1 || num > money)
        break;

      /* è²·ç¬¬ i è™Ÿè‚¡ç¥¨ num å¼µ */
      own[i - 1] += num;
      money = num * price;
      if (cuser.money <= money)
        cuser.money = 0;
      else
        cuser.money -= money;

      /* è¨˜éŒ„è³¼è²·è¨˜éŒ„ */
      usr_fpath(buf, cuser.userid, fname);
      fp = fopen(buf, "a+");
      ch = (price % 1000) / 10; /* å°æ•¸ä½ */
      fprintf(fp, "[%s] %5d.%02d è²·é€² %s %d å¼µ èŠ±è²» %d\n",
        Btime(&now), price / 1000, (ch < 10 ? ch * 10 : ch),
        sto->name[i - 1], num, money);
      fclose(fp);
      break;


    case 's':   /* sell */
      now = time(0);
      ptime = localtime(&now);
      if (ptime->tm_hour >= 3 && ptime->tm_hour <= 18)
      {
        vmsg("äº¤æ˜“æ™‚é–“ç‚ºæ¯å¤© 7:00pm åˆ°éš”å¤©æ—©ä¸Š 4:00am .. :)");
        break;
      }

      sprintf(buf, "è¦è³£å“ªå®¶(1-%d)ï¼Ÿ", max);
      vget(b_lines, 0, buf, name, 4, DOECHO);
      i = atoi(name);
      if (i < 1 || i > max)
        break;
      price = own[i - 1];
      if (!price)       /* æ²’æœ‰æŒè‚¡ä¸èƒ½è³£ */
        break;

      sprintf(buf, "è¦è³£å¹¾å¼µ(1-%d)ï¼Ÿ", price);
      vget(b_lines, 0, buf, name, 4, DOECHO);
      num = atoi(name);
      if (num < 1 || num > price)
        break;

      /* è³£ç¬¬ i è™Ÿè‚¡ç¥¨ num å¼µ */
      own[i - 1] -= num;
      price = sto->price[i - 1];
      price -= price / 300; /* æŠ½ç¨…åƒåˆ†ä¹‹ä¸‰ */
      money = num * price;
      cuser.money += money;

      /* è¨˜éŒ„è³£å‡ºè¨˜éŒ„ */
      usr_fpath(buf, cuser.userid, fname);
      fp = fopen(buf, "a+");
      ch = (price % 1000) / 10; /* å°æ•¸ä½ */
      fprintf(fp, "[%s] %5d.%02d è³£å‡º %s %d å¼µ æ”¶å…¥ %d\n",
        Btime(&now), price / 1000, (ch < 10 ? ch * 10 : ch),
        sto->name[i - 1], num, money);
      fclose(fp);
      break;


    case 'v':   /* view history */
      usr_fpath(buf, cuser.userid, fname);
      more(buf, NULL);
      break;


    case 'e':   /* edit history */
      usr_fpath(buf, cuser.userid, fname);
      vedit(buf, 0);
      break;


    case 'p':   /* previous page */
    case KEY_UP:
    case KEY_PGUP:
      if (page)
    page--;
      else
    page = maxpage - 1;
      break;


    case 'n':   /* next page */
    case KEY_DOWN:
    case KEY_PGDN:
      if (page + 1 < maxpage)
    page++;
      else
    page = 0;
      break;


    case 'q':
    case KEY_LEFT:
      /* åœ¨é›¢é–‹è‚¡å¸‚æ™‚æ‰å›å­˜æ‰€æœ‰è‚¡ç¥¨å¼µæ•¸åŠé‡‘éŒ¢ï¼Œç¯€çœI/O */
      usr_fpath(buf, cuser.userid, FN_STOCK);
      fp = fopen(buf, "w");
      for (i = 0; i < STOSUM; i++)
       fprintf(fp, "%d\n", own[i]);
      fclose(fp);
      return 0;


    default:
      if (ch >= '1' && ch <= '9')
      {
        if (vget(b_lines, 0, "è·³è‡³ç¬¬å¹¾é ï¼š", name, 3, DOECHO))
        {
          i = atoi(name) - 1;
          if (i < maxpage)
            page = i;
        }
        break;
      }
      goto get_key; /* ä¸ç”¨é‡ç¹ªç•«é¢ */
    }
  }
}
#endif              /* HAVE_GAME */

--
[1mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mpc512-2.EE.NCTU.edu.tw[37m ç™¼è¡¨[m
