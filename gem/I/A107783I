ä½œè€…: itoc (ç ´è§£éŸŒé«”æ‰æ˜¯ç‹é“ï¼) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] äº¤é€šå¤§å­¸åŠŸèª²è¡¨
æ™‚é–“: 2004/04/07 Wed 14:31:55                           Updated: 2004/04/07

  ç¬¦åˆäº¤é€šå¤§å­¸ä¸Šèª²æ™‚é–“çš„åŠŸèª²è¡¨

  å–ä»£ classtable.c å³å¯ä½¿ç”¨

/*-------------------------------------------------------*/
/* classtable.c ( YZU WindTopBBS Ver 3.02 )              */
/*-------------------------------------------------------*/
/* target : åŠŸèª²è¡¨                                       */
/* create :   /  /                                       */
/* update : 02/07/12                                     */
/* author :                                              */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

#ifdef HAVE_CLASSTABLE

/* ----------------------------------------------------- */
/* classtable.c ä¸­é‹ç”¨çš„è³‡æ–™çµæ§‹                         */
/* ----------------------------------------------------- */


#define MAX_WEEKDAY     6       /* ä¸€æ˜ŸæœŸæœ‰ 6 å¤© */
#define MAX_DAYCLASS    16      /* ä¸€å¤©æœ‰ 16 ç¯€ */


typedef struct
{
  char name[9];     /* èª²å */
  char teacher[9];  /* æ•™å¸« */
  char class[8];    /* æ•™å®¤ */
  char nouse[4];    /* æ²’ç”¨çš„æ¬„ä½ */
}   CLASS;


typedef struct
{
  CLASS table[MAX_WEEKDAY][MAX_DAYCLASS];
    /* ä¸€æ˜ŸæœŸ MAX_WEEKDAY * MAX_DAYCLASS å ‚èª² */
}   CLASS_TABLE;


typedef struct
{
  char c_class[5];  /* ç¬¬å¹¾ç¯€ */
  char c_start[6];  /* ä¸Šèª²æ™‚é–“ */
  char c_break[6];  /* ä¸‹èª²æ™‚é–“ */
}  CLOCK;


static CLOCK class_time[MAX_DAYCLASS] =     /* èª²å ‚æ™‚é–“ */
{
  {" ï¼­ ", "06:00", "06:50"},
  {" ï¼® ", "07:00", "07:50"},
  {" ï¼¡ ", "08:00", "08:50"},
  {" ï¼¢ ", "09:00", "09:50"},
  {" ï¼£ ", "10:10", "11:00"},
  {" ï¼¤ ", "11:10", "12:00"},
  {" ï¼¸ ", "12:30", "13:20"},
  {" ï¼¥ ", "13:30", "14:20"},
  {" ï¼¦ ", "14:30", "15:20"},
  {" ï¼§ ", "15:40", "16:30"},
  {" ï¼¨ ", "16:40", "17:30"},
  {" ï¼¹ ", "17:40", "18:30"},
  {" ï¼© ", "18:30", "19:20"},
  {" ï¼ª ", "19:30", "20:20"},
  {" ï¼« ", "20:30", "21:20"},
  {" ï¼¬ ", "21:30", "22:20"}
};


/* ----------------------------------------------------- */
/* CLASS è™•ç†å‡½æ•¸                                        */
/* ----------------------------------------------------- */


static void
class_show(x, y, class)
  int x, y;
  CLASS *class;
{
  move(x, y);
  prints("èª²åï¼š%s", class->name);
  move(x + 1, y);
  prints("æ•™å¸«ï¼š%s", class->teacher);
  move(x + 2, y);
  prints("æ•™å®¤ï¼š%s", class->class);
}


static int          /* 1:æ­£ç¢º 0:éŒ¯èª¤ */
class_number(day, class)    /* å‚³å›æ˜ŸæœŸå¹¾ç¬¬å¹¾ç¯€ */
  int *day;
  int *class;
{
  char ans[4];

  move(2, 0);
  outs("5C è¡¨ç¤ºæ˜ŸæœŸäº”ç¬¬ï¼£ç¯€");
  *day = vget(3, 0, "ä¸Šèª²æ™‚é–“ï¼š", ans, 3, DOECHO) - '1';
  *class = *(ans + 1);
  if (*class >= 'A' && *class <= 'Z')
    *class |= 0x20;     /* æ›å°å¯« */

  switch (*class)
  {
  case 'm':
  case 'n':
    *class -= 'm';
    break;

  case 'a':
  case 'b':
  case 'c':
  case 'd':
    *class -= 'a' - 2;
    break;

  case 'x':
    *class = 6;
    break;

  case 'e':
  case 'f':
  case 'g':
  case 'h':
    *class -= 'e' - 7;
    break;

  case 'y':
    *class = 11;
    break;

  case 'i':
  case 'j':
  case 'k':
  case 'l':
    *class -= 'i' - 12;
    break;

  default:
    return 0;
  }
  if (*day > MAX_WEEKDAY - 1 || *day < 0 || *class > MAX_DAYCLASS - 1 || *class < 0)
    return 0;

  return 1;
}


static void
class_edit(class)
  CLASS *class;
{
  int echo;

  echo = *(class->name) ? GCARRY : DOECHO;
  vget(4, 0, "èª²åï¼š", class->name, sizeof(class->name), echo);
  vget(5, 0, "æ•™å¸«ï¼š", class->teacher, sizeof(class->teacher), echo);
  vget(6, 0, "æ•™å®¤ï¼š", class->class, sizeof(class->class), echo);
}


/* ----------------------------------------------------- */
/* CLASS_TABLE è™•ç†å‡½æ•¸                                  */
/* ----------------------------------------------------- */


static void
table_file(fpath, table)    /* æŠŠ table å¯«å…¥ FN_CLASSTBL_LOG */
  char *fpath;
  CLASS_TABLE *table;
{
  int i, j;
  FILE *fp;

  fp = fopen(fpath, "w");

  fprintf(fp, "           æ˜ŸæœŸä¸€    æ˜ŸæœŸäºŒ    æ˜ŸæœŸä¸‰    æ˜ŸæœŸå››    æ˜ŸæœŸäº”    æ˜ŸæœŸå…­\n");
  for (i = 0; i < MAX_DAYCLASS; i++)
  {
    fprintf(fp, "ç¬¬%sç¯€  ", class_time[i].c_class);
    for (j = 0; j < MAX_WEEKDAY; j++)
      fprintf(fp, "%-8.8s  ", table->table[j][i].name);

    fprintf(fp, "\n  %s   ", class_time[i].c_start);
    for (j = 0; j < MAX_WEEKDAY; j++)
      fprintf(fp, "%-8.8s  ", table->table[j][i].teacher);

    fprintf(fp, "\n  %s   ", class_time[i].c_break);
    for (j = 0; j < MAX_WEEKDAY; j++)
      fprintf(fp, "%-8.8s  ", table->table[j][i].class);

    fprintf(fp, "\n\n");
  }
  fclose(fp);
}


static void
table_show(table)
  CLASS_TABLE *table;
{
  char fpath[64];

  usr_fpath(fpath, cuser.userid, FN_CLASSTBL_LOG);
  table_file(fpath, table);
  more(fpath, NULL);
}


static void
table_mail(table)
  CLASS_TABLE *table;
{
  char fpath[64];

  usr_fpath(fpath, cuser.userid, FN_CLASSTBL_LOG);
  table_file(fpath, table);
  mail_self(fpath, cuser.userid, "å€‹äººåŠŸèª²è¡¨", MAIL_READ);
}


static void
table_edit(table)
  CLASS_TABLE *table;
{
  int i, j;

  vs_bar("ç·¨è¼¯å€‹äººåŠŸèª²è¡¨");

  if (class_number(&i, &j))
  {
    class_edit(&(table->table[i][j]));
    class_show(10, 0, &(table->table[i][j]));
  }
}


static void
table_del(table)
  CLASS_TABLE *table;
{
  int i, j;

  vs_bar("åˆªé™¤å€‹äººåŠŸèª²è¡¨");

  if (!class_number(&i, &j))
    return;

  class_show(10, 0, &(table->table[i][j]));

  if (vans(msg_sure_ny) == 'y')
    memset(&(table->table[i][j]), 0, sizeof(CLASS));
}


static void
table_copy(table)
  CLASS_TABLE *table;
{
  int i, j, x, y;

  vs_bar("å€‹äººåŠŸèª²è¡¨");

  move(9, 0);
  outs("ä¾†æºï¼š");
  if (!class_number(&i, &j))
    return;

  class_show(10, 0, &(table->table[i][j]));

  move(9, 39);
  outs("ç›®çš„ï¼š");
  if (!class_number(&x, &y))
    return;

  class_show(10, 39, &(table->table[x][y]));

  if (vans(msg_sure_ny) == 'y')
    memcpy(&(table->table[x][y]), &(table->table[i][j]), sizeof(CLASS));
}


int
main_classtable()
{
  char fpath[64];
  CLASS_TABLE newtable, oldtable, *ptr;

  usr_fpath(fpath, cuser.userid, FN_CLASSTBL);
  ptr = &newtable;

  if (rec_get(fpath, ptr, sizeof(CLASS_TABLE), 0))
    memset(ptr, 0, sizeof(CLASS_TABLE));
  memcpy(&oldtable, ptr, sizeof(CLASS_TABLE));

  for (;;)
  {
    switch (vans("èª²è¡¨ç³»çµ± (E/C/D)ç·¨è¼¯/è¤‡è£½/åˆªé™¤ P)å°å‡º K)å…¨ç  S)å­˜æª” M)ä¿¡ç®± Q)é›¢é–‹ [Q] "))
    {
    case 'e':
      table_edit(ptr);
      break;
    case 'd':
      table_del(ptr);
      break;
    case 'c':
      table_copy(ptr);
      break;

    case 'p':
      table_show(ptr);
      break;
    case 'm':
      table_mail(ptr);
      break;

    case 's':
      rec_put(fpath, ptr, sizeof(CLASS_TABLE), 0, NULL);
      memcpy(&oldtable, ptr, sizeof(CLASS_TABLE));
      vmsg("å„²å­˜å®Œæˆ");
      break;
    case 'k':
      if (vans(msg_sure_ny) == 'y')
      {
        unlink(fpath);
        memset(ptr, 0, sizeof(CLASS_TABLE));
        memset(&oldtable, 0, sizeof(CLASS_TABLE));
      }
      break;

    default:
      goto end_loop;
    }
  }

end_loop:

  /* æª¢æŸ¥æ–°èˆŠæ˜¯å¦ä¸€æ¨£ï¼Œè‹¥ä¸ä¸€æ¨£è¦å•æ˜¯å¦å­˜æª” */
  if (memcmp(&oldtable, ptr, sizeof(CLASS_TABLE)))
  {
    if (vans("æ˜¯å¦å„²å­˜(Y/N)ï¼Ÿ[Y] ") != 'n')
      rec_put(fpath, ptr, sizeof(CLASS_TABLE), 0, NULL);
  }

  return 0;
}
#endif  /* HAVE_CLASSTABLE */

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
