ç™¼ä¿¡äºº: itoc.bbs@processor.tfcis.org (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: è«‹å•é—œæ–¼é›…è™ï¼å¥‡æ‘©çš„æ–°èåŠŸèƒ½
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2004/02/12 Thu 12:45:28)                Updated: 2006/08/12

â€» å¼•è¿°ã€Šsegaa.bbs@segaa.com.tw (åŠ ç­ing)ã€‹ä¹‹éŠ˜è¨€ï¼š
>    å¦‚æœèªªè¦åƒç„¡åä¸€æ¨£ç›´æ¥æŠŠkimoæ–°èè‡ªå‹•è½‰åˆ°çœ‹æ¿ä¸Š
>    æ¯å€‹åˆ†é¡å„é–‹ä¸€å€‹ç‰ˆï¼Œæ¯å¤©è‡ªå‹•åŸ·è¡Œå»æŠ“æ–°èå¾Œç›´æ¥poståˆ°æ¿ä¸Š

  åœ¨ ~/run/kimo ä¸‹é–‹ 12 å€‹ç›®éŒ„ï¼Œåˆ†åˆ¥æ˜¯
  A/ B/ C/ D/ E/ F/ G/ H/ I/ J/ K/ L/

  äº¦å³åœ¨å·¥ä½œç«™ä¸ŠåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤
  % mkdir ~/run/kimo
  % mkdir ~/run/kimo/A ~/run/kimo/B ~/run/kimo/C ~/run/kimo/D
  % mkdir ~/run/kimo/E ~/run/kimo/F ~/run/kimo/G ~/run/kimo/H
  % mkdir ~/run/kimo/I ~/run/kimo/J ~/run/kimo/K ~/run/kimo/L

: src/util/Makefile

EXE =   .... [1;33menews-open[m

: crontab -e æ–°å¢æ­¤äºŒè¡Œ

# æ¯å¤© 10:30AM 4:30PM æŠ“å¥‡æ‘©æ–°è
30 10,16 * * * bin/enews-open

: struct.h æ–°å¢ä¸‹é¢é€™æ®µ

/* ----------------------------------------------------- */
/* enews-open.c ä¸­é‹ç”¨çš„è³‡æ–™çµæ§‹ : 256 bytes             */
/* ----------------------------------------------------- */


typedef struct
{
  time_t chrono;                /* ç·¨è™Ÿ */
  char kind;                    /* ç¨®é¡ */
  char xname[50];               /* æª”æ¡ˆåç¨± */

  char link[128];               /* é€£çµè·¯å¾‘ */
  char title[TTLEN + 1];        /* æ–‡ç« æ¨™é¡Œ */
} ENEWS;

: util/enews-open.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/enews-open.c    ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : å¥‡æ‘©æ–°èæ›´æ–°                                 */
/* create : 02/01/29                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#if 0

 æœ¬å¥‡æ‘©æ–°èæ›´æ–°ç¨‹å¼éœ€è¦é…åˆ contab å»æŠ“è³‡æ–™ï¼Œcrontab å¦‚ä¸‹ï¼š

# æ¯å¤© 10:30AM 4:30PM æŠ“å¥‡æ‘©æ–°è
30 10,16 * * * bin/enews-open

 è¦ä½¿ç”¨ enews-open.c å¿…é ˆè£æœ‰ lynxï¼Œæ³¨æ„ lynx çš„è·¯å¾‘è¦å’Œç¨‹å¼å»åˆã€‚
 å¦‚æœä¸»æ©Ÿéœ€é€é proxy æ‰èƒ½é€£å¤–çš„è©±ï¼Œé‚£éº¼è¦ä¿®æ”¹ lynx.cfg çš„ http_proxy è¨­å®šå€¼ã€‚

 ç¬¬ä¸€æ¬¡åŸ·è¡Œæœ¬ç¨‹å¼ä»¥å‰ï¼Œå¿…é ˆå…ˆæ‰‹å‹•ç”¨ lynx ç™»å…¥ tw.yahoo.com

 è¦ä½¿ç”¨ enews-open.c å¿…é ˆè£æœ‰ iconvï¼Œæ³¨æ„ iconv çš„è·¯å¾‘è¦å’Œç¨‹å¼å»åˆã€‚

 æ–‡ç« æª”æ¡ˆæ”¾åœ¨ run/kimo/

 è³‡æ–™ä¾†æºï¼šYahoo! å¥‡æ‘©æ–°è http://tw.news.yahoo.com/

#endif


#include "bbs.h"


#define LYNX_PATH       "/usr/local/bin/lynx --source"  /* lynx çš„çµ•å°è·¯å¾‘ */
#define ICONV_PATH      "/usr/local/bin/iconv -c -f utf-8 -t cp950"


#define INDEX_FILE  "tmp/kimo_index"
#define NEWS_FILE   "tmp/kimo_news"


/*-------------------------------------------------------*/
/* åˆ†æ html                                             */
/*-------------------------------------------------------*/


static int wlen;    /* æœ¬è¡Œæœ‰å¤šå°‘å­— */
static int slen;    /* æœ¬è¡Œæœ‰å¤šå°‘åŠå½¢å­— */
static char source[64]; /* æœ¬ç¯‡æ–°èçš„ä¾†æº */


static void
foutc(ch, fp)
  int ch;
  FILE *fp;
{
  static int in_tag = 0;    /* 1: åœ¨ <tag> ä¸­ */
  static int in_chi = 0;    /* 1: å‰ä¸€ç¢¼æ˜¯ä¸­æ–‡å­— */

  if (ch == '<')
  {
    in_tag = 1;
    return;
  }

  if (!in_tag)
  {
    if (in_chi || ch & 0x80)    /* å‰ä¸€å€‹charæˆ–é€™charæ˜¯ä¸­æ–‡å­—çš„ç¬¬ä¸€ç¢¼ */
      in_chi ^= 1;
    else            /* å¦‚æœéƒ½ä¸æ˜¯ï¼Œè¡¨ç¤ºé€™charæ˜¯åŠå½¢å­— */
      slen++;

    if (wlen >= 60 - slen % 2)  /* ä¸€è¡Œæœ€å¤š 60 å­—ï¼Œè‹¥æœ‰å¥‡æ•¸å€‹åŠå½¢å­—ï¼Œè©²è¡Œåªå° 59 å­— */
    {
      fputs("\n    ", fp);  /* æ¯è¡Œå‰é¢éƒ½ç©ºå››æ ¼ */
      wlen = 0;
      /* slen = 0; */
      slen = !in_chi;       /* è‹¥æ–°çš„é€™è¡Œç¬¬ä¸€å€‹charæ˜¯åŠå½¢å­—ï¼Œslen=1 */
    }

    fputc(ch, fp);
    wlen++;
  }
  else
  {
    if (ch == '>')
      in_tag = 0;
  }
}


static void
fouts(str, fp)
  uschar *str;
  FILE *fp;
{
  int ch;

  wlen = 0;
  slen = 0;
  fputs("\n    ", fp);      /* æ¯è¡Œå‰é¢éƒ½ç©ºå››æ ¼ */

  while (ch = *str)
  {
    foutc(ch, fp);
    str++;
  }
}


static void
html_download(enews)        /* ä¸‹è¼‰æ–‡ç« ä¸¦è½‰æ›ç‚ºæ–‡å­—æª” */
  ENEWS *enews;
{
  char *strS, *strE, *strL;
  char buf[2048];   /* å‡è¨­æ–‡ç« æ¯æ®µä¸æœƒè¶…é 2048 å­— */
  FILE *fpr, *fpw;
  int article_begin;

  /* ä¸‹è¼‰æ–‡ç«  */
  sprintf(buf, LYNX_PATH " %s | " ICONV_PATH " > " NEWS_FILE, enews->link);
  system(buf);

  /* è½‰æ›ç‚ºæ–‡å­—æª” */
  if (fpr = fopen(NEWS_FILE, "r"))
  {
    sprintf(buf, "run/kimo/%c/%s", enews->kind, enews->xname);
    if (fpw = fopen(buf, "w"))
    {
      /* é–‹é ­åŠ ä¸Šæ¨™é¡Œ */
      fprintf(fpw, "%s %s (%s) %s %s\n",
        STR_AUTHOR1, STR_SYSOP, SYSOPNICK, STR_POST2, "å¥‡æ‘©æ–°è");
      fprintf(fpw, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n", enews->title, Now());

      /* åŠ ä¸Šæ–°èä¾†æº */
      fprintf(fpw, "\n    ä¾†æºï¼š%s\n", source);

      /* html -> text */
      article_begin = 0;
      while (fgets(buf, sizeof(buf), fpr))
      {
        if (!article_begin)     /* æ–‡ç« é–‹å§‹ */
        {
          if (strstr(buf, "<!--(begin) inc-article_content.jake -->"))
            article_begin = 1;
          continue;
        }
        else
        {
          /* æ–‡ç« çµæŸ */
          if (strstr(buf, "<!--(end) inc-article_content.jake -->"))
            break;

          strS = buf;
          /* æœ¬æ–‡éƒ¨åˆ† */
          while ((strS = strstr(strS, "<p>")) && (strE = strstr(strS, "</p>")))
          {
            *strE = '\n';
            *(strE + 1) = '\0';
            strS += 3;
            while (strL = strstr(strS, "<br />"))
            {
              *strL = '\n';
              *(strL + 1) = '\0';
              fouts(strS, fpw);
              strS = strL + 6;
            }
            if ((strS != strE) && !strstr(strS, "<article_image>")) /* è·³éåœ–ç‰‡è¨»è§£ */
              fouts(strS, fpw);
            strS = strE + 4;
          }
        }
      }

      /* çµå°¾åŠ ä¸Šé€£çµ */
      fprintf(fpw, "\n--\nYahoo!å¥‡æ‘©æ–°è\n%s\n", enews->link);
      fclose(fpw);
    }

    fclose(fpr);
    unlink(NEWS_FILE);  /* æ¸…é™¤æš«å­˜æª” */
  }
}


static void
xml_fetch(fpath, kind)  /* å°‡é€™æª”æ¡ˆä¸­æœ‰æ•ˆçš„é€£çµæ‰¾å‡ºä¾† */
  char *fpath;
  char kind;        /* ç¨®é¡ */
{
  static int chrono = 0;
  FILE *fp;
  char folder[64], buf[1024];
  char *strA, *strB;
  ENEWS enews;
  int article_num;

  if (!(fp = fopen(fpath, "r")))
    return;

  sprintf(folder, "run/kimo/%c/.ENEWS", kind);
  unlink(folder);   /* é‡å»ºä¸€å€‹æ–°çš„ */

#if 0
  è™•ç† XML æ ¼å¼å¦‚ä¸‹ï¼š
<item>
<title>é›™äººæ»‘å†°å¥ªéŠ€ å‰µå¤§é™¸å²ä¸Šæ–°é«˜ (è¯åˆæ–°èç¶²)</title>
<link>http://tw.rd.yahoo.com/referurl/news/rss/spo/*http://tw.news.yahoo.com/060214/15/2uqj5.html</link>
</item>
#endif

  article_num = 0;

  while (fgets(buf, 1024, fp) && article_num <= 30)
  {
    if (strstr(buf, "<item>"))
    {
      /* åŠ å…¥ record */

      memset(&enews, 0, sizeof(ENEWS));
      enews.chrono = ++chrono;      /* æ¯ç¯‡æ–‡ç« ä¸€å€‹ç·¨è™Ÿ */
      enews.kind = kind;
      sprintf(enews.xname, "A%06d%c", chrono, kind);
      fgets(buf, 1024, fp); /* <title> */
      *(strA = strstr(buf, " (")) = '\0';
      str_ncpy(enews.title, buf + 7, sizeof(enews.title));
      *(strB = strstr(strA + 2, ")")) = '\0';
      str_ncpy(source, strA + 2, sizeof(source));
      fgets(buf, 1024, fp); /* <link> */
      strA = strstr(buf, "*");
      *(strB = strstr(strA, "</link>")) = '\0';
      sprintf(enews.link, strA + 1);
      if (!rec_add(folder, &enews, sizeof(ENEWS)))
        html_download(&enews);

      article_num++;
    }
  }

  fclose(fp);
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main()
{
  char kind;
  char cmd[256];

  char *class[13] =
  {
    "realtime", "politics", "society", "taiwan", "intl",
    "biz", "tech", "sports", "health",
    "showbiz", "travel", "life", "oddlyenough"
  };

  chdir(BBSHOME);

  /* æŠ“ RSS ä¸¦åˆ†æä¹‹ */

  for (kind = 'A'; kind <= 'M'; kind++)
  {
    sprintf(cmd, LYNX_PATH " http://tw.news.yahoo.com/rss/%s | "
      ICONV_PATH " > " INDEX_FILE, class[kind - 'A']);
    system(cmd);
    xml_fetch(INDEX_FILE, kind);
    unlink(INDEX_FILE);     /* æ¸…é™¤æš«å­˜æª” */
  }

  return 0;
}

--
 [1;43mâ•­[46mâ”¼[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [32;47m processor.tfcis.org [m
 [1;44mâ”¼[41mâ•¯[m A[1mut[30mho[mr: [1;33mitoc [30må¾ [35mpc512-2.ee.nctu.edu.tw [30mç™¼è¡¨[m
