ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] åˆªé™¤éä¹…æ²’æœ‰æ–°æ–‡ç« çš„çœ‹æ¿
æ™‚é–“: 2005/04/05 Tue 16:13:03                           Updated: 2005/12/28

â€» å¼•è¿°ã€Šdrewlin.bbs@bbs.seehere.org (eternity.)ã€‹ä¹‹éŠ˜è¨€ï¼š
> å¸Œæœ›ç³»çµ±èƒ½å¤ è‡ªå‹•åˆªé™¤ä¸‰å€‹æœˆä»¥ä¸Šæ²’æœ‰æ–°æ–‡ç« çš„çœ‹æ¿

: global.h

#define FN_RUN_PAL      "run/pal.log"   /* æœ‹å‹è¶…éä¸Šé™è¨˜éŒ„ */
+ #define FN_RUN_EXPIREBRD "run/expirebrd" /* ç³»çµ±ç é™¤çœ‹æ¿è¨˜éŒ„ */

: battr.h

+ #define BRD_NOEXPIRE  0x80    /* ä¸æœƒè¢«ç³»çµ±ç é™¤ */

- #define NUMBATTRS   7
+ #define NUMBATTRS   8

- #define STR_BATTR   "zTcsvA%"
+ #define STR_BATTR   "zTcsvA%e"

   "ä¸è©•åˆ†çœ‹æ¿",         /* BRD_NOSCORE */
+  "ä¸è¢«ç³»çµ±ç é™¤çœ‹æ¿",   /* BRD_NOEXPIRE */

: account.c:main()

    sprintf(title, "%så¯„ä¿¡è¨˜éŒ„", date);
    keeplog(FN_RUN_MAIL_LOG, BN_SECURITY, title, 2);

+   sprintf(title, "%sç³»çµ±ç é™¤çœ‹æ¿è¨˜éŒ„", date);
+   keeplog(FN_RUN_EXPIREBRD, BN_SECURITY, title, 2);


: crontab -e åŠ å…¥

4 4 4 * * bin/expireboard > /dev/null 2>&1

: src/util/Makefile åŠ å…¥ expireboard

EXE =   ... [1;33mexpireboard[m

: src/util/expireboard.c æ–°å¢ç¨‹å¼å¦‚ä¸‹

/*-------------------------------------------------------*/
/* util/expireboard.c   ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : ç é™¤éä¹…æ²’æœ‰æ–°æ–‡ç« çš„çœ‹æ¿                     */
/* create : 05/04/05                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

#define THRESHOLD_TIME      (40 * 86400) /* ç é™¤è¶…é 40 å¤©æ²’æ–‡ç« çš„çœ‹æ¿ */
#define THRESHOLD_NOTE_TIME (30 * 86400) /* ç æ¿å‰ 30 å¤©é€šçŸ¥æ¿ä¸» */
[1;44m// crontab è£¡ expireboard çš„åŸ·è¡Œé€±æœŸè¦è·Ÿ THRESHOLD_NOTE_TIME åŒæ­¥ [m


/*-------------------------------------------------------*/
/* é€šçŸ¥ä¿¡                                                */
/*-------------------------------------------------------*/


static void
mail_to_him(userid, brdname)
  char *userid, *brdname;
{
  HDR hdr;
  char folder[64];

  usr_fpath(folder, userid, NULL);
  if (!dashd(folder))    /* é¿å…è©² ID ä¸å­˜åœ¨ */
    return;

  usr_fpath(folder, userid, FN_DIR);
  hdr_stamp(folder, HDR_LINK, &hdr, "etc/expirebrd_note");
  strcpy(hdr.owner, STR_SYSOP);
  strcpy(hdr.nickname, SYSOPNICK);
  sprintf(hdr.title, "[%s] æ¿å³å°‡è¢«ç é™¤", brdname);
  rec_add(folder, &hdr, sizeof(HDR));
}


static void
note_expire(brd)    /* æ‰¾å‡ºæ¿ä¸» */
  BRD *brd;
{
  char *ptr, *str, buf[BMLEN + 1];
  int len, alllen;

  sprintf(buf, "%s", brd->BM);
  alllen = 0;
  ptr = str = buf;

  for (; ptr = strchr(str, '/') ;)
  {
    *ptr = '\0';
    mail_to_him(str, brd->brdname);
    len = strlen(str);
    alllen += (len + 1);    /* æ¿ä¸»ID + '/' */
    str = buf + alllen;
  }
  mail_to_him(str, brd->brdname);         /* æœ€å¾Œä¸€ç­†è³‡æ–™å¦å¤–è™•ç† */
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


static time_t now;
static time_t delta;      /* æœ€å¾Œä¸€ç¯‡æ–‡ç« è·ç›®å‰å¹¾ç§’ */
static int page;          /* æœ‰å¹¾ç¯‡æ–‡ç«  */


static void
expire(brd)
  BRD *brd;
{
  int fd, fsize;
  char folder[64];
  HDR hdr;
  struct stat st;

  brd_fpath(folder, brd->brdname, FN_DIR);

  if ((fd = open(folder, O_RDONLY)) >= 0 && !fstat(fd, &st))
  {
    fsize = st.st_size;
    page = fsize / sizeof(HDR);

    if (page <= 0)  /* æ²’æœ‰æ–‡ç« å‰‡çœ‹é–‹æ¿æ™‚é–“ */
    {
      delta = brd->bstamp;
    }
    else
    {
      lseek(fd, fsize - sizeof(HDR), SEEK_SET);
      read(fd, &hdr, sizeof(HDR));
      delta = hdr.chrono;
    }
    delta = now - delta;
    close(fd);
  }
}


static BCACHE *bshm;


static void
init_bshm()
{
  /* itoc.030727: åœ¨é–‹å•Ÿ bbsd ä¹‹å‰ï¼Œæ‡‰è©²å°±è¦åŸ·è¡Œé accountï¼Œ
     æ‰€ä»¥ bshm æ‡‰è©²å·²è¨­å®šå¥½ */

  bshm = shm_new(BRDSHM_KEY, sizeof(BCACHE));

  if (bshm->uptime <= 0)        /* bshm æœªè¨­å®šå®Œæˆ */
    exit(0);
}


int
main()
{
  int pos;
  BRD brd, *bhdr;
  char fpath[64];
  FILE *fp;

  chdir(BBSHOME);

  if (!(fp = fopen(FN_RUN_EXPIREBRD, "w")))
    return -1;

  time(&now);
  init_bshm();

  fprintf(fp, "ä¸‹åˆ—çœ‹æ¿å·²æ–¼ %s è¢«ç³»çµ±ç é™¤ï¼š\n\n", Btime(&now));

  pos = 0;
  while (!rec_get(FN_BRD, &brd, sizeof(BRD), pos))
  {
    if (*brd.brdname && !(brd.battr & BRD_NOEXPIRE))
    {
      expire(&brd);

      if (delta >= THRESHOLD_TIME)
      {
        gem_fpath(fpath, brd.brdname, NULL);
        f_rm(fpath);
        f_rm(fpath + 4);

        memset(&brd, 0, sizeof(BRD));
        sprintf(brd.title, "[%s] deleted by <crontab>", brd.brdname);
        rec_put(FN_BRD, &brd, sizeof(BRD), pos, NULL);

        bhdr = bshm->bcache + pos;
        memcpy(bhdr, &brd, sizeof(BRD));

        fprintf(fp, "  %s\n", brd.brdname);
      }
      else if (delta >= THRESHOLD_NOTE_TIME)
      {
        note_expire(&brd);
      }
    }
    pos++;
  }

  fclose(fp);

  return 0;
}

: etc/expirebrd_note æ–°å¢æ­¤æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹

ä½œè€…: SYSOP (ç«™é•·) ç«™å…§: [ç³»çµ±å…¬å‘Š]
æ¨™é¡Œ: ç æ¿é€šçŸ¥
æ™‚é–“: å°±æ˜¯ç¾åœ¨

 æ‚¨å¥½ï¼š

     ç”±æ–¼æ­¤æ¿ä½¿ç”¨ç‡éä½ï¼Œæ‰€ä»¥æ­¤æ¿å³å°‡è¢«ç³»çµ±è‡ªå‹•ç é™¤ï¼Œè‹¥æ‚¨ä¸å¸Œæœ›çœ‹æ¿
 è¢«ç é™¤ï¼Œè«‹å®šæœŸæ–¼çœ‹æ¿ä¸Šç™¼è¡¨æ–‡ç« ã€‚

--
                                          ç«™å‹™ç®¡ç†å“¡ ï¼³ï¼¹ï¼³ï¼¯ï¼°



--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mthree.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
