ç™¼ä¿¡äºº: shakalaca.bbs@bittern.csie.nctu.edu.tw.bbs@aurora. çœ‹æ¿: plan
æ¨™  é¡Œ: [doc] bbs + gallery
ç™¼ä¿¡ç«™: aurora (2004/03/08 Mon 19:07:12)                  Updated: 2004/04/28

: so/Makefile è‹¥æ˜¯ FreeBSD é€™æ¨£æ”¹

SO =    .... [1;33mgallery.so[m

.SUFFIXES: .c .o .so

.c.o:   ;  $(CC) $(CFLAGS) -c $*.c
.o.so:  ;  ld -s -G $*.o -o $*.so -L../lib -ldao [1;33m-lmd[m

: so/Makefile è‹¥æ˜¯ Linux é€™æ¨£æ”¹

SO =    .... [1;33mgallery.so[m

SUFFIXES:
SUFFIXES: .c .o .so

c.o:    ;  $(CC) $(CFLAGS) -c $*.c
o.so:   ;  ld -s -G $*.o -o $*.so -L../lib -ldao [1;33m-lssl[m

: menu.c é©ç•¶çš„é¸å–®åŠ å…¥

  "bin/gallery.so:create_account", 0, - M_XMODE,
  "Gallery    â™‚ æ–°å¢ç›¸ç°¿ â™€",

: so/gallery.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* gallery.c    ( NTHU CS MapleBBS Ver 2.36 )            */
/*-------------------------------------------------------*/
/* target : create gallery account                       */
/* create : 04/03/08                                     */
/* update : 04/03/08                                     */
/* author : shakalaca.bbs@php.twbbs.org                  */
/*-------------------------------------------------------*/


#include "bbs.h"


#define ALBUM_PATH      "/home/data/www/albums"
#define FN_GALLERY_LOG  "run/gallery.log"


typedef struct
{
  char username[32];
  char fullname[32];
  char password[64];
  char email[64];
  char uid[32];
  char lastactiondate[64];
} GalleryUser;


/* ------------------------------------------------------------------ */

static void
f_add(fpath, msg)   /* ä»¿ f_cat()ï¼Œå”¯æ¬Šé™æ”¹ç‚º 0664 */
  char *fpath;
  char *msg;
{
  int fd;

  if ((fd = open(fpath, O_WRONLY | O_CREAT | O_APPEND, 0664)) >= 0)
  {
    write(fd, msg, strlen(msg));
    close(fd);
  }
}


static void
f_join(from, to)    /* æ•ˆæœé¡ä¼¼ f_suck()ï¼Œå”¯æ¬Šé™æ”¹ç‚º 0664 */
  char *from, *to;
{
  int in, out, len;
  char buf[512];

  if ((in = open(from, O_RDONLY)) >= 0)
  {
    if ((out = open(to, O_WRONLY | O_CREAT | O_APPEND, 0664)) >= 0)
    {
      while (len = read(in, buf, sizeof(buf)))
        write(out, buf, len);

      close(out);
    }
    close(in);
  }
}


/* ------------------------------------------------------------------ */


static int      /* 1:æˆåŠŸ 0:å¤±æ•— */
create_file(u, hash)
  GalleryUser u;
  char *hash;
{
  char fpath[64], input[1024];

  sprintf(fpath, "%s/.users/%s", ALBUM_PATH, hash);

  if (!dashf(fpath))     /* è¦æª¢æŸ¥ hash æ˜¯ä¸æ˜¯æœ‰é‡è¦† */
  {
    sprintf(input, "O:12:\"gallery_user\":13:{s:8:\"username\";%s;"
      "s:8:\"fullname\";%s;s:8:\"password\";%s;s:5:\"email\";%s;s:7:\"isAdmin\";b:0;"
      "s:15:\"canCreateAlbums\";s:1:\"0\";s:3:\"uid\";%s;s:15:\"defaultLanguage\";"
      "s:5:\"en_US\";s:7:\"version\";i:5;s:15:\"recoverPassHash\";N;"
      "s:10:\"lastAction\";s:8:\"register\";s:14:\"lastActionDate\";%s;"
      "s:9:\"origEmail\";%s;}",
      u.username, u.fullname, u.password, u.email, u.uid,
      u.lastactiondate, u.email);

    f_add(fpath, input);
    return 1;
  }

  return 0;
}


static int      /* 1:æˆåŠŸ 0:å¤±æ•— */
create_album(u, hash)
  GalleryUser u;
  char *hash;
{
  char fpath[128], file[128], buf[256], buf2[128];
  time_t now;

  sprintf(fpath, "%s/%s", ALBUM_PATH, cuser.userid);

  if (!dashd(fpath))
  {
    if (mkdir(fpath, 0775) == -1)
    {
      /* è¦æŠŠå‰›æ‰ç”¢ç”Ÿçš„ hashfile åˆªé™¤ */
      sprintf(fpath, "%s/.users/%s", ALBUM_PATH, hash);
      unlink(fpath);
      return 0;
    }

    time(&now);

    sprintf(file, "%s/photos.dat", fpath);
    f_add(file, "N;");

    sprintf(file, "%s/album.dat", fpath);

    sprintf(buf2, "%s çš„ç›¸ç°¿", cuser.userid);
    sprintf(buf, "O:5:\"album\":5:{s:6:\"fields\";a:57:{s:5:\"title\";s:%d:\"%s\";",
      strlen(buf2), buf2);
    f_add(file, buf);

    f_join("etc/gallery/album.dat.head", file);

    sprintf(buf, "s:11:\"clicks_date\";i:%ld;", now);
    f_add(file, buf);

    f_join("etc/gallery/album.dat.body", file);

    sprintf(buf, "s:4:\"name\";s:%d:\"%s\";s:5:\"owner\";%s;s:13:\"last_mod_time\";i:%ld;",
      strlen(cuser.userid), cuser.userid, u.uid, now);
    f_add(file, buf);

    f_join("etc/gallery/album.dat.foot", file);
  }

  return 1;
}


#ifdef LINUX

#include <openssl/md5.h>

static char *
gen_salt(password)
  char *password;
{
#define MD5ENCODELEN    16
  int i;
  MD5_CTX ctx;
  char buf[MD5ENCODELEN];
  static char retbuf[2 * MD5ENCODELEN + 1];

  MD5Init(&ctx);
  MD5Update(&ctx, (uschar *) password, (usint) strlen(password));
  MD5Final(buf, &ctx);

  for (i = 0; i < MD5ENCODELEN; i++)
    sprintf(retbuf + (i << 1), "%02x", buf[i]);

  return retbuf;
}

#else

#include <md5.h>

static char *
gen_salt(password)        /* è¼¸å…¥åŸå§‹å¯†ç¢¼ï¼Œè¼¸å‡ºåŠ å¯†å¯†ç¢¼ */
  char *password;
{
  int i, ch;
  char salt[5], tmpbuf[64], buf[33];
  static char retbuf[64];

  for (i = 0; i < 4; i++)
  {
    ch = rand() % (109 - 48 + 1) + 48;
    if (ch > 57)
      ch += 7;
    if (ch > 90)
      ch += 6;
    salt[i] = ch;
  }
  salt[4] = '\0';

  sprintf(tmpbuf, "%s%s", salt, password);
  MD5Data(tmpbuf, strlen(tmpbuf), buf);
  sprintf(retbuf, "%s%s", salt, buf);

  return retbuf;
}
#endif


static void
gallery_log(mode)
  char *mode;
{
  char buf[128];

  sprintf(buf, "%s %s (%s)\n", Now(), mode, cuser.userid);

  f_add(FN_GALLERY_LOG, buf);
}


int
create_account()
{
  GalleryUser gu;
  char buf[128], *ptr;
  time_t now;

  sprintf(buf, "%s/%s", ALBUM_PATH, cuser.userid);

  if (dashd(buf))
  {
    vmsg("æ‚¨å·²ç¶“ç”³è«‹éç›¸ç°¿äº†ï¼");
    return XEASY;
  }

  time(&now);
  sprintf(gu.username, "s:%d:\"%s\"", strlen(cuser.userid), cuser.userid);
  sprintf(gu.fullname, "s:%d:\"%s\"", strlen(cuser.username), cuser.username);
  sprintf(gu.email, "s:%d:\"%s\"", strlen(cuser.email), cuser.email);
  sprintf(gu.lastactiondate, "i:%ld", now);

  for (;;)
  {
    vget(b_lines, 0, "è«‹è¨­å®šå¯†ç¢¼ï¼š", buf, PSWDLEN + 1, NOECHO);
    if ((strlen(buf) < 3) || !strcmp(buf, cuser.userid))
    {
      vmsg("å¯†ç¢¼å¤ªç°¡å–®ï¼Œæ˜“é­å…¥ä¾µï¼Œè‡³å°‘è¦ 4 å€‹å­—ï¼Œè«‹é‡æ–°è¼¸å…¥");
      continue;
    }

    vget(b_lines, 0, "è«‹æª¢æŸ¥å¯†ç¢¼ï¼š", buf + PSWDLEN + 2, PSWDLEN + 1, NOECHO);
    if (!strcmp(buf, buf + PSWDLEN + 2))
      break;

    vmsg("å¯†ç¢¼è¼¸å…¥éŒ¯èª¤, è«‹é‡æ–°è¼¸å…¥å¯†ç¢¼");
  }

  srand(now + cuser.userno);
  ptr = gen_salt(buf);
  sprintf(gu.password, "s:%d:\"%s\"", strlen(ptr), ptr);

  /* ç¢ºä¿åŒä¸€æ™‚é–“ä¸åŒäººå»ºçš„ hash ä¸åŒ */
  sprintf(buf, "%ld_%ld", now, rand());
  sprintf(gu.uid, "s:%d:\"%s\"", strlen(buf), buf);

  umask(0002);

  if (!create_file(gu, buf))
  {
    gallery_log("ERROR CREATING USER PROFILE");
    vmsg("éŒ¯èª¤ï¼šç„¡æ³•å»ºç«‹è³‡æ–™æª”ï¼Œè«‹é€šçŸ¥ç«™é•·ï¼");
  }
  else if (!create_album(gu, buf))
  {
    gallery_log("ERROR CREATING DIRECTORY");
    vmsg("éŒ¯èª¤ï¼šç„¡æ³•å»ºç«‹ç›¸ç°¿ï¼Œè«‹é€šçŸ¥ç«™é•·ï¼");
  }
  else
  {
    gallery_log("CREATE ALBUM");
    vmsg("å·²å»ºç«‹è³‡æ–™ :)");
  }

  return XEASY;
}



ç¨‹å¼èªªæ˜ï¼š

* å…ˆè£ gallery å§ï¼ŒFreeBSD å¯ä»¥ç”¨ ports : /usr/ports/www/gallery
  ä¸ç„¶å°±å» http://gallery.sf.net æŠ“ã€‚

* FreeBSD å·²ç¶“é è¨­è£ md5 äº†ï¼Œå¦‚æœå…¶ä»–ç³»çµ±æ²’æœ‰è£ MD5 çš„è©±ï¼Œè«‹è‡ªè¡Œå®‰è£ã€‚

* å»æŠ“ ftp://php.twbbs.org/pub/bbs/gallery/etc è£¡é¢çš„æ±è¥¿ï¼Œæ”¾åˆ° BBS å®¶ç›®éŒ„
  ä¸‹çš„ etc/gallery è£¡é¢ã€‚é€™æ˜¯ album.dat çš„å…§å®¹ï¼Œç›´æ¥æ‹¿ä¾†ç”¨ç„¶å¾Œæ›ä¸Šè‡ªè¨‚çš„æ¬„
  ä½ï¼Œgallery æœƒå¾ˆè°æ˜çš„æŠŠè©²è³‡æ–™å¤¾ç•¶ä½œæ˜¯ç›¸ç°¿ã€‚

  ç•¶ç„¶é€™é‚Šå¯ä»¥ä½œå¾ˆå¤šè®ŠåŒ–ï¼Œåœ¨ album.dat.head çš„æœ€å¾Œå¹¾å€‹æ¬„ä½æœ‰ä¸€å€‹æ˜¯

    s:15:"parentAlbumName";i:0;

  æŒ‡çš„æ˜¯è©²ç›®éŒ„çš„çˆ¶ç›®éŒ„ç‚ºä½•ï¼Œå¦‚æœæƒ³æŠŠ bbs ä½¿ç”¨è€…ç”³è«‹çš„ç›®éŒ„éƒ½æ”¾åˆ°æŸå€‹
  è³‡æ–™å¤¾ä¸‹é¢çš„è©± (æ¯”å¦‚ bbs)ï¼Œå…ˆç”¨ gallery å»ºç«‹ bbs ç›¸ç°¿ï¼Œç„¶å¾Œä¿®æ”¹
  album.dat.headï¼ŒæŠŠä¸Šé¢é‚£äº›å­—ä¸²æ”¹ç‚º

    s:15:"parentAlbumName";s:3:"bbs";

  "bbs" å‰é¢çš„ 3 å°±æ˜¯æŒ‡ "bbs" é€™å€‹å­—ä¸²çš„é•·åº¦ï¼Œä¾æ­¤é¡æ¨å¯ä»¥æ›æˆ
  ä½ æƒ³è¦çš„è³‡æ–™å¤¾åç¨±ã€‚

* è¦æŠŠé€™äºŒå€‹ç›®éŒ„çš„æ¬Šé™
  /home/data/www/albums
  /home/data/www/albums/.users
  è®“ bbs èº«åˆ†å¯ä»¥å¯«å…¥ã€‚

* é€™æ¨£å­æ‡‰è©²å°±è¡Œäº† :D

  å¦‚æœæœ‰å•é¡Œæ­¡è¿æå‡º :)

  ç¨‹å¼ç›®å‰ä¸ç¢ºå®šæ˜¯å¦ç‚º bug freeï¼Œå¦‚æœå› ç‚ºä½¿ç”¨é€™æ”¯ç¨‹å¼é€ æˆ CPU ç‡’æ‰ï¼Œ
  è³‡æ–™æ¶ˆå¤±ï¼Œè¨˜æ†¶é«”ä¸è¦‹ï¼Œè¢«äººå…¥ä¾µï¼Œå¥³æœ‹å‹è·‘æ‰æˆ–æ˜¯è‚¡å¸‚å¥—ç‰¢ï¼Œæœ¬äººä¸è² è²¬ã€‚ :pp

--
                                                      æˆ‘çš„ç°½åæª”åªæœ‰åå€‹å­—.
--
 [1;37m  ^..^    [33mâ˜… [1;36m< è±¬ é ­ ç´€ å…¬ åœ’ - php.twbbs.org (140.113.208.200) >[m
 [1;37m-w @@ w-- [1;34m                         < bittern.csie.nctu.edu.tw >[m
