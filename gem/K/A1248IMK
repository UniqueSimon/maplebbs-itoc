ä½œè€…: itoc (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: itoc
æ¨™é¡Œ: Re: [è«‹å•] é—œæ–¼All_Postçš„æ–‡ç« è®€å–...
æ™‚é–“: 2004/06/18 Fri 19:55:40                           Updated: 2005/10/30

â€» å¼•è¿°ã€ŠDaniel.bbs@pctAngel.twbbs.org (æˆ‘æ„›pct)ã€‹ä¹‹éŠ˜è¨€ï¼š
> è¦å¦‚ä½•åšæ‰èƒ½è®“ä½¿ç”¨è€…ä¸ç®¡åœ¨All_Postæˆ–å…¶ä»–ç‰ˆåªè¦è®€å–åŒä¸€ç¯‡æ–‡ç« ï¼Œ
> å‰‡è©²ç¯‡æ–‡ç« åœ¨All_Postç‰ˆé¡¯ç¤ºå·²è®€éï¼Œè€Œå…¶ä»–ç‰ˆä¸Šè©²ç¯‡æ–‡ç« ä¹Ÿæ˜¯å·²è®€ç‹€æ…‹ï¼Ÿ

  é¦–å…ˆè¦åšç²¾è¯å€é€™ç¯‡
  [åŠŸèƒ½] post.c æ‰€æœ‰çš„ post éƒ½æœƒå‡ºç¾åœ¨ All_Post æ¿

  [All_Post] æ–‡ç« çš„ hdr.xid ç‚º åŸçœ‹æ¿ æ–‡ç« çš„ hdr.chrono

: post.c:do_post()

  /* qazq.031025: å…¬é–‹æ¿æ‰åš all_post */
  brd = bshm->bcache + currbno;
  if ((brd->readlevel | brd->postlevel) < (PERM_VALID << 1))
-   do_allpost(fpath, rcpt, nick, mode);
+   do_allpost(fpath, rcpt, nick, mode, hdr.chrono);

: post.c:do_allpost()

static void
- do_allpost(fpath, owner, nick, mode)
+ do_allpost(fpath, owner, nick, mode, chrono)
  char *fpath;
  char *owner;
  char *nick;
  int mode;
+ time_t chrono;
{
  HDR hdr;
  char folder[64];
  char *brdname = "All_Post";       // æ¿åè‡ªå®š

  brd_fpath(folder, brdname, fn_dir);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, fpath);

  hdr.xmode = mode & ~POST_OUTGO;  /* æ‹¿æ‰ POST_OUTGO */
+ hdr.xid = chrono;
  strcpy(hdr.owner, owner);
  strcpy(hdr.nick, nick);
  strcpy(hdr.title, ve_title);

  rec_bot(folder, &hdr, sizeof(HDR));

  btime_update(brd_bno(brdname));
}

: post.c æ–°å¢é€™ä¸€æ®µåœ¨ post_browse() å‰é¢

static int
find_board(fpath)
  char *fpath;
{
  FILE *fp;
  char buf[ANSILINELEN], *str, *ptr;

  if (fp = fopen(fpath, "r"))
  {
    ptr = fgets(buf, ANSILINELEN, fp);
    fclose(fp);

    if (ptr &&
      ((str = strstr(buf, STR_POST1 " ")) ||
      (str = strstr(buf, STR_POST2 " "))))
    {
      str += sizeof(STR_POST1);
      if (ptr = strchr(str, '\n'))
        *ptr = '\0';
      return brd_bno(str);
    }
  }
  return -1;
}

static void
allpost_history(xo, hdr)
  XO *xo;
  HDR *hdr;
{
  int fd, bno;
  BRD *brd;
  char folder[64], fpath[64];
  HDR old;

  if (strcmp(currboard, "All_Post"))/* åœ¨ä¸€èˆ¬æ¿è®€å®Œï¼Œä¹Ÿå» All_Post æ¨™ç¤ºå·²è®€ */
  {
    brd_fpath(folder, "All_Post", fn_dir);
    if ((fd = open(folder, O_RDONLY)) >= 0)
    {
      lseek(fd, 0, SEEK_SET);
      while (read(fd, &old, sizeof(HDR)) == sizeof(HDR))
      {
        if (hdr->chrono == old.xid)
        {
          hdr_fpath(fpath, folder, &old);
          if ((bno = find_board(fpath)) >= 0)
          {
            brd = bshm->bcache + bno;
            if (!strcmp(currboard, brd->brdname))
            {
              bno = brd_bno("All_Post");
              brd = bshm->bcache + bno;

              brh_get(brd->bstamp, bno);
              bno = hdr->chrono;
              brh_add(bno - 1, bno, bno + 1);

              /* æ¢å¾©åŸä¾†çœ‹æ¿ */
              brd = bshm->bcache + currbno;
              brh_get(brd->bstamp, currbno);
              break;
            }
          }
        }
      }
      close(fd);
    }
  }
  else                              /* åœ¨ All_Post è®€å®Œï¼Œä¹Ÿå»åˆ¥æ¿æ¨™ç¤ºå·²è®€ */
  {
    hdr_fpath(fpath, xo->dir, hdr);
    if ((bno = find_board(fpath)) >= 0)
    {
      brd = bshm->bcache + bno;
      brh_get(brd->bstamp, bno);
      bno = hdr->xid;
      brh_add(bno - 1, bno, bno + 1);

      /* æ¢å¾©åŸä¾†çœ‹æ¿ */
      brd = bshm->bcache + currbno;
      brh_get(brd->bstamp, currbno);
    }
  }
}

: post.c:post_browse()

    post_history(xo, hdr);
+   allpost_history(xo, hdr);
    strcpy(currtitle, str_ttl(hdr->title));

  é€™åªé™æ”¹å®Œ code æ‰ä¸Šç«™ä½¿ç”¨è€…æ‰€æ–°å¢çš„æ–‡ç« 
  ä¹‹å‰çš„æ–‡ç« ä¸ work

--
  æ²’è©¦é

--
 [1;41mâ•­[44mâ”¼[m Or[1mig[30min[m: [43m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [35;47m processor.tfcis.org [m
 [1;43mâ•°[46mâ•–[m [1mMo[30mdi[mfy: [1;35m2004/06/18 Fri 20:38:09[m
