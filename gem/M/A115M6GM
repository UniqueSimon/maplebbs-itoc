ç™¼ä¿¡äºº: TKyo.bbs@cpu.tfcis.org (æš—é»‘è²´å…¬å­) çœ‹æ¿: plan
æ¨™  é¡Œ: [æ–°å¢ž] window.c pans() pmsg() æ”¯æ´ ANSI å­—å…ƒç¢¼
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2005/04/11 Mon 18:00:23)                Updated: 2005/04/11

/* æœ¬ç¨‹å¼ç¢¼éœ€å…ˆæ›´æ–°éŽ windows.c pans/pmsg ç½®ä¸­ç¨‹å¼ç¢¼ */

: maple/window.c
#include "bbs.h"

/* æ–°å¢žå‡½å¼ : å‰”é™¤ ANSI å­—å…ƒç¢¼åŠå‚³å›žçœŸæ­£å­—ä¸²é•·åº¦ */
static int
chk_ansi(char *str)
{
  int i = 0, ch;
  int is_ansi = 0;

  while (ch = *str)
  {
    if (is_ansi)
    {
      if (ch == 'm')
        is_ansi = 0;
    }
    else
    {
      if (ch == KEY_ESC)
        is_ansi = 1;
      else
        i++;
    }
    str++;
  }

  return i;
}

: maple/window.c : pans()
int             /* å‚³å›žå°å¯«å­—æ¯æˆ–æ•¸å­— */
pans(x, y, title, desc)
  int x, y;
  char *title;
  char *desc[];
{
- int cur, old_cur, max, ch;
+ int cur, old_cur, max, ch, i; /* æ–°å¢žè®Šæ•¸ i, åŠ é€Ÿç”¨ */
  char hotkey;

   /* æ‰¾å‡º title åŠ desc ä¸­æœ€é•·çš„é•·åº¦ */
  char buf[512];        /* tsaikd.041005 title å¯èƒ½æœ‰å¥½å¹¾è¡Œ */
  strcpy(buf, title);
- desc_maxlen = strlen(strtok(buf, "\n"));
+ desc_maxlen = chk_ansi(strtok(buf, "\n"));
  char *tmp;
- while ( (tmp = strtok(NULL, "\n")) !=NULL )
-   desc_maxlen = (desc_maxlen > strlen(tmp)) ? desc_maxlen : strlen(tmp);
+ while ((tmp = strtok(NULL, "\n")) != NULL)
+   desc_maxlen = ((i = chk_ansi(tmp)) > desc_maxlen) ? i : desc_maxlen;

- for( ch=1 ; desc[ch] ; ch++ )
-   desc_maxlen = (desc_maxlen > strlen(desc[ch])) ?
-\       desc_maxlen : strlen(desc[ch]);
+ for (ch = 1; desc[ch]; ch++)
+   desc_maxlen = ((i = chk_ansi(desc[ch])) > desc_maxlen) ? i : desc_maxlen;
  .
  .
  .
}

: maple/window.c : draw_item()
{
  .
  .
  .
- sprintf(buf, " â”‚%s%c %c%c%c%-25s  \033[mâ”‚ ",
+ sprintf(buf, " â”‚%s%c %c%c%c%-s%*c\033[mâ”‚ ",
  .
  .
  .
- (hotkey == *desc) ? ']' : ')', desc + 1);
+ (hotkey == *desc) ? ']' : ')', desc + 1,
+ (desc_maxlen - chk_ansi(desc + 1)), ' ');
  .
  .
  .
}

: maple/window.c : draw_menu()
{
  .
  .
  .
  /* tsaikd.041005 å€Ÿç”¨ meet */
- meet = strlen(ptitle[i]) + (strlen(ptitle[i]) % 2);
+ meet = chk_ansi(ptitle[i]) + (chk_ansi(ptitle[i]) % 2);
  .
  .
  .
}

: maple/window.c : pmsg()
- int len, x, y, i;
+ int len, x, y, i, j; /* æ–°å¢žè®Šæ•¸ j, åŠ é€Ÿç”¨ */

- len = strlen(strtok(buf, "\n"));
- for( i=1 ; (pbuf = strtok(NULL, "\n")) != NULL ; i++ )
-   len = len<strlen(pbuf) ? strlen(pbuf) : len;

+ len = chk_ansi(strtok(buf, "\n"));
+ for (i = 1; (pbuf = strtok(NULL, "\n")); i++)
+   len = ((j = chk_ansi(pbuf)) > len) ? j : len;
  .
  .
  .
}

--
 [1;43mâ—¤[46mâ—¥[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [36;47m cpu.tfcis.org [m
 [1;44mâ—£[41mâ—¢[m A[1mut[30mho[mr: [1;33mTKyo [30må¾ž [31mcszone.twbbs.org [30mç™¼è¡¨[m
