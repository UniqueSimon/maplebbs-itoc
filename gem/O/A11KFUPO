ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] å°‡å°šæœªå­˜æª”çš„æ°´çƒå­˜æ–¼ä¿¡ç®±
æ™‚é–“: 2005/10/09 Sun 00:58:44                           Updated: 2005/10/09

: src/util/Makefile

EXE =   ... [1;33msaveBMWtoMbox[m

: src/util/saveBMWtoMbox.c æ–°å¢ç¨‹å¼å¦‚ä¸‹

/*-------------------------------------------------------*/
/* saveBMWtoMbox.c      ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : å°‡å°šæœªå­˜æª”çš„æ°´çƒå­˜æ–¼ä¿¡ç®±                     */
/* create : 05/10/08                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"


/* æŠ„ bmw.c */
#define BMW_FORMAT  "\033[1;33;46mâ˜…%s \033[37;45m %s \033[m" /* æ”¶åˆ°çš„æ°´çƒ */
#define BMW_FORMAT2 "\033[1;33;41mâ˜†%s \033[34;47m %s \033[m" /* é€å‡ºçš„æ°´çƒ */


int
main()
{
  int fd;
  char c;
  char fbmw[64], buf[64], folder[64], *str;
  HDR hdr;
  ACCT acct;
  BMW bmw;
  FILE *fp;
  DIR *dirp;
  struct dirent *de;

  for (c = 'a'; c <= 'z'; c++)
  {
    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      str = de->d_name;
      if (*str <= ' ' || *str == '.')
        continue;

      /* æª¢æŸ¥æœ‰ç„¡æœªå­˜æª”çš„ FN_BMW */
      sprintf(fbmw, "%s/" FN_BMW, str);
      if (!dashf(fbmw))
        continue;

      /* å–å¾—è©² ID çš„æ­£ç¢ºå¤§å°å¯«ã€userno */
      sprintf(buf, "%s/" FN_ACCT, str);
      if ((fd = open(buf, O_RDONLY)) >= 0)
      {
        read(fd, &acct, sizeof(ACCT));
        close(fd);
      }
      else
      {
        strcpy(acct.userid, str);
      }

      /* å°‡æ°´çƒè¨˜éŒ„è®Šæˆä¿¡ä»¶ */
      if ((fd = open(fbmw, O_RDONLY)) >= 0)
      {
        sprintf(folder, "%s/" FN_DIR, str);
        if (fp = fdopen(hdr_stamp(folder, 0, &hdr, buf), "w"))
        {
          fprintf(fp, "              == æ°´çƒè¨˜éŒ„ %s ==\n\n", Now());

          while (read(fd, &bmw, sizeof(BMW)) == sizeof(BMW))
          {
            fprintf(fp, bmw.sender == acct.userno ? BMW_FORMAT2 " %s\n" :
              BMW_FORMAT " %s\n",
              bmw.userid, bmw.msg, Btime(&bmw.btime));
          }
          fclose(fp);
        }
        close(fd);

        strcpy(hdr.owner, acct.userid);
        strcpy(hdr.title, "[å‚™ å¿˜ éŒ„] æ°´çƒç´€éŒ„");
        hdr.xmode = MAIL_READ | MAIL_NOREPLY;
        rec_add(folder, &hdr, sizeof(HDR));
      }

      /* å­˜åˆ°ä¿¡ç®±å¾Œå°±åˆªé™¤ FN_BMW åŠ FN_AMW */
      unlink(fbmw);
      sprintf(fbmw, "%s/" FN_AMW, str);
      unlink(fbmw);
    }

    closedir(dirp);
  }

  return 0;
}


--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
