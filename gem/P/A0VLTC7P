ç™¼ä¿¡äºº: BioStar.bbs@micro.bio.ncue.edu.tw (æ¾æ¹–å°é›²é›€) çœ‹æ¿: itoc
æ¨™  é¡Œ: [å•é¡Œ] æ˜Ÿåº§ç”·å¥³é…å°...  æ”¹ä¸å‡ºä¾†...  Q_Q
ç™¼ä¿¡ç«™: æ“å¤©å´— (Sun, 20 Jul 2003 04:04:39 +0800 (CST))    Updated: 2003/07/20

: menu.c é©ç•¶çš„é¸å–®åŠ å…¥

+  "bin/horoscope.so:x_astro", 0, - M_XMODE,
+  "Astro      ã€ æˆ‘çš„æ˜Ÿåº§ ã€‘",

+  "bin/horoscope.so:x_pair", 0, - M_XMODE,
+  "Pair       ã€ æ˜Ÿåº§é…å° ã€‘",

: src/so/Makefile

SO =    admutil.so bank.so chat.so help.so vote.so xyz.so [1;33mhoroscope.so[m \

: etc/horoscope

  å»ºé€™ç›®éŒ„ etc/horoscope
  etc/horoscope/ ä¸‹é‚„è¦æœ‰ä¸‰å€‹æª”æ¡ˆ  day.hint moon.dat venus.dat
  æ”¾åœ¨ http://cpu.twbbs.org/horoscope/

: src/so/horoscope.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* horoscope.c  ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : æ˜Ÿåº§ç”·å¥³é…å°                                 */
/* create : 03/07/20                                     */
/* update :   /  /                                       */
/* author : BioStar.bbs@micro.bio.ncue.edu.tw            */
/*-------------------------------------------------------*/


#include "bbs.h"


struct birth
{
  int yy;    /* å‡ºç”Ÿè¥¿å…ƒå¹´ */
  int mm;    /* å‡ºç”Ÿæœˆ */
  int dd;    /* å‡ºç”Ÿæ—¥ */
};

struct h_set
{
  int s;     /* å¤ªé™½æ˜Ÿåº§ */
  int m;     /* æœˆäº®æ˜Ÿåº§ */
  int v;     /* é‡‘æ˜Ÿæ˜Ÿåº§ */
};


static char name[12][5] =
{
  "ç‰¡ç¾Š", "é‡‘ç‰›", "é›™å­",
  "å·¨èŸ¹", "ç…å­", "è™•å¥³",
  "å¤©ç§¤", "å¤©è ", "å°„æ‰‹",
  "æ‘©ç¾¯", "æ°´ç“¶", "é›™é­š"
};


static char *said[21] =
{
  "å•Š~~~å•Š~~~çµ¦æˆ‘ä¸€æ¯å¿˜æƒ…æ°´~~~",
  "å”‰~~~ä¸‹ä¸€å€‹æƒ…äººæœƒæ›´å¥½ï¼",
  "æ„›æƒ…æ˜¯è¾›è‹¦è€Œæ²’æœ‰ä»£åƒ¹çš„....",
  "å”‰...ç”¨å¾Œå¤©çš„åŠªåŠ›ä¾†è£œå…ˆå¤©ä¸è¶³å›‰ï¼Ÿ",
  "ä½ çŸ¥é“äººå®šå‹å¤©çš„é“ç†å—ï¼Ÿ",
  "æ‰€æœ‰çš„æˆå°±éƒ½æ˜¯é ä¹åä¹åˆ†çš„åŠªåŠ›çš„ï¼",
  "æ„›æƒ…æ²’æœ‰å¤©ç§¤ï¼è¼•é‡å…¨çœ‹è‡ªå·±ï¼",
  "å¤šçµ¦ä»–ä¸€äº›é—œæ‡·..æœƒå¾ˆæœ‰å¹«åŠ©çš„..",
  "ä½ å€‘çš„æ„Ÿæƒ…è¦é äº’ç›¸çš„åŒ…å®¹ï¼",
  "åå¹´ä¿®å¾—åŒèˆ¹æ¸¡...è¦å¥½å¥½çæƒœï¼",
  "æ„Ÿæƒ…æ˜¯æ²’æœ‰ç†ç”±çš„..å–œæ­¡å°±è¿½å§ï¼",
  "å—¯....æœ‰ç©ºå‡ºå»ç´„å€‹æœƒä¸€å®šä¸éŒ¯ï¼",
  "å—¯...åšå€‹æ„›å¯ä»¥å¢é€²å°å€†å£çš„æ„Ÿæƒ…å“¦ï¼",
  "ä½ å€‘æ„Ÿæƒ…æœƒèˆ‡æ—¥ä¿±å¢å“¦ï¼",
  "å‘µå‘µ...ä½ å€‘å°±æ˜¯å®¹æ˜“äº’ç›¸å¸å¼•~~",
  "å—¯..ä½ å€‘å°±æ˜¯é€™éº¼å®¹æ˜“å°±ç›¸æ„›äº†~~~",
  "åƒä½ å€‘é€™éº¼ç›¸é…å¯¦åœ¨æ˜¯ä¸å®¹æ˜“.....",
  "ä½ å€‘çš„æˆ€æ„›æœƒæ˜¯éå¸¸ç”œèœœçš„å“¦~~~",
  "å¤©å•Šï¼ä½ å€‘çœŸæ˜¯å¤©é€ åœ°è¨­çš„ä¸€å°ï¼",
  "éƒ½ç›¸é…åˆ°é€™ç¨®ç¨‹åº¦äº†..æœ‰æ²’æœ‰è€ƒæ…®çµå©šï¼Ÿ",
  "å‘µå‘µ...ä½ å€‘æ˜¯é€™ç«™å”¯ä¸€å‡ºç¾æ»¿åˆ†çš„æƒ…ä¾¶ï¼"
};


/* ----------------------------------------------------- */
/* å¤ªé™½æ˜Ÿåº§                                              */
/* ----------------------------------------------------- */


static int
SunHoro(Sa)
  struct birth *Sa;
{
  int Mm[12] = {20, 19, 21, 20, 21, 22, 23, 23, 23, 24, 23, 22};

  if (Sa->dd - Mm[Sa->mm - 1] >= 0)
    return (Sa->mm + 9) % 12;
  else
    return (Sa->mm + 8) % 12;
}


/* ----------------------------------------------------- */
/* é‡‘æ˜Ÿæ˜Ÿåº§                                              */
/* ----------------------------------------------------- */


static int              /* 1:è©²å¹´é–å¹´ */
Lunar(year)
  int year;
{
  if (year % 400 == 0)
    return 1;

  if (year % 100 == 0)
    return 0;

  if (year % 4 == 0)
    return 1;

  return 0;
}


static int
MonthTotalDay(Sa)
  struct birth *Sa;
{
  int MD[12] = {0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334};
  return MD[Sa->mm - 1] + (Lunar(Sa->yy) && Sa->mm > 2);
}


static int
DayNumber(Sa)           /* å‚³çµ¦çµæ§‹ birth, å‚³å›è©²å¤©ç‚ºç¬¬å¹¾å¤© */
  struct birth *Sa;
{
  int i;
  int TotalDay = 0;

  for (i = 1929; i < Sa->yy; i++)         /* å¾ StartDay(1929) ç®—èµ·  */
  {
    if (i < Sa->yy)
    {
      TotalDay = TotalDay + 365;
      if (Lunar(i))
        TotalDay++;
    }
  }

  TotalDay += MonthTotalDay(Sa);
  TotalDay += Sa->dd;

  return TotalDay;
}


static int
VenusHoro(Sa)
  struct birth *Sa;
{
  int rc;
  FILE *fp;
  struct birth Venusx;
  uschar VMon, VDay, VHr, VMin;
  char Venus, buf[120];

  if (!(fp = fopen("etc/horoscope/venus.dat", "r")))
    return 0;

  do
  {
    if (!fgets(buf, sizeof(buf), fp))
      break;
  } while (atoi(buf + 1) > Sa->yy);

  while (fgets(buf, 12, fp))
  {
    if (*buf == '!')
    {
      Venus = buf[9];
      buf[9] = '\0';
      VMin = atoi(buf + 7);
      buf[7] = '\0';
      VHr = atoi(buf + 5);
      buf[5] = '\0';
      VDay = atoi(buf + 3);
      buf[3] = '\0';
      VMon = atoi(buf + 1);
      buf[1] = '\0';
      Venusx.yy = Sa->yy;
      Venusx.mm = VMon;
      Venusx.dd = VDay;

      if (DayNumber(&Venusx) <= DayNumber(Sa))
      {
        rc = Venus >= 'A' ? Venus - 'A' + 9 : Venus - '1';
        break;
      }
    }
  }

  fclose(fp);

  return rc % 12;
}


/* ----------------------------------------------------- */
/* æœˆäº®æ˜Ÿåº§                                              */
/* ----------------------------------------------------- */


static int
MoonAddingDay(Day)
  int Day;
{
  int x[31] =
  {
    0, 1, 1, 1, 2, 2, 3,
    3, 4, 4, 5, 5, 5, 6,
    6, 7, 7, 8, 8, 9, 9,
    10, 10, 10, 11, 11, 12, 12,
    1, 1, 2
  };

  return x[Day - 1];
}


static int
MoonHoro(Sa)
  struct birth *Sa;
{
  int rc, j;
  FILE *fp;
  char Month, MoonBase, MoonMon;
  char buf[60], *ptr;

  Month = Sa->mm > 9 ? Sa->mm - 10 + 'A' : Sa->mm + '0';

  if (!(fp = fopen("etc/horoscope/moon.dat", "r")))
    return 0;

  j = 1929;
  while (j <= Sa->yy)
  {
    fgets(buf, 60, fp);
    j++;
  }

  fclose(fp);

  ptr = buf + 5;

  while (*ptr == '!' && *ptr)
  {
    MoonMon = *(ptr + 1);
    MoonBase = *(ptr + 2);

    if (Month == MoonMon)
    {
      rc = ((MoonBase - 'A') + 12) % 12 + MoonAddingDay(Sa->dd);
      break;
    }

    ptr += 3;
  }

  return rc % 12;
}


/* ----------------------------------------------------- */
/* ä¸»ç¨‹å¼                                                */
/* ----------------------------------------------------- */


static int
day_hint()
{
  int j, Day;
  FILE *fp;
  char msg[150];
  int MD[12] = {0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335};

  if (!(fp = fopen("etc/horoscope/day.hint", "r")))
    return 0;

  fgets(msg, 150, fp);
  Day = MD[cuser.month - 1] + cuser.day - 1;

  j = 0;
  while (j < Day)
  {
    if (!fgets(msg, 150, fp))
      break;

    if (*msg == '#')
      j++;
  }

  outs("     \033[1;36måœ¨ä»Šå¤©å‡ºç”Ÿçš„ä½ ï¼š\033[m \n");

  for (j = 0; j < 4 && fgets(msg, 150, fp); j++)
    prints(" \033[1;37m%s\033[m", msg);

  fclose(fp);
}


static int
TogetherRule(x, y)      /* ç®—å‡ºé€Ÿé…ç¨‹åº¦ï¼Œå‚³å› 0~100 */
  struct h_set *x;
  struct h_set *y;
{
  int score;

  /* å…¬å¼éš¨ä¾¿å¯«çš„ */

  score = (y->s - x->s) * 12 + (y->m - x->m) * 6 + (y->v - x->v) * 3;
  if (score < 0)
    score = -score;

  return score % 101;
}


static void
ask_birth(row, b)
  int row;
  struct birth *b;
{
  int year, month, day;
  char buf[80];
  int mmday[12] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};

  year = b->yy;
  month = b->mm;
  day = b->dd;

  row++;
  do
  {
    sprintf(buf, "ç”Ÿæ—¥ï¼æ°‘åœ‹ %02d å¹´ï¼š", year);
    if (vget(row, 0, buf, buf, 3, DOECHO))
      year = atoi(buf);
  } while (year < 40 || year > 90);
  year += 1911;
  mmday[1] = Lunar(year) ? 29 : 28;

  row++;
  do
  {
    sprintf(buf, "ç”Ÿæ—¥ï¼ %02d æœˆï¼š", month);
    if (vget(row, 0, buf, buf, 3, DOECHO))
      month = atoi(buf);
  } while (month < 1 || month > 12);

  row++;
  do
  {
    sprintf(buf, "ç”Ÿæ—¥ï¼ %02d æ—¥ï¼š", day);
    if (vget(row, 0, buf, buf, 3, DOECHO))
      day = atoi(buf);
  } while (day < 1 || day > mmday[month - 1]);

  b->yy = year;
  b->mm = month;
  b->dd = day;
}


static void
get_hset(row, x, b)
  int row;
  struct h_set *x;
  struct birth *b;
{
  char buf[3];

  x->s = SunHoro(b);
  x->m = MoonHoro(b);
  x->v = VenusHoro(b);

  move(row++, 0);
  outs("1)å¤ªé™½ 2)æœˆäº® 3)é‡‘æ˜Ÿ");

  while (1)
  {
    move(row, 0);
    prints(" [%s] [%s] [%s]", name[x->s], name[x->m], name[x->v]);

    switch (vget(row + 1, 0, "[1-3]å¾®èª¿ [Q]ç¢ºå®šï¼š", buf, 3, LCECHO))
    {
    case '1':
      x->s = (x->s + 1) % 12;
      break;
    case '2':
      x->m = (x->m + 1) % 12;
      break;
    case '3':
      x->v = (x->v + 1) % 12;
      break;
    case 'q':
      return;
    }
  }
}


int
x_astro()
{
  int Sun, Moon, Venus;
  struct birth User;

  User.mm = cuser.month;
  User.dd = cuser.day;
  User.yy = cuser.year + 1911;

  Sun = SunHoro(&User);
  Moon = MoonHoro(&User);
  Venus = VenusHoro(&User);

  vs_bar("æˆ‘çš„æ˜Ÿåº§");

  move(8, 0);

  prints("     è©±èªªé¼é¼å¤§åçš„ \033[1;36m%s\033[m ç¶“éä¸€æ¬¡æšåä¸–ç•Œçš„\n"
    "     \033[1;32;44m" BBSNAME "ä¹‹æ—…å¾Œï¼Œå¤§å®¶çš†ç¨±ä»–å«åš \033[1;33m%s\033[m\n"
    "     ä»–å‡ºç”Ÿæ–¼\033[30;43mæ°‘åœ‹ %d å¹´ %d æœˆ %d æ—¥\033[m\n",
    cuser.userid, cuser.username, User.yy - 1911, User.mm, User.dd);

  prints("     ä¸»å®°ä»–çš„å€‹æ€§çš„å¤ªé™½æ˜Ÿåº§æ˜¯ \033[1;33;41m%såº§\033[m\n"
    "     è€Œå½±éŸ¿ä»–çš„æœ¬èƒ½è¡Œç‚ºçš„æœˆäº®æ˜Ÿåº§æ˜¯ \033[1;33;45m%såº§\033[m\n"
    "     ä»¥åŠå½±éŸ¿å€‹äººå¸å¼•åŠ›èˆ‡é©æ‡‰åŠ›çš„é‡‘æ˜Ÿæ˜Ÿåº§ç‚º \033[1;33;44m%såº§ \033[m\n",
    name[Sun], name[Moon], name[Venus]);

  day_hint();

  vmsg(NULL);

  return 0;
}


int
x_pair()
{
  int i, score;
  struct h_set hu, hp;
  struct birth User, Pair;

  vs_bar("æ˜Ÿåº§é…å°");

  move(2, 0);
  outs("é…å°è€…ï¼š");
  User.yy = cuser.year;
  User.mm = cuser.month;
  User.dd = cuser.day;
  ask_birth(2, &User);
  get_hset(7, &hu, &User);

  move(12, 0);
  outs("è¢«é…å°è€…ï¼š");
  Pair.yy = 0;
  Pair.mm = 0;
  Pair.dd = 0;
  ask_birth(12, &Pair);
  get_hset(17, &hp, &Pair);

  move(2, 0);
  clrtobot();

  move(6, 0);

  prints("  ID             \033[1;36m%15s\033[m        The one you love\n",
    cuser.userid);
  prints("  æš±ç¨±           \033[1;33m%15s\033[m                å¿ƒæ„›çš„äºº\n",
    cuser.username);
  prints("  ç”Ÿæ—¥          æ°‘åœ‹%2då¹´%2dæœˆ%2dæ—¥\033[m"
    "        æ°‘åœ‹%2då¹´%2dæœˆ%2dæ—¥\n",
    User.yy - 1911, User.mm, User.dd,
    Pair.yy - 1911, Pair.mm, Pair.dd);

  prints("  å¤ªé™½æ˜Ÿåº§                \033[1;33;41m%såº§\033[m"
    "                  %såº§\n",
    name[hu.s], name[hp.s]);
  prints("  æœˆäº®æ˜Ÿåº§                \033[1;33;45m%såº§\033[m"
    "                  %såº§\n",
    name[hu.m], name[hp.m]);
  prints("  é‡‘æ˜Ÿæ˜Ÿåº§                \033[1;33;44m%såº§\033[m"
    "                  %såº§\n",
    name[hu.v], name[hp.v]);

  score = TogetherRule(&hu, &hp);
  outs("\n  \033[1;34mç¸½ å¾— åˆ†ï¼š\033[46m");
  for (i = score / 2; i > 0; i--)   /* æ¯ 2 åˆ† 1 æ ¼ */
    outc(' ');
  prints("\033[40;37m %d/100\033[m\n", score);
  prints("\n  \033[1m" SYSOPNICK "çµ¦ä½ å€‘çš„è©•èªï¼š\033[33m%s\033[m",
    said[score / 5]);

  vmsg(NULL);

  return 0;
}

--
[1;31m|[33m Origin [31m| [;37;42m å½°åŒ–å¸«å¤§ç”Ÿç‰©ç³» åŸé¢¨?çœºæœˆ?æ“å¤©å´— [32;47m micro.bio.ncue.edu.tw [m
[1;31m|[35m Author [31m| [36m163.23.212.99[m
