ä½œè€…: itoc (AsPSQwel) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] grade.c äº¤å¤§æˆç¸¾æŸ¥è©¢
æ™‚é–“: Wed Feb 12 21:26:55 2003                          Updated: 2003/12/29

: menu.c åœ¨é©ç•¶çš„é¸å–®åŠ ä¸Š

+ "bin/grade.so:main_grade", 0, - M_XMODE,
+ "Grade      â™‚ æˆç¸¾æŸ¥æ¦œ â™€",

: game/Makefile

SO =    ... [1;33mgrade.so[m

: game/grade.c æ–°å¢é€™ç¨‹å¼

/*-------------------------------------------------------*/
/* grade.c        ( NTHU CS MapleBBS Ver 3.10 )          */
/*-------------------------------------------------------*/
/* target : äº¤é€šå¤§å­¸æŸ¥æˆç¸¾ç³»çµ±                           */
/* create : 02/06/26                                     */
/* update : 02/07/26                                     */
/* author : eric.bbs@boring.twbbs.tw                     */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

#ifdef HAVE_NETTOOL

#define mouts(x,y,s)    { move(x, y); outs(s); }
#define HTTP_PORT       80
#define SERVER_grade    "140.113.101.141"
#define CGI_grade       "/REGCGI"


static char *
html_strip(p, c, len)
  char *p, *c;
  int len;
{
  int i;

  p += 4;        /* <td> */
  for (i = 0; *p != '<'; i++)
  {
    if (i < len)
      *c++ = *p;
    p++;
  }
  *c = '\0';

  return p;
}


static int
http_conn(server, s, sid)
  char *server, *s, *sid;
{
  int sockfd, i;
  int sum, sub, gpa, pass, nocount, graduate;
  char *p, *xtail;
  char pool[8192], fpath[64];
  char cid[7], cname[31], cs[5], cscore[11], ct[2];
  FILE *fp;

  mouts(b_lines - 1, 0, "é€£æ¥ä¼ºæœå™¨ä¸­ï¼Œè«‹ç¨å€™.............");
  refresh();

  if ((sockfd = dns_open(server, HTTP_PORT)) < 0)
  {
    vmsg("ç„¡æ³•èˆ‡ä¼ºæœå™¨å–å¾—é€£çµï¼ŒæŸ¥è©¢å¤±æ•—ï¼");
    return -1;
  }

  /* parser return message from web server */
  write(sockfd, s, strlen(s));
  /* read(sockfd, p = pool, sizeof(pool)); */        /* å¤ªå¤§äº†ï¼Œä¸€æ¬¡è®€ä¸å®Œ */
  p = xtail = pool;
  for (;;)
  {
    if (p >= xtail)
    {
      i = read(sockfd, p, sizeof(pool));
      if (i <= 0)
        break;
      xtail = p + i;
    }
    p++;
  }
  shutdown(sockfd, 1);
  close(sockfd);

  sprintf(fpath, "tmp/%s.grade", cuser.userid);
  fp = fopen(fpath, "w");

  /* itoc.è¨»è§£: æ–°ç”Ÿæ²’æœ‰æ­·å¹´æˆç¸¾æ™‚ï¼Œæœƒå› ç‚º pool é‚„æ®˜å­˜å‰ä¸€å€‹äººçš„è³‡æ–™ï¼Œ
     æ•…é¡¯ç¤ºå‰ä¸€å€‹äººçš„æˆç¸¾æˆ–é€ æˆåˆ¤æ–·éŒ¯èª¤ï¼Œæ‰€ä»¥è¦å…ˆæŠŠæœ€å¾Œä¸€å€‹(ç¬¬äºŒå€‹)
     </TABLE> æ‰¾å‡ºä¾† */
  xtail = strstr(pool, "</TABLE>");
  xtail = strstr(xtail + 1, "</TABLE>");/* æ‰¾æœ€å¾Œä¸€å€‹ </TABLE> */

  sum = 0;        /* åŠ æ¬Šç¸½åˆ† */
  sub = 0;        /* ä¿®ç¿’çš„ç¸½å­¸åˆ† */
  pass = 0;        /* åŠæ ¼çš„å­¸åˆ† */
  nocount = 0;        /* ä¸åˆ—å…¥å¹³å‡çš„å­¸åˆ† */
  gpa = 0;        /* åŠ æ¬Š GPA ç¸½åˆ† */
  graduate = atoi(sid) % 1000 >= 200 ? 1 : 0;        /* ç ”ç©¶ç”Ÿé‚„æ˜¯å¤§å­¸ç”Ÿ */

  p = pool;

  fputs("      â•­â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•¦â•â•â•â•â•â•¦â•â•â•®\n", fp);
  fputs("      â•‘èª²è™Ÿ  â•‘èª²å                          â•‘å­¸åˆ†â•‘ åˆ†æ•¸     â•‘é¸ä¿®â•‘\n", fp);
  fputs("      â• â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•¬â•â•â•â•â•â•¬â•â•â•£\n", fp);

  for (;;)
  {
    p = strstr(p, "<td>");

    if (!p || p >= xtail)        /* åˆ°æœ€å¾Œäº†æˆ–æ–°ç”Ÿæ ¹æœ¬æ²’è³‡æ–™ */
      break;

    p = html_strip(p, cid, 6);           /* èª²è™Ÿ */
    p = html_strip(p, cname, 30);        /* èª²å */
    p = html_strip(p, cs, 4);            /* å­¸åˆ† */
    p = html_strip(p, cscore, 10);       /* åˆ†æ•¸ */
    p = html_strip(p, ct, 1);            /* é¸åˆ¥ */

    fprintf(fp, "      â•‘\033[35m%-6s\033[mâ•‘\033[33m%-30s\033[mâ•‘"
      "\033[32m%-4s\033[mâ•‘\033[36m%-10s\033[mâ•‘\033[31m%-4s\033[mâ•‘\n",
      cid, cname, cs, cscore, ct);

    if (!str_ncmp(cscore, "æˆç¸¾æœªé€é”", 10) || !str_ncmp(cscore, "Tr", 2))        /* æŠµå…ã€æˆç¸¾æœªé€é”æš«ä¸ç®—å…¥å¹³å‡ã€å­¸åˆ† */
    {
      continue;
    }
    else if (!str_ncmp(cscore, "Withdraw", 8))        /* Withdraw ä¸ç®—å…¥å¹³å‡ */
    {
      i = atoi(cs);
      nocount += i;
      sub += i;
    }
    else if (!str_ncmp(cscore, "Pass", 4))        /* Pass ä¸ç®—å…¥å¹³å‡ */
    {
      i = atoi(cs);
      pass += i;
      nocount += i;
      sub += i;
    }
    else                                        /* æœ‰æˆç¸¾ */
    {
      i = atoi(cs);
      sockfd = atoi(cscore);
      sum += sockfd * i;        /* æŒ‰å­¸åˆ†åŠ æ¬Š */
      sub += i;

      if (sockfd >= (graduate ? 70 : 60))        /* ç ”ç©¶ç”Ÿ 70 åˆ†åŠæ ¼ï¼›å¤§å­¸ç”Ÿ 60 åˆ†åŠæ ¼ */
      {
        pass += i;

        if (graduate)
          gpa += i * (sockfd >= 85 ? 4 : sockfd >= 75 ? 3 : 2);
        else
          gpa += i * (sockfd >= 80 ? 4 : sockfd >= 70 ? 3 : 2);
      }
    }
  }
  fputs("      â•°â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•©â•â•â•â•â•â•©â•â•â•¯\n", fp);

  i = sub - nocount;
  fprintf(fp, "\n      ã€å¹³å‡ã€‘\033[1;31m%.2f\033[m  ã€å­¸åˆ†ã€‘%d/%d  ã€GPAã€‘%.2f\n",
    i ? sum / (double) i : 0,
    pass, sub,
    i ? gpa / (double) i : 0);                /* é¿å…é™¤æ•¸ç‚º 0 */

  fclose(fp);

  if (more(fpath, (char *) -1) >= 0)
  {
    if (vans("æ‚¨è¦å°‡æŸ¥è©¢çµæœå¯„å›ä¿¡ç®±å—ï¼Ÿ[N] ") == 'y')
      mail_self(fpath, cuser.userid, "[å‚™ å¿˜ éŒ„] æˆç¸¾æŸ¥è©¢", 0);
  }
  unlink(fpath);

  return 0;
}


static int
grade(sid, id, choice)
  char *sid, *id;
  int choice;
{
  char pool[1024];
  char atrn[256], sendform[512], serid[80], *p;
  int sockfd, i;

  if ((sockfd = dns_open(SERVER_grade, HTTP_PORT)) < 0)
  {
    vmsg("ç„¡æ³•èˆ‡ä¼ºæœå™¨å–å¾—é€£çµï¼ŒæŸ¥è©¢å¤±æ•—ï¼");
    return -1;
  }
  else
  {
    mouts(b_lines - 1, 0, "é€£æ¥ä¼ºæœå™¨ä¸­ï¼Œè«‹ç¨å€™.............");
    refresh();
  }

  sprintf(atrn, "F=CHKPASS&CHKKIND=2&userid=%s&passwd=%s", sid, id);
  sprintf(sendform, "GET /regcgi?%s HTTP/1.0\n\n", atrn);
  write(sockfd, sendform, strlen(sendform));

  /* parse */
  read(sockfd, pool, sizeof(pool));
  close(sockfd);

  /* itoc.è¨»è§£: ä¸èƒ½ç”¨æœ‰æ²’æœ‰ strstr(pool, "SERID") ä¾†æª¢æŸ¥ã€‚
     ç•¶å‰ä¸€å€‹äººæ­£ç¢ºè¼¸å…¥æŸ¥è©¢æ™‚ï¼Œæœƒå¾ sockfd ä¸­è®€å‡ºè¼ƒé•·çš„è³‡æ–™é€² poolï¼Œ
     å¾Œä¸€å€‹äººè‹¥è¼¸å…¥éŒ¯èª¤ï¼Œæœƒå¾ sockfd ä¸­è®€å‡ºè¼ƒçŸ­çš„è³‡æ–™é€² poolï¼Œ
     å› ç‚º pool æ²’æœ‰æ¸…ç©ºï¼Œå¾Œä¸€å€‹äººçš„ pool å¾Œæ®µä¸­ä»ç„¶æœƒæœ‰å‰ä¸€å€‹äººçš„ SERIDï¼Œ
     å¾Œä¸€å€‹äººå°±æœƒèª¤æŸ¥åˆ°å‰ä¸€å€‹äººçš„æˆç¸¾ */

  if (strstr(pool, "<b>"))
  {
    vmsg("æŸ¥ç„¡æ­¤å­¸è™Ÿæˆ–å¯†ç¢¼è¼¸å…¥éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
    return 0;
  }

  if (p = strstr(pool, "SERID"))
  {
    p = p + 14;
    for (i = 0;; i++)
    {
      serid[i] = p[i];
      if (p[i] == '"')
      {
        serid[i] = 0;
        break;
      }
    }
  }

  sprintf(atrn, "F=SHOWSCORE&SERID=%s&USERID=%s%%20%%20%%20&CHOICE=%s",
    serid, sid, choice ? "2.æŸ¥è©¢æ­·å¹´æˆç¸¾" : "1.æŸ¥è©¢æœ¬å­¸æœŸæˆç¸¾");
  sprintf(sendform, "GET /REGCGI?%s HTTP/1.0\n\n", atrn);
  http_conn(SERVER_grade, sendform, sid);

  return 0;
}


int
main_grade()
{
  char sid[8];        /* å­¸è™Ÿ */
  char id[11];        /* èº«åˆ†è­‰å­—è™Ÿ */
  char ans[3];
  int choice;        /* 0:å­¸æœŸæˆç¸¾ 1:æ­·å±†æˆç¸¾ */

  while (1)
  {
    clear();
    mouts(0, 25, "\033[1;37;44mâ— äº¤é€šå¤§å­¸æˆç¸¾æŸ¥è©¢ â—\033[m");
    mouts(3, 0, "è³‡æ–™ä¾†æºï¼šhttp://"SERVER_grade);

    if (!vget(5, 0, "è«‹è¼¸å…¥å­¸è™Ÿï¼š", sid, 8, DOECHO))
      break;
    if (!vget(6, 0, "è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿï¼š", id, 11, NOECHO))
      break;
    choice = vget(7,0, "è«‹é¸æ“‡ (1)æœ¬å­¸æœŸæˆç¸¾ (2)æ­·å¹´æˆç¸¾ï¼š[1] ",
      ans, 3, DOECHO) == '2';
    grade(sid, id, choice);
  }
  return 0;
}
#endif    /* HAVE_NETTOOL */

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm-GD2.NCTU.edu.tw[37m ç™¼è¡¨[m
