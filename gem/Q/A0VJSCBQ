ç™¼ä¿¡äºº: PaulLiu.bbs@processor.tfcis.org (GrandPaul) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: [å•é¡Œ] é—œæ–¼ RFC 2045 / RFC 2047
ç™¼ä¿¡ç«™: XEON (Tue, 01 Apr 2003 19:22:16 +0800 (CST))      Updated: 2005/08/29

â€» -------------- lib çš„éƒ¨åˆ† -------------- â€»

: libiconv

  è£ libiconv
  è‹¥æ˜¯ FreeBSDï¼Œåœ¨ /usr/ports/converters/libiconv

: lib/dao.p

/* str_decode.c */
char *mm_getencode(unsigned char *str, char *code);
void mm_getcharset(const char *str, char *charset, int size);
int mmdecode(unsigned char *src, int encode, unsigned char *dst);
void str_decode(unsigned char *str);
+ void str_conv(unsigned char *fromcode, unsigned char *tocode,
+   char *str, int len);

: lib/Makefile è‹¥æ˜¯ FreeBSD è¦æ”¹é€™å€‹

CC      = gcc
RANLIB  = ranlib
CPROTO  = cproto -E"gcc -pipe -E" -I../include # -s -v
! CFLAGS  = .... -I../include [1;33m-I/usr/local/include[m

: lib/str_decode.c åœ¨æœ€å¾ŒåŠ å…¥é€™ä¸€æ•´æ®µ

/* é€™å€‹å‡½å¼æœƒå°‡ä¸€å€‹å­—ä¸² (src) å¾ charset=fromcode è½‰æˆ charset=tocode,
   srclen æ˜¯ src çš„é•·åº¦, dst æ˜¯è¼¸å‡ºçš„buffer, dstlen å‰‡æŒ‡å®šäº†
   dst çš„å¤§å°, æœ€å¾Œæœƒè£œ '\0', æ‰€ä»¥è¦ç•™ä¸€å€‹byteçµ¦'\0'.
   å¦‚æœé‡åˆ° src ä¸­æœ‰éå­—é›†çš„å­—, æˆ–æ˜¯ src ä¸­æœ‰æœªå®Œæ•´çš„ byte,
   éƒ½æœƒç æ‰.
*/

#include <errno.h>
#include <iconv.h>

static int
str_iconv(fromcode, tocode, src, srclen, dst, dstlen)
  const char *fromcode; /* charset of source string */
  const char *tocode;   /* charset of destination string */
  char *src;            /* source string */
  int srclen;           /* source string length */
  char *dst;            /* destination string */
  int dstlen;           /* destination string length */
{
  iconv_t iconv_descriptor;
  int dstlen_old;
  extern int errno;

  dstlen--;                     /* keep space for '\0' */

  /* Open a descriptor for iconv */
  iconv_descriptor = iconv_open(tocode, fromcode);

  if (iconv_descriptor == ((iconv_t) (-1)))     /* if open fail */
  {
    strncpy(dst, src, dstlen);
    return dstlen;
  }

  dstlen_old = dstlen;

  /* Start translation */
  while (srclen > 0 && dstlen > 0)
  {
    if (iconv(iconv_descriptor, (void *) &src, &srclen, &dst, &dstlen))
    {
      switch (errno)
      {
      case EILSEQ:  /* invalid multibyte happened */
      case EINVAL:  /* incomplete multibyte happened */
        /* delete that byte */
        *dst = *src;
        src++;
        srclen--;
        dst++;
        dstlen--;
        break;

      case E2BIG:   /* dst no rooms */
        /* break out the while loop */
        srclen = 0;
        break;
      }
    }
  }
  *dst = '\0';

  /* close descriptor of iconv */
  iconv_close(iconv_descriptor);

  return (dstlen_old - dstlen);
}


void
str_conv(fromcode, tocode, str, len)
  unsigned char *fromcode;
  unsigned char *tocode;
  char *str;        /* æ¬² convert çš„å­—ä¸² (æœªå¿…è¦ end with '\0') */
  int len;          /* å­—ä¸² str çš„é•·åº¦ */
{
  char *ptr;

  if (len <= 0)
    return;

  if (!str_cmp(fromcode, tocode))    /* ç›¸åŒ charset å°±ä¸è½‰äº† */
    return;

  ptr = (char *) malloc(len);
  strncpy(ptr, str, len);
  str_iconv(fromcode, tocode, ptr, len, str, len);
  free(ptr);
}

--
    [1;32mâ•­â”€ Origin â”€â•— [;36;40m?[1m?[;36;40m?[1mO[;36;40m?[1m?[;36;40m?[1m?[31m processor.tfcis.org [32m ï½ ÎºÎ»Î¼ â”€â”¤[m
    [1;32mâ”œ   Author   â•¡ [33;44mcnal.csie.nctu.edu.tw                    [m
