ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] å°éµæ™‚åˆ»æŸ¥è©¢
æ™‚é–“: 2006/05/21 Sun 12:17:12                           Updated: 2006/05/21

: menu.c é©ç•¶çš„é¸å–®åŠ ä¸Šé€™äºŒè¡Œ

+ "bin/railway.so:main_railway", 0, - M_XMODE,
+ "Railway    â™‚ ç«è»Šæ™‚åˆ» â™€",

: game/Makefile

SO =    ... [1;33mrailway.so[m

: game/railway.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* railway.c    ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : å°éµç«è»Šæ™‚åˆ»è¡¨æŸ¥è©¢                           */
/* create : 02/05/29                                     */
/* update :   /  /                                       */
/* author : lp@micro.ee.nthu.edu.tw                      */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#if 0
  1. éœ€è¦å®‰è£ lynxã€piconvã€grepï¼Œä¸”è«‹æª¢æŸ¥é€™ä¸‰è€…åœ¨ http_conn()
     è£¡é¢çš„è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚
  2. ç¨‹å¼é›–ç„¶æœ‰è½‰è»Šç«™çš„éƒ¨åˆ†ï¼Œä½†æ˜¯ç›®å‰æ²’æœ‰ç”¨ã€‚
#endif

#include "bbs.h"

#define mouts(x,y,s)    { move(x, y); outs(s); }

#define FORM_railway    "\"SBeginStation=%s&SBeginStationName=&SEndStation=%s&SEndStationName=&SClass=%s&SDateTime=%s&STime=&SearchType=0&SBeginCityCode=&SEndCityCode=&BStationIndex=&EStationIndex=\""

#define REF             "http://www.railway.gov.tw/"

#define RAILWAY_XPOS    1
#define RAILWAY_YPOS    0
#define MAX_SITE        212
#define SITE_PER_LINE   13      /* æ¯åˆ—ç§€ 13 å€‹ç«™å° */

static char *siteid[MAX_SITE] = /* è»Šç«™ç«™å° */
{
  "å°æ±", "å±±é‡Œ", "é¹¿é‡", "ç‘æº", "ç‘å’Œ", "æœˆç¾", "é—œå±±", "æµ·ç«¯", "æ± ä¸Š", "å¯Œé‡Œ", "æ±ç«¹", "æ±é‡Œ", "å®‰é€š",
  "ç‰é‡Œ", "ä¸‰æ°‘", "ç‘ç©—", "å¯Œæº", "å¤§å¯Œ", "å…‰å¾©", "è¬æ¦®", "é³³æ—", "å—å¹³", "æºªå£", "è±ç”°", "å£½è±", "å¹³å’Œ",
  "å¿—å­¸", "å‰å®‰", "èŠ±è“®", "åŒ—åŸ”", "æ™¯ç¾", "æ–°åŸ", "å´‡å¾·", "å’Œä»", "å’Œå¹³", "æ¼¢æœ¬", "æ­¦å¡”", "å—æ¾³", "æ±æ¾³",
  "æ°¸æ¨‚", "è˜‡æ¾³","è˜‡æ¾³æ–°","æ–°é¦¬", "å†¬å±±", "ç¾…æ±", "ä¸­é‡Œ", "äºŒçµ", "å®œè˜­", "å››åŸ", "ç¤æºª", "é ‚åŸ”", "é ­åŸ",
  "å¤–æ¾³", "é¾œå±±", "å¤§æºª", "å¤§é‡Œ", "çŸ³åŸ", "ç¦éš†", "è²¢å¯®", "é›™æºª", "ç‰¡ä¸¹","ä¸‰è²‚å¶º","ä¾¯ç¡","ç‘èŠ³","å››è…³äº­",
  "æš–æš–", "åŸºéš†", "ä¸‰å‘", "å…«å µ", "ä¸ƒå µ", "äº”å µ", "æ±æ­¢", "å—æ¸¯", "æ¾å±±", "å°åŒ—", "è¬è¯", "æ¿æ©‹", "æ¨¹æ—",
  "å±±ä½³", "é¶¯æ­Œ", "æ¡ƒåœ’", "å…§å£¢", "ä¸­å£¢", "åŸ”å¿ƒ", "æ¥Šæ¢…", "å¯Œå²¡", "æ¹–å£", "æ–°è±", "ç«¹åŒ—", "æ–°ç«¹", "é¦™å±±",
  "å´é ‚", "ç«¹å—", "è«‡æ–‡", "å¤§å±±", "å¾Œé¾", "é¾æ¸¯","ç™½æ²™å±¯","æ–°åŸ”", "é€šéœ„", "è‹‘è£¡", "æ—¥å—","å¤§ç”²","å°ä¸­æ¸¯",
  "æ¸…æ°´", "æ²™é¹¿", "é¾äº•", "å¤§è‚š", "è¿½åˆ†", "é€ æ©‹", "è±å¯Œ", "è‹—æ —", "å—å‹¢", "éŠ…é‘¼", "ä¸‰ç¾©", "æ³°å®‰", "åé‡Œ",
  "è±åŸ", "æ½­å­", "å¤ªåŸ", "å°ä¸­", "å¤§æ…¶", "çƒæ—¥", "æˆåŠŸ","å½°åŒ–", "èŠ±å£‡", "å¤§æ‘", "å“¡æ—", "æ°¸é–", "ç¤¾é ­",
  "ç”°ä¸­", "äºŒæ°´", "æ—å…§", "çŸ³æ¦´", "æ–—å…­", "æ–—å—", "çŸ³é¾œ", "å¤§æ—", "æ°‘é›„", "å˜‰ç¾©", "æ°´ä¸Š", "å—é–", "å˜‰åŒ—",
  "å¾Œå£", "æ–°ç‡Ÿ", "æŸ³ç‡Ÿ","æ—é³³ç‡Ÿ","éš†ç”°", "æ‹”æ—", "å–„åŒ–", "æ–°å¸‚", "æ°¸åº·", "å¤§æ©‹", "å°å—", "ä¿å®‰", "ä¸­æ´²",
  "å¤§æ¹–", "è·¯ç«¹", "å²¡å±±", "æ©‹é ­", "æ¥ æ¢“", "å·¦ç‡Ÿ", "é«˜é›„", "é³³å±±", "å¾Œåº„","ä¹æ›²å ‚","å…­å¡Šå","å±æ±","æ­¸ä¾†",
  "éºŸæ´›", "è¥¿å‹¢", "ç«¹ç”°", "æ½®å·", "å´é ‚", "å—å·", "é®å®‰", "æ—é‚Š", "ä½³å†¬", "æ±æµ·", "æ‹å¯®", "åŠ ç¥¿", "å…§ç…",
  "æ‹å±±", "å¤èŠ", "å¤§æ­¦", "ç€§æºª", "å¤šè‰¯", "é‡‘å´™","å¤ªéº»é‡Œ","çŸ¥æœ¬", "åº·æ¨‚", "å¤§è¯", "ååˆ†", "æœ›å¤", "å¶ºè…³",
  "å¹³æºª", "èæ¡", "ç«¹ä¸­", "ä¸Šå“¡", "æ¦®è¯", "ç«¹æ±", "æ©«å±±","ä¹è®šé ­","åˆèˆˆ", "å¯Œè²´", "å…§ç£", "æºæ³‰", "æ¿æ°´",
  "é¾æ³‰", "é›†é›†", "æ°´é‡Œ", "è»ŠåŸ•"
};


static char *siteno[MAX_SITE] = /* è»Šç«™ä»£ç¢¼ */
{
  "1632", "1631", "1630", "1629", "1628", "1627", "1626", "1625", "1624", "1623", "1622", "1621", "1620",
  "1619", "1617", "1616", "1614", "1613", "1612", "1611", "1610", "1609", "1608", "1607", "1606", "1605",
  "1604", "1602", "1715", "1714", "1713", "1712", "1711", "1710", "1709", "1708", "1706", "1705", "1704",
  "1703", "1827", "1826", "1825", "1824", "1823", "1822", "1821", "1820", "1819", "1818", "1817", "1816",
  "1815", "1814", "1813", "1812", "1811", "1810", "1809", "1808", "1807", "1806", "1805", "1804", "1803",
  "1802", "1001", "1029", "1002", "1003", "1004", "1005", "1006", "1007", "1008", "1009", "1011", "1012",
  "1013", "1014", "1015", "1016", "1017", "1018", "1019", "1020", "1021", "1022", "1023", "1025", "1026",
  "1027", "1028", "1102", "1104", "1105", "1106", "1107", "1108", "1109", "1110", "1111", "1112", "1113",
  "1114", "1115", "1116", "1117", "1118", "1302", "1304", "1305", "1307", "1308", "1310", "1314", "1315",
  "1317", "1318", "1323", "1319", "1322", "1320", "1321", "1120", "1202", "1240", "1203", "1204", "1205",
  "1206", "1207", "1208", "1209", "1210", "1211", "1212", "1213", "1214", "1215", "1217", "1218", "1241",
  "1219", "1220", "1221", "1222", "1223", "1224", "1225", "1226", "1227", "1239", "1228", "1229", "1230",
  "1231", "1232", "1233", "1234", "1235", "1236", "1238", "1402", "1403", "1404", "1405", "1406", "1407",
  "1408", "1409", "1410", "1411", "1412", "1413", "1414", "1415", "1416", "1417", "1418", "1502", "1503",
  "1504", "1507", "1508", "1510", "1511", "1512", "1514", "1516", "1517", "1903", "1904", "1905", "1906",
  "1907", "1908", "2203", "2204", "2211", "2205", "2206", "2207", "2208", "2209", "2210", "2702", "2703",
  "2704", "2705", "2706", "2707"
};


static int cx, cy;
static int fr_pos, to_pos, tr_pos;
static char fr_no[5], to_no[5], tr_no[4];       /* èµ·è¿„ ä»£ç¢¼ */
static char typer[5];                           /* å°è™Ÿ/éå°è™Ÿ */


static void
outs_site(pos)
  int pos;
{
  char *site;

  site = siteid[pos];
  if (site[4] == '\0')
    prints(" %s ", site);
  else
    outs(site);
}


static void
outs_info(color, msg)
  int color;
  char *msg;             /* strlen(msg) == 14 */
{
  move(b_lines, 0);
  clrtoeol();
  move(b_lines, 30);     /* ç½®ä¸­ */
  prints("\033[%dm %s \033[m", color, msg);
}


static void
site_drawrow(x)          /* é‡ç¹ª x åˆ— */
  int x;
{
  int i;

  move(x + RAILWAY_XPOS, RAILWAY_YPOS);
  i = x * SITE_PER_LINE;
  x = (x + 1) * SITE_PER_LINE;
  if (x > MAX_SITE)
    x = MAX_SITE;
  for (; i < x; i++)
  {
    if (i == fr_pos)
      outs("\033[41m");
    else if (i == to_pos)
      outs("\033[44m");
    else if (i == tr_pos)
      outs("\033[42m");
    outs_site(i);
    if (i == fr_pos || i == to_pos || i == tr_pos)
      outs("\033[m");
  }
}


static void
site_show()
{
  int i;

  clear();
  move(0, 23);
  outs("\033[1;37;44mâ— å°éµç«è»Šæ™‚åˆ»è¡¨æŸ¥è©¢ç³»çµ± â—\033[5;33m æ¸¬è©¦ç‰ˆ\033[m");

  for (i = 0; i < MAX_SITE; i++)
  {
    if (i % SITE_PER_LINE == 0)
      move(i / SITE_PER_LINE + RAILWAY_XPOS, RAILWAY_YPOS);
    outs_site(i);
  }

  move(b_lines - 4, 0);
  outs("å•Ÿç¨‹è»Šç«™ï¼š         åˆ°é”è»Šç«™ï¼š");
  move(b_lines - 3, 0);
  outs("æŸ¥è©¢æ™‚é–“ï¼š00:00 è‡³ 24:00 (å…§å®š, ç„¡æ³•æ”¹)");
  move(b_lines - 2, 0);
  outs("æŸ¥è©¢è»Šç¨®ï¼š1)å°è™Ÿå¿«è»Š 2)éå°è™Ÿè»Š 3)å…¨éƒ¨è»Šç¨®");

  cx = cy = 0;
  fr_pos = to_pos = tr_pos = -1;

}


static int              /* 1:æˆåŠŸ */
site_choose(flag)
  int flag;             /* 1:é¸èµ·ç«™  2:é¸è¿„ç«™  4: é¸è½‰ç«™ */
{
  int pos;

  /* é€™å¹¾æ ¼æ²’æœ‰ç«™å° */
  if (cx == MAX_SITE / SITE_PER_LINE && cy >= MAX_SITE % SITE_PER_LINE)
    return 0;

  pos = cx * SITE_PER_LINE + cy;

  if (flag == 1)
  {
    fr_pos = pos;
    strcpy(fr_no, siteno[fr_pos]);
    move(b_lines - 4, 10);
    prints("%-6s", siteid[fr_pos]);
  }
  else if (flag == 4)
  {
    if (fr_pos == pos)
      return 0;
    to_pos = pos;
    strcpy(to_no, siteno[to_pos]);
    move(b_lines - 4, 29);
    outs(siteid[to_pos]);
  }
  else /* if (flag == 2) */
  {
    if (fr_pos == pos || to_pos == pos)
      return 0;
    tr_pos = pos;
    strcpy(tr_no, siteno[tr_pos]);
    move(b_lines - 4, 48);
    outs(siteid[tr_pos]);
  }

  site_drawrow(cx);
  return 1;       /* é¸ä¸‹ä¸€å€‹ */
}


static int              /* 1: å·²æ±ºå®šèµ·è¿„ç«™ */
site_menu(flag)         /* ç›®å‰åœ¨é¸ 1:èµ· 4:è¿„ 2:è½‰ ç«™ */
  int flag;
{
  for (;;)
  {
    /* itoc.031209: è‹¥é‡åˆ°ä¸‰å€‹å­—çš„ç«™åï¼Œåˆåµæ¸¬å…¨å½¢æ™‚ï¼Œé‚£éº¼æœƒå¤šè·³ä¸€æ¬¡ï¼Œæš«æ™‚ä¸ç®¡äº† :p */
    move(cx + RAILWAY_XPOS, cy * 6 + RAILWAY_YPOS + 2);
    switch (vkey())
    {
    case KEY_RIGHT:
      cy++;
      if (cy > 12)
        cy = 0;
      break;

    case KEY_LEFT:
      cy--;
      if (cy < 0)
        cy = 12;
      break;

    case KEY_DOWN:
      cx++;
      if (cx > 16)
        cx = 0;
      break;

    case KEY_UP:
      cx--;
      if (cx < 0)
        cx = 16;
      break;

    case KEY_ENTER:
    case ' ':
      if (site_choose(flag))
        return 1;
      break;

    case 'q':
      return 0;
    }
  }
}


static void
rail_query()
{
  char ans[3], *msg;

  outs_info(45, "è«‹é¸æ“‡æŸ¥è©¢è»Šç¨®");

  switch (vget(b_lines - 2, 0, "æŸ¥è©¢è»Šç¨®ï¼š1)å°è™Ÿå¿«è»Š 2)éå°è™Ÿè»Š 3)å…¨éƒ¨è»Šç¨®ï¼š[3] ", ans, 3, DOECHO))
  {
  case '1':
    strcpy(typer, "0");
    msg = "1)å°è™Ÿå¿«è»Š";
    break;

  case '2':
    strcpy(typer, "1");
    msg = "2)éå°è™Ÿè»Š";
    break;

  default:
    strcpy(typer, "2");
    msg = "3)å…¨éƒ¨è»Šç¨®";
    break;
  }

  move(b_lines - 2, 10);
  outs(msg);
  clrtoeol();

  refresh();        /* å†æ¬¡ vget() æœƒå‡ºç¾å‰é¢çš„æ§åˆ¶ç¢¼ï¼Œè¦ refresh */
}


static char
Tcolor(str)        /* ä¾è»Šæ¬¡ä¾†æ±ºå®šé¡è‰² */
  char *str;
{
  if (!strncmp(str, "è‡ªå¼·", 4))
    return '1';
  if (!strncmp(str, "è’å…‰", 4))
    return '6';
  if (!strncmp(str, "å¾©èˆˆ", 4))
    return '4';
  return '0';
}


static void
html_parser(src, dst)
  char *src, *dst;
{
  FILE *fpr, *fpw;
  char data[256];
  char *result;
  int line_num;
  int tcount;         /* ç¸½å…±æœ‰å¹¾ç­æ¬¡ */
  struct stat st;

  if ((!stat(src, &st) && !st.st_size) || !(fpr = fopen(src, "r")))
    return;

  fpw = fopen(dst, "w");

  line_num = 0;
  while (fgets(data, sizeof(data), fpr))
  {
    if (++line_num >= 6)
    {
      fprintf(fpw, "%s", data);
      break;
    }
  }

  line_num++;
  fprintf(fpw, "\n"
    "â”Œâ”€â”€â”€â”¬â”€â”€â”¬â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”\n"
    "â”‚ ä¹˜å â”‚è»Šæ¬¡â”‚å±±â”‚å§‹ç™¼ç«™->çµ‚é»ç«™â”‚ç™»è»Šè»Šç«™  â”‚ä¸‹è»Šè»Šç«™  â”‚å…¨ç¥¨â”‚è¡Œé§›æ™‚é–“  â”‚\n"
    "â”‚ è»Šç¨® â”‚ç·¨è™Ÿâ”‚æµ·â”‚              â”‚é–‹è»Šæ™‚é–“  â”‚åˆ°é”æ™‚é–“  â”‚åƒ¹éŒ¢â”‚          â”‚");

  while (fgets(data, sizeof(data), fpr))
  {
    if (++line_num >= 30)
      break;
  }

  tcount = 0;
  while (1)
  {
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, " ")))
      break;

    fprintf(fpw, "\nâ”œâ”€â”€â”€â”¼â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”¤");

    /* è»Šå‹ï¼Œ6 bytes */
    fprintf(fpw, "\nâ”‚\033[1;4%c;37m%6.6s\033[m", Tcolor(result), result);        /* å†·æ°£æŸ´å®¢æœƒè¶…é 6 bytes */

    /* è»Šæ¬¡ä»£ç¢¼ï¼Œ4 bytes */
    if (!(result = strtok(NULL, " ")))
      break;
    fprintf(fpw, "â”‚%4.4s", result);        /* å†·æ°£æŸ´å®¢æœƒè¶…é 4 bytes */

    /* å±±ç·šæˆ–æµ·ç·šæˆ–ç©ºçš„ï¼Œ2 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "â”‚%2s", result + 37);

    /* å•Ÿç¨‹ç«™ã€åˆ°é”ç«™ï¼Œ6 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "â”‚%14s", result + 31);

    /* é–‹è»Šæ™‚é–“ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "â”‚%8s  ", result + 32);

    /* åˆ°é”æ™‚é–“ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "â”‚%8s  ", result + 32);

    /* å…¨ç¥¨åƒ¹æ ¼ 3 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "â”‚%4s", result + 34);

    /* è¡Œé§›æ™‚é–“ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")) || !(result = strtok( result, " ")))
      break;
    fprintf(fpw, "â”‚%10sâ”‚", result);

    /* è·³éå‚™è¨» */
    if (!fgets(data, sizeof(data), fpr))
      break;

    tcount++;
  }                 /* end of while */


  fprintf(fpw,  "\nâ””â”€â”€â”€â”´â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”˜\n\n\n\n");

  if (!tcount)
    fprintf(fpw, "\n\næŠ±æ­‰ï¼æ²’æœ‰æ‚¨æ¬²æ­ä¹˜çš„ç­è»Š");

  fclose(fpr);
  fclose(fpw);
}


static int
http_conn(s)
  char *s;
{
  char src[30], dst[30];
  char cmd[768];

  mouts(b_lines - 1, 0, "é€£æ¥ä¼ºæœå™¨ä¸­ï¼Œè«‹ç¨å€™...");
    refresh();

  sprintf(src, "tmp/%s.rail", cuser.userid);
  sprintf(cmd, "/usr/local/bin/lynx -display_charset=utf-8 -nolist -dump  "
    "http://new.twtraffic.com.tw/twrail/nonscript_search_result.aspx?%s | "
    "/usr/local/bin/piconv -f utf8 -t big5 | /usr/bin/grep -v 'åœ–ç¤º' > %s",
    s, src);
  system(cmd);

  sprintf(dst, "tmp/%s.way", cuser.userid);
  html_parser(src, dst);

  /* show message that return from the web server */


  if (more(dst, (char *) -1) >= 0)
  {
    if (vans("æ‚¨è¦å°‡æŸ¥è©¢çµæœå¯„å›ä¿¡ç®±å—ï¼Ÿ[N] ") == 'y')
      mail_self(dst, cuser.userid, "[å‚™ å¿˜ éŒ„] ç«è»Šæ™‚åˆ»æŸ¥è©¢çµæœ", MAIL_READ);
  }
  unlink(dst);
  unlink(src);

  return 0;
}



static void
railway(delay)
  int delay;
{
  char atrn[512];
  char day[20];
  struct tm *ptime;
  time_t now;

  time(&now);
  now += 86400 * delay;
  ptime = localtime(&now);
  sprintf(day, "%02d/%d/%d",
    (ptime->tm_year - 11 ) % 100 , ptime->tm_mon + 1, ptime->tm_mday);

  sprintf(atrn, FORM_railway, fr_no, to_no, typer, day);
  http_conn(atrn);
}


int
main_railway()
{
  int ch;

  site_show();

  outs_info(41, "è«‹é¸æ“‡å•Ÿç¨‹è»Šç«™");
  if (!site_menu(1))
    return 0;

  outs_info(44, "è«‹é¸æ“‡åˆ°é”è»Šç«™");
  if (!site_menu(4))
    return 0;

  rail_query();  /* æ±ºå®šå°è™Ÿ/éå°è™Ÿ */

  ch = vans("æŸ¥è©¢ 0)ä»Šå¤© 1)æ˜å¤© 2)å¾Œå¤© 3456789)å¤©å¾Œçš„æ™‚åˆ»è¡¨ Q)é›¢é–‹ï¼Ÿ[0] ");
  if (ch == 'q')
  {
    vmsg("hmm.....ä¸æƒ³æŸ¥å›‰...^o^");
    return 0;
  }
  if (ch < '0' || ch > '9')
    ch = 0;
  else
    ch -= '0';

  railway(ch);

  return 0;
}

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
