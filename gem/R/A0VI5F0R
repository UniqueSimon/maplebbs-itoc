ä½œè€…: itoc (é¢¨èª¿é›¨é †ï¼Œåœ‹æ³°æ°‘å®‰) çœ‹æ¿: plan
æ¨™é¡Œ: [åŠŸèƒ½] "--" ä»¥ä¸‹çš„æ±è¥¿å…¨éƒ¨ç„¡æ³•ä¿®æ”¹
æ™‚é–“: Sun Jul 27 01:26:18 2003                          Updated: 2005/06/30

â€» å¼•è¿°ã€Šxeon.bbs@xeon.tfcis.org (Xeon Chen)ã€‹ä¹‹éŠ˜è¨€ï¼š
> "--" ä»¥ä¸‹çš„æ±è¥¿å…¨éƒ¨ç„¡æ³•ä¿®æ”¹

  1. æŽ¨æ–‡å¾Œï¼Œä½œè€…å¯ä»¥ä¿®æ”¹æ–‡ç« ï¼Œä½†ä¸èƒ½ä¿®æ”¹æŽ¨æ–‡
  2. æ­·æ¬¡ä¿®æ”¹çš„æ™‚é–“è¨˜éŒ„å‡æœƒä¿ç•™ä¸‹ä¾†

: modes.h

#define EDIT_ANONYMOUS  0x10    /* åŒ¿åæ¨¡å¼ */
#define EDIT_RESTRICT   0x20    /* åŠ å¯†å­˜æª” */
+ #define EDIT_MODIFYPOST 0x40    /* ç¦æ­¢ä¿®æ”¹ -- ä»¥ä¸‹çš„æ–‡å­— */

: post.c:post_edit()

  /* åŽŸä½œè€…ä¿®æ”¹ */
  else if (!strcmp(hdr->owner, cuser.userid) && HAS_PERM(PERM_POST))
  {
+   curredit = EDIT_MODIFYPOST;
    if (!vedit(fpath, 0))       /* è‹¥éžå–æ¶ˆå‰‡åŠ ä¸Šä¿®æ”¹è³‡è¨Š */
    {
      if (fp = fopen(fpath, "a"))
      {
        ve_banner(fp, 1);
        fclose(fp);
      }
    }
+   curredit = 0;

: edit.c

typedef struct textline
{
  struct textline *prev;
  struct textline *next;
+ char startq;              /* 1: -- é–‹å§‹ */
  int len;
  uschar data[ANSILINELEN];
}       textline;

: edit.c:ve_forward()

  while (n--)
  {
-   if (!(tmp = cur->next))
+   /* itoc.030727: PGDN ç¿»é æœ€å¤šç§»åˆ° -- é–‹å§‹ */
+   if (!(tmp = cur->next) || cur->startq)
      break;

: edit.c:ve_alloc()

  if (p = (textline *) malloc(sizeof(textline)))
  {
    p->prev = NULL;
    p->next = NULL;
+   p->startq = 0;
    p->len = 0;
    p->data[0] = '\0';
    return p;
  }

: edit.c:ve_load()

  uschar *str;
  textline *next;
+ textline *tmp;

  next = this->next;
+ tmp = this;

  mgets(-1);

  while (str = mgets(fd))
  {
    this = ve_line(this, str);

+   /* itoc.030727: -- é–‹å§‹ */
+   if ((curredit & EDIT_MODIFYPOST) && !strcmp(str, "--"))
+   {
+     /* æ‰¾æœ€å¾Œä¸€å€‹ "--" */
+     tmp->startq = 0;
+     tmp = this;
+     this->startq = 1;
+   }
  }

: edit.c:tbf_read()

static inline void
tbf_read()
{
  int fd;
  char fpath[80];

+ /* itoc.030727: -- é–‹å§‹ä»¥å¾Œä¾¿ä¸èƒ½è¼‰å…¥æš«å­˜æª” */
+ if (vx_cur->startq)
+   return;

: edit.c:vedit() çš„è¨»è§£

/* ----------------------------------------------------- */
/* ve_op:                                                */
/*  0 => ç´”ç²¹ç·¨è¼¯æª”æ¡ˆ                                    */
/* -1 => ç·¨è¼¯ä½†ä¸èƒ½å„²å­˜ï¼Œç”¨åœ¨ç·¨è¼¯ä½œè€…ä¸æ˜¯è‡ªå·±çš„æ–‡ç«       */
/*  1 => å¼•æ–‡ã€åŠ ç°½åæª”ï¼Œä¸¦åŠ ä¸Šæª”é ­ï¼Œç”¨åœ¨ç™¼è¡¨æ–‡ç« /ç«™å…§ä¿¡ */
/*  2 => å¼•æ–‡ã€åŠ ç°½åæª”ï¼Œä¸åŠ ä¸Šæª”é ­ï¼Œç”¨åœ¨å¯„ç«™å¤–ä¿¡        */
/* ----------------------------------------------------- */
/* è‹¥ ve_op æ˜¯ 1 æˆ– 2 æ™‚ï¼Œé€²å…¥ vedit å‰é‚„å¾—æŒ‡å®š curredit */
+ /* è‹¥ ve_op æ˜¯ 0ï¼Œè‹¥è¦ç¦æ­¢ä¿®æ”¹ -- ä»¥ä¸‹çš„æ–‡å­—ï¼Œé€²å…¥ vedit */
+ /* å‰é‚„å¾—æŒ‡å®š curredit ç‚º EDIT_MODIFYPOST                */
/* ----------------------------------------------------- */

: edit.c:vedit()

    cc = vkey();

+   if (vln->startq)
+   {
+     /* itoc.030727: -- é–‹å§‹ä»¥å¾Œï¼Œåªèƒ½æŒ‰ä»¥ä¸‹æŒ‰éµ */
+     if (cc != KEY_INS && cc != KEY_LEFT && cc != KEY_UP &&
+       cc != Ctrl('P') && cc != KEY_PGUP && cc != Ctrl('B') &&
+       cc != KEY_PGDN && cc != Ctrl('F') && cc != Ctrl('O') &&
+       cc != Ctrl('T') && cc != Ctrl('S') && cc != Ctrl('V') &&
+       cc != Ctrl('X') && cc != Ctrl('Z'))
+     goto ve_key;
+   }

: edit.c:vedit()

      case Ctrl('O'):           /* delete to end of file */

        /* vln->len = ve_col = cc = 0; */
        tmp = vln->next;
        vln->next = NULL;
        while (tmp)
        {
-         vln = tmp->next;
-         free(tmp);
-         tmp = vln;
+         textline *tmp2;
+         /* yiting: è‹¥ä¸‹ä¸€è¡Œæ˜¯"--"ï¼Œå‰‡æŠŠå®ƒæŽ¥åˆ°ç›®å‰é€™è¡Œçš„ä¸‹é¢ */
+         if ((curredit & EDIT_MODIFYPOST) && (tmp->startq))
+         {
+           vln->next = tmp;
+           tmp->prev = vln;
+           break;
+         }
+         tmp2 = tmp->next;
+         free(tmp);
+         tmp = tmp2;
        }
        ve_mode = mode | VE_REDRAW;
        continue;

: edit.c:ve_edit()

      case Ctrl('D'):
      case KEY_DEL:             /* delete current character */

        cc = vln->len;
        if (cc == col)
        {
+         /* è‹¥ä¸‹è¡Œæ˜¯ --ï¼Œä¸èƒ½ DEL */
+         if ((curredit & EDIT_MODIFYPOST)&&(tmp = vln->next)&&(tmp->startq))
+           goto ve_key;
          join_up(vln);
          ve_mode = mode | VE_REDRAW;
        }


--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ž [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
