ç™¼ä¿¡äºº: SnowWolf.bbs@xeon.tfcis.org (éœå¤œ) çœ‹æ¿: plan
æ¨™  é¡Œ: [æ–‡ä»¶] å°å°æ¨‚
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (Wed, 27 Aug 2003 13:17:56 +0800 (CST))  Updated: 2004/10/28

  æ”¹é€™ç¯‡å‰è«‹ç¢ºå®šä½ åšäº†ç²¾è¯å€é€™ç¯‡...

[1;32m~/src/include/global.h[m

+ #define FN_RUN_TICKET          "run/ticket"
+ #define FN_RUN_TICKET_USER     "run/ticket.user"
+ #define FN_RUN_TICKET_RECORD   "run/ticket.record"

[1;32m~/src/maple/menu.c,é©ç•¶é¸å–®åŠ å…¥[m

+ "bin/ticket.so:main_ticket", 0, - M_GAME,
+ "9Ticket    â™‚ å°å°æ¨‚æ¨‚ â™€",

> ------------------------------------------------------------------------ <

[1;32mæ–°å¢~/etc/game/buyticket[m


    èªªæ˜å…§å®¹è‡ªå·±æ‰“ :p

> ------------------------------------------------------------------------ <

[1;32mä¿®æ”¹~/src/game/Makefile[m

SO =    ..... [1;33mticket.so[m

[1;32mæ–°å¢~/src/game/ticket.c[m

/*-------------------------------------------------------*/
/* ticket.c     ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : å°å°æ¨‚                                       */
/* create :   /  /                                       */
/* update : 03/08/27                                     */
/* author : Ptt.bbs@ptt.twbbs.org                        */
/* modify : yychen                                       */
/*-------------------------------------------------------*/


#include "bbs.h"


static char betname[8][9] =
{
  "ç–²å€¦é‡è²“", "æ²’åŠ›å’©å’©", "éŠé­‚å°é¢¨", "é­”åŠ›å°å¤¢",
  "å‹¤å¥®å¤§é­š", "ç¢¼é ­é˜¿å€«", "ä¸€å †èèŸ»", "å˜°å“©å’•åš•"
};


/*-------------------------------------------------------*/
/* è¢å¹•æ§åˆ¶                                              */
/*-------------------------------------------------------*/


static void
clrfromto(x, y)
  int x, y;
{
  int i;

  i = x;
  while (i <= y)
  {
    move(i, 0);
    clrtoeol();
    i++;
  }
}


static int                      /* 1: æª”æ¡ˆåœ¨  0: æª”æ¡ˆä¸åœ¨ */
show_file(fpath, ln, lines)     /* å¾ç¬¬ ln åˆ—é–‹å§‹å°æª”æ¡ˆ lines è¡Œ */
  char *fpath;
  int ln, lines;
{
  FILE *fp;
  char buf[ANSILINELEN];
  int i;

  if ((fp = fopen(fpath, "r")))
  {
    clrfromto(ln, ln + lines);
    move(ln, 0);
    i = lines;
    while (fgets(buf, ANSILINELEN, fp) && i--)
      outs(buf);
    fclose(fp);
    return 1;
  }

  return 0;
}


static void
show_bet()
{
  FILE *fp;
  int i, total, ticket[8] = {0, 0, 0, 0, 0, 0, 0, 0};

  total = 0;
  if (fp = fopen(FN_RUN_TICKET_RECORD, "r"))
  {
    fscanf(fp, "%9d %9d %9d %9d %9d %9d %9d %9d\n",
      &ticket[0], &ticket[1], &ticket[2], &ticket[3],
      &ticket[4], &ticket[5], &ticket[6], &ticket[7]);
    for (i = 0; i < 8; i++)
      total += ticket[i];
    fclose(fp);
  }
  prints("\033[1;33m1.%-8s:%-9d2.%-8s:%-9d3.%-8s:%-9d4.%-8s:%-9d\033[m\n"
    "\033[1;33m5.%-8s:%-9d6.%-8s:%-9d7.%-8s:%-9d8.%-8s:%-9d\033[m\n"
    "\033[1;37;44m ä¸‹æ³¨æ‰€æœ‰é‡‘é¡: \033[33m%d00\033[37m éŠ€\033[m",
    betname[0], ticket[0], betname[1], ticket[1],
    betname[2], ticket[2], betname[3], ticket[3],
    betname[4], ticket[4], betname[5], ticket[5],
    betname[6], ticket[6], betname[7], ticket[7], total);
}


static void
show_ticket_data()
{
  clear();
  vs_bar("å°å°æ¨‚è³­ç›¤");

  move(2, 0);
  outs("\033[1;32må‰å¹¾æ¬¡é–‹ççµæœ\033[m");
  show_file(FN_RUN_TICKET, 3, 8);

  move(14, 0);
  outs("\033[1;36mç›®å‰ä¸‹æ³¨ç‹€æ³\033[m\n");
  show_bet();
  move(19, 0);
  prints("\033[1;46mæ‚¨èº«ä¸Šæœ‰ï¼š %-10d å…ƒ\033[m\n", cuser.money);
  prints("è«‹é¸æ“‡è¦è³¼è²·çš„ç¨®é¡(1~8)[Q:é›¢é–‹]");
}


static int
append_ticket_record(ch, n)
  int ch, n;
{
  FILE *fp;
  int ticket[8] = {0, 0, 0, 0, 0, 0, 0, 0};

  if (fp = fopen(FN_RUN_TICKET_USER, "a"))
  {
    fprintf(fp, "%s %d %d\n", cuser.userid, ch, n);
    fclose(fp);
  }

  if (fp = fopen(FN_RUN_TICKET_RECORD, "r+"))
  {
    fscanf(fp, "%9d %9d %9d %9d %9d %9d %9d %9d\n",
      &ticket[0], &ticket[1], &ticket[2], &ticket[3],
      &ticket[4], &ticket[5], &ticket[6], &ticket[7]);
    ticket[ch] += n;
    rewind(fp);
    fprintf(fp, "%9d %9d %9d %9d %9d %9d %9d %9d\n",
      ticket[0], ticket[1], ticket[2], ticket[3],
      ticket[4], ticket[5], ticket[6], ticket[7]);
    fclose(fp);
  }
  else if (fp = fopen(FN_RUN_TICKET_RECORD, "w"))
  {
    ticket[ch] += n;
    fprintf(fp, "%9d %9d %9d %9d %9d %9d %9d %9d\n",
      ticket[0], ticket[1], ticket[2], ticket[3],
      ticket[4], ticket[5], ticket[6], ticket[7]);
    fclose(fp);
  }
}


static void
show_picture(filename)
  char *filename;
{
  FILE *fp;
  char buf[256];

  move(5, 0);
  if ((fp = fopen(filename, "r")))
  {
    while (fgets(buf, 256, fp))
      outs(buf);
    fclose(fp);
  }
}


static void
ch_buyitem(money, picture, item)
  int money;
  char *picture;
  int *item;
{
  int num = 0;
  char buf[5];
  vget(b_lines - 1, 0, "è¦è²·å¤šå°‘ä»½å‘¢:", buf, 4, LCECHO);
  num = atoi(buf);
  if (num < 0)
    num = 0;
  if (cuser.money > money * num)
  {
    *item += num;
    cuser.money -= money * num;
    clrfromto(5, 17);
    show_picture(picture);
  }
  else
  {
    vmsg("ç¾é‡‘ä¸å¤ ï¼");
  }
}


static int
ticket_main()
{
  int ch, n;

  while (1)
  {
    show_ticket_data();
    ch = vkey();
    if (ch == 'q' || ch == 'Q')
      break;
    ch -= '1';
    if (ch > 7 || ch < 0)
      continue;
    n = 0;
    ch_buyitem(100, "etc/game/buyticket", &n);
    if (n > 0)
      append_ticket_record(ch, n);
  }
  return 0;
}


static void
query_ticket()
{
  FILE *fp;
  int tickets[8] = {0, 0, 0, 0, 0, 0, 0, 0};
  int num1, num2, i = 0;
  char userid[IDLEN + 1];

  if (fp = fopen(FN_RUN_TICKET_USER, "r"))
  {
    while ((fscanf(fp, "%s %d %d", userid, &num1, &num2)) != EOF)
    {
      if (!str_cmp(userid, cuser.userid))
      {
        if (!i)
          i = 1;
        tickets[num1] += num2;
      }
    }
    fclose(fp);
  }
  else
  {
    vmsg("æ«ƒå°å°å§ï¼šä¸¦æ²’æœ‰ä»»ä½•ä¸€å€‹äºº(åŒ…æ‹¬æ‚¨)æŠ¼æ³¨");
    return;
  }
  if (!i)
  {
    vmsg("æ«ƒå°å°å§ï¼šæŠ±æ­‰ï¼Œæ‚¨ä¸¦æ²’æœ‰æŠ¼ä»»ä½•ä¸€é …ï¼");
    return;
  }

  clear();
  outs("\033[1;33mæ«ƒå°å°å§çµ¦æ‚¨ä¸€å¼µæ¸…å–®ï¼š\033[\n");
  prints("\033[1;32må°å°æ¨‚è³­ç›¤ï¼š\033[35m%s \033[32mä¸‹æ³¨ä¸€è¦½è¡¨\033[m\n\n", cuser.userid);
  for (i = 0; i < 8; i++)
  {
    prints("\033[1;3%dmæ‚¨(%s) æŠ¼äº† [%d. %-4s]ï¼š%d å¼µ\033[m\n",
      i + 1 <= 7 ? i + 1 : i - 6,
      cuser.userid, i + 1, betname[i],
      tickets[i]);
  }
  vmsg(NULL);
}


/* Chukuang æ”¹å¯«ï¼Œå¯ä»¥åŸ·è¡Œä¸‹æ³¨èˆ‡æŸ¥è©¢ */
int
main_ticket()
{
  if (cutmp->status & STATUS_COINLOCK)
  {
    vmsg(MSG_COINLOCK);
    return XEASY;
  }

  vs_bar("å°å°æ¨‚è³­ç›¤");

  move(3, 0);
  outs(
    "\033[1;32mè¦å‰‡:\033[m 1.å¯è³¼è²·å…«ç¨®ä¸åŒé¡å‹çš„å½©ç¥¨ã€‚æ¯å¼µè¦èŠ±100å…ƒã€‚\n"
    "      2.æ¯åäºŒå°æ™‚é–‹çä¸€æ¬¡(0:30 12:30)ã€‚\n"
    "      3.é–‹çæ™‚æœƒæŠ½å‡ºä¸€ç¨®å½©ç¥¨, æœ‰è³¼è²·è©²å½©ç¥¨è€…, å‰‡å¯ä¾è³¼è²·çš„å¼µæ•¸å‡åˆ†ç¸½è³­é‡‘ã€‚\n"
    "      4.æ¯ç­†çé‡‘ç”±ç³»çµ±æŠ½å–5%ä¹‹ç¨…é‡‘ã€‚\n\n");

  move(9, 10);
  outs("[1] \033[1;41m å°å°æ¨‚è³­ç›¤æŠ•æ³¨ \033[m");
  move(10, 14);
  outs("\033[1;31mâ”€â”€â”€â”€â”€â”€â”€â”€\033[m");
  move(11, 10);
  outs("[2] \033[1;44m æŸ¥è©¢æ‰€ä¸‹æ³¨è³‡æ–™ \033[m");
  move(12, 14);
  outs("\033[1;34mâ”€â”€â”€â”€â”€â”€â”€â”€\033[m");
  move(13, 10);
  outs("[0] \033[1;42m é›¢é–‹å°å°æ¨‚è³­ç›¤ \033[m");
  move(14, 14);
  outs("\033[1;32mâ”€â”€â”€â”€â”€â”€â”€â”€\033[m");

  switch (vans("è«‹è¼¸å…¥æ‚¨çš„é¸æ“‡ï¼š"))
  {
  case '1':
    ticket_main();
    break;
  case '2':
    query_ticket();
    break;
  }

  return 0;
}

> ------------------------------------------------------------------------ <


[1;32mä¿®æ”¹~/src/util/Makefile[m

EXE =    ..... [1;33mticket_open[m

[1;32mæ–°å¢~/src/util/ticket_open.c[m

/*-------------------------------------------------------*/
/* ticket.c     ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : å°å°æ¨‚é–‹ç                                   */
/* create :   /  /                                       */
/* update : 03/08/27                                     */
/* author : Ptt.bbs@ptt.twbbs.org                        */
/*-------------------------------------------------------*/


#include "bbs.h"

#define MAX_DES     8          /* æœ€å¤§ä¿ç•™çæ•¸ */


/* JCWang:ç™¼éŒ¢å‡½å¼ */
stativ void
add_money(userid, kind, money)
  char *userid;
  int kind;
  int money;
{
  char fpath[64];
  PAYCHECK paycheck;

  memset(&paycheck, 0, sizoef(PAYCHECK));
  time(&paycheck.tissue);
  paycheck.money = money;
  strcpy(paycheck.reason, "å°å°æ¨‚çé‡‘");

  usr_fpath(fpath, userid, FN_PAYCHECK);
  rec_add(fpath, &paycheck, sizeof(PAYCHECK));
}


static void
mail_to_him(fpath, userid, title, xmode)     /* itoc.011115: å¯„æª”æ¡ˆçµ¦ userid */
  char *fpath;                  /* æª”æ¡ˆè·¯å¾‘ */
  char *userid;                 /* æ”¶ä»¶äºº */
  char *title;                  /* éƒµä»¶æ¨™é¡Œ */
  usint xmode;
{
  HDR hdr;
  char folder[64];

  usr_fpath(folder, userid, FN_DIR);
  hdr_stamp(folder, HDR_LINK, &hdr, fpath);
  strcpy(hdr.owner, STR_SYSOP);
  strcpy(hdr.title, title);
  hdr.xmode = xmode;
  rec_add(folder, &hdr, sizeof(HDR));
}


static void
mail_to_him(userid, num, name, givemoney)
  char *userid;
  int num;
  char *name;
  int givemoney;
{
  FILE *fp;
  char fpath[64];

  usr_fpath(fpath, userid, "ticket");
  if (fp = fopen(fpath, "w"))
  {
    fprintf(fp, "%s ä¸­äº† %d å¼µ [%s] å¾— %d å…ƒ\n", userid, num, name, givemoney);
    fclose(fp);
    mail_to_him(fpath, userid, "[å°å°æ¨‚] è³­ç›¤é–‹çé€šçŸ¥", 0);
    unlink(fpath);
  }
}


int
main()
{
  int money, bet, n, total, ticket[8] = {0, 0, 0, 0, 0, 0, 0, 0};
  FILE *fp;
  time_t now;
  char des[MAX_DES][200] = {"", "", "", ""};
  static char betname[8][13] =
  {
    "ç–²å€¦é‡è²“","æ²’åŠ›å’©å’©","éŠé­‚å°é¢¨","é­”åŠ›å°å¤¢",
    "å‹¤å¥®å¤§é­š","ç¢¼é ­é˜¿å€«","ä¸€å †èèŸ»","å˜°å“©å’•åš•"
  };

  chdir(BBSHOME);

  f_mv(FN_RUN_TICKET_RECORD, FN_RUN_TICKET_RECORD ".tmp");
  f_mv(FN_RUN_TICKET_USER, FN_RUN_TICKET_USER ".tmp");

  if (!(fp = fopen(FN_RUN_TICKET_RECORD ".tmp", "r")))
    return 0;

  fscanf(fp, "%9d %9d %9d %9d %9d %9d %9d %9d\n",
    &ticket[0], &ticket[1], &ticket[2], &ticket[3],
    &ticket[4], &ticket[5], &ticket[6], &ticket[7]);
  total = 0;
  for (n = 0; n < 8; n++)
    total += ticket[n];
  fclose(fp);

  if (!total)
    return 0;

  if (fp = fopen(FN_RUN_TICKET, "r"))
  {
    for (n = 0; n < MAX_DES && fgets(des[n], 200, fp); n++);
    fclose(fp);
  }

  time(&now);
  srand(now);
  bet = rnd(8);

  money = ticket[bet] ? total * 95 / ticket[bet] : 9999999;

  if (fp = fopen(FN_RUN_TICKET, "w"))
  {
    if (des[MAX_DES - 1][0])
      n = 1;
    else
      n = 0;
    for (; n < MAX_DES && des[n][0] != 0; n++)
    {
      fprintf(fp, des[n]);
    }
    fprintf(fp, "%14.14s è³­ç›¤é–‹å‡º:%s ç¸½é‡‘é¡:%d00 å…ƒ "
      "çé‡‘/å¼µ:%d å…ƒ æ©Ÿç‡:%1.2f\n",
      Btime(&now), betname[bet], total, money,
      (float)ticket[bet] / total);
    fclose(fp);
  }

  if (ticket[bet] &&
    (fp = fopen(FN_RUN_TICKET_USER ".tmp", "r")))  /* æœ‰äººæŠ¼ä¸­ */
  {
    int mybet, num;
    char userid[20];

    while (fscanf(fp, "%s %d %d\n", userid, &mybet, &num) != EOF)
    {
      if (mybet == bet)
      {
        printf("%s ä¸­äº† %d å¼µ [%s] å¾— %d å…ƒ\n",
          userid, num, betname[mybet], money * num);
        add_money(userid, 4, money * num);
        mail_to_him(userid, num, betname[mybet], money * num);
      }
    }
  }
  unlink(FN_RUN_TICKET_RECORD ".tmp");
  unlink(FN_RUN_TICKET_USER ".tmp");
}

[1;32mæœ€å¾Œåˆ¥å¿˜äº†æ”¾å…¥å¯æ„›çš„crontabä¸­:P[m

# å°å°æ¨‚é–‹ç
30 0 * * * bin/openticket > /dev/null 2>&1

--
[1;36m=[37m[[36mï¹[37m:[33m?[37mæ‘ƒ?[mâ—£?[1;33m?[37m:[36mï¹ [31mOrigin[37m ]|[[m     [31m?[1må¨[0;31mO?[1mç—[0;31m?[1mprocessor.tfcis.org    [37m]|[?[33mæŸèªª[m?[1;36mï¹[37m:][36m=[m
[1;36m=[m[[1;36mï¹Š[37m:[33m?[30mæ‘ƒ?[mâ•±?[1;33m?[37m:[36mï¹Š [31mAuthor[m ]|[ [1m    bbs.kuas.edu.tw                 [m]|[?[1;33m?[30m?[37mæ’[30m?[36mï¹Š[37m:[m][1;36m=[m
