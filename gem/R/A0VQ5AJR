ç™¼ä¿¡äºº: BioStar.bbs@micro.bio.ncue.edu.tw (æ¾æ¹–å°é›²é›€) çœ‹æ¿: plan
æ¨™  é¡Œ: [æ–‡ä»¶] ï¼ˆäº”åˆ†é˜ç´¯ç©ï¼‰ç™»å…¥èˆ‡ç™»å‡ºäººæ•¸ MRTG åœ–è¡¨
ç™¼ä¿¡ç«™: æ“å¤©å´— (Sat, 01 Nov 2003 01:41:28 +0800 (CST))    Updated: 2003/11/01

å¦‚æœå¼„ä¸€å€‹æª”æ¡ˆè¨˜éŒ„ç™»å…¥çš„åºè™Ÿ...  æ¯ä¸€æ¬¡æœ‰ä½¿ç”¨è€…ç™»å…¥å°±ç´¯åŠ ä¸Šå»...
å¦‚æœæˆ‘æƒ³çŸ¥é“ç¾åœ¨ A æ™‚é–“åˆ° B æ™‚é–“ä¸­æœ‰å¤šå°‘æ¬¡ç™»å…¥ I ......
é‚£å°±æ˜¯ç™»å…¥çš„åºè™Ÿçš„å·®è·ï¼š I = SB - SA ......
A æ™‚é–“åˆ° B æ™‚é–“ç·šä¸Šäººæ•¸å·®è· D = LB - LA ......
ç·šä¸Šäººæ•¸å·®è·ç­‰å…¥ç™»å…¥æ¬¡æ•¸ I æ¸›æ‰ç™»å‡ºæ¬¡æ•¸ Oï¼š L = I - O ......
O = I - L ......  æœ‰é»è¤‡é›œ......
ä¸‹é¢ç¨‹å¼ç¢¼å¦‚æœæœ‰ä¸æ°ç•¶...  é‚„è«‹å„ä½å‰è¼©ä¸åæŒ‡æ­£...

: include/struct.h:æ–°å¢ LOGNUM çµæ§‹

typedef struct
{
  int online;                   /* ç·šä¸Šäººæ•¸ */
  int log_serial;               /* ç™»å…¥åºè™Ÿ */
} LOGNUM;


: include/struct.h:

#define FN_BRD          ".BRD"          /* board list */
#define FN_SCHEMA       ".USR"          /* userid schema */
[1;32;40m+ #define FN_LOGNUM       ".LOGNUM"[m


: util/showLOGNUM.c:æ–°å¢é€™å€‹æª”æ¡ˆ

#include "bbs.h"

static UCACHE *ushm;


static inline void
init_ushm()
{
  ushm = shm_new(UTMPSHM_KEY, sizeof(UCACHE));
}


int
main()
{
  int login, logout, diff;
  LOGNUM log_a, log_b;

  chdir(BBSHOME);

  memset(&log_a, 0, sizeof(log_a));
  memset(&log_b, 0, sizeof(log_b));

  if (rec_get(FN_LOGNUM, &log_a, sizeof(LOGNUM), 0))
    rec_add(FN_LOGNUM, &log_a, sizeof(log_a));

  if (rec_get(FN_LOGNUM, &log_b, sizeof(LOGNUM), 1))
    rec_add(FN_LOGNUM, &log_b, sizeof(log_b));

  init_ushm();
  log_a.online = ushm->count;

  login = log_a.log_serial - log_b.log_serial;
  diff = log_a.online - log_b.online;
  logout = login - diff;

  log_b.online = log_a.online;
  log_b.log_serial = log_a.log_serial;

  rec_put(FN_LOGNUM, &log_b, sizeof(LOGNUM), 1, NULL);

  printf("%d\n%d\n0\n0\n", login, logout);

  exit (0);
}


 å…ˆè·‘ä¸€æ¬¡ showLOGNUM ä»¥ç”Ÿæˆ .LOGNUM æª”æ¡ˆ......


: maple/bbsd.c:utmp_setup()

  UTMP utmp;
  uschar *addr;
[1;32;40m+ LOGNUM lognum;[m


: maple/bbsd.c:utmp_setup()

  if (!utmp_new(&utmp))
    login_abort("\næ‚¨å‰›å‰›é¸çš„ä½å­å·²ç¶“è¢«äººæ·è¶³å…ˆç™»äº†ï¼Œè«‹ä¸‹æ¬¡å†ä¾†å§");

[1;32;40m+ rec_get(FN_LOGNUM, &lognum, sizeof(LOGNUM), 0);[m
[1;32;40m+ lognum.online = ushm->count;[m
[1;32;40m+ lognum.log_serial++;[m
[1;32;40m+ rec_put(FN_LOGNUM, &lognum, sizeof(LOGNUM), 0, NULL);[m


mrtg èˆ‡ apache è¦å…ˆå®‰è£å¥½......
ç·¨è¼¯ä¸€å€‹ mrtg çš„ cfg æª”æ¡ˆ...  å…§å®¹å¦‚ä¸‹...

Target[BBS]: `/usr/home/bbs/bin/showLOGNUM`
MaxBytes[BBS]: 2500                                 # é€šå¸¸ç”¨ MAXACTIVE
Title[BBS]: BBS ç™»å…¥èˆ‡ç™»å‡º MRTG åœ–ï¼ˆæœ€è¿‘äº”åˆ†é˜å…§ï¼‰
PageTop[BBS]: BBS ç™»å…¥èˆ‡ç™»å‡º MRTG åœ–ï¼ˆæœ€è¿‘äº”åˆ†é˜å…§ï¼‰
Options[BBS]: gauge, growright
YLegend[BBS]: BBS OnLine
ShortLegend[BBS]: äºº
WorkDir: /usr/home/mrtg/www/lognum                  # è‡ªè¨‚...
LegendO[BBS]: ç™»å‡ºäººæ•¸
LegendI[BBS]: ç™»å…¥äººæ•¸
Language: big5

å¯«å…¥ç³»çµ± crontab ä¸­......  å…§å®¹è¦–æƒ…æ³è€Œå®š......
*/5 * * * * root /usr/local/bin/mrtg /usr/local/etc/mrtg/mrtg_bbslog.cfg

ç¯„ä¾‹ï¼š
http://bbs.bio.ncue.edu.tw/mrtg/lognum/bbs.html


--
 [1;41mâ”Œ[44mâ”¼[m Or[1mig[30min[m: [41m å½°åŒ–å¸«å¤§ç”Ÿç‰©ç³»Ë™åŸé¢¨?çœºæœˆ?æ“å¤©å´— [32;47m micro.bio.ncue.edu.tw [m
 [1;42mâ”¼[45mâ”˜[m A[1mut[30mho[mr: [1;33mBioStar [30må¾ [35m163.23.212.18 [30mç™¼è¡¨[m
