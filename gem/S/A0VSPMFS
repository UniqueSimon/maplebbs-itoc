ä½œè€…: itoc (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: itoc
æ¨™é¡Œ: Re: é—œæ–¼M3 for win
æ™‚é–“: Wed Dec  3 02:25:27 2003                          Updated: 2005/04/05

â€» å¼•è¿°ã€ŠGainer.bbs@venus.nhit.edu.tw (GAI)ã€‹ä¹‹éŠ˜è¨€ï¼š
> æˆ‘å·²ç¶“æ¶è¨­Mapleä¸éåœ¨ç³»çµ±ç¶­è­·å€è£¡é¢å°‘äº†ä¸€å‘'è¨­å®šæ¬Šé™'
> è¦å¦‚ä½•æ–°å¢å‘¢??

: menu.c:menu_admin[]

  "bin/admutil.so:a_user", PERM_ALLACCT, - M_SYSTEM,
  "User       â—¤ é¡§å®¢è³‡æ–™ â—¢",

+ "bin/admutil.so:a_setperm", PERM_ALLBOARD, - M_SYSTEM,
+ "Perm       â—¤ è¨­å®šæ¬Šé™ â—¢",

: admutil.c:a_setperm() åŠ åœ¨ a_user() å¾Œé¢

int
a_setperm()
{
  ACCT acct;
  int adm;
  usint levelup, leveldown;
  char ans[8];

  move(1, 0);
  clrtobot();

  while (acct_get(msg_uid, &acct) > 0)
  {
    if (acct.userlevel & PERM_ALLADMIN)        /* ä¸èƒ½æ”¹ç«™å‹™çš„æ¬Šé™ */
      return 0;

    [1;44m// å¦‚æœå¤§ç«™é•·ä¸æƒ³è®“å°ç«™é•·ç”¨  â—¤ è¨­å®šæ¬Šé™ â—¢ é€™é¸é …çœ‹ä½¿ç”¨è€…è³‡æ–™ [m
    [1;44m// é‚£éº¼å¯ä»¥æŠŠä¸‹é¢é€™è¡Œæ‹¿æ‰                                      [m
    acct_show(&acct, 1);        /* é¡¯ç¤ºä½¿ç”¨è€…è³‡æ–™ */

    if (HAS_PERM(PERM_ALLACCT))
    {
      adm = vans("è¨­å®š 1)æ¿ä¸»ä¸Šä»» 2)æ¿ä¸»å¸ä»» 3)åœæ¬Š 4)å¾©æ¬Š 5)ç å¸³è™Ÿï¼Ÿ[Q] ");
      if (adm < '1' || adm > '5')
        return 0;
    }
    else /* if (HAS_PERM(PERM_ALLBOARD)) */
    {
      adm = vans("è¨­å®š 1)æ¿ä¸»ä¸Šä»» 2)æ¿ä¸»å¸ä»» Q)å–æ¶ˆ [Q] ");
      if (adm < '1' || adm > '2')
        return 0;
    }

    if (vans(msg_sure_ny) != 'y')
      return 0;

    switch (adm)
    {
    case '1':
      levelup = PERM_BM;
      leveldown = 0;
      break;

    case '2':
      levelup = 0;
      leveldown = PERM_BM;
      break;

    case '3':
      levelup = 0;
      if (vans("è«‹å•è¦åœæ­¢é€™ä½ä½¿ç”¨è€…çš„ç™¼æ–‡æ¬Šå—(Y/N)ï¼Ÿ[Y] ") != 'n')
        levelup |= PERM_DENYPOST;
      if (vans("è«‹å•è¦åœæ­¢é€™ä½ä½¿ç”¨è€…çš„è«‡è©±æ¬Šå—(Y/N)ï¼Ÿ[Y] ") != 'n')
        levelup |= PERM_DENYTALK;
      if (vans("è«‹å•è¦åœæ­¢é€™ä½ä½¿ç”¨è€…çš„èŠå¤©æ¬Šå—(Y/N)ï¼Ÿ[Y] ") != 'n')
        levelup |= PERM_DENYCHAT;
      if (vans("è«‹å•è¦åœæ­¢é€™ä½ä½¿ç”¨è€…çš„å¯„ä¿¡æ¬Šå—(Y/N)ï¼Ÿ[Y] ") != 'n')
        levelup |= PERM_DENYMAIL;
      leveldown = 0;

      /* åœæ¬Šè¦æŒ‡å®šæœŸé™ */
      adm = -1;
      if (vget(b_lines, 0, "åœæ¬Šå¹¾å¤©ï¼š", ans, 4, DOECHO))
        adm = atoi(ans);
      if (adm <= 0)
        adm = 30;         /* é è¨­ 30 å¤© */
      acct.tvalid = time(0) + adm * 86400;
      break;

    case '4':
      levelup = 0;
      leveldown = PERM_ALLDENY;
      time(&(acct.tvalid));
      break;

    case '5':
      levelup = PERM_PURGE;
      leveldown = 0;
      break;
    }

    acct_setperm(&acct, levelup, leveldown);
  }

  return 0;
}

> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ <

  ç«™å‹™åœæ¬Šéœ€è¦è¼¸å…¥ç†ç”±ï¼Œä¸¦ä¸”æŠŠç†ç”±è¨˜åœ¨ log æ¿

: admutil.c æ–°å¢ä»¥ä¸‹å‡½å¼åœ¨ a_setperm() å‰é¢

static void
add_post(brdname, fpath, title)           /* ç™¼æ–‡åˆ°çœ‹æ¿ */
  char *brdname;        /* æ¬² post çš„çœ‹æ¿ */
  char *fpath;          /* æª”æ¡ˆè·¯å¾‘ */
  char *title;          /* æ–‡ç« æ¨™é¡Œ */
{
  HDR hdr;
  char folder[64];

  brd_fpath(folder, brdname, fn_dir);
  hdr_stamp(folder, HDR_LINK | 'A', &hdr, fpath);
  strcpy(hdr.owner, cuser.userid);
  strcpy(hdr.nick, cuser.username);
  strcpy(hdr.title, title);
  rec_add(folder, &hdr, sizeof(HDR));
}


static void
log_setperm(userid, day, reason)
  char *userid;
  int day;
  char *reason;
{
  char fpath[64], title[TTLEN + 1];
  FILE *fp;

  sprintf(fpath, "tmp/log_setperm.%s", cuser.userid);   /* æš«å­˜æª” */
  if (fp = fopen(fpath, "w"))
  {
    sprintf(title, "ç«™é•· %s åœ %s æ¬Š %d å¤©",
      cuser.userid, userid, day);

    /* æ–‡ç« æª”é ­ */
    fprintf(fp, "%s %s (%s) %s %s\n",
      str_author1, cuser.userid, cuser.username,
      str_post2, BN_SECURITY);
    fprintf(fp, "æ¨™é¡Œ: %s\næ™‚é–“: %s\n\n", title, Now());

    /* æ–‡ç« å…§å®¹ */
    fprintf(fp, "%s\n\n", title);
    fprintf(fp, "ç†ç”±ï¼š%s\n\n", reason);
    fclose(fp);

    add_post(BN_SECURITY, fpath, title);
    unlink(fpath);
  }
}

: admutil.c:a_setperm()

  ACCT acct;
  int adm;
  usint levelup, leveldown;
  char ans[8];
+ char reason[80];

  ...
  ...

      /* åœæ¬Šè¦æŒ‡å®šæœŸé™ */
      adm = -1;
      if (vget(b_lines, 0, "åœæ¬Šå¹¾å¤©ï¼š", ans, 4, DOECHO))
        adm = atoi(ans);
      if (adm <= 0)
        adm = 30;         /* é è¨­ 30 å¤© */
      acct.tvalid = time(0) + adm * 86400;
+     if (!vget(b_lines, 0, "åœæ¬Šç†ç”±ï¼š", reason, 50, DOECHO))
+       strcpy(reason, "è«é ˆæœ‰");
+     log_setperm(acct.userid, adm, reason);
      break;

--
 [1;43mâ”Œ[44mâ”¼[m Or[1mig[30min[m: [44m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [31;47m processor.tfcis.org [m
 [1;41mâ””[42mâ”˜[m A[1mut[30mho[mr: [1;36mitoc [30må¾ [35mitoc.dorm11.nctu.edu.tw [30mç™¼è¡¨[m
