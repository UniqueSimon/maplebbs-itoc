ç™¼ä¿¡äºº: BioStar.bbs@micro.bio.ncue.edu.tw (æ¾æ¹–å°é›²é›€(Skyl çœ‹æ¿: plan
æ¨™  é¡Œ: [æ–‡ä»¶] ç¶“æ¿Ÿæ¦‚æ³ economy.c
ç™¼ä¿¡ç«™: æ“å¤©å´— (2004/01/23 Fri 10:43:40)                  Updated: 2004/01/23

åªæƒ³çŸ¥é“ç¾åœ¨é‡‘éŠ€å¹£ä¸€äº›è³‡è¨Š......

: src/util/Makefile

EXE =   .... [1;33meconomy[m

: util/economy.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* util/economy         ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : ç¶“æ¿Ÿæ¦‚æ³                                     */
/* create : 04/01/23                                     */
/* update :   /  /                                       */
/* author : BioStar.bbs@micro.bio.ncue.edu.tw            */
/*-------------------------------------------------------*/


#include "bbs.h"


#define OUTFILE_ECONOMY "gem/@/@-economy"
#define FN_ECONOMY      "run/economy"


typedef struct
{
  long long int totalgold;
  long long int totalmoney;
  time_t last_time;
} ECONOMY;


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main()
{
  char c;
  int usernum = 0, avgmoney = 0, avggold = 0;
  long long int totalmoney = 0, totalgold = 0;
  FILE *fp;
  ECONOMY economy;
  long long int golddiff = 0, moneydiff = 0;
  double avggolddiff, avgmoneydiff, days;
  time_t now_time, interval;

  chdir(BBSHOME);

  /* ç¬¬ä¸€æ¬¡çµ±è¨ˆ */
  if (rec_get(FN_ECONOMY, &economy, sizeof(ECONOMY), 0))
    memset(&economy, 0, sizeof(ECONOMY));

  for (c = 'a'; c <= 'z'; c++)
  {
    char buf[64];
    struct dirent *de;
    DIR *dirp;

    sprintf(buf, BBSHOME "/usr/%c", c);
    chdir(buf);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      ACCT acct;
      int fd;
      char *fname;

      fname = de->d_name;
      if (*fname <= ' ' || *fname == '.')
        continue;

      sprintf(buf, "%s/.ACCT", fname);
      if ((fd = open(buf, O_RDONLY)) < 0)
        continue;

      read(fd, &acct, sizeof(ACCT));
      close(fd);

      totalmoney += acct.money;
      totalgold += acct.gold;
      usernum++;
    }

    closedir(dirp);
  }

  chdir(BBSHOME);

  avgmoney = totalmoney / usernum;
  avggold = totalgold / usernum;

  now_time = time(0);
  interval = now_time - economy.last_time;
  days = (double) interval / (double) 86400;

  golddiff = totalgold - economy.totalgold;
  moneydiff = totalmoney - economy.totalmoney;
  avggolddiff = ((double) golddiff / (double) usernum) / days;
  avgmoneydiff = ((double) moneydiff / (double) usernum) / days;

  if (fp = fopen(OUTFILE_ECONOMY, "w"))
  {
    fprintf(fp, "\n\n\t\t\t\t\tæœ¬ç«™ç¶“æ¿Ÿæ¦‚æ³\n");
    fprintf(fp, "\n\t\tâ•­â”€â”¤\033[1;32;41m %s  \033[mâ”œâ”€â•®\n", Now());
    fprintf(fp, "\t\tâ”‚æœ¬ç«™ç›®å‰ç¸½äººå£ï¼š%14d äºº â”‚\n", usernum);
    fprintf(fp, "\t\tâ”‚\033[1;33mæœ¬ç«™äººæ°‘ç¸½é‡‘å¹£ï¼š%14lld å…ƒ\033[m â”‚\n", totalgold);
    fprintf(fp, "\t\tâ”‚\033[1;33må¹³å‡æ¯äººæœ‰é‡‘å¹£ï¼š%14d å…ƒ\033[m â”‚\n", avggold);
    fprintf(fp, "\t\tâ”‚\033[1;33mé‡‘å¹£æ—¥ç”Ÿç”¢æ¯›é¡ï¼š%14lld å…ƒ\033[m â”‚\n", golddiff);
    fprintf(fp, "\t\tâ”‚\033[1;33må¹³å‡é‡‘å¹£æ—¥ç”¢é¡ï¼š%14.3f å…ƒ\033[m â”‚\n", avggolddiff);
    fprintf(fp, "\t\tâ”‚\033[1mæœ¬ç«™äººæ°‘ç¸½éŠ€å¹£ï¼š%14lld å…ƒ\033[m â”‚\n", totalmoney);
    fprintf(fp, "\t\tâ”‚\033[1må¹³å‡æ¯äººæœ‰éŠ€å¹£ï¼š%14d å…ƒ\033[m â”‚\n", avgmoney);
    fprintf(fp, "\t\tâ”‚\033[1méŠ€å¹£æ—¥ç”Ÿç”¢æ¯›é¡ï¼š%14lld å…ƒ\033[m â”‚\n", moneydiff);
    fprintf(fp, "\t\tâ”‚\033[1må¹³å‡éŠ€å¹£æ—¥ç”¢é¡ï¼š%14.3f å…ƒ\033[m â”‚\n", avgmoneydiff);
    fprintf(fp, "\t\tâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\n");

    fclose(fp);
  }

  economy.totalgold = totalgold;
  economy.totalmoney = totalmoney;
  economy.last_time = now_time;
  rec_put(FN_ECONOMY, &economy, sizeof(ECONOMY), 0, NULL);
}


--
 [1;43mâ•­[46mâ”¼[m Or[1mig[30min[m: [41m å½°åŒ–å¸«å¤§ç”Ÿç‰©ç³»Ë™åŸé¢¨?çœºæœˆ?æ“å¤©å´— [32;47m micro.bio.ncue.edu.tw [m
 [1;44mâ”¼[41mâ•¯[m A[1mut[30mho[mr: [1;33mBioStar [30må¾ [35m61-219-111-196.HINET-IP.hinet.net [30mç™¼è¡¨[m
