ä½œè€…: itoc.bbs@bbs.cs.nthu.edu.tw ç«™å…§: plan
æ¨™é¡Œ: Re: è«‹æ•™ä¸€ä¸‹å¦‚ä½•é‡å»º .BRD
æ™‚é–“: Sun Oct 20 17:34:53 2002                          Updated: 2005/05/19

â€» å¼•è¿°ã€Šrojerã€‹ä¹‹éŠ˜è¨€ï¼š
>         è‹¥ .BRD çˆ›æŽ‰
>         æœ‰è¾¦æ³•ç”¨ç¨‹å¼åŽ»é‡æ–°å»ºç«‹å—Ž?!

  åŸ·è¡Œæ­¤ç¨‹å¼ä»¥å¾Œï¼Œå†å°‡ .BRD_new è¦†è“‹ .BRD å³å¯

  æ¿ä¸»è¦æ‰‹å‹•é‡å»º
  ç‰¹æ®Šçœ‹æ¿æ¬Šé™(ç§˜å¯†/å¥½å‹/ç«™å‹™æ¿)è¦æ‰‹å‹•é‡è¨­
  åˆ†é¡žè¦æ‰‹å‹•æ”¹

: src/util/Makefile

EXE =   ..... [1;33mrebrd[m

: src/util/rebrd.c æ–°å¢žé€™ç¨‹å¼

/*-------------------------------------------------------*/
/* util/rebrd.c         ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : é‡å»º .BRD                                    */
/* create : 02/10/20                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/

/*
  è‹±æ–‡æ¿ååŽ» brd/* æŠ“
  ä¸­æ–‡æ¿ååŽ» gem/@/@Class æŠ“
  çœ‹æ¿å±¬æ€§åŽ» innd/newsfeeds.bbs æŠ“
  æ¿ä¸»è¦æ‰‹å‹•é‡å»º
  ç‰¹æ®Šçœ‹æ¿æ¬Šé™(ç§˜å¯†/å¥½å‹/ç«™å‹™æ¿)è¦æ‰‹å‹•é‡è¨­
  åˆ†é¡žè¦æ‰‹å‹•æ”¹
*/


#include "bbs.h"


static int                  /* 1:æ­¤çœ‹æ¿è½‰ä¿¡ 0:æ­¤çœ‹æ¿ä¸è½‰ä¿¡ */
board_outgo(brdname)
  char *brdname;
{
  newsfeeds_t nf;
  int fd;
  int rc = 0;

  /* è‹¥ newsfeeds è£¡é¢æœ‰è³‡æ–™ï¼Œå°±ä»£è¡¨è¦è½‰ä¿¡ */

  if ((fd = open("innd/newsfeeds.bbs", O_RDONLY)) >= 0)
  {
    while (read(fd, &nf, sizeof(newsfeeds_t)) == sizeof(newsfeeds_t))
    {
      if (!str_cmp(brdname, nf.board))
      {
        rc = 1;
        break;
      }
    }
    close(fd);
  }

  return rc;
}


static void
board_title(folder, brdname, title)  /* åŽ» gem/@/@Class æ‰¾ brd.title */
  char *folder;
  char *brdname;
  char *title;
{
  int xmode;
  char fpath[64];
  HDR hdr;
  FILE *fp;

  if (*title)           /* å·²ç¶“æ‰¾åˆ° */
    return;

  if (fp = fopen(folder, "r"))
  {
    while (fread(&hdr, sizeof(HDR), 1, fp) == 1)
    {
      xmode = hdr.xmode & (GEM_BOARD | GEM_FOLDER);

      if (xmode == (GEM_BOARD | GEM_FOLDER))      /* çœ‹æ¿ç²¾è¯å€æ·å¾‘ */
      {
        if (!strcmp(hdr.xname, brdname))
        {
          /* åƒè€ƒ gem.c:brd2gem() çš„æ ¼å¼ */
          str_ncpy(title, hdr.title + BNLEN + 1 + BCLEN + 1, BTLEN + 1);
          break;
        }
      }
      else if (xmode == GEM_FOLDER)               /* å·å®— recursive é€²åŽ»æ‰¾ */
      {
        hdr_fpath(fpath, folder, &hdr);
        board_title(fpath, brdname, title);
      }
    }

    fclose(fp);
  }
}


static void
transbrd(brdname)
  char *brdname;
{
  static int chrono = 1000;

  BRD brd;
  int outgo;
  char title[BTLEN + 1];

  memset(&brd, 0, sizeof(BRD));
  outgo = board_outgo(brdname);

  str_ncpy(brd.brdname, brdname, sizeof(brd.brdname));
  title[0] = '\0';
  board_title("gem/@/@"CLASS_INIFILE, brdname, title);
  sprintf(brd.title, "åˆ†é¡ž %s", title);  /* åˆ†é¡žæ‰‹å‹•æ”¹ */
  /* brd.BM ç•™ç™½ï¼Œæ‰‹å‹•æ¢å¾© */

  brd.bvote = 0;                /* æŠ•ç¥¨æœƒæµå¤± */
  brd.bstamp = ++chrono;
  brd.readlevel = 0;            /* ç‰¹æ®Šæ¿æ¬Šé™æ‰‹å‹•æ”¹ */
  brd.postlevel = PERM_POST;
  brd.battr = outgo ? 0 : BRD_NOTRAN;

  /* é€™äº›æœƒè‡ªå‹•æ›´æ–° */
  brd.btime = 0;
  brd.bpost = 0;
  brd.blast = 0;

  /* æ–°æª”æ¡ˆå»ºåœ¨ .BRD_new å†è¦†è“‹ .BRD å³å¯ */
  rec_add(".BRD_new", &brd, sizeof(BRD));
}


int
main()
{
  DIR *dirp;
  struct dirent *de;
  char *str;

  chdir(BBSHOME);

  if (!(dirp = opendir("brd")))
    exit(-1);

  unlink(".BRD_new");

  while (de = readdir(dirp))
  {
    str = de->d_name;
    if (*str <= ' ' || *str == '.')
      continue;

    transbrd(str);
  }

  closedir(dirp);
  exit(0);
}

--
â€» Origin: æ¥“æ©‹é©›ç«™<bbs.cs.nthu.edu.tw> â—† From: itoc.Dorm-GD2.NCTU.edu.tw
