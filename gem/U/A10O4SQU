ç™¼ä¿¡äºº: simple.bbs@bbs.wfc.edu.tw (é¤Šå…µåƒæ—¥ ç”¨åœ¨ä¸€æ™‚) çœ‹æ¿: plan
æ¨™  é¡Œ: [åŠŸèƒ½]æ¨‚é€å½©-å¤§æ¨‚é€(ä¿®æ”¹ç‰ˆ)
ç™¼ä¿¡ç«™: å¡å¸ƒå¥‡è«¾ (2004/10/27 Wed 00:39:26)                Updated: 2006/01/24

: src/so/Makefile

SO =    ... [1;33mlottery.so[m

: so/lottery.c æ–°å¢æ­¤ç¨‹å¼

/*-------------------------------------------------------*/
/* lottery.c    ( YZU WindTopBBS Ver 3.00 )              */
/*-------------------------------------------------------*/
/* target : å½©åˆ¸éŠæˆ²                                     */
/* create : 02/01/12                                     */
/* update : 03/05/26                                     */
/* author : verit.bbs@bbs.yzu.edu.tw                     */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/* modify : simple.bbs@bbs.wfc.edu.tw                    */
/*-------------------------------------------------------*/


#include "bbs.h"


static int choose_num[6];       /* æ‰€é¸çš„å…­å€‹è™Ÿç¢¼ */
static int choose_count;        /* å·²ç¶“é¸äº†å¹¾å€‹è™Ÿç¢¼ */


/*-------------------------------------------------------*/
/* ç•«é¢é‡ç¹ª                                              */
/*-------------------------------------------------------*/


static void
lottery_screen(fpath)
  char *fpath;
{
  FILE *fp;
  char buf[ANSILINELEN];

  vs_bar("æ¨‚é€å½©åˆ¸éŠæˆ²");

  if (fp = fopen(fpath, "r"))
  {
    while (fgets(buf, ANSILINELEN, fp))
      outs(buf);
    fclose(fp);
  }
}


/*-------------------------------------------------------*/
/* å°‡é¸æ“‡çš„æ¨‚é€è™Ÿç¢¼å¯„åˆ°è‡ªå·±ä¿¡ç®±                          */
/*-------------------------------------------------------*/


static void
lottery_mail_one()
{
  int i;
  FILE *fp;
  char fpath[64];

  sprintf(fpath, "tmp/%s.lottery", cuser.userid);

  if (fp = fopen(fpath, "w"))
  {
    fprintf(fp, "%s\n", Now());
    fprintf(fp, "æ‚¨æ‰€è³¼è²·çš„æ¨‚é€è™Ÿç¢¼ç‚ºï¼š");
    for (i = 0; i < 6; i++)
      fprintf(fp, "%d ", choose_num[i]);
    fprintf(fp, "\n");
    fclose(fp);

    mail_self(fpath, cuser.userid, "[å‚™ å¿˜ éŒ„] å½©åˆ¸ç´€éŒ„", MAIL_READ);
    unlink(fpath);
  }
}


/*-------------------------------------------------------*/
/* æ¨‚é€ç³»çµ±ç´€éŒ„                                          */
/*-------------------------------------------------------*/


static int
int_cmp(a, b)
  int *a;
  int *b;
{
  return *a - *b;
}


static void
lottery_log()
{
  int i;
  BUY_LOTTERY log;

  qsort(choose_num, 6, sizeof(int), int_cmp);

  memset(&log, 0, sizeof(BUY_LOTTERY));
  strcpy(log.userid, cuser.userid);
  for (i = 0; i < 6; i++)
    log.num[i] = choose_num[i];

  rec_add(FN_RUN_LOTTERY, &log, sizeof(BUY_LOTTERY));
}


/*-------------------------------------------------------*/
/* ç•«æ§åˆ¶æ¸¸æ¨™                                            */
/*-------------------------------------------------------*/


static void
draw_cursor(x, y, mode)
  int x, y;
  int mode;                     /* 1:é¸å– 0:å–æ¶ˆé¸å– */
{
  move(2 * x - 1, 4 + y * 8);
  outc(mode == 1 ? '[' : ' ');
  move(2 * x - 1, 7 + y * 8);
  outc(mode == 1 ? ']' : ' ');
}


/*-------------------------------------------------------*/
/* ç•«æ¨‚é€å½©åˆ¸ä¸‹æ³¨ç•«é¢                                    */
/*-------------------------------------------------------*/


static void
draw_numbers()
{
  int i, x, index;

  vs_bar("æ¨‚é€å½©åˆ¸ä¸‹æ³¨");

  x = 4;
  index = 1;

  move(x++, 1);
  outs("â•­â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â•®"
    "ã€€ã€€ã€€â•­â”€â”€â”€â•® ");
  for (i = 0; i < 7; i++, index += 7)
  {
    move(x++, 1);
    prints("â”‚  %02d  â”‚  %02d  â”‚  %02d  â”‚"
      "  %02d  â”‚  %02d  â”‚  %02d  â”‚  %02d  â”‚      â”‚      â”‚",
      index, index + 1, index + 2,
      index + 3, index + 4, index + 5, index + 6);
    move(x++, 1);
    if (i < 6)
      outs("â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤"
        "ã€€ã€€ã€€â”œâ”€â”€â”€â”¤");
  }
  outs("â•°â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â•¯"
    "ã€€ã€€ã€€â•°â”€â”€â”€â•¯");
}


/*-------------------------------------------------------*/
/* ç•«å‡ºä½¿ç”¨è€…é¸æ“‡çš„æ¨‚é€è™Ÿç¢¼                              */
/*-------------------------------------------------------*/


static void
draw_choose()
{
  int x;

  for (x = 0; x < choose_count; x++)
  {
    move(2 * x + 5, 68);
    prints(" %02d", choose_num[x]);
  }
  for (; x < 6; x++)
  {
    move(2 * x + 5, 68);
    outs("   ");
  }
}


/*-------------------------------------------------------*/
/* é¸å–æ¨‚é€è™Ÿç¢¼                                          */
/*-------------------------------------------------------*/


static int                      /* 1:å·²é¸å®Œå…­å€‹è™Ÿç¢¼ */
do_choose(num)
  int num;                      /* æ‰€é¸å–çš„è™Ÿç¢¼ */
{
  int i;
  int choose_flag;              /* -1:é¸å– >=0:å–æ¶ˆé¸å– */

  choose_flag = -1;

  for (i = 0; i < choose_count; i++)
  {
    if (choose_num[i] == num)
    {
      choose_flag = i;
      break;
    }
  }

  if (choose_flag >= 0)         /* å–æ¶ˆ */
  {
    choose_count--;
    for (i = choose_flag; i < choose_count; i++)
      choose_num[i] = choose_num[i + 1];
    draw_choose();
  }
  else                          /* é¸å– */
  {
    if (choose_count == 6)
    {
      vmsg("æ‚¨å·²ç¶“é¸äº†å…­å€‹è™Ÿç¢¼");
      return 1;
    }
    else
    {
      choose_num[choose_count] = num;
      choose_count++;
      draw_choose();
    }
  }
  return 0;
}


/*-------------------------------------------------------*/
/* æ¨‚é€ä¸‹æ³¨è™Ÿç¢¼é¸æ“‡                                      */
/*-------------------------------------------------------*/


static void
random_choose()
{
  int i, j;

  /* é€ å‡ºå…­å€‹ä¸åŒçš„æ•¸å­— */
  for (i = 0; i < 6; i++)
  {
    choose_num[i] = rnd(49) + 1;
    for (j = 0; j < i; j++)
    {
      if (choose_num[i] == choose_num[j])
      {
        i--;
        break;
      }
    }
  }
}


static void
lottery_buy_one()
{
  int cx, cy, ch;

  if (cuser.money < 1000)
  {
    vmsg("æ‚¨çš„éŠ€å¹£ä¸å¤ è³¼è²·å½©åˆ¸");
    return;
  }

  if (vans("æ¯å¼µå½©åˆ¸åƒ¹æ ¼ç‚º 1000 éŠ€å¹£ï¼Œæ˜¯å¦è¦è³¼è²·å‘¢(Y/N)ï¼Ÿ[Y] ") == 'n')
    return;

  draw_numbers();

  if (vans("æ˜¯å¦è¦é›»è…¦é¸è™Ÿ(Y/N)ï¼Ÿ[N] ") == 'y')
  {
    random_choose();

#if 1  /* ç´”ç²¹åªæ˜¯ç‚ºäº†ç§€å‡ºé¸è™Ÿçµæœï¼Œè¦ä¸ç„¶ä¸éœ€è¦é€™æ®µ */
    choose_count = 0;
    for (ch = 0; ch < 6; ch++)
      do_choose(choose_num[ch]);
    vmsg("é›»è…¦é¸è™Ÿçµæœ");
#endif
  }
  else     /* æ‰‹å‹•é¸è™Ÿ */
  {
    choose_count = 0;
    memset(choose_num, 0, sizeof(choose_num));
    cx = 3;
    cy = 0;

    while (1)
    {
      outz("â˜… æ“ä½œèªªæ˜ (æ–¹å‘)ç§»å‹• (Enter)é¸å–/å–æ¶ˆ (q)é›¢é–‹");

      for (;;)
      {
        draw_cursor(cx, cy, 1);
        ch = vkey();
        draw_cursor(cx, cy, 0);

        switch (ch)
        {
        case '\n':
          if (do_choose((cx - 3) * 7 + cy + 1))
            goto end_choose;
          break;
        case KEY_DOWN:
          cx = (cx == 9) ? 3 : cx + 1;
          break;
        case KEY_UP:
          cx = (cx == 3) ? 9 : cx - 1;
          break;
        case KEY_LEFT:
          cy = (cy == 0) ? 6 : cy - 1;
          break;
        case KEY_RIGHT:
          cy = (cy == 6) ? 0 : cy + 1;
          break;
        case 'q':
          return;
        }
      }

  end_choose:

      if (vans("æ˜¯å¦è¦ç¢ºå®šé€™å…­å€‹è™Ÿç¢¼(Y/N)ï¼Ÿ[N] ") == 'y')
        break;
    }
  }

  cuser.money -= 1000;
  lottery_log();

  if (vans("æ˜¯å¦è¦ä¿ç•™å½©åˆ¸(Y/N)ï¼Ÿ[Y] ") != 'n')
    lottery_mail_one();
}


static void
lottery_buy_some()
{
  int i, j, num;
  char fpath[64];
  FILE *fp;

  if (cuser.money < 1000)
  {
    vmsg("æ‚¨çš„éŠ€å¹£ä¸å¤ è³¼è²·å½©åˆ¸");
    return;
  }

  vget(b_lines, 0, "è«‹è¼¸å…¥æ¬²è²·å¼µæ•¸ï¼š", fpath, 5, DOECHO);
  if ((num = atoi(fpath)) <= 0)
    return;

  if (cuser.money < num * 1000)
  {
    vmsg("æ‚¨çš„éŠ€å¹£ä¸å¤ è³¼è²·å½©åˆ¸");
    return;
  }

  fp = NULL;
  if (vans("æ˜¯å¦è¦ä¿ç•™å½©åˆ¸(Y/N)ï¼Ÿ[Y] ") != 'n')
  {
    sprintf(fpath, "tmp/%s.lottery", cuser.userid);
    if (fp  = fopen(fpath, "w"))
    {
      fprintf(fp, "%s\n", Now());
      fprintf(fp, "æ‚¨æ‰€è³¼è²·çš„æ¨‚é€è™Ÿç¢¼ç‚ºï¼š");
    }
  }

  for (i = 0; i < num; i++)
  {
    random_choose();
    lottery_log();

    if (fp)
    {
      for (j = 0; j < 6; j++)
        fprintf(fp, "%d ", choose_num[j]);
      fprintf(fp, "\n");
    }
  }

  if (fp)
  {
    fclose(fp);
    mail_self(fpath, cuser.userid, "[å‚™ å¿˜ éŒ„] å½©åˆ¸ç´€éŒ„", MAIL_READ);
    unlink(fpath);
  }

  cuser.money -= num * 1000;
}


/*-------------------------------------------------------*/
/* ä¸»ç¨‹å¼                                                */
/*-------------------------------------------------------*/


int
main_lottery()
{
  double money;

  if (HAS_STATUS(STATUS_COINLOCK))
  {
    vmsg(MSG_COINLOCK);
    return XEASY;
  }

  srand(time(NULL) + cuser.userno);

  while (1)
  {
    lottery_screen("etc/game/lottery.main");

    /* é¡¯ç¤ºç´¯ç©çé‡‘ */
    money = 0;
    rec_get(LAST_KEEP_MONEY, &money, sizeof(money), 0);
    money += rec_num(FN_RUN_LOTTERY, sizeof(BUY_LOTTERY)) * 1000;
    move(20, 10);
    prints("ç›®å‰ç´¯ç©çé‡‘æœ‰ %.0f å…ƒ", money);

    switch (vkey())
    {
    case 'b':
      lottery_buy_one();
      break;

    case 's':
      lottery_buy_some();
      break;

    case 'h':
      lottery_screen("etc/game/lottery.rule");
      vmsg(NULL);
      break;

    default:
      return 0;
    }
  }
}

--
[m[1;32mâ€» Origin: [33må³é³³æŠ€è¡“å­¸é™¢é›»ç®—ä¸­å¿ƒ å¡å¸ƒå¥‡è«¾ [37m<bbs.wfc.edu.tw>[m
[1;31mâ—† From: [36mbbs.wfc.edu.tw[m
