Áôº‰ø°‰∫∫: TKyo.bbs@cpu.tfcis.org (ÊöóÈªëË≤¥ÂÖ¨Â≠ê) ÁúãÊùø: plan
Ê®ô  È°å: Re: [ÂïèÈ°å]ÊñáÁ´†È°ûÂà•
Áôº‰ø°Á´ô: ÂãïÂäõÊ†∏ÂøÉ (2005/01/25 Tue 16:54:09)                Updated: 2006/04/17

‚Äª ÂºïËø∞„Ääwim888.bbs@wim888.twbbs.org (888)„Äã‰πãÈäòË®ÄÔºö
> Âú®POSTÊñáÁ´†ÊôÇÊúÉÂÖàÂïèË¶Å‰∏çË¶ÅÂä†‰∏äÊñáÁ´†È°ûÂà•
> ÁõÆÂâçÊòØË¶ÅÂ∞±ÂÖ®Á´ôÈÉΩÁî®Ë¶Å‰∏çÁÑ∂Â∞±ÊòØÈÉΩ‰∏çÁî®
> ËÉΩ‰∏çËÉΩÊîπÊàêËÆìÊØèÂÄãÁâàÂàÜÈñãÂéªÊ±∫ÂÆö
> ÊØèÂÄãÁâàÂèØ‰ª•Ë®≠ÂÆöËá™Â∑±ÁöÑÊñáÁ´†ÊúâÂì™‰∫õÈ°ûÂà•

Âëµ, ÂâõÂ•ΩÊàëÁ´ô‰∏äÊúâÈÄôÂäüËÉΩ, ÂØ´Â•Ω‰∏ÄÂÄãÁ¶ÆÊãúÂ§ö‰∫Ü, Â∞± Post Âá∫‰æÜÁµ¶Â§ßÂÆ∂ÂèÉËÄÉÂêß :)

------------------------------------------------------------------------------
: src/include/modes.h : ÂÅáË®≠ XO_ZONE ÊúÄÂæåÁÇ∫Á≤æËèØÂçÄ, ÈúÄË∑ü xz[] ÂêåÊ≠•

  #define XZ_GEM          (XO_ZONE + 13)          /* Á≤æËèØÂçÄ */
+ #define XZ_PREFIX       (XO_ZONE + 14)          /* ÊñáÁ´†È°ûÂà•ÂÆöÁæ©Ê™î */

: src/include/battr.h : ÂÅáË®≠ÁúãÊùøÂ±¨ÊÄßÊúÄÂæåÊòØ BRD_NOSCORE

  #define BRD_NOSCORE   0x40    /* ‰∏çË©ïÂàÜÁúãÊùø */
+ #define BRD_PREFIX    0x80    /* ‰ΩøÁî®ÊñáÁ´†È°ûÂà• */

- #define NUMBATTRS 7
+ #define NUMBATTRS 8

- #define STR_BATTR "zTcsvA%"         /* itoc: Êñ∞Â¢ûÊóóÊ®ôÁöÑÊôÇÂÄôÂà•Âøò‰∫ÜÊîπÈÄôË£°Âïä */
+ #define STR_BATTR "zTcsvA%p"        /* itoc: Êñ∞Â¢ûÊóóÊ®ôÁöÑÊôÇÂÄôÂà•Âøò‰∫ÜÊîπÈÄôË£°Âïä */

#ifdef _ADMIN_C_
  static char *battr_tbl[NUMBATTRS] =
  {
    .
    .
    .
  "‰∏çË©ïÂàÜÁúãÊùø",         /* BRD_NOSCORE */
+ "‰ΩøÁî®ÊñáÁ´†È°ûÂà•"        /* BRD_PREFIX */
};
#endif

: src/include/struct.h : ÈÅ©Áï∂‰ΩçÁΩÆÂä†ÂÖ•

+ #define FN_PREFIX       "prefix.dat"            /* ÊñáÁ´†È°ûÂà•ÂÆöÁæ©Ê™î */
+ typedef struct
+ {
+   time_t stamp;                 /* Á∑®Ëôü */
+   usint xmode;                  /* ÊñáÁ´†È°ûÂà•Ê®°Âºè */
+   char title[11];               /* ÊñáÁ´†È°ûÂà•Ê®ôÈ°å */
+ }       PREFIX;

: src/include/theme.h : ÈÅ©Áï∂‰ΩçÁΩÆÂä†ÂÖ•

#define NECKER_PREFIX  "[‚Üê]Èõ¢Èñã [T]‰øÆÊîπÈ°ûÂà• [E]‰øÆÊîπ [m]ÁßªÂãï [t]Ê®ôÁ±§ [d/D]Âà™Èô§ [^D]Ê®ôÁ±§Âà™Èô§ [h]Ë™™Êòé\n" \
COLOR3 "  Á∑®Ëôü   ÊñáÁ´†È°ûÂà•    Â±¨ÊÄß%*s                                                     \033[m"

#define FEETER_PREFIX   \
COLOR1 " È°ûÂà•ÁÆ°ÁêÜ " COLOR2 " (ENTER)ÂàáÊèõÂ±¨ÊÄß (a)Êñ∞Â¢û (E)‰øÆÊîπ (‚Üë/‚Üì)‰∏ä‰∏ã (PgUp/PgDn)‰∏ä‰∏ãÈ†Å      "

: src/maple/xover.c : xz[]

- {NULL, NULL, M_GEM, FEETER_GEM}               /* XZ_GEM */
+ {NULL, NULL, M_GEM, FEETER_GEM},              /* XZ_GEM */
+ {NULL, NULL, M_XMODE, FEETER_PREFIX}          /* XZ_PREFIX */

: src/so/manage.c : post_manage()

  char *menu[] =
  {
    .
    .
    .
+   "Prefix  Á∑®ËºØÊñáÁ´†È°ûÂà•"
     NULL
  };

  case 'o':
    ret = XoBM(xo);
    break;
#endif

  case 'p':
+   {
+     void *p;
+     int (*func) ();

+     p = DL_get("bin/prefix.so:XoPrefix");

+     if (p)
+     {
+       func = p;
+       ret = (*(func)) (xo);
+     }
+     else
+       ret = XO_FOOT;

+      break;
+   }


: src/maple/post.c

/* ÈÅ©Áï∂‰ΩçÁΩÆÂä†ÂÖ•‰∏Ä function post_prefix() */

static char *
post_prefix()
{
  char *menu[13], fpath[64];
  PREFIX prefix;
  static char buf[10][14];
  char buf_title[50];
  int ch, i, j, num, page, page_max, page_size;

  if (currbattr & BRD_PREFIX)
  {
    brd_fpath(fpath, currboard, FN_PREFIX);
    if ((num = rec_num(fpath, sizeof(PREFIX))) > 0)
    {
      page_size = 9;
      page_max = ((num - 1) / page_size) + 1;
      page = 0;
      menu[0] = "QP";

      for (;;)
      {
        i = page * page_size;
        for (j = 0; j <= page_size; i++, j++)
        {
          if (!(rec_get(fpath, &prefix, sizeof(PREFIX), i)))
          {
            if (prefix.xmode && (!(bbstate & STAT_BOARD)))
              strcpy(buf[j], "#  Êùø‰∏ªÂæ°Áî®");
            else
              sprintf(buf[j], "%d  %s", (j + 1), prefix.title);

            menu[j + 1] = buf[j];
          }
          else
          {
            j++;
            break;
          }
        }

        menu[j] = "Q  ÂèñÊ∂à";
        menu[j + 1] = NULL;

        sprintf(buf_title, "ÈÅ∏ÊìáÊñáÁ´†È°ûÂà•  (‚Üê) ÊèõÈ†Å‚ïë%c‚ïë", page + '1');
        ch = pans(-1, -1, buf_title, menu);
        if (ch == 'q')
          break;
        else if (ch == 'p')
        {
          page++;
          if (page == page_max)
            page = 0;
        }
        else if (ch == '#')
          vmsg("ÁÑ°Ê≥ï‰ΩøÁî®Ê≠§ÊñáÁ´†È°ûÂà•\nÂõ†ÁÇ∫ÊÇ®‰∏çÊòØË©≤ÊùøÊùø‰∏ªÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÊñáÁ´†È°ûÂà•ÔºÅ");
        else
          return buf[ch - '1'] + 3;
      }
    }
  }
  return NULL;
}

: src/maple/post.c : do_post()

  prints("ÁôºË°®ÊñáÁ´†Êñº„Äê %s „ÄëÁúãÊùø", currboard);

#ifdef POST_PREFIX
  .
  .
  .
#else
- if (!ve_subject(21, title, NULL))
+ if (!ve_subject(22, title, ((title) ? NULL : post_prefix())))
#endif
    return XO_HEAD;

: src/so/prefix.c Êñ∞Â¢ûÈÄôÈöªÁ®ãÂºè

/*-------------------------------------------------------*/
/* prefix.c         ( NTHU CS MapleBBS Ver 3.10 )        */
/*-------------------------------------------------------*/
/* target : Post Refix ÁÆ°ÁêÜ‰ªãÈù¢Á®ãÂºè                      */
/* author : kyo.bbs@cszone.org                           */
/* create : 05/01/17                                     */
/* update :   /  /                                       */
/*-------------------------------------------------------*/


#include "bbs.h"


extern XZ xz[];
extern char xo_pool[];

#define PREFIX_MANAGER  0x01

#define C_PREFIX_MANAGER        "\033[1;31m"
#define C_PREFIX_USER           "\033[1;37m"

static int
prefix_edit(prefix, echo)
  PREFIX *prefix;
  int echo;
{
  char buf_command[3] = {0};
  char *menu[] = {buf_command,
      "1  ‰∏ÄËà¨‰ΩøÁî®ËÄÖ",
      "2  Êùø‰∏ªÂ∞àÁî®", NULL};

  strcpy(buf_command, "11");

  if (echo == GCARRY)
  {
    if (prefix->xmode & PREFIX_MANAGER)
      strcpy(buf_command, "22");
  }

  switch(pans(-1, -1, "È°ûÂà•‰ΩøÁî®Ê¨äÈôê", menu))
  {
    case '1':
      prefix->xmode = 0;
      break;
    case '2':
      prefix->xmode = PREFIX_MANAGER;
      break;
  }

  if (!(vget(b_lines, 0, "ÊñáÁ´†È°ûÂà•Ôºö", prefix->title, 11, echo)))
    return 0;

  return 1;
}

static int
prefix_add(xo)
  XO *xo;
{
  PREFIX prefix;

  memset(&prefix, 0, sizeof(PREFIX));

  if (prefix_edit(&prefix, DOECHO))
  {
    char fpath[64];

    time(&prefix.stamp);
    brd_fpath(fpath, currboard, FN_PREFIX);
    rec_add(fpath, &prefix, sizeof(PREFIX));
  }

  return XO_INIT;
}

static int
prefix_change(xo)
  XO *xo;
{
  PREFIX *prefix, old_prefix;
  int pos, cur;

  pos = xo->pos;
  cur = pos - xo->top;
  prefix = (PREFIX *) xo_pool + cur;

  old_prefix = *prefix;

  if (prefix_edit(&old_prefix, GCARRY))
  {
    if (memcmp(prefix, &old_prefix, sizeof(PREFIX)))
    {
      if (vans("Á¢∫ÂÆöË¶Å‰øÆÊîπÂóéÔºü[N] ") == 'y')
      {
        char fpath[64];

        brd_fpath(fpath, currboard, FN_PREFIX);
        rec_put(fpath, &old_prefix, sizeof(PREFIX), pos, NULL);
        return XO_INIT;
      }
    }
  }

  return XO_HEAD;
}

static int
prefix_title(xo)
  XO *xo;
{
  PREFIX *prefix, old_prefix;
  int pos, cur;

  pos = xo->pos;
  cur = pos - xo->top;
  prefix = (PREFIX *) xo_pool + cur;

  old_prefix = *prefix;

  if (vget(b_lines, 0, "ÊñáÁ´†È°ûÂà•Ôºö", prefix->title, 11, GCARRY))
  {
    if (memcmp(prefix, &old_prefix, sizeof(PREFIX)))
    {
      char fpath[64];

      brd_fpath(fpath, currboard, FN_PREFIX);
      rec_put(fpath, prefix, sizeof(PREFIX), pos, NULL);
      return XO_LOAD;
    }
  }

  return XO_FOOT;
}

prefix_delete(xo)
  XO *xo;
{
  if (vans(msg_del_ny) == 'y')
  {
    if (!rec_del(xo->dir, sizeof(PREFIX), xo->pos, NULL))
    {
      PREFIX *prefix;
      prefix = (PREFIX *) xo_pool + (xo->pos - xo->top);
      return XO_LOAD;
    }
  }
  return XO_FOOT;
}

static int
prefix_rangedel(xo)
  XO *xo;
{
  return xo_rangedel(xo, sizeof(PREFIX), NULL, NULL);
}

static int
vfyprefix(prefix, pos)
  PREFIX *prefix;
  int pos;
{
  return Tagger(prefix->stamp, pos, TAG_NIN);
}

static int
prefix_prune(xo)
  XO *xo;
{
  return xo_prune(xo, sizeof(PREFIX), vfyprefix, NULL);
}

static void
prefix_item(num, prefix)
  int num;
  PREFIX *prefix;
{
  prints("%6d  %c%-10s  %s%s\033[m\n",
    num, tag_char(prefix->stamp),
    prefix->title,
    (prefix->xmode & PREFIX_MANAGER) ? C_PREFIX_MANAGER : C_PREFIX_USER,
    (prefix->xmode & PREFIX_MANAGER) ? "Êùø‰∏ªÂ∞àÁî®" : "‰∏ÄËà¨‰ΩøÁî®ËÄÖ");
}

static int
prefix_query(xo)
  XO *xo;
{
  PREFIX *prefix;
  int pos, cur;
  char fpath[64];

  pos = xo->pos;
  cur = pos - xo->top;
  prefix = (PREFIX *) xo_pool + cur;

  prefix->xmode ^= PREFIX_MANAGER;
  brd_fpath(fpath, currboard, FN_PREFIX);
  rec_put(fpath, prefix, sizeof(PREFIX), pos, NULL);

  move(3 + cur, 0);
  prefix_item(++pos, prefix);

  return XO_NONE;
}

static int
prefix_body(xo)
  XO *xo;
{
  PREFIX *prefix;
  int max, num, tail;

  max = xo->max;
  if (max <= 0)
  {
    if (vans("Êñ∞Â¢ûÊñáÁ´†È°ûÂà•Ë≥áÊñôÔºü[N] ") == 'y')
      return prefix_add(xo);

    return XO_QUIT;
  }

  prefix = (PREFIX *) xo_pool;
  num = xo->top;
  tail = num + XO_TALL;
  if (max > tail)
    max = tail;

  move(3, 0);
  do
  {
    prefix_item(++num, prefix++);
  } while (num < max);
  clrtobot();

  return XO_FOOT;       /* itoc.010403: Êää b_lines Â°´‰∏ä feeter */
}

static int
prefix_head(xo)
  XO *xo;
{
  vs_head("È°ûÂà•ÁÆ°ÁêÜ", str_site);
  prints(NECKER_PREFIX, d_cols, "");

  return prefix_body(xo);
}

static int
prefix_load(xo)
  XO *xo;
{
  xo_load(xo, sizeof(PREFIX));
  return prefix_body(xo);
}

static int
prefix_init(xo)
  XO *xo;
{
  xo_load(xo, sizeof(PREFIX));
  return prefix_head(xo);
}

static int
prefix_tag(xo)
  XO *xo;
{
  PREFIX *prefix;
  int tag, pos, cur;

  pos = xo->pos;
  cur = pos - xo->top;
  prefix = (PREFIX *) xo_pool + cur;

  if (tag = Tagger(prefix->stamp, pos, TAG_TOGGLE))
  {
    move(3 + cur, 0);
    prefix_item(++pos, prefix);
  }

  return xo->pos + 1 + XO_MOVE; /* lkchu.981201: Ë∑≥Ëá≥‰∏ã‰∏ÄÈ†Ö */
}


static int
prefix_move(xo)
  XO *xo;
{
  PREFIX *prefix;
  int pos, cur, i;
  char buf[40], ans[5];

  pos = xo->pos;
  cur = pos - xo->top;
  prefix = (PREFIX *) xo_pool + cur;

  sprintf(buf, "Ë´ãËº∏ÂÖ•Á¨¨ %d ÈÅ∏È†ÖÁöÑÊñ∞‰ΩçÁΩÆÔºö", pos + 1);
  if (vget(b_lines, 0, buf, ans, 5, DOECHO))
  {
    i = atoi(ans) - 1;
    if (i < 0)
      i = 0;
    else if (i >= xo->max)
      i = xo->max - 1;

    if (i != pos)
    {
      if (!rec_del(xo->dir, sizeof(PREFIX), pos, NULL))
      {
        rec_ins(xo->dir, prefix, sizeof(PREFIX), i, 1);
        xo->pos = i;
        return prefix_load(xo);
      }
    }
  }
  return XO_FOOT;
}

static int
prefix_help(xo)
  XO *xo;
{
  xo_help("prefix");
  return XO_HEAD;
}


static KeyFunc prefix_cb[] =
{
  XO_INIT, prefix_init,
  XO_LOAD, prefix_load,
  XO_HEAD, prefix_head,
  XO_BODY, prefix_body,

  'r', prefix_query,
  'a', prefix_add,
  'E', prefix_change,
  'T', prefix_title,
  Ctrl('D'), prefix_prune,
  'd', prefix_delete,
  'D', prefix_rangedel,
  't', prefix_tag,
  'm', prefix_move,
  'h', prefix_help
};


int
XoPrefix(xo)
  XO *xo;
{

  if (bbstate & STAT_BM)
  {
    char fpath[64];

    brd_fpath(fpath, currboard, FN_PREFIX);
    xz[XZ_PREFIX - XO_ZONE].xo = xo = xo_new(fpath);
    xz[XZ_PREFIX - XO_ZONE].cb = prefix_cb;
    xover(XZ_PREFIX);
    free(xo);

    return XO_INIT;
  }

  return XO_NONE;
}
------------------------------------------------------------------------------

--
 [1;43m‚ó§[46m‚ó•[m Or[1mig[30min[m: [41m Maple-itocÀôÂãïÂäõÊ†∏ÂøÉ [36;47m cpu.tfcis.org [m
 [1;44m‚ó£[41m‚ó¢[m A[1mut[30mho[mr: [1;33mTKyo [30mÂæû [31mcszone.twbbs.org [30mÁôºË°®[m
