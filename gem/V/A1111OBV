ä½œè€…: itoc (ç«™ä¸Šäººæ•¸ï¼š802) ç«™å…§: plan
æ¨™é¡Œ: [åŠŸèƒ½] æ¸…é™¤éŽèˆŠçš„ä¸Šç«™ä¾†æºè¨˜éŒ„
æ™‚é–“: 2005/02/15 Tue 01:25:24                           Updated: 2005/08/15

  usr/u/userid/log é€™å€‹ã€Žä¸Šç«™ä¾†æºè¨˜éŒ„ã€æœƒå› å¹´ä»£ä¹…é è€Œè®Šå¾—å¾ˆè‚¥å¤§
  é€™å€‹ç¨‹å¼å¯ä»¥åˆªé™¤éŽèˆŠçš„è¨˜éŒ„

: src/util/Makefile

EXE =   ..... [1;33mdelog[m

: src/util/delog.c æ–°å¢žé€™ç¨‹å¼

/*-------------------------------------------------------*/
/* util/delog.c         ( NTHU CS MapleBBS Ver 3.10 )    */
/*-------------------------------------------------------*/
/* target : æ¸…é™¤éŽèˆŠçš„ä¸Šç«™ä¾†æºè¨˜éŒ„                       */
/* create : 05/02/14                                     */
/* update :   /  /                                       */
/* author : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/
/* syntax : delog [userid]                               */
/*-------------------------------------------------------*/


#include "bbs.h"


#define QUICK_DELOG


#ifdef QUICK_DELOG
#define KEEP_BYTES      20480   /* åªä¿ç•™æœ€å¾Œ 20480 bytes çš„ä¸Šç«™ä¾†æºè¨˜éŒ„ */
#else
#define KEEP_DAYS       180     /* åªä¿ç•™æœ€è¿‘ 180 å¤©çš„ä¸Šç«™ä¾†æºè¨˜éŒ„ */
static int now;
#endif


#ifdef QUICK_DELOG
static void
delog(fpath)
  char *fpath;
{
  int fd, fsize;
  char *fimage, *fend, *ptr;

  if (fimage = f_img(fpath, &fsize))
  {
    if (fsize > KEEP_BYTES)
    {
      fend = fimage + fsize;

      for (ptr = fimage + fsize - KEEP_BYTES;
        *ptr != '\n' && ptr < fend; ptr++);
      ptr++;

      if (ptr < fend)
      {
        if ((fd = open(fpath, O_WRONLY | O_CREAT | O_TRUNC, 0600)) >= 0)
        {
          write(fd, ptr, fend - ptr);
          close(fd);
        }
      }
    }
    free(fimage);
  }
  else
  {
    unlink(fpath);
  }
}
#else
static int
decode_Btime(str)
  char *str;
{
  /* ä¾ Btime() æ ¼å¼ä¸åŒè€Œè®Š */

  /* ç‚ºç°¡å–®èµ·è¦‹ï¼Œä¸è€ƒæ…®é–å¹´åŠå¤§å°æœˆï¼Œæ‰€ä»¥å¯¦éš›ä¿ç•™çš„æ—¥æœŸ
     æœƒå’Œ KEEP_DAYS ç•¥æœ‰ä¸åŒ */

  if (*str == '2')      /* æ–°æ ¼å¼: 2003/12/01 Mon 22:05:38 */
    return atoi(str) * 365 + atoi(str + 5) * 31 + atoi(str + 8);
  else                  /* èˆŠæ ¼å¼: 03/12/01 15:33:08 */
    return atoi(str) * 365 + atoi(str + 3) * 31 + atoi(str + 6);
}


static void
delog(fpath)
  char *fpath;
{
  int keep;
  char fnew[64], buf[256];
  FILE *fpr, *fpw;

  if (fpr = fopen(fpath, "r"))
  {
    sprintf(fnew, "%s.new", fpath);
    if (fpw = fopen(fnew, "w"))
    {
      keep = 0;
      while (fgets(buf, sizeof(buf), fpr))
      {
        if (!keep)
        {
          if (decode_Btime(buf) >= now)
            keep = 1;
        }

        if (keep)
          fputs(buf, fpw);
      }

      fclose(fpw);
    }
    fclose(fpr);

    unlink(fpath);
    rename(fnew, fpath);
  }
}
#endif


int
main(argc, argv)
  int argc;
  char *argv[];
{
  char c, *str, fpath[64];
  struct dirent *de;
  DIR *dirp;

  if (argc > 2)
  {
    printf("Usage: %s [userid]\n", argv[0]);
    return -1;
  }

#ifndef QUICK_DELOG
  now = decode_Btime(Now()) - KEEP_DAYS;
#endif

  if (argc == 2)
  {
    chdir(BBSHOME);
    usr_fpath(fpath, argv[1], FN_LOG);
    delog(fpath);
    return 0;
  }

  for (c = 'a'; c <= 'z'; c++)
  {
    printf("æ­£é–‹å§‹è™•ç† %c é–‹é ­çš„ ID\n", c);

    sprintf(fpath, BBSHOME "/usr/%c", c);
    chdir(fpath);

    if (!(dirp = opendir(".")))
      continue;

    while (de = readdir(dirp))
    {
      str = de->d_name;
      if (*str <= ' ' || *str == '.')
        continue;

      sprintf(fpath, "%s/" FN_LOG, str);
      delog(fpath);
    }

    closedir(dirp);
  }

  return 0;
}

--
  è‹¥ #undef QUICK_DELOG çš„è©±ï¼Œè »åƒ I/O çš„ï¼Œä¹…ä¹…è·‘ä¸€æ¬¡å°±å¯ä»¥äº†

--
[1;37mâ–¡ æœ¬æ–‡ç« ç”± [33mitoc[37m å¾ž [32mitoc.Dorm11.NCTU.edu.tw[37m ç™¼è¡¨[m
