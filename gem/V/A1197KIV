ç™¼ä¿¡äºº: itoc.bbs@cpu.tfcis.org (æ ¸å¿ƒå‹•åŠ›) çœ‹æ¿: plan
æ¨™  é¡Œ: Re: [è«‹ç›Š] ä¿®æ”¹æ–‡ç« å‚™ä»½å•é¡Œ
ç™¼ä¿¡ç«™: å‹•åŠ›æ ¸å¿ƒ (2005/05/24 Tue 18:55:31)                Updated: 2007/04/26

â€» å¼•è¿°ã€ŠRagnarok (å‘†å‘†å–µ(â‰§âŠ™âŠ™â‰¦))ã€‹ä¹‹éŠ˜è¨€ï¼š
> æˆ‘æƒ³åƒ JUNK/DELETED ä¸€æ¨£å‚™ä»½è¢«ä¿®æ”¹éçš„æ–‡ç« (ç·¨è¼¯å‰çš„å…§å®¹)ï¼Œå­˜åˆ° BN_MODIFY æ¿
> æˆ‘æƒ³æœ€å®¹æ˜“çš„æ–¹æ³•å¥½åƒæ˜¯åœ¨ post_edit() ä¸­ï¼Œåœ¨é€²å…¥vedit()å‰è¤‡è£½ä¸€ä»½å…§å®¹è‡³è©²æ¿ã€‚

: post.c:post_edit()

  char fpath[64];
+ char folder[64];
  HDR *hdr;
+ HDR xpost;
  FILE *fp;

  hdr = (HDR *) xo_pool + (xo->pos - xo->top);

  hdr_fpath(fpath, xo->dir, hdr);
+ brd_fpath(folder, BN_JUNK, fn_dir);

  if (HAS_PERM(PERM_ALLBOARD))                  /* ç«™é•·ä¿®æ”¹ */
  {
#ifdef HAVE_REFUSEMARK
    if (!chkrestrict(hdr))
      return XO_NONE;
#endif
+   hdr_stamp(folder, HDR_COPY | 'A', &xpost, fpath);
+   strcpy(xpost.owner, hdr->owner);
+   strcpy(xpost.nick, hdr->nick);
+   strcpy(xpost.title, hdr->title);
-   vedit(fpath, 0);
+   if (!vedit(fpath, 0))
+   {
+     rec_bot(folder, &xpost, sizeof(HDR));
+     btime_update(brd_bno(BN_JUNK));
+   }
+   else
+   {
+     hdr_fpath(fpath, folder, &xpost);
+     unlink(fpath);
+   }
  }
  else if (cuser.userlevel && !strcmp(hdr->owner, cuser.userid))
  {
+   hdr_stamp(folder, HDR_COPY | 'A', &xpost, fpath);
+   strcpy(xpost.owner, hdr->owner);
+   strcpy(xpost.nick, hdr->nick);
+   strcpy(xpost.title, hdr->title);
    if (!vedit(fpath, 0))       /* è‹¥éå–æ¶ˆå‰‡åŠ ä¸Šä¿®æ”¹è³‡è¨Š */
    {
      if (fp = fopen(fpath, "a"))
      {
        ve_banner(fp, 1);
        fclose(fp);
      }
+     rec_bot(folder, &xpost, sizeof(HDR));
+     btime_update(brd_bno(BN_JUNK));
    }
+   else
+   {
+     hdr_fpath(fpath, folder, &xpost);
+     unlink(fpath);
+   }
  }

--
 [1;43mâ—¤[46mâ—¥[m Or[1mig[30min[m: [41m Maple-itocË™å‹•åŠ›æ ¸å¿ƒ [36;47m cpu.tfcis.org [m
 [1;44mâ—£[41mâ—¢[m A[1mut[30mho[mr: [1;33mitoc [30må¾ [31mitoc.Dorm11.NCTU.edu.tw [30mç™¼è¡¨[m
